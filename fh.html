<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>3&nbsp; The Univariate Fay-Herriot model – EUPM Practitioners Guide</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./fh_multivariate.html" rel="next">
<link href="./data.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-de84f8d6bb715db06a919283c2d1e787.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-dab9f7089602d7cfcae6e9e20dddb093.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./fh.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">The Univariate Fay-Herriot model</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">EUPM Practitioners Guide</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Small Area Estimations for the poverty mapping: an overview</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data preparation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fh.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">The Univariate Fay-Herriot model</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fh_multivariate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Multivariate Fay–Herriot</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ul.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Unit-Level Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">3.1</span> Introduction</a></li>
  <li><a href="#data-and-preparation" id="toc-data-and-preparation" class="nav-link" data-scroll-target="#data-and-preparation"><span class="header-section-number">3.2</span> Data and preparation</a>
  <ul class="collapse">
  <li><a href="#load-required-libraries" id="toc-load-required-libraries" class="nav-link" data-scroll-target="#load-required-libraries"><span class="header-section-number">3.2.1</span> Load required libraries</a></li>
  <li><a href="#load-the-dataset" id="toc-load-the-dataset" class="nav-link" data-scroll-target="#load-the-dataset"><span class="header-section-number">3.2.2</span> Load the dataset</a></li>
  <li><a href="#direct-estimation" id="toc-direct-estimation" class="nav-link" data-scroll-target="#direct-estimation"><span class="header-section-number">3.2.3</span> Direct estimation</a></li>
  <li><a href="#variance-smoothing" id="toc-variance-smoothing" class="nav-link" data-scroll-target="#variance-smoothing"><span class="header-section-number">3.2.4</span> Variance smoothing</a></li>
  <li><a href="#auxiliary-variable-preparation" id="toc-auxiliary-variable-preparation" class="nav-link" data-scroll-target="#auxiliary-variable-preparation"><span class="header-section-number">3.2.5</span> Auxiliary variable preparation</a></li>
  </ul></li>
  <li><a href="#model-selection" id="toc-model-selection" class="nav-link" data-scroll-target="#model-selection"><span class="header-section-number">3.3</span> Model selection</a>
  <ul class="collapse">
  <li><a href="#model-preparation" id="toc-model-preparation" class="nav-link" data-scroll-target="#model-preparation"><span class="header-section-number">3.3.1</span> Model preparation</a></li>
  <li><a href="#check-multicollinearity" id="toc-check-multicollinearity" class="nav-link" data-scroll-target="#check-multicollinearity"><span class="header-section-number">3.3.2</span> Check multicollinearity</a></li>
  </ul></li>
  <li><a href="#model-estimation-of-fh-point-and-their-mse-estimates." id="toc-model-estimation-of-fh-point-and-their-mse-estimates." class="nav-link" data-scroll-target="#model-estimation-of-fh-point-and-their-mse-estimates."><span class="header-section-number">3.4</span> Model estimation of FH point and their MSE estimates.</a></li>
  <li><a href="#assessment-of-the-estimated-model." id="toc-assessment-of-the-estimated-model." class="nav-link" data-scroll-target="#assessment-of-the-estimated-model."><span class="header-section-number">3.5</span> Assessment of the estimated model.</a>
  <ul class="collapse">
  <li><a href="#diagnostic-plots" id="toc-diagnostic-plots" class="nav-link" data-scroll-target="#diagnostic-plots"><span class="header-section-number">3.5.1</span> Diagnostic plots</a></li>
  </ul></li>
  <li><a href="#comparison-of-the-fh-results-with-the-direct-estimates." id="toc-comparison-of-the-fh-results-with-the-direct-estimates." class="nav-link" data-scroll-target="#comparison-of-the-fh-results-with-the-direct-estimates."><span class="header-section-number">3.6</span> Comparison of the FH results with the direct estimates.</a></li>
  <li><a href="#benchmark-the-fh-point-estimates-for-consistency-with-higher-results." id="toc-benchmark-the-fh-point-estimates-for-consistency-with-higher-results." class="nav-link" data-scroll-target="#benchmark-the-fh-point-estimates-for-consistency-with-higher-results."><span class="header-section-number">3.7</span> Benchmark the FH point estimates for consistency with higher results.</a></li>
  <li><a href="#preparation-of-the-results." id="toc-preparation-of-the-results." class="nav-link" data-scroll-target="#preparation-of-the-results."><span class="header-section-number">3.8</span> Preparation of the results.</a>
  <ul class="collapse">
  <li><a href="#poverty-map" id="toc-poverty-map" class="nav-link" data-scroll-target="#poverty-map"><span class="header-section-number">3.8.1</span> Poverty map</a></li>
  </ul></li>
  <li><a href="#saving-the-results." id="toc-saving-the-results." class="nav-link" data-scroll-target="#saving-the-results."><span class="header-section-number">3.9</span> Saving the results.</a>
  <ul class="collapse">
  <li><a href="#save-workspace." id="toc-save-workspace." class="nav-link" data-scroll-target="#save-workspace."><span class="header-section-number">3.9.1</span> Save workspace.</a></li>
  <li><a href="#export-the-model-output-and-estimation-results." id="toc-export-the-model-output-and-estimation-results." class="nav-link" data-scroll-target="#export-the-model-output-and-estimation-results."><span class="header-section-number">3.9.2</span> Export the model output and estimation results.</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">The Univariate Fay-Herriot model</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">3.1</span> Introduction</h2>
<p>In this section, we will present a whole estimation procedure of the standard area-level model introduced by <span class="citation" data-cites="Fay1979">Fay and Herriot (<a href="references.html#ref-Fay1979" role="doc-biblioref">1979</a>)</span> in R. As with the disclaimer in the preceding section, this practical manual is not intended to serve as a theoretical introduction to area-level models. Instead, it offers a set of straightforward and practical R scripts, accompanied by clear explanations, to demonstrate how these tasks can be carried out in R. For a theoretical foundation please refer to <span class="citation" data-cites="Fay1979">Fay and Herriot (<a href="references.html#ref-Fay1979" role="doc-biblioref">1979</a>)</span> and <span class="citation" data-cites="RaoMolina2015">Rao and Molina (<a href="references.html#ref-RaoMolina2015" role="doc-biblioref">2015</a>)</span>. In addition to theoretical information, the vignette “A framework for producing small area estimates based on area-level models in R” of the R package <code>emdi</code> <span class="citation" data-cites="Harmening2023">(<a href="references.html#ref-Harmening2023" role="doc-biblioref">Harmening et al. 2023</a>)</span> provides further code examples for the FH model.</p>
<p>In this chapter, we will describe how to run the univariate Fay-Herriot (FH) using simulated income data from Spain. The estimation procedure is explained step by step.</p>
<p>Step 1: Data preparation. Compute the direct estimates and their corresponding variances on the area-level and eventually perform variance smoothing. Aggregate the available auxiliary variables to the same area level and combine both input data.</p>
<p>Step 2: Model selection. Select the aggregated auxiliary variables at the area level for the FH model using a stepwise selection based on information criteria like the Akaike, Bayesian or Kullback information criteria.</p>
<p>Step 3: Model estimation of FH point estimates and their mean squared error (MSE) estimates as uncertainty measure. Eventually apply a transformation.</p>
<p>Step 4: Assessment of the estimated model. Check the FH model assumptions, including linearity, normality of predicted area effects and standardized model residuals. When violations of the model assumptions are detected, the application of a transformation might help. Repeat Step 3 including a transformation and check again the model assumptions.</p>
<p>Step 5: Comparison of the FH results with the direct estimates.</p>
<p>Step 6: Benchmark the FH point estimates for consistency with higher results.</p>
<p>Step 7: Preparation of the results. Create tables and maps of results.</p>
<p>Step 8: Saving the results. One option is to export the results to known formats like Excel or OpenDocument Spreadsheets.</p>
<p>We will show below the use of the <code>fh()</code> function of the R package <code>emdi</code> <span class="citation" data-cites="Harmening2023">(<a href="references.html#ref-Harmening2023" role="doc-biblioref">Harmening et al. 2023</a>)</span> which computes the EBLUPs and their MSE estimates of the standard FH model and several extensions of it, among others it allows for the application of transformations. Because the poverty rate is a ratio, it might be helpful to apply the arcsin transformation to guarantee that the results lie between 0 and 1. The function call is:</p>
<p><code>fh(fixed, vardir, combined_data, domains = NULL, method = "reml", interval = NULL,   k = 1.345, mult_constant = 1, transformation = "no", backtransformation = NULL,   eff_smpsize = NULL, correlation = "no", corMatrix = NULL, Ci = NULL, tol = 1e-04,   maxit = 100, MSE = FALSE, mse_type = "analytical", B = c(50, 0), seed = 123)</code></p>
</section>
<section id="data-and-preparation" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="data-and-preparation"><span class="header-section-number">3.2</span> Data and preparation</h2>
<section id="load-required-libraries" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="load-required-libraries"><span class="header-section-number">3.2.1</span> Load required libraries</h3>
<p>First of all, load the required R libraries. The code automatically installs the packages that are not yet installed and loads them. If you need further packages, please add them to the list of <code>p_load</code> which contains the packages required to the run the codes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">sum</span>(<span class="fu">installed.packages</span>()[,<span class="dv">1</span>] <span class="sc">%in%</span> <span class="st">"pacman"</span>) <span class="sc">!=</span> <span class="dv">1</span>){</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"pacman"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(sae, survey, spdep, emdi, data.table, MASS, caret, dplyr, sf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="load-the-dataset" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="load-the-dataset"><span class="header-section-number">3.2.2</span> Load the dataset</h3>
<p>Usually, SAE combines multiple data sources: a survey data set and a census or administrative/register dataset. For the estimation of area-level models, we need area-level aggregates of the same area-level (e.g.&nbsp;NUTS3) of both datasets. The target variable (typically household welfare/income for poverty mapping) is available in the survey but not in the census data.</p>
<p>In this example, we use a synthetic data set adapted from R package <code>sae</code> called <code>incomedata</code>. The original data contains information for <span class="math inline">\(n = 17,119\)</span> fictitious individuals residing across <span class="math inline">\(D = 52\)</span> Spanish provinces. The variables include the name of the province of residence (<code>provlab</code>), province code (<code>prov</code>), as well as several correlates of income.</p>
<p>For this tutorial, we use a random 10% sample of the <code>incomedata</code> to estimate the poverty rates. For the univariate case, we use the income variable from 2012.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>income_dt <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/incomedata_sample.RDS"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(income_dt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 1,716
Columns: 31
Groups: provlab [52]
$ provlab     &lt;fct&gt; Alava, Alava, Alava, Alava, Alava, Alava, Alava, Alava, Al…
$ prov        &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2…
$ ac          &lt;int&gt; 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 8, 8, 8, 8, 8, 8, …
$ gen         &lt;int&gt; 2, 1, 2, 1, 2, 2, 1, 2, 1, 1, 1, 2, 1, 2, 1, 1, 1, 1, 1, 2…
$ age         &lt;int&gt; 4, 4, 5, 3, 3, 2, 5, 4, 4, 0, 0, 3, 3, 1, 2, 0, 3, 3, 0, 2…
$ nat         &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
$ educ        &lt;int&gt; 3, 3, 1, 3, 3, 0, 1, 3, 0, 0, 0, 2, 1, 0, 0, 0, 0, 0, 0, 0…
$ labor       &lt;int&gt; 1, 1, 3, 1, 3, 0, 3, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0…
$ age2        &lt;int&gt; 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1…
$ age3        &lt;int&gt; 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 1, 1, 0, 0…
$ age4        &lt;int&gt; 1, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ age5        &lt;int&gt; 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ educ1       &lt;int&gt; 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0…
$ educ2       &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0…
$ educ3       &lt;int&gt; 1, 1, 0, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ nat1        &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
$ labor1      &lt;int&gt; 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0…
$ labor2      &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ labor3      &lt;int&gt; 0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ income2012  &lt;dbl&gt; 26125.271, 27404.099, 13117.838, 27920.737, 8705.592, 6340…
$ weight      &lt;dbl&gt; 7424.759, 23577.245, 41976.969, 19471.566, 12738.217, 2463…
$ income2013  &lt;dbl&gt; 27500.673, 28174.985, 13581.315, 28508.978, 9182.841, 6272…
$ income2014  &lt;dbl&gt; 34739.7326, 32137.8461, 15980.5806, 31512.1529, 11699.9025…
$ povline2012 &lt;dbl&gt; 6477.484, 6477.484, 6477.484, 6477.484, 6477.484, 6477.484…
$ povline2013 &lt;dbl&gt; 6515.865, 6515.865, 6515.865, 6515.865, 6515.865, 6515.865…
$ povline2014 &lt;dbl&gt; 6515.865, 6515.865, 6515.865, 6515.865, 6515.865, 6515.865…
$ abs         &lt;dbl&gt; 0.8493392, 0.8493392, 0.8493392, 0.8493392, 0.8493392, 0.8…
$ ntl         &lt;dbl&gt; 0.2091905, 0.2091905, 0.2091905, 0.2091905, 0.2091905, 0.2…
$ aec         &lt;dbl&gt; 1.1651876, 1.1651876, 1.1651876, 1.1651876, 1.1651876, 1.1…
$ schyrs      &lt;dbl&gt; 1.7099321, 1.7099321, 1.7099321, 1.7099321, 1.7099321, 1.7…
$ mkt         &lt;dbl&gt; 2.578254, 2.578254, 2.578254, 2.578254, 2.578254, 2.578254…</code></pre>
</div>
</div>
</section>
<section id="direct-estimation" class="level3" data-number="3.2.3">
<h3 data-number="3.2.3" class="anchored" data-anchor-id="direct-estimation"><span class="header-section-number">3.2.3</span> Direct estimation</h3>
<p>We will use the direct Horvitz-Thompons estimators that use the survey weights in <code>weight</code> variable. We calculate the sample sizes for each provinces and compute the direct estimates and their variances. We use the <code>direct</code> function of the <code>emdi</code> package here. Other options are e.g.&nbsp;the <code>direct</code> function of package <code>sae</code> <span class="citation" data-cites="molinamarhuenda2015">(<a href="references.html#ref-molinamarhuenda2015" role="doc-biblioref">Molina and Marhuenda 2015</a>)</span> or the <code>svyby</code> command of package <code>survey</code> <span class="citation" data-cites="Lumley2024">(<a href="references.html#ref-Lumley2024" role="doc-biblioref">Lumley 2024</a>)</span>. Then, we create a dataframe containing the direct estimate, the standard errors, the variances, the coefficient of variation and the design effects, that are needed for the arcsin transformation. The design effect is the ratio of the variance considering the sampling design to the variance estimated under simple random sampling. For detailled information about the arcsin transformation please refer to <span class="citation" data-cites="Casas2016">Casas-Cordero, Encina, and Lahiri (<a href="references.html#ref-Casas2016" role="doc-biblioref">2016</a>)</span> and <span class="citation" data-cites="Schmid2017">Schmid et al. (<a href="references.html#ref-Schmid2017" role="doc-biblioref">2017</a>)</span>. In some areas with a very small sample size, it may occur, that the individual data only consists of zeros and ones, resulting in a direct estimate of zero or one and a direct variance of zero. We set those areas to out-of-sample and for the final estimation results only the synthetic part of the FH model is used.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="do">## calculate sample size for each province</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>sampsize_dt <span class="ot">&lt;-</span> </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>income_dt <span class="sc">|&gt;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(provlab) <span class="sc">|&gt;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">N =</span> <span class="fu">n</span>())</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="do">## computation of direct estimates and their variances</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>direct_dt <span class="ot">&lt;-</span> emdi<span class="sc">::</span><span class="fu">direct</span>(<span class="at">y =</span> <span class="st">"income2012"</span>,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>                       <span class="at">smp_data =</span> income_dt <span class="sc">|&gt;</span> <span class="fu">as.data.table</span>(),</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>                       <span class="at">smp_domains =</span> <span class="st">"provlab"</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>                       <span class="at">weights =</span> <span class="st">"weight"</span>,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>                       <span class="at">threshold =</span> <span class="fu">unique</span>(income_dt<span class="sc">$</span>povline2012),</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>                       <span class="at">var =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="do">## create dataframe</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>direct_dt <span class="ot">&lt;-</span> </span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>       direct_dt<span class="sc">$</span>ind <span class="sc">|&gt;</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>       dplyr<span class="sc">::</span><span class="fu">select</span>(Domain, Head_Count) <span class="sc">|&gt;</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>       <span class="fu">rename</span>(<span class="at">Direct =</span> <span class="st">"Head_Count"</span>) <span class="sc">|&gt;</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>       <span class="fu">merge</span>(direct_dt<span class="sc">$</span>MSE <span class="sc">|&gt;</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>               dplyr<span class="sc">::</span><span class="fu">select</span>(Domain, Head_Count) <span class="sc">|&gt;</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>               <span class="fu">rename</span>(<span class="at">vardir =</span> <span class="st">"Head_Count"</span>),</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>             <span class="at">by =</span> <span class="st">"Domain"</span>) <span class="sc">|&gt;</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>       <span class="fu">mutate</span>(<span class="at">SD =</span> <span class="fu">sqrt</span>(vardir)) <span class="sc">|&gt;</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>       <span class="fu">mutate</span>(<span class="at">CV =</span> SD <span class="sc">/</span> Direct) <span class="sc">|&gt;</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>       <span class="fu">merge</span>(sampsize_dt <span class="sc">|&gt;</span> </span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>               <span class="fu">mutate</span>(<span class="at">provlab =</span> <span class="fu">as.factor</span>(provlab)), </span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>             <span class="at">by.x =</span> <span class="st">"Domain"</span>, </span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>             <span class="at">by.y =</span> <span class="st">"provlab"</span>) <span class="sc">|&gt;</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">var_SRS =</span> Direct <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> Direct) <span class="sc">/</span> N) <span class="sc">|&gt;</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">deff =</span> vardir <span class="sc">/</span> var_SRS) <span class="sc">|&gt;</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">n_eff =</span> N<span class="sc">/</span>deff)</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a><span class="do">## set zero variance to OOS</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>direct_dt <span class="ot">&lt;-</span> direct_dt[<span class="fu">complete.cases</span>(direct_dt), ]</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a><span class="do">## have a look at sample sizes</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(direct_dt<span class="sc">$</span>N)    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   6.00   14.00   25.00   34.61   49.00  142.00 </code></pre>
</div>
</div>
</section>
<section id="variance-smoothing" class="level3" data-number="3.2.4">
<h3 data-number="3.2.4" class="anchored" data-anchor-id="variance-smoothing"><span class="header-section-number">3.2.4</span> Variance smoothing</h3>
<p>A quick inspection of the preceding results will show some provinces contain low sample sizes which sometimes result in extreme value poverty rates and hence 0 variance. To avoid this, we will show you how to apply the variance smoothing method suggested by <span class="citation" data-cites="you2023application">You and Hidiroglou (<a href="references.html#ref-you2023application" role="doc-biblioref">2023</a>)</span>. Please see the code and Roxygen comments below explaining the use of the <code>varsmoothie_king()</code> function which computes smoothed variances. In case, the arcsin transformation will be applied, the variance smoothing described here is not necessary, since the arcsin transformation works variance stabilizing itself. When applying the arcsin transformation, the direct variances are automatically set to 1/(4*effective sampling size) when using the <code>fh</code> function of package <code>emdi</code>. The effective sample size equals the sample size of each area divided by the design effect. If the variance stabilizing effect is not enough, the design effect of a higher area level could also be used here (in this example the regions <code>ac</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' A function to perform variance smoothing</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' The variance smoothing function applies the methodology of You and Hiridoglou (2023)</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' which uses simply log linear regression to estimate direct variances for sample </span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' poverty rates which is useful for replacing poverty rates in areas with low sampling.</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param domain a vector of unique domain/target areas</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param direct_var the raw variances estimated from sample data</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param sampsize the sample size for each domain</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>varsmoothie_king <span class="ot">&lt;-</span> <span class="cf">function</span>(domain,</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>                             direct_var,</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>                             sampsize){</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">Domain =</span> domain,</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>                   <span class="at">var =</span> direct_var,</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>                   <span class="at">n =</span> sampsize)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  dt<span class="sc">$</span>log_n <span class="ot">&lt;-</span> <span class="fu">log</span>(dt<span class="sc">$</span>n)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  dt<span class="sc">$</span>log_var <span class="ot">&lt;-</span> <span class="fu">log</span>(dt<span class="sc">$</span>var)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>  lm_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="at">formula =</span> log_var <span class="sc">~</span> log_n,</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> dt[<span class="sc">!</span>(<span class="fu">abs</span>(dt<span class="sc">$</span>log_var) <span class="sc">==</span> <span class="cn">Inf</span>),])</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>  dt<span class="sc">$</span>pred_var <span class="ot">&lt;-</span> <span class="fu">predict</span>(lm_model, <span class="at">newdata =</span> dt)</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>  residual_var <span class="ot">&lt;-</span>  <span class="fu">summary</span>(lm_model)<span class="sc">$</span>sigma<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>  dt<span class="sc">$</span>var_smooth <span class="ot">&lt;-</span> <span class="fu">exp</span>(dt<span class="sc">$</span>pred_var) <span class="sc">*</span> <span class="fu">exp</span>(residual_var<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(dt[, <span class="fu">c</span>(<span class="st">"Domain"</span>, <span class="st">"var_smooth"</span>), <span class="at">with =</span> F])</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Ok, the goal now is to use the above <code>varsmoothie_king()</code> function to add an additional column of smoothed variances into our <code>direct_dt</code> dataframe.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>var_smooth <span class="ot">&lt;-</span> <span class="fu">varsmoothie_king</span>(<span class="at">domain =</span> direct_dt<span class="sc">$</span>Domain,</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">direct_var =</span> direct_dt<span class="sc">$</span>vardir,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">sampsize =</span> direct_dt<span class="sc">$</span>N)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>direct_dt <span class="ot">&lt;-</span> var_smooth <span class="sc">|&gt;</span> <span class="fu">merge</span>(direct_dt, <span class="at">by =</span> <span class="st">"Domain"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="auxiliary-variable-preparation" class="level3" data-number="3.2.5">
<h3 data-number="3.2.5" class="anchored" data-anchor-id="auxiliary-variable-preparation"><span class="header-section-number">3.2.5</span> Auxiliary variable preparation</h3>
<p>The FH model is a model of poverty rates at the target area level, hence the data format required for this exercise has the province as its unit of observation. This format has a few essential columns:</p>
<ul>
<li><p>Variable for poverty rates</p></li>
<li><p>The set of candidate variables from which the most predicted of poverty rates will be selected</p></li>
<li><p>The target area variable identifier (i.e.&nbsp;in this case the province variable <code>prov</code> and <code>provlab</code>)</p></li>
</ul>
<p>We prepare this dataset as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="do">## create the candidate variables</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>candidate_vars <span class="ot">&lt;-</span> <span class="fu">colnames</span>(income_dt)[<span class="sc">!</span><span class="fu">colnames</span>(income_dt) <span class="sc">%in%</span> </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                                         <span class="fu">c</span>(<span class="st">"provlab"</span>, <span class="st">"prov"</span>, </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">"income2012"</span>, <span class="st">"income2013"</span>, <span class="st">"income2014"</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">"povline2012"</span>, <span class="st">"povline2013"</span>, <span class="st">"povline2014"</span>,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">"ac"</span>, <span class="st">"nat"</span>, <span class="st">"educ"</span>, <span class="st">"labor"</span>,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">"age"</span>)]</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="do">## change dummy of gen to 0 and 1</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>income_dt <span class="ot">&lt;-</span> </span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  income_dt <span class="sc">|&gt;</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(gen), <span class="sc">~</span> <span class="fu">case_when</span>(</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    .x <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    .x <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_real_</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  )))</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="do">## aggregating the unit-level data to the province level</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>prov_dt <span class="ot">&lt;-</span> </span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>income_dt <span class="sc">|&gt;</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(provlab) <span class="sc">|&gt;</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">any_of</span>(candidate_vars),</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span> <span class="fu">weighted.mean</span>(<span class="at">x =</span> ., <span class="at">w =</span> weight, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">.names =</span> <span class="st">"{.col}"</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a><span class="do">### combine the the dataframe containing the direct estimates and their variances with the province level data</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>comb_Data <span class="ot">&lt;-</span> <span class="fu">merge</span>(direct_dt, prov_dt,</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">by.x =</span> <span class="st">"Domain"</span>, <span class="at">by.y =</span> <span class="st">"provlab"</span>,</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">all =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="model-selection" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="model-selection"><span class="header-section-number">3.3</span> Model selection</h2>
<section id="model-preparation" class="level3" data-number="3.3.1">
<h3 data-number="3.3.1" class="anchored" data-anchor-id="model-preparation"><span class="header-section-number">3.3.1</span> Model preparation</h3>
<p>FH does not run if there is any missing value in the auxiliary variables, and therefore, any variable with missing value should be removed in advance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>rowsNAcovariates <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">sapply</span>(comb_Data[,..candidate_vars], is.na))</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>comb_Data <span class="ot">&lt;-</span> comb_Data[rowsNAcovariates <span class="sc">==</span> <span class="dv">0</span>, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="check-multicollinearity" class="level3" data-number="3.3.2">
<h3 data-number="3.3.2" class="anchored" data-anchor-id="check-multicollinearity"><span class="header-section-number">3.3.2</span> Check multicollinearity</h3>
<p>With the help of the <code>step()</code> function of package <code>emdi</code>, we perform a variable selection based on the chosen variable selection criterion and directly get the model with fewer variables. The function <code>step_wrapper()</code> implemented below is a wrapper to the <code>emdi::step()</code> function and performs all the perfunctory cleaning necessary to use <code>step()</code>. This includes dropping columns that are entirely missing (<code>NA</code>) and keep only complete cases/observations (for the model selection only the in-sample domains are used) and remove perfectly or near collinear variables and combinations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' A function to perform stepwise variable selection based on selection criteria</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param dt data.frame, dataset containing the set of outcome and independent variables</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param xvars character vector, the set of x variables</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param y character, the name of the y variable</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param cor_thresh double, a correlation threshold between 0 and 1</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param criteria character, criteria that can be chosen are "AIC", "AICc", "AICb1", "AICb2", "BIC", "KIC", "KICc", "KICb1", or "KICb2". Defaults to "AIC". If transformation is set to "arcsin", only "AIC" and "BIC" can be chosen.</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param vardir character, name of the variable containing the domain-specific sampling variances of the direct estimates that are included in dt</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param transformation character, either "no" (default) or "arcsin".</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param eff_smpsize character, name of the variable containing the effective sample sizes that are included in dt. Required argument when the arcsin transformation is chosen. Defaults to NULL.</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' @import data.table</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co">#' @import caret</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom emdi step fh</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>step_wrapper <span class="ot">&lt;-</span> <span class="cf">function</span>(dt, xvars, y, <span class="at">cor_thresh =</span> <span class="fl">0.95</span>, <span class="at">criteria =</span> <span class="st">"AIC"</span>,</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>                         vardir, <span class="at">transformation =</span> <span class="st">"no"</span>, eff_smpsize) {</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(dt)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Drop columns that are entirely NA</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> dt[, <span class="fu">which</span>(<span class="fu">unlist</span>(<span class="fu">lapply</span>(dt, <span class="cf">function</span>(x) <span class="sc">!</span><span class="fu">all</span>(<span class="fu">is.na</span>(x))))), with <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>  xvars <span class="ot">&lt;-</span> xvars[xvars <span class="sc">%in%</span> <span class="fu">colnames</span>(dt)]</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Keep only complete cases</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> dt[<span class="fu">complete.cases</span>(dt),] </span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 1: Remove aliased (perfectly collinear) variables</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>  model_formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(y, <span class="st">"~"</span>, <span class="fu">paste</span>(xvars, <span class="at">collapse =</span> <span class="st">" + "</span>)))</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>  lm_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(model_formula, <span class="at">data =</span> dt)</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>  aliased <span class="ot">&lt;-</span> <span class="fu">is.na</span>(<span class="fu">coef</span>(lm_model))</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(aliased)) {</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    xvars <span class="ot">&lt;-</span> <span class="fu">names</span>(aliased)[<span class="sc">!</span>aliased <span class="sc">&amp;</span> <span class="fu">names</span>(aliased) <span class="sc">!=</span> <span class="st">"(Intercept)"</span>]</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 2: Remove near-linear combinations</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>  xmat <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(dt[, ..xvars])</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>  combo_check <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">findLinearCombos</span>(xmat), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(combo_check) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(combo_check<span class="sc">$</span>remove) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>    xvars <span class="ot">&lt;-</span> xvars[<span class="sc">-</span>combo_check<span class="sc">$</span>remove]</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>    xmat <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(dt[, ..xvars])</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 3: Drop highly correlated variables</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>  cor_mat <span class="ot">&lt;-</span> <span class="fu">abs</span>(<span class="fu">cor</span>(xmat))</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">diag</span>(cor_mat) <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> (<span class="fu">any</span>(cor_mat <span class="sc">&gt;</span> cor_thresh, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>    cor_pairs <span class="ot">&lt;-</span> <span class="fu">which</span>(cor_mat <span class="sc">==</span> <span class="fu">max</span>(cor_mat, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">arr.ind =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>, ]</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>    var1 <span class="ot">&lt;-</span> <span class="fu">colnames</span>(cor_mat)[cor_pairs[<span class="dv">1</span>]]</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>    var2 <span class="ot">&lt;-</span> <span class="fu">colnames</span>(cor_mat)[cor_pairs[<span class="dv">2</span>]]</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drop the variable with higher mean correlation</span></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>    drop_var <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">mean</span>(cor_mat[var1, ]) <span class="sc">&gt;</span> <span class="fu">mean</span>(cor_mat[var2, ])) var1 <span class="cf">else</span> var2</span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>    xvars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(xvars, drop_var)</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>    xmat <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(dt[, ..xvars])</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>    cor_mat <span class="ot">&lt;-</span> <span class="fu">abs</span>(<span class="fu">cor</span>(xmat))</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">diag</span>(cor_mat) <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 4: Warn if still ill-conditioned</span></span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>  cond_number <span class="ot">&lt;-</span> <span class="fu">kappa</span>(xmat, <span class="at">exact =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (cond_number <span class="sc">&gt;</span> <span class="fl">1e10</span>) {</span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">"Design matrix is ill-conditioned (condition number &gt; 1e10). Consider reviewing variable selection."</span>)</span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Final model fit</span></span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>  model_formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(y, <span class="st">"~"</span>, <span class="fu">paste</span>(xvars, <span class="at">collapse =</span> <span class="st">" + "</span>)))</span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Stepwise selection</span></span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>  fh_args <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">fixed =</span> model_formula,</span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">vardir =</span> vardir,</span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">combined_data =</span> dt,</span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"ml"</span>,</span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">MSE =</span> <span class="cn">FALSE</span></span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (transformation <span class="sc">==</span> <span class="st">"arcsin"</span>) {</span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>    fh_args<span class="sc">$</span>transformation <span class="ot">&lt;-</span> <span class="st">"arcsin"</span></span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>    fh_args<span class="sc">$</span>backtransformation <span class="ot">&lt;-</span> <span class="st">"bc"</span></span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>    fh_args<span class="sc">$</span>eff_smpsize <span class="ot">&lt;-</span> eff_smpsize</span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a>    fh_args<span class="sc">$</span>transformation <span class="ot">&lt;-</span> <span class="st">"no"</span></span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a>    fh_args<span class="sc">$</span>B <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">50</span>)</span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a>  fh_model <span class="ot">&lt;-</span> <span class="fu">do.call</span>(emdi<span class="sc">::</span>fh, fh_args)</span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a>  stepwise_model <span class="ot">&lt;-</span> emdi<span class="sc">::</span><span class="fu">step</span>(fh_model, <span class="at">criteria =</span> criteria)</span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(stepwise_model)</span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We apply the function to select the variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>fh_step <span class="ot">&lt;-</span> <span class="fu">step_wrapper</span>(<span class="at">dt =</span> comb_Data, </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">xvars =</span> candidate_vars,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">y =</span> <span class="st">"Direct"</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">cor_thresh =</span> <span class="fl">0.8</span>,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">criteria =</span> <span class="st">"AIC"</span>,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">vardir =</span> <span class="st">"vardir"</span>, </span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">transformation =</span> <span class="st">"arcsin"</span>, </span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>                        <span class="at">eff_smpsize =</span> <span class="st">"n_eff"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         df     AIC
- gen     1 -63.164
- mkt     1 -63.163
- labor1  1 -63.059
- nat1    1 -62.934
- labor2  1 -62.613
- weight  1 -62.543
- aec     1 -61.789
- educ2   1 -61.408
- abs     1 -61.311
&lt;none&gt;      -61.165
- educ3   1 -59.668
- age2    1 -59.182
- ntl     1 -58.846
- educ1   1 -58.643
- age4    1 -58.363
- age3    1 -58.149
- age5    1 -57.609
- schyrs  1 -49.426</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>         df     AIC
- mkt     1 -65.162
- labor1  1 -65.016
- nat1    1 -64.893
- labor2  1 -64.599
- weight  1 -64.389
- aec     1 -63.782
- abs     1 -63.293
- educ2   1 -63.211
&lt;none&gt;      -63.164
- educ3   1 -61.628
- age2    1 -61.174
- ntl     1 -60.377
- age4    1 -60.327
- educ1   1 -60.282
- age3    1 -60.114
- age5    1 -59.585
- schyrs  1 -49.299</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>         df     AIC
- labor1  1 -66.996
- nat1    1 -66.892
- labor2  1 -66.572
- weight  1 -66.299
- aec     1 -65.757
- abs     1 -65.265
- educ2   1 -65.205
&lt;none&gt;      -65.162
- educ3   1 -63.586
- age2    1 -63.156
- ntl     1 -62.339
- age4    1 -62.282
- educ1   1 -62.281
- age3    1 -62.103
- age5    1 -61.529
- schyrs  1 -44.722</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>         df     AIC
- nat1    1 -68.744
- weight  1 -68.194
- labor2  1 -68.091
- aec     1 -67.444
- educ2   1 -67.204
- abs     1 -67.056
&lt;none&gt;      -66.996
- educ3   1 -65.559
- ntl     1 -64.281
- educ1   1 -64.280
- age2    1 -64.146
- age5    1 -63.528
- age4    1 -63.153
- age3    1 -62.968
- schyrs  1 -44.445</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>         df     AIC
- labor2  1 -69.873
- weight  1 -69.862
- aec     1 -69.064
- educ2   1 -68.990
- abs     1 -68.835
&lt;none&gt;      -68.744
- educ3   1 -67.146
- educ1   1 -66.088
- age2    1 -66.018
- ntl     1 -65.874
- age5    1 -65.351
- age4    1 -65.001
- age3    1 -64.922
- schyrs  1 -45.918</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>         df     AIC
- weight  1 -70.966
- aec     1 -70.254
- educ2   1 -70.002
&lt;none&gt;      -69.873
- abs     1 -69.619
- educ3   1 -68.510
- age2    1 -67.269
- ntl     1 -67.101
- educ1   1 -66.763
- age5    1 -66.706
- age3    1 -65.948
- age4    1 -65.936
- schyrs  1 -45.910</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>         df     AIC
- aec     1 -71.617
- educ2   1 -71.408
&lt;none&gt;      -70.966
- abs     1 -70.484
- educ3   1 -69.733
- age2    1 -68.714
- ntl     1 -68.470
- educ1   1 -68.334
- age5    1 -67.634
- age3    1 -67.530
- age4    1 -67.073
- schyrs  1 -46.344</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>         df     AIC
- educ2   1 -72.299
&lt;none&gt;      -71.617
- abs     1 -71.486
- educ3   1 -70.772
- age2    1 -69.871
- educ1   1 -69.716
- ntl     1 -68.932
- age5    1 -68.705
- age4    1 -68.546
- age3    1 -68.297
- schyrs  1 -46.078</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>         df     AIC
- educ3   1 -72.474
&lt;none&gt;      -72.299
- abs     1 -72.265
- age2    1 -71.479
- age5    1 -69.915
- educ1   1 -69.674
- ntl     1 -69.367
- age4    1 -69.075
- age3    1 -67.544
- schyrs  1 -45.239</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>         df     AIC
- abs     1 -73.093
&lt;none&gt;      -72.474
- age2    1 -71.628
- age5    1 -71.235
- educ1   1 -71.185
- age4    1 -70.720
- ntl     1 -70.406
- age3    1 -69.189
- schyrs  1 -45.949</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>         df     AIC
&lt;none&gt;      -73.093
- age5    1 -72.249
- educ1   1 -72.137
- age2    1 -71.922
- ntl     1 -71.327
- age4    1 -71.134
- age3    1 -70.271
- schyrs  1 -47.230</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fh_step<span class="sc">$</span>fixed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Direct ~ age2 + age3 + age4 + age5 + educ1 + ntl + schyrs
&lt;environment: 0x000002e70931b6c8&gt;</code></pre>
</div>
</div>
</section>
</section>
<section id="model-estimation-of-fh-point-and-their-mse-estimates." class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="model-estimation-of-fh-point-and-their-mse-estimates."><span class="header-section-number">3.4</span> Model estimation of FH point and their MSE estimates.</h2>
<p>In this example, we use the function <code>fh</code> to calculate the FH estimates. Because we want to estimate a ratio, we need to apply the arcsin transformation to guarantee that the results lie between 0 and 1. For that, we choose “arcsin” as <code>transformation</code>, and a bias-corrected <code>backtransformation</code> (“bc”). Additionally, the effective sample size, which equals the sample size of each area divided by the design effect, is needed for the arcsin transformation. We set the <code>MSE</code> estimation to <code>TRUE</code>, the <code>mse_type</code> to “boot” (necessary for the type of transformation) and determine the number of bootstrap iterations. For practical applications, values larger than 200 are recommended. In case, no transformation is desired, the <code>transformation</code> argument must be set to “no” and the inputs <code>backtransformation</code> and <code>eff_smpsize</code> are no longer needed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>fh_model <span class="ot">&lt;-</span> <span class="fu">fh</span>(<span class="at">fixed =</span> <span class="fu">formula</span>(fh_step<span class="sc">$</span>fixed),</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">vardir =</span> <span class="st">"vardir"</span>, </span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">combined_data =</span> comb_Data, </span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">domains =</span> <span class="st">"Domain"</span>,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">method =</span> <span class="st">"ml"</span>, </span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">transformation =</span> <span class="st">"arcsin"</span>, </span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">backtransformation =</span> <span class="st">"bc"</span>,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">eff_smpsize =</span> <span class="st">"n_eff"</span>, </span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">MSE =</span> <span class="cn">TRUE</span>, </span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">mse_type =</span> <span class="st">"boot"</span>, <span class="at">B =</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">0</span>)) </span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="do">## In case, no transformation is desired, the call would like this:</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="co"># fh_model &lt;- fh(</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="co">#   fixed = Direct ~ age2 + age3 + age4 + age5 + educ1 + ntl + schyrs, #formula(fh_step$fixed),</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="co">#   vardir = "vardir", combined_data = comb_Data, domains = "Domain",</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="co">#   method = "ml", MSE = TRUE) </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="assessment-of-the-estimated-model." class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="assessment-of-the-estimated-model."><span class="header-section-number">3.5</span> Assessment of the estimated model.</h2>
<p>With the help of the <code>summary</code> method of <code>emdi</code>, we gain detailed insights into the data and model components. It includes information on the estimation methods used, the number of domains, the log-likelihood, and information criteria as proposed by <span class="citation" data-cites="Marhuenda2014">Marhuenda, Morales, and Camen Pardo (<a href="references.html#ref-Marhuenda2014" role="doc-biblioref">2014</a>)</span>. It also reports the adjusted <span class="math inline">\(R^2\)</span> from a standard linear model and the adjusted <span class="math inline">\(R^2\)</span> specific to FH models, as introduced by <span class="citation" data-cites="Lahiri2015">Lahiri and Suntornchost (<a href="references.html#ref-Lahiri2015" role="doc-biblioref">2015</a>)</span>. It also offers diagnostic measures to assess model assumptions regarding the standardized realized residuals and random effects. These include skewness and kurtosis (based on the <code>moments</code> package by <span class="citation" data-cites="Komsta2015">Komsta and Novomestky (<a href="references.html#ref-Komsta2015" role="doc-biblioref">2015</a>)</span>), as well as Shapiro-Wilk test statistics and corresponding p-values to evaluate the normality of both error components.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fh_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
 fh(fixed = formula(fh_step$fixed), vardir = "vardir", combined_data = comb_Data, 
    domains = "Domain", method = "ml", transformation = "arcsin", 
    backtransformation = "bc", eff_smpsize = "n_eff", MSE = TRUE, 
    mse_type = "boot", B = c(50, 0))

Out-of-sample domains:  3 
In-sample domains:  49 

Variance and MSE estimation:
Variance estimation method:  ml 
Estimated variance component(s):  7.643268e-05 
MSE method:  bootstrap 

Coefficients:
            coefficients std.error t.value   p.value    
(Intercept)     0.803839  0.161793  4.9683 6.753e-07 ***
age2           -0.596737  0.335123 -1.7807   0.07497 .  
age3           -0.492147  0.224118 -2.1959   0.02810 *  
age4           -0.501614  0.252090 -1.9898   0.04661 *  
age5           -0.436006  0.258521 -1.6865   0.09169 .  
educ1           0.251093  0.146038  1.7194   0.08555 .  
ntl            -0.032500  0.016747 -1.9406   0.05230 .  
schyrs          0.093883  0.016794  5.5904 2.265e-08 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Explanatory measures:
   loglike       AIC       BIC     AdjR2     FH_R2
1 45.54653 -73.09307 -56.06668 0.4342252 0.7365157

Residual diagnostics:
                         Skewness Kurtosis Shapiro_W Shapiro_p
Standardized_Residuals  0.1976387 2.604752 0.9829282 0.6919975
Random_effects         -0.3420849 3.629614 0.9694044 0.2292763

Transformation:
 Transformation Back_transformation
         arcsin                  bc</code></pre>
</div>
</div>
<p>We can see, that 49 domains are in-sample domains. The 3 out-of-sample domains belong to the domains with 0 direct and variance estimates that we set to <code>NA</code> in the beginning. The variance of the random effects equals 7.643268e-05. All of the included auxiliary variables are significant on a 0.05 significance level and their explanatory power is large with an adjusted <span class="math inline">\(R^2\)</span> (for FH models) of around 0.74. The results of the Shapiro-Wilk-test indicate that normality is not rejected for both errors.</p>
<section id="diagnostic-plots" class="level3" data-number="3.5.1">
<h3 data-number="3.5.1" class="anchored" data-anchor-id="diagnostic-plots"><span class="header-section-number">3.5.1</span> Diagnostic plots</h3>
<p>We produce normal quantile-quantile (Q-Q) plots of the standardized realized residuals and random effects and plots of the kernel densities of the distribution of both error terms by the <code>plot</code> method of <code>emdi</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fh_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="fh_files/figure-html/plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Press [enter] to continue</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="fh_files/figure-html/plot-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Press [enter] to continue</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="fh_files/figure-html/plot-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The plots show slight deviations of the distributions from normality, but together with the results of the Shapiro-Wilk-test, we do not reject the normality assumption.</p>
</section>
</section>
<section id="comparison-of-the-fh-results-with-the-direct-estimates." class="level2" data-number="3.6">
<h2 data-number="3.6" class="anchored" data-anchor-id="comparison-of-the-fh-results-with-the-direct-estimates."><span class="header-section-number">3.6</span> Comparison of the FH results with the direct estimates.</h2>
<p>The FH estimates are expected to align closely with the direct estimates in domains with small direct MSEs and/or large sample sizes. Moreover, incorporating auxiliary information should enhance the precision of the direct estimates. We produce a scatter plot proposed by <span class="citation" data-cites="Brown2001">Brown et al. (<a href="references.html#ref-Brown2001" role="doc-biblioref">2001</a>)</span> and a line plot. The fitted regression and the identity line of the scatter plot should not differ too much. The FH estimates should track the direct estimates within the line plot especially for domains with a large sample size/small MSE of the direct estimator. Furthermore, we compare the MSE and CV estimates for the direct and FH estimators using boxplots and ordered scatter plots (by setting the input arguments <code>MSE</code> and <code>CV</code> to <code>TRUE</code>).</p>
<p>Additionally, we compute a correlation coefficient of the direct estimates and the estimates of the regression-synthetic part of the FH model <span class="citation" data-cites="Chandra2015">(<a href="references.html#ref-Chandra2015" role="doc-biblioref">Chandra, Salvati, and Chambers 2015</a>)</span> and a goodness of fit diagnostic <span class="citation" data-cites="Brown2001">(<a href="references.html#ref-Brown2001" role="doc-biblioref">Brown et al. 2001</a>)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">compare_plot</span>(fh_model, <span class="at">MSE =</span> <span class="cn">TRUE</span>, <span class="at">CV =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="fh_files/figure-html/compare-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Press [enter] to continue</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="fh_files/figure-html/compare-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Press [enter] to continue</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="fh_files/figure-html/compare-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Press [enter] to continue</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="fh_files/figure-html/compare-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Press [enter] to continue</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="fh_files/figure-html/compare-5.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Press [enter] to continue</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="fh_files/figure-html/compare-6.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">compare</span>(fh_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Brown test 

Null hypothesis: EBLUP estimates do not differ significantly from the
      direct estimates 

  W.value Df   p.value
 31.14936 49 0.9780679

Correlation between synthetic part and direct estimator:  0.68 </code></pre>
</div>
</div>
<p>The direct estimates are tracked by most of the FH estimates within the line plot. The precision of the direct estimates could be improved by the usage of the FH model in terms of MSEs and CVs. The null hypothesis of the Brown test is not rejected and the correlation coefficient indicates a positive correlation (0.68) between the direct and FH estimates.</p>
<p>If the result of the model assessment is not satisfactory, the following should be checked again: Can the direct estimation including variance estimation be improved? Are there further auxiliary variables and/or must possible interaction effects be taken into account? Does a (different) transformation need to be used?</p>
</section>
<section id="benchmark-the-fh-point-estimates-for-consistency-with-higher-results." class="level2" data-number="3.7">
<h2 data-number="3.7" class="anchored" data-anchor-id="benchmark-the-fh-point-estimates-for-consistency-with-higher-results."><span class="header-section-number">3.7</span> Benchmark the FH point estimates for consistency with higher results.</h2>
<p>Benchmarking is based on the principle that aggregated FH estimates should sum up to the estimates at a higher regional level. For the benchmark function, a benchmark value and a vector containing the shares of the population size per area (<span class="math inline">\(N_d/N\)</span>) is required. Please note, that only the FH estimates are benchmarked and not their MSE estimates. As benchmark types “raking”, “ratio” and “MSE_adj” can be chosen. For further details about using the function, please refer to the <code>emdi</code> vignette and for general information about the benchmarking options to <span class="citation" data-cites="Datta2011">Datta et al. (<a href="references.html#ref-Datta2011" role="doc-biblioref">2011</a>)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="do">## create the poverty indicator</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>income_dt <span class="ot">&lt;-</span> </span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  income_dt <span class="sc">|&gt;</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">poor2012 =</span> <span class="fu">ifelse</span>(income2012 <span class="sc">&lt;</span> povline2012, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="do">## compute the benchmark value (mean of poor2012 for the whole country of Spain)</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>benchmark_value <span class="ot">&lt;-</span> <span class="fu">weighted.mean</span>(income_dt<span class="sc">$</span>poor2012, income_dt<span class="sc">$</span>weight)</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="do">## compute the share of population size in the total population size (N_d/N) per area</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"sizeprov"</span>)</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>comb_Data <span class="ot">&lt;-</span> comb_Data <span class="sc">|&gt;</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(sizeprov <span class="sc">|&gt;</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ratio_n =</span> Nd<span class="sc">/</span><span class="fu">sum</span>(Nd)), <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Domain"</span> <span class="ot">=</span><span class="st">"provlab"</span>))</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>fh_bench <span class="ot">&lt;-</span> <span class="fu">benchmark</span>(fh_model,</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>                      <span class="at">benchmark =</span> benchmark_value,</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>                      <span class="at">share =</span> comb_Data<span class="sc">$</span>ratio_n, </span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>                      <span class="at">type =</span> <span class="st">"ratio"</span>,</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>                      <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(fh_bench<span class="sc">$</span>ind)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Domain     Direct        FH  FH_Bench Out
1    Alava 0.30885799 0.2930754 0.3055698   0
2 Albacete 0.05339445 0.1166571 0.1216305   0
3 Alicante 0.19412452 0.1629585 0.1699058   0
4  Almeria 0.42100526 0.1954816 0.2038155   0
5    Avila         NA 0.1156717 0.1206030   1
6  Badajoz 0.15381464 0.1664585 0.1735550   0</code></pre>
</div>
</div>
</section>
<section id="preparation-of-the-results." class="level2" data-number="3.8">
<h2 data-number="3.8" class="anchored" data-anchor-id="preparation-of-the-results."><span class="header-section-number">3.8</span> Preparation of the results.</h2>
<p>Create one dataframe that contains the direct and FH estimation results including MSE and CV results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span><span class="fu">as.data.frame</span>(<span class="fu">estimators</span>(fh_model, <span class="at">MSE =</span> <span class="cn">TRUE</span>, <span class="at">CV =</span> <span class="cn">TRUE</span>))</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Domain     Direct  Direct_MSE Direct_CV        FH       FH_MSE     FH_CV
1    Alava 0.30885799 0.025486256 0.5168853 0.2930754 0.0051610993 0.2451274
2 Albacete 0.05339445 0.003324107 1.0797952 0.1166571 0.0009149401 0.2592896
3 Alicante 0.19412452 0.003357358 0.2984822 0.1629585 0.0006634858 0.1580661
4  Almeria 0.42100526 0.015853486 0.2990714 0.1954816 0.0009920503 0.1611242
5    Avila         NA          NA        NA 0.1156717 0.0031406044 0.4844842
6  Badajoz 0.15381464 0.004314773 0.4270526 0.1664585 0.0005706955 0.1435147</code></pre>
</div>
</div>
<section id="poverty-map" class="level3" data-number="3.8.1">
<h3 data-number="3.8.1" class="anchored" data-anchor-id="poverty-map"><span class="header-section-number">3.8.1</span> Poverty map</h3>
<p>With the help of geographical maps, the results can be presented in a user-friendly way and differences among the areas can be detected more easily. For the map, a shape file is reqired. The domain identifiers in the results object (<code>fh_model</code>) need to match to the respective identifiers of the shape file. Therefore, we create a mapping table first and then produce the map by <code>emdi::map_plot</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="do">## load the shapefile dataframe and convert it to an object of type sf which is a necessary input for the map_plot function</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>spain_dt <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/shapes/spainshape.RDS"</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>spain_dt <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_as_sf</span>(spain_dt)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Create a suitable mapping table</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Find the right order</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>domain_ord <span class="ot">&lt;-</span> <span class="fu">match</span>(spain_dt<span class="sc">$</span>provlab, fh_model<span class="sc">$</span>ind<span class="sc">$</span>Domain)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Create the mapping table based on the order obtained above</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>map_tab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">pop_data_id =</span> fh_model<span class="sc">$</span>ind<span class="sc">$</span>Domain[domain_ord],</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>                      <span class="at">shape_id =</span> spain_dt<span class="sc">$</span>provlab)</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="do">## Create map</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="fu">map_plot</span>(<span class="at">object =</span> fh_model, <span class="at">MSE =</span> <span class="cn">TRUE</span>, <span class="at">map_obj =</span> spain_dt,</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a> <span class="at">map_dom_id =</span> <span class="st">"provlab"</span>, <span class="at">map_tab =</span> map_tab)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Press [enter] to continue</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Press [enter] to continue</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Press [enter] to continue</code></pre>
</div>
<div class="cell-output-display">
<div id="fig-povmap-1" class="quarto-float quarto-figure quarto-figure-center anchored" width="672">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-povmap-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fh_files/figure-html/fig-povmap-1.png" id="fig-povmap-1" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-povmap-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.1
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display">
<div id="fig-povmap-2" class="quarto-float quarto-figure quarto-figure-center anchored" width="672">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-povmap-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fh_files/figure-html/fig-povmap-2.png" id="fig-povmap-2" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-povmap-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.2
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display">
<div id="fig-povmap-3" class="quarto-float quarto-figure quarto-figure-center anchored" width="672">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-povmap-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fh_files/figure-html/fig-povmap-3.png" id="fig-povmap-3" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-povmap-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.3
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display">
<div id="fig-povmap-4" class="quarto-float quarto-figure quarto-figure-center anchored" width="672">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-povmap-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="fh_files/figure-html/fig-povmap-4.png" id="fig-povmap-4" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-povmap-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.4
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="saving-the-results." class="level2" data-number="3.9">
<h2 data-number="3.9" class="anchored" data-anchor-id="saving-the-results."><span class="header-section-number">3.9</span> Saving the results.</h2>
<section id="save-workspace." class="level3" data-number="3.9.1">
<h3 data-number="3.9.1" class="anchored" data-anchor-id="save-workspace."><span class="header-section-number">3.9.1</span> Save workspace.</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">save.image</span>(<span class="st">"fh_estimation.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="export-the-model-output-and-estimation-results." class="level3" data-number="3.9.2">
<h3 data-number="3.9.2" class="anchored" data-anchor-id="export-the-model-output-and-estimation-results."><span class="header-section-number">3.9.2</span> Export the model output and estimation results.</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write.excel</span>(fh_model,</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fh_model_output.xlsx"</span>,</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">MSE =</span> <span class="cn">TRUE</span>, <span class="at">CV =</span> <span class="cn">TRUE</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-Brown2001" class="csl-entry" role="listitem">
Brown, G., R. Chambers, P. Heady, and D. Heasman. 2001. <span>“Evaluation of Small Area Estimation Methods - an Application to Unemployment Estimates from the <span>UK</span> <span>LFS</span>.”</span> In <em>Proceedings of Statistics Canada Symposium</em>.
</div>
<div id="ref-Casas2016" class="csl-entry" role="listitem">
Casas-Cordero, C., J. Encina, and P. Lahiri. 2016. <span>“Poverty Mapping for the Chilean Comunas.”</span> In <em>Analysis of Poverty by Small Area Estimation</em>, by M. Pratesi, 379–403. John Wiley &amp; Sons. <a href="https://doi.org/10.1002/9781118814963.ch20">https://doi.org/10.1002/9781118814963.ch20</a>.
</div>
<div id="ref-Chandra2015" class="csl-entry" role="listitem">
Chandra, H., N. Salvati, and R. Chambers. 2015. <span>“A Spatially Nonstationary <span>Fay-Herriot</span> Model for Small Area Estimation.”</span> <em>Journal of the Survey Statistics and Methodology</em> 3 (2): 109–35. <a href="https://doi.org/10.1093/jssam/smu026">https://doi.org/10.1093/jssam/smu026</a>.
</div>
<div id="ref-Datta2011" class="csl-entry" role="listitem">
Datta, G. S., M. Ghosh, R. Steorts, and J. Maples. 2011. <span>“Bayesian Benchmarking with Applications to Small Area Estimation.”</span> <em>TEST</em> 20 (3): 574–88. <a href="https://doi.org/10.1007/s11749-010-0218-y">https://doi.org/10.1007/s11749-010-0218-y</a>.
</div>
<div id="ref-Fay1979" class="csl-entry" role="listitem">
Fay, Robert E., and Roger A. Herriot. 1979. <span>“Estimates of Income for Small Places: An Application of <span>J</span>ames-<span>S</span>tein Procedures to Census Data.”</span> <em>Journal of the American Statistical Association</em> 74: 269–77.
</div>
<div id="ref-Harmening2023" class="csl-entry" role="listitem">
Harmening, Sylvia, Ann-Kristin Kreutzmann, Sören Schmidt, Nicola Salvati, and Timo Schmid. 2023. <span>“A Framework for Producing Small Area Estimates Based on Area-Level Models in r.”</span> <em>The R Journal</em> 15 (1): 316–41. <a href="https://doi.org/10.32614/RJ-2023-039">https://doi.org/10.32614/RJ-2023-039</a>.
</div>
<div id="ref-Komsta2015" class="csl-entry" role="listitem">
Komsta, Lukasz, and Frederick Novomestky. 2015. <em>Moments: Moments, Cumulants, Skewness, Kurtosis and Related Tests</em>. <a href="https://CRAN.R-project.org/package=moments">https://CRAN.R-project.org/package=moments</a>.
</div>
<div id="ref-Lahiri2015" class="csl-entry" role="listitem">
Lahiri, P., and J. Suntornchost. 2015. <span>“Variable Selection for Linear Mixed Models with Applications in Small Area Estimation.”</span> <em>The Indian Journal of Statistics</em> 77-B (2): 312–20. <a href="https://www.jstor.org/stable/43694416">https://www.jstor.org/stable/43694416</a>.
</div>
<div id="ref-Lumley2024" class="csl-entry" role="listitem">
Lumley, Thomas. 2024. <span>“Survey: Analysis of Complex Survey Samples.”</span>
</div>
<div id="ref-Marhuenda2014" class="csl-entry" role="listitem">
Marhuenda, Y., D. Morales, and M. del Camen Pardo. 2014. <span>“Information Criteria for <span>Fay-Herriot</span> Model Selection.”</span> <em>Computational Statistics and Data Analysis</em> 70: 268–80. <a href="https://doi.org/10.1016/j.csda.2013.09.016">https://doi.org/10.1016/j.csda.2013.09.016</a>.
</div>
<div id="ref-molinamarhuenda2015" class="csl-entry" role="listitem">
Molina, Isabel, and Yolanda Marhuenda. 2015. <span>“<span class="nocase">sae</span>: An <span>R</span> Package for Small Area Estimation.”</span> <em>The R Journal</em> 7 (1): 81–98. <a href="https://journal.r-project.org/archive/2015/RJ-2015-007/RJ-2015-007.pdf">https://journal.r-project.org/archive/2015/RJ-2015-007/RJ-2015-007.pdf</a>.
</div>
<div id="ref-RaoMolina2015" class="csl-entry" role="listitem">
Rao, J. N. K., and Isabel Molina. 2015. <em>Small Area Estimation</em>. John Wiley; Sons, Inc, Hoboken, NJ, USA.
</div>
<div id="ref-Schmid2017" class="csl-entry" role="listitem">
Schmid, T., F. Bruckschen, N. Salvati, and T. Zbiranski. 2017. <span>“Constructing Sociodemographic Indicators for National Statistical Institutes Using Mobile Phone Data: Estimating Literacy Rates in <span>Senegal</span>.”</span> <em>Journal of the Royal Statistical Society A</em> 180 (4): 1163–90. <a href="https://doi.org/10.1111/rssa.12305">https://doi.org/10.1111/rssa.12305</a>.
</div>
<div id="ref-you2023application" class="csl-entry" role="listitem">
You, Yong, and Mike Hidiroglou. 2023. <span>“Application of Sampling Variance Smoothing Methods for Small Area Proportion Estimation.”</span> <em>Journal of Official Statistics</em> 39 (4): 571–90.
</div>
</div>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./data.html" class="pagination-link" aria-label="Data preparation">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data preparation</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./fh_multivariate.html" class="pagination-link" aria-label="Multivariate Fay–Herriot">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Multivariate Fay–Herriot</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb49" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="an">bibliography:</span><span class="co"> references.bib</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="fu"># The Univariate Fay-Herriot model</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>In this section, we will present a whole estimation procedure of the standard area-level model introduced by @Fay1979 in R. As with the disclaimer in the preceding section, this practical manual is not intended to serve as a theoretical introduction to area-level models. Instead, it offers a set of straightforward and practical R scripts, accompanied by clear explanations, to demonstrate how these tasks can be carried out in R. For a theoretical foundation please refer to @Fay1979 and @RaoMolina2015. In addition to theoretical information, the vignette "A framework for producing small area estimates based on area-level models in R" of the R package <span class="in">`emdi`</span> <span class="co">[</span><span class="ot">@Harmening2023</span><span class="co">]</span> provides further code examples for the FH model.</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>In this chapter, we will describe how to run the univariate Fay-Herriot (FH) using simulated income data from Spain. The estimation procedure is explained step by step.</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>Step 1: Data preparation. Compute the direct estimates and their corresponding variances on the area-level and eventually perform variance smoothing. Aggregate the available auxiliary variables to the same area level and combine both input data.</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>Step 2: Model selection. Select the aggregated auxiliary variables at the area level for the FH model using a stepwise selection based on information criteria like the Akaike, Bayesian or Kullback information criteria.</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>Step 3: Model estimation of FH point estimates and their mean squared error (MSE) estimates as uncertainty measure. Eventually apply a transformation.</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>Step 4: Assessment of the estimated model. Check the FH model assumptions, including linearity, normality of predicted area effects and standardized model residuals. When violations of the model assumptions are detected, the application of a transformation might help. Repeat Step 3 including a transformation and check again the model assumptions.</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>Step 5: Comparison of the FH results with the direct estimates.</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>Step 6: Benchmark the FH point estimates for consistency with higher results.</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>Step 7: Preparation of the results. Create tables and maps of results.</span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>Step 8: Saving the results. One option is to export the results to known formats like Excel or OpenDocument Spreadsheets.</span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>We will show below the use of the <span class="in">`fh()`</span> function of the R package <span class="in">`emdi`</span> <span class="co">[</span><span class="ot">@Harmening2023</span><span class="co">]</span> which computes the EBLUPs and their MSE estimates of the standard FH model and several extensions of it, among others it allows for the application of transformations. Because the poverty rate is a ratio, it might be helpful to apply the arcsin transformation to guarantee that the results lie between 0 and 1. The function call is:</span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a><span class="in">`fh(fixed, vardir, combined_data, domains = NULL, method = "reml", interval = NULL,   k = 1.345, mult_constant = 1, transformation = "no", backtransformation = NULL,   eff_smpsize = NULL, correlation = "no", corMatrix = NULL, Ci = NULL, tol = 1e-04,   maxit = 100, MSE = FALSE, mse_type = "analytical", B = c(50, 0), seed = 123)`</span></span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data and preparation</span></span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a><span class="fu">### Load required libraries</span></span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>First of all, load the required R libraries. The code automatically installs the packages that are not yet installed and loads them. If you need further packages, please add them to the list of <span class="in">`p_load`</span> which contains the packages required to the run the codes.</span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a><span class="in">```{r libraries, message = FALSE, warning = FALSE}</span></span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a><span class="in">if (sum(installed.packages()[,1] %in% "pacman") != 1){</span></span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a><span class="in">  install.packages("pacman")</span></span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a><span class="in">pacman::p_load(sae, survey, spdep, emdi, data.table, MASS, caret, dplyr, sf)</span></span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-48"><a href="#cb49-48" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-49"><a href="#cb49-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-50"><a href="#cb49-50" aria-hidden="true" tabindex="-1"></a><span class="fu">### Load the dataset</span></span>
<span id="cb49-51"><a href="#cb49-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-52"><a href="#cb49-52" aria-hidden="true" tabindex="-1"></a>Usually, SAE combines multiple data sources: a survey data set and a census or administrative/register dataset. For the estimation of area-level models, we need area-level aggregates of the same area-level (e.g. NUTS3) of both datasets. The target variable (typically household welfare/income for poverty mapping) is available in the survey but not in the census data.</span>
<span id="cb49-53"><a href="#cb49-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-54"><a href="#cb49-54" aria-hidden="true" tabindex="-1"></a>In this example, we use a synthetic data set adapted from R package <span class="in">`sae`</span> called <span class="in">`incomedata`</span>. The original data contains information for $n = 17,119$ fictitious individuals residing across $D = 52$ Spanish provinces. The variables include the name of the province of residence (<span class="in">`provlab`</span>), province code (<span class="in">`prov`</span>), as well as several correlates of income.</span>
<span id="cb49-55"><a href="#cb49-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-56"><a href="#cb49-56" aria-hidden="true" tabindex="-1"></a>For this tutorial, we use a random 10% sample of the <span class="in">`incomedata`</span> to estimate the poverty rates. For the univariate case, we use the income variable from 2012.</span>
<span id="cb49-57"><a href="#cb49-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-58"><a href="#cb49-58" aria-hidden="true" tabindex="-1"></a><span class="in">```{r load_data, message = FALSE, warning = FALSE}</span></span>
<span id="cb49-59"><a href="#cb49-59" aria-hidden="true" tabindex="-1"></a><span class="in">income_dt &lt;- readRDS("data/incomedata_sample.RDS")</span></span>
<span id="cb49-60"><a href="#cb49-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-61"><a href="#cb49-61" aria-hidden="true" tabindex="-1"></a><span class="in">glimpse(income_dt)</span></span>
<span id="cb49-62"><a href="#cb49-62" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-63"><a href="#cb49-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-64"><a href="#cb49-64" aria-hidden="true" tabindex="-1"></a><span class="fu">### Direct estimation</span></span>
<span id="cb49-65"><a href="#cb49-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-66"><a href="#cb49-66" aria-hidden="true" tabindex="-1"></a>We will use the direct Horvitz-Thompons estimators that use the survey weights in <span class="in">`weight`</span> variable. We calculate the sample sizes for each provinces and compute the direct estimates and their variances. We use the <span class="in">`direct`</span> function of the <span class="in">`emdi`</span> package here. Other options are e.g. the <span class="in">`direct`</span> function of package <span class="in">`sae`</span> <span class="co">[</span><span class="ot">@molinamarhuenda2015</span><span class="co">]</span> or the <span class="in">`svyby`</span> command of package <span class="in">`survey`</span> <span class="co">[</span><span class="ot">@Lumley2024</span><span class="co">]</span>. Then, we create a dataframe containing the direct estimate, the standard errors, the variances, the coefficient of variation and the design effects, that are needed for the arcsin transformation. The design effect is the ratio of the variance considering the sampling design to the variance estimated under simple random sampling. For detailled information about the arcsin transformation please refer to @Casas2016 and @Schmid2017. In some areas with a very small sample size, it may occur, that the individual data only consists of zeros and ones, resulting in a direct estimate of zero or one and a direct variance of zero. We set those areas to out-of-sample and for the final estimation results only the synthetic part of the FH model is used.</span>
<span id="cb49-67"><a href="#cb49-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-68"><a href="#cb49-68" aria-hidden="true" tabindex="-1"></a><span class="in">```{r direct, message = FALSE, warning = FALSE}</span></span>
<span id="cb49-69"><a href="#cb49-69" aria-hidden="true" tabindex="-1"></a><span class="in">## calculate sample size for each province</span></span>
<span id="cb49-70"><a href="#cb49-70" aria-hidden="true" tabindex="-1"></a><span class="in">sampsize_dt &lt;- </span></span>
<span id="cb49-71"><a href="#cb49-71" aria-hidden="true" tabindex="-1"></a><span class="in">income_dt |&gt;</span></span>
<span id="cb49-72"><a href="#cb49-72" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(provlab) |&gt;</span></span>
<span id="cb49-73"><a href="#cb49-73" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(N = n())</span></span>
<span id="cb49-74"><a href="#cb49-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-75"><a href="#cb49-75" aria-hidden="true" tabindex="-1"></a><span class="in">## computation of direct estimates and their variances</span></span>
<span id="cb49-76"><a href="#cb49-76" aria-hidden="true" tabindex="-1"></a><span class="in">direct_dt &lt;- emdi::direct(y = "income2012",</span></span>
<span id="cb49-77"><a href="#cb49-77" aria-hidden="true" tabindex="-1"></a><span class="in">                       smp_data = income_dt |&gt; as.data.table(),</span></span>
<span id="cb49-78"><a href="#cb49-78" aria-hidden="true" tabindex="-1"></a><span class="in">                       smp_domains = "provlab",</span></span>
<span id="cb49-79"><a href="#cb49-79" aria-hidden="true" tabindex="-1"></a><span class="in">                       weights = "weight",</span></span>
<span id="cb49-80"><a href="#cb49-80" aria-hidden="true" tabindex="-1"></a><span class="in">                       threshold = unique(income_dt$povline2012),</span></span>
<span id="cb49-81"><a href="#cb49-81" aria-hidden="true" tabindex="-1"></a><span class="in">                       var = TRUE)</span></span>
<span id="cb49-82"><a href="#cb49-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-83"><a href="#cb49-83" aria-hidden="true" tabindex="-1"></a><span class="in">## create dataframe</span></span>
<span id="cb49-84"><a href="#cb49-84" aria-hidden="true" tabindex="-1"></a><span class="in">direct_dt &lt;- </span></span>
<span id="cb49-85"><a href="#cb49-85" aria-hidden="true" tabindex="-1"></a><span class="in">       direct_dt$ind |&gt;</span></span>
<span id="cb49-86"><a href="#cb49-86" aria-hidden="true" tabindex="-1"></a><span class="in">       dplyr::select(Domain, Head_Count) |&gt;</span></span>
<span id="cb49-87"><a href="#cb49-87" aria-hidden="true" tabindex="-1"></a><span class="in">       rename(Direct = "Head_Count") |&gt;</span></span>
<span id="cb49-88"><a href="#cb49-88" aria-hidden="true" tabindex="-1"></a><span class="in">       merge(direct_dt$MSE |&gt;</span></span>
<span id="cb49-89"><a href="#cb49-89" aria-hidden="true" tabindex="-1"></a><span class="in">               dplyr::select(Domain, Head_Count) |&gt;</span></span>
<span id="cb49-90"><a href="#cb49-90" aria-hidden="true" tabindex="-1"></a><span class="in">               rename(vardir = "Head_Count"),</span></span>
<span id="cb49-91"><a href="#cb49-91" aria-hidden="true" tabindex="-1"></a><span class="in">             by = "Domain") |&gt;</span></span>
<span id="cb49-92"><a href="#cb49-92" aria-hidden="true" tabindex="-1"></a><span class="in">       mutate(SD = sqrt(vardir)) |&gt;</span></span>
<span id="cb49-93"><a href="#cb49-93" aria-hidden="true" tabindex="-1"></a><span class="in">       mutate(CV = SD / Direct) |&gt;</span></span>
<span id="cb49-94"><a href="#cb49-94" aria-hidden="true" tabindex="-1"></a><span class="in">       merge(sampsize_dt |&gt; </span></span>
<span id="cb49-95"><a href="#cb49-95" aria-hidden="true" tabindex="-1"></a><span class="in">               mutate(provlab = as.factor(provlab)), </span></span>
<span id="cb49-96"><a href="#cb49-96" aria-hidden="true" tabindex="-1"></a><span class="in">             by.x = "Domain", </span></span>
<span id="cb49-97"><a href="#cb49-97" aria-hidden="true" tabindex="-1"></a><span class="in">             by.y = "provlab") |&gt;</span></span>
<span id="cb49-98"><a href="#cb49-98" aria-hidden="true" tabindex="-1"></a><span class="in">      mutate(var_SRS = Direct * (1 - Direct) / N) |&gt;</span></span>
<span id="cb49-99"><a href="#cb49-99" aria-hidden="true" tabindex="-1"></a><span class="in">      mutate(deff = vardir / var_SRS) |&gt;</span></span>
<span id="cb49-100"><a href="#cb49-100" aria-hidden="true" tabindex="-1"></a><span class="in">      mutate(n_eff = N/deff)</span></span>
<span id="cb49-101"><a href="#cb49-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-102"><a href="#cb49-102" aria-hidden="true" tabindex="-1"></a><span class="in">## set zero variance to OOS</span></span>
<span id="cb49-103"><a href="#cb49-103" aria-hidden="true" tabindex="-1"></a><span class="in">direct_dt &lt;- direct_dt[complete.cases(direct_dt), ]</span></span>
<span id="cb49-104"><a href="#cb49-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-105"><a href="#cb49-105" aria-hidden="true" tabindex="-1"></a><span class="in">## have a look at sample sizes</span></span>
<span id="cb49-106"><a href="#cb49-106" aria-hidden="true" tabindex="-1"></a><span class="in">summary(direct_dt$N)    </span></span>
<span id="cb49-107"><a href="#cb49-107" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-108"><a href="#cb49-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-109"><a href="#cb49-109" aria-hidden="true" tabindex="-1"></a><span class="fu">### Variance smoothing</span></span>
<span id="cb49-110"><a href="#cb49-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-111"><a href="#cb49-111" aria-hidden="true" tabindex="-1"></a>A quick inspection of the preceding results will show some provinces contain low sample sizes which sometimes result in extreme value poverty rates and hence 0 variance. To avoid this, we will show you how to apply the variance smoothing method suggested by @you2023application. Please see the code and Roxygen comments below explaining the use of the <span class="in">`varsmoothie_king()`</span> function which computes smoothed variances. In case, the arcsin transformation will be applied, the variance smoothing described here is not necessary, since the arcsin transformation works variance stabilizing itself. When applying the arcsin transformation, the direct variances are automatically set to 1/(4<span class="sc">\*</span>effective sampling size) when using the <span class="in">`fh`</span> function of package <span class="in">`emdi`</span>. The effective sample size equals the sample size of each area divided by the design effect. If the variance stabilizing effect is not enough, the design effect of a higher area level could also be used here (in this example the regions <span class="in">`ac`</span>).</span>
<span id="cb49-112"><a href="#cb49-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-113"><a href="#cb49-113" aria-hidden="true" tabindex="-1"></a><span class="in">```{r varsmooting}</span></span>
<span id="cb49-114"><a href="#cb49-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-115"><a href="#cb49-115" aria-hidden="true" tabindex="-1"></a><span class="in">#' A function to perform variance smoothing</span></span>
<span id="cb49-116"><a href="#cb49-116" aria-hidden="true" tabindex="-1"></a><span class="in">#' </span></span>
<span id="cb49-117"><a href="#cb49-117" aria-hidden="true" tabindex="-1"></a><span class="in">#' The variance smoothing function applies the methodology of You and Hiridoglou (2023)</span></span>
<span id="cb49-118"><a href="#cb49-118" aria-hidden="true" tabindex="-1"></a><span class="in">#' which uses simply log linear regression to estimate direct variances for sample </span></span>
<span id="cb49-119"><a href="#cb49-119" aria-hidden="true" tabindex="-1"></a><span class="in">#' poverty rates which is useful for replacing poverty rates in areas with low sampling.</span></span>
<span id="cb49-120"><a href="#cb49-120" aria-hidden="true" tabindex="-1"></a><span class="in">#' </span></span>
<span id="cb49-121"><a href="#cb49-121" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param domain a vector of unique domain/target areas</span></span>
<span id="cb49-122"><a href="#cb49-122" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param direct_var the raw variances estimated from sample data</span></span>
<span id="cb49-123"><a href="#cb49-123" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param sampsize the sample size for each domain</span></span>
<span id="cb49-124"><a href="#cb49-124" aria-hidden="true" tabindex="-1"></a><span class="in">#' </span></span>
<span id="cb49-125"><a href="#cb49-125" aria-hidden="true" tabindex="-1"></a><span class="in">#' @export</span></span>
<span id="cb49-126"><a href="#cb49-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-127"><a href="#cb49-127" aria-hidden="true" tabindex="-1"></a><span class="in">varsmoothie_king &lt;- function(domain,</span></span>
<span id="cb49-128"><a href="#cb49-128" aria-hidden="true" tabindex="-1"></a><span class="in">                             direct_var,</span></span>
<span id="cb49-129"><a href="#cb49-129" aria-hidden="true" tabindex="-1"></a><span class="in">                             sampsize){</span></span>
<span id="cb49-130"><a href="#cb49-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-131"><a href="#cb49-131" aria-hidden="true" tabindex="-1"></a><span class="in">  dt &lt;- data.table(Domain = domain,</span></span>
<span id="cb49-132"><a href="#cb49-132" aria-hidden="true" tabindex="-1"></a><span class="in">                   var = direct_var,</span></span>
<span id="cb49-133"><a href="#cb49-133" aria-hidden="true" tabindex="-1"></a><span class="in">                   n = sampsize)</span></span>
<span id="cb49-134"><a href="#cb49-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-135"><a href="#cb49-135" aria-hidden="true" tabindex="-1"></a><span class="in">  dt$log_n &lt;- log(dt$n)</span></span>
<span id="cb49-136"><a href="#cb49-136" aria-hidden="true" tabindex="-1"></a><span class="in">  dt$log_var &lt;- log(dt$var)</span></span>
<span id="cb49-137"><a href="#cb49-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-138"><a href="#cb49-138" aria-hidden="true" tabindex="-1"></a><span class="in">  lm_model &lt;- lm(formula = log_var ~ log_n,</span></span>
<span id="cb49-139"><a href="#cb49-139" aria-hidden="true" tabindex="-1"></a><span class="in">                 data = dt[!(abs(dt$log_var) == Inf),])</span></span>
<span id="cb49-140"><a href="#cb49-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-141"><a href="#cb49-141" aria-hidden="true" tabindex="-1"></a><span class="in">  dt$pred_var &lt;- predict(lm_model, newdata = dt)</span></span>
<span id="cb49-142"><a href="#cb49-142" aria-hidden="true" tabindex="-1"></a><span class="in">  residual_var &lt;-  summary(lm_model)$sigma^2</span></span>
<span id="cb49-143"><a href="#cb49-143" aria-hidden="true" tabindex="-1"></a><span class="in">  dt$var_smooth &lt;- exp(dt$pred_var) * exp(residual_var/2)</span></span>
<span id="cb49-144"><a href="#cb49-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-145"><a href="#cb49-145" aria-hidden="true" tabindex="-1"></a><span class="in">  return(dt[, c("Domain", "var_smooth"), with = F])</span></span>
<span id="cb49-146"><a href="#cb49-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-147"><a href="#cb49-147" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb49-148"><a href="#cb49-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-149"><a href="#cb49-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-150"><a href="#cb49-150" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-151"><a href="#cb49-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-152"><a href="#cb49-152" aria-hidden="true" tabindex="-1"></a>Ok, the goal now is to use the above <span class="in">`varsmoothie_king()`</span> function to add an additional column of smoothed variances into our <span class="in">`direct_dt`</span> dataframe.</span>
<span id="cb49-153"><a href="#cb49-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-156"><a href="#cb49-156" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-157"><a href="#cb49-157" aria-hidden="true" tabindex="-1"></a>var_smooth <span class="ot">&lt;-</span> <span class="fu">varsmoothie_king</span>(<span class="at">domain =</span> direct_dt<span class="sc">$</span>Domain,</span>
<span id="cb49-158"><a href="#cb49-158" aria-hidden="true" tabindex="-1"></a>                               <span class="at">direct_var =</span> direct_dt<span class="sc">$</span>vardir,</span>
<span id="cb49-159"><a href="#cb49-159" aria-hidden="true" tabindex="-1"></a>                               <span class="at">sampsize =</span> direct_dt<span class="sc">$</span>N)</span>
<span id="cb49-160"><a href="#cb49-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-161"><a href="#cb49-161" aria-hidden="true" tabindex="-1"></a>direct_dt <span class="ot">&lt;-</span> var_smooth <span class="sc">|&gt;</span> <span class="fu">merge</span>(direct_dt, <span class="at">by =</span> <span class="st">"Domain"</span>)</span>
<span id="cb49-162"><a href="#cb49-162" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-163"><a href="#cb49-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-164"><a href="#cb49-164" aria-hidden="true" tabindex="-1"></a><span class="fu">### Auxiliary variable preparation</span></span>
<span id="cb49-165"><a href="#cb49-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-166"><a href="#cb49-166" aria-hidden="true" tabindex="-1"></a>The FH model is a model of poverty rates at the target area level, hence the data format required for this exercise has the province as its unit of observation. This format has a few essential columns:</span>
<span id="cb49-167"><a href="#cb49-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-168"><a href="#cb49-168" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Variable for poverty rates</span>
<span id="cb49-169"><a href="#cb49-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-170"><a href="#cb49-170" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The set of candidate variables from which the most predicted of poverty rates will be selected</span>
<span id="cb49-171"><a href="#cb49-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-172"><a href="#cb49-172" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The target area variable identifier (i.e. in this case the province variable <span class="in">`prov`</span> and <span class="in">`provlab`</span>)</span>
<span id="cb49-173"><a href="#cb49-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-174"><a href="#cb49-174" aria-hidden="true" tabindex="-1"></a>We prepare this dataset as follows:</span>
<span id="cb49-175"><a href="#cb49-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-178"><a href="#cb49-178" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-179"><a href="#cb49-179" aria-hidden="true" tabindex="-1"></a><span class="do">## create the candidate variables</span></span>
<span id="cb49-180"><a href="#cb49-180" aria-hidden="true" tabindex="-1"></a>candidate_vars <span class="ot">&lt;-</span> <span class="fu">colnames</span>(income_dt)[<span class="sc">!</span><span class="fu">colnames</span>(income_dt) <span class="sc">%in%</span> </span>
<span id="cb49-181"><a href="#cb49-181" aria-hidden="true" tabindex="-1"></a>                                         <span class="fu">c</span>(<span class="st">"provlab"</span>, <span class="st">"prov"</span>, </span>
<span id="cb49-182"><a href="#cb49-182" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">"income2012"</span>, <span class="st">"income2013"</span>, <span class="st">"income2014"</span>,</span>
<span id="cb49-183"><a href="#cb49-183" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">"povline2012"</span>, <span class="st">"povline2013"</span>, <span class="st">"povline2014"</span>,</span>
<span id="cb49-184"><a href="#cb49-184" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">"ac"</span>, <span class="st">"nat"</span>, <span class="st">"educ"</span>, <span class="st">"labor"</span>,</span>
<span id="cb49-185"><a href="#cb49-185" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">"age"</span>)]</span>
<span id="cb49-186"><a href="#cb49-186" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb49-187"><a href="#cb49-187" aria-hidden="true" tabindex="-1"></a><span class="do">## change dummy of gen to 0 and 1</span></span>
<span id="cb49-188"><a href="#cb49-188" aria-hidden="true" tabindex="-1"></a>income_dt <span class="ot">&lt;-</span> </span>
<span id="cb49-189"><a href="#cb49-189" aria-hidden="true" tabindex="-1"></a>  income_dt <span class="sc">|&gt;</span></span>
<span id="cb49-190"><a href="#cb49-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(gen), <span class="sc">~</span> <span class="fu">case_when</span>(</span>
<span id="cb49-191"><a href="#cb49-191" aria-hidden="true" tabindex="-1"></a>    .x <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb49-192"><a href="#cb49-192" aria-hidden="true" tabindex="-1"></a>    .x <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb49-193"><a href="#cb49-193" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_real_</span></span>
<span id="cb49-194"><a href="#cb49-194" aria-hidden="true" tabindex="-1"></a>  )))</span>
<span id="cb49-195"><a href="#cb49-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-196"><a href="#cb49-196" aria-hidden="true" tabindex="-1"></a><span class="do">## aggregating the unit-level data to the province level</span></span>
<span id="cb49-197"><a href="#cb49-197" aria-hidden="true" tabindex="-1"></a>prov_dt <span class="ot">&lt;-</span> </span>
<span id="cb49-198"><a href="#cb49-198" aria-hidden="true" tabindex="-1"></a>income_dt <span class="sc">|&gt;</span></span>
<span id="cb49-199"><a href="#cb49-199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(provlab) <span class="sc">|&gt;</span></span>
<span id="cb49-200"><a href="#cb49-200" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb49-201"><a href="#cb49-201" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(</span>
<span id="cb49-202"><a href="#cb49-202" aria-hidden="true" tabindex="-1"></a>      <span class="fu">any_of</span>(candidate_vars),</span>
<span id="cb49-203"><a href="#cb49-203" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span> <span class="fu">weighted.mean</span>(<span class="at">x =</span> ., <span class="at">w =</span> weight, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb49-204"><a href="#cb49-204" aria-hidden="true" tabindex="-1"></a>      <span class="at">.names =</span> <span class="st">"{.col}"</span></span>
<span id="cb49-205"><a href="#cb49-205" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb49-206"><a href="#cb49-206" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb49-207"><a href="#cb49-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-208"><a href="#cb49-208" aria-hidden="true" tabindex="-1"></a><span class="do">### combine the the dataframe containing the direct estimates and their variances with the province level data</span></span>
<span id="cb49-209"><a href="#cb49-209" aria-hidden="true" tabindex="-1"></a>comb_Data <span class="ot">&lt;-</span> <span class="fu">merge</span>(direct_dt, prov_dt,</span>
<span id="cb49-210"><a href="#cb49-210" aria-hidden="true" tabindex="-1"></a>    <span class="at">by.x =</span> <span class="st">"Domain"</span>, <span class="at">by.y =</span> <span class="st">"provlab"</span>,</span>
<span id="cb49-211"><a href="#cb49-211" aria-hidden="true" tabindex="-1"></a>    <span class="at">all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb49-212"><a href="#cb49-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-213"><a href="#cb49-213" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-214"><a href="#cb49-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-215"><a href="#cb49-215" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model selection</span></span>
<span id="cb49-216"><a href="#cb49-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-217"><a href="#cb49-217" aria-hidden="true" tabindex="-1"></a><span class="fu">### Model preparation</span></span>
<span id="cb49-218"><a href="#cb49-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-219"><a href="#cb49-219" aria-hidden="true" tabindex="-1"></a>FH does not run if there is any missing value in the auxiliary variables, and therefore, any variable with missing value should be removed in advance.</span>
<span id="cb49-220"><a href="#cb49-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-221"><a href="#cb49-221" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fh_model, message = FALSE, warning = FALSE}</span></span>
<span id="cb49-222"><a href="#cb49-222" aria-hidden="true" tabindex="-1"></a><span class="in">rowsNAcovariates &lt;- rowSums(sapply(comb_Data[,..candidate_vars], is.na))</span></span>
<span id="cb49-223"><a href="#cb49-223" aria-hidden="true" tabindex="-1"></a><span class="in">comb_Data &lt;- comb_Data[rowsNAcovariates == 0, ]</span></span>
<span id="cb49-224"><a href="#cb49-224" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-225"><a href="#cb49-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-226"><a href="#cb49-226" aria-hidden="true" tabindex="-1"></a><span class="fu">### Check multicollinearity</span></span>
<span id="cb49-227"><a href="#cb49-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-228"><a href="#cb49-228" aria-hidden="true" tabindex="-1"></a>With the help of the <span class="in">`step()`</span> function of package <span class="in">`emdi`</span>, we perform a variable selection based on the chosen variable selection criterion and directly get the model with fewer variables. The function <span class="in">`step_wrapper()`</span> implemented below is a wrapper to the <span class="in">`emdi::step()`</span> function and performs all the perfunctory cleaning necessary to use <span class="in">`step()`</span>. This includes dropping columns that are entirely missing (<span class="in">`NA`</span>) and keep only complete cases/observations (for the model selection only the in-sample domains are used) and remove perfectly or near collinear variables and combinations.</span>
<span id="cb49-229"><a href="#cb49-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-232"><a href="#cb49-232" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-233"><a href="#cb49-233" aria-hidden="true" tabindex="-1"></a><span class="co">#' A function to perform stepwise variable selection based on selection criteria</span></span>
<span id="cb49-234"><a href="#cb49-234" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb49-235"><a href="#cb49-235" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param dt data.frame, dataset containing the set of outcome and independent variables</span></span>
<span id="cb49-236"><a href="#cb49-236" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param xvars character vector, the set of x variables</span></span>
<span id="cb49-237"><a href="#cb49-237" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param y character, the name of the y variable</span></span>
<span id="cb49-238"><a href="#cb49-238" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param cor_thresh double, a correlation threshold between 0 and 1</span></span>
<span id="cb49-239"><a href="#cb49-239" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param criteria character, criteria that can be chosen are "AIC", "AICc", "AICb1", "AICb2", "BIC", "KIC", "KICc", "KICb1", or "KICb2". Defaults to "AIC". If transformation is set to "arcsin", only "AIC" and "BIC" can be chosen.</span></span>
<span id="cb49-240"><a href="#cb49-240" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param vardir character, name of the variable containing the domain-specific sampling variances of the direct estimates that are included in dt</span></span>
<span id="cb49-241"><a href="#cb49-241" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param transformation character, either "no" (default) or "arcsin".</span></span>
<span id="cb49-242"><a href="#cb49-242" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param eff_smpsize character, name of the variable containing the effective sample sizes that are included in dt. Required argument when the arcsin transformation is chosen. Defaults to NULL.</span></span>
<span id="cb49-243"><a href="#cb49-243" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb49-244"><a href="#cb49-244" aria-hidden="true" tabindex="-1"></a><span class="co">#' @import data.table</span></span>
<span id="cb49-245"><a href="#cb49-245" aria-hidden="true" tabindex="-1"></a><span class="co">#' @import caret</span></span>
<span id="cb49-246"><a href="#cb49-246" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom emdi step fh</span></span>
<span id="cb49-247"><a href="#cb49-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-248"><a href="#cb49-248" aria-hidden="true" tabindex="-1"></a>step_wrapper <span class="ot">&lt;-</span> <span class="cf">function</span>(dt, xvars, y, <span class="at">cor_thresh =</span> <span class="fl">0.95</span>, <span class="at">criteria =</span> <span class="st">"AIC"</span>,</span>
<span id="cb49-249"><a href="#cb49-249" aria-hidden="true" tabindex="-1"></a>                         vardir, <span class="at">transformation =</span> <span class="st">"no"</span>, eff_smpsize) {</span>
<span id="cb49-250"><a href="#cb49-250" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-251"><a href="#cb49-251" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(dt)</span>
<span id="cb49-252"><a href="#cb49-252" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb49-253"><a href="#cb49-253" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Drop columns that are entirely NA</span></span>
<span id="cb49-254"><a href="#cb49-254" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> dt[, <span class="fu">which</span>(<span class="fu">unlist</span>(<span class="fu">lapply</span>(dt, <span class="cf">function</span>(x) <span class="sc">!</span><span class="fu">all</span>(<span class="fu">is.na</span>(x))))), with <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb49-255"><a href="#cb49-255" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-256"><a href="#cb49-256" aria-hidden="true" tabindex="-1"></a>  xvars <span class="ot">&lt;-</span> xvars[xvars <span class="sc">%in%</span> <span class="fu">colnames</span>(dt)]</span>
<span id="cb49-257"><a href="#cb49-257" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-258"><a href="#cb49-258" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Keep only complete cases</span></span>
<span id="cb49-259"><a href="#cb49-259" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> dt[<span class="fu">complete.cases</span>(dt),] </span>
<span id="cb49-260"><a href="#cb49-260" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-261"><a href="#cb49-261" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 1: Remove aliased (perfectly collinear) variables</span></span>
<span id="cb49-262"><a href="#cb49-262" aria-hidden="true" tabindex="-1"></a>  model_formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(y, <span class="st">"~"</span>, <span class="fu">paste</span>(xvars, <span class="at">collapse =</span> <span class="st">" + "</span>)))</span>
<span id="cb49-263"><a href="#cb49-263" aria-hidden="true" tabindex="-1"></a>  lm_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(model_formula, <span class="at">data =</span> dt)</span>
<span id="cb49-264"><a href="#cb49-264" aria-hidden="true" tabindex="-1"></a>  aliased <span class="ot">&lt;-</span> <span class="fu">is.na</span>(<span class="fu">coef</span>(lm_model))</span>
<span id="cb49-265"><a href="#cb49-265" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(aliased)) {</span>
<span id="cb49-266"><a href="#cb49-266" aria-hidden="true" tabindex="-1"></a>    xvars <span class="ot">&lt;-</span> <span class="fu">names</span>(aliased)[<span class="sc">!</span>aliased <span class="sc">&amp;</span> <span class="fu">names</span>(aliased) <span class="sc">!=</span> <span class="st">"(Intercept)"</span>]</span>
<span id="cb49-267"><a href="#cb49-267" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb49-268"><a href="#cb49-268" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-269"><a href="#cb49-269" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 2: Remove near-linear combinations</span></span>
<span id="cb49-270"><a href="#cb49-270" aria-hidden="true" tabindex="-1"></a>  xmat <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(dt[, ..xvars])</span>
<span id="cb49-271"><a href="#cb49-271" aria-hidden="true" tabindex="-1"></a>  combo_check <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">findLinearCombos</span>(xmat), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb49-272"><a href="#cb49-272" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(combo_check) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(combo_check<span class="sc">$</span>remove) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb49-273"><a href="#cb49-273" aria-hidden="true" tabindex="-1"></a>    xvars <span class="ot">&lt;-</span> xvars[<span class="sc">-</span>combo_check<span class="sc">$</span>remove]</span>
<span id="cb49-274"><a href="#cb49-274" aria-hidden="true" tabindex="-1"></a>    xmat <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(dt[, ..xvars])</span>
<span id="cb49-275"><a href="#cb49-275" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb49-276"><a href="#cb49-276" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-277"><a href="#cb49-277" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 3: Drop highly correlated variables</span></span>
<span id="cb49-278"><a href="#cb49-278" aria-hidden="true" tabindex="-1"></a>  cor_mat <span class="ot">&lt;-</span> <span class="fu">abs</span>(<span class="fu">cor</span>(xmat))</span>
<span id="cb49-279"><a href="#cb49-279" aria-hidden="true" tabindex="-1"></a>  <span class="fu">diag</span>(cor_mat) <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb49-280"><a href="#cb49-280" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> (<span class="fu">any</span>(cor_mat <span class="sc">&gt;</span> cor_thresh, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb49-281"><a href="#cb49-281" aria-hidden="true" tabindex="-1"></a>    cor_pairs <span class="ot">&lt;-</span> <span class="fu">which</span>(cor_mat <span class="sc">==</span> <span class="fu">max</span>(cor_mat, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">arr.ind =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>, ]</span>
<span id="cb49-282"><a href="#cb49-282" aria-hidden="true" tabindex="-1"></a>    var1 <span class="ot">&lt;-</span> <span class="fu">colnames</span>(cor_mat)[cor_pairs[<span class="dv">1</span>]]</span>
<span id="cb49-283"><a href="#cb49-283" aria-hidden="true" tabindex="-1"></a>    var2 <span class="ot">&lt;-</span> <span class="fu">colnames</span>(cor_mat)[cor_pairs[<span class="dv">2</span>]]</span>
<span id="cb49-284"><a href="#cb49-284" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drop the variable with higher mean correlation</span></span>
<span id="cb49-285"><a href="#cb49-285" aria-hidden="true" tabindex="-1"></a>    drop_var <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">mean</span>(cor_mat[var1, ]) <span class="sc">&gt;</span> <span class="fu">mean</span>(cor_mat[var2, ])) var1 <span class="cf">else</span> var2</span>
<span id="cb49-286"><a href="#cb49-286" aria-hidden="true" tabindex="-1"></a>    xvars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(xvars, drop_var)</span>
<span id="cb49-287"><a href="#cb49-287" aria-hidden="true" tabindex="-1"></a>    xmat <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(dt[, ..xvars])</span>
<span id="cb49-288"><a href="#cb49-288" aria-hidden="true" tabindex="-1"></a>    cor_mat <span class="ot">&lt;-</span> <span class="fu">abs</span>(<span class="fu">cor</span>(xmat))</span>
<span id="cb49-289"><a href="#cb49-289" aria-hidden="true" tabindex="-1"></a>    <span class="fu">diag</span>(cor_mat) <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb49-290"><a href="#cb49-290" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb49-291"><a href="#cb49-291" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-292"><a href="#cb49-292" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 4: Warn if still ill-conditioned</span></span>
<span id="cb49-293"><a href="#cb49-293" aria-hidden="true" tabindex="-1"></a>  cond_number <span class="ot">&lt;-</span> <span class="fu">kappa</span>(xmat, <span class="at">exact =</span> <span class="cn">TRUE</span>)</span>
<span id="cb49-294"><a href="#cb49-294" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (cond_number <span class="sc">&gt;</span> <span class="fl">1e10</span>) {</span>
<span id="cb49-295"><a href="#cb49-295" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">"Design matrix is ill-conditioned (condition number &gt; 1e10). Consider reviewing variable selection."</span>)</span>
<span id="cb49-296"><a href="#cb49-296" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb49-297"><a href="#cb49-297" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-298"><a href="#cb49-298" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Final model fit</span></span>
<span id="cb49-299"><a href="#cb49-299" aria-hidden="true" tabindex="-1"></a>  model_formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(y, <span class="st">"~"</span>, <span class="fu">paste</span>(xvars, <span class="at">collapse =</span> <span class="st">" + "</span>)))</span>
<span id="cb49-300"><a href="#cb49-300" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-301"><a href="#cb49-301" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Stepwise selection</span></span>
<span id="cb49-302"><a href="#cb49-302" aria-hidden="true" tabindex="-1"></a>  fh_args <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb49-303"><a href="#cb49-303" aria-hidden="true" tabindex="-1"></a>    <span class="at">fixed =</span> model_formula,</span>
<span id="cb49-304"><a href="#cb49-304" aria-hidden="true" tabindex="-1"></a>    <span class="at">vardir =</span> vardir,</span>
<span id="cb49-305"><a href="#cb49-305" aria-hidden="true" tabindex="-1"></a>    <span class="at">combined_data =</span> dt,</span>
<span id="cb49-306"><a href="#cb49-306" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"ml"</span>,</span>
<span id="cb49-307"><a href="#cb49-307" aria-hidden="true" tabindex="-1"></a>    <span class="at">MSE =</span> <span class="cn">FALSE</span></span>
<span id="cb49-308"><a href="#cb49-308" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb49-309"><a href="#cb49-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-310"><a href="#cb49-310" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (transformation <span class="sc">==</span> <span class="st">"arcsin"</span>) {</span>
<span id="cb49-311"><a href="#cb49-311" aria-hidden="true" tabindex="-1"></a>    fh_args<span class="sc">$</span>transformation <span class="ot">&lt;-</span> <span class="st">"arcsin"</span></span>
<span id="cb49-312"><a href="#cb49-312" aria-hidden="true" tabindex="-1"></a>    fh_args<span class="sc">$</span>backtransformation <span class="ot">&lt;-</span> <span class="st">"bc"</span></span>
<span id="cb49-313"><a href="#cb49-313" aria-hidden="true" tabindex="-1"></a>    fh_args<span class="sc">$</span>eff_smpsize <span class="ot">&lt;-</span> eff_smpsize</span>
<span id="cb49-314"><a href="#cb49-314" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb49-315"><a href="#cb49-315" aria-hidden="true" tabindex="-1"></a>    fh_args<span class="sc">$</span>transformation <span class="ot">&lt;-</span> <span class="st">"no"</span></span>
<span id="cb49-316"><a href="#cb49-316" aria-hidden="true" tabindex="-1"></a>    fh_args<span class="sc">$</span>B <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">50</span>)</span>
<span id="cb49-317"><a href="#cb49-317" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb49-318"><a href="#cb49-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-319"><a href="#cb49-319" aria-hidden="true" tabindex="-1"></a>  fh_model <span class="ot">&lt;-</span> <span class="fu">do.call</span>(emdi<span class="sc">::</span>fh, fh_args)</span>
<span id="cb49-320"><a href="#cb49-320" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-321"><a href="#cb49-321" aria-hidden="true" tabindex="-1"></a>  stepwise_model <span class="ot">&lt;-</span> emdi<span class="sc">::</span><span class="fu">step</span>(fh_model, <span class="at">criteria =</span> criteria)</span>
<span id="cb49-322"><a href="#cb49-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-323"><a href="#cb49-323" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(stepwise_model)</span>
<span id="cb49-324"><a href="#cb49-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-325"><a href="#cb49-325" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb49-326"><a href="#cb49-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-327"><a href="#cb49-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-328"><a href="#cb49-328" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-329"><a href="#cb49-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-330"><a href="#cb49-330" aria-hidden="true" tabindex="-1"></a>We apply the function to select the variables.</span>
<span id="cb49-331"><a href="#cb49-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-332"><a href="#cb49-332" aria-hidden="true" tabindex="-1"></a><span class="in">```{r remove_multicol, message = FALSE, warning = FALSE}</span></span>
<span id="cb49-333"><a href="#cb49-333" aria-hidden="true" tabindex="-1"></a><span class="in">fh_step &lt;- step_wrapper(dt = comb_Data, </span></span>
<span id="cb49-334"><a href="#cb49-334" aria-hidden="true" tabindex="-1"></a><span class="in">                        xvars = candidate_vars,</span></span>
<span id="cb49-335"><a href="#cb49-335" aria-hidden="true" tabindex="-1"></a><span class="in">                        y = "Direct",</span></span>
<span id="cb49-336"><a href="#cb49-336" aria-hidden="true" tabindex="-1"></a><span class="in">                        cor_thresh = 0.8,</span></span>
<span id="cb49-337"><a href="#cb49-337" aria-hidden="true" tabindex="-1"></a><span class="in">                        criteria = "AIC",</span></span>
<span id="cb49-338"><a href="#cb49-338" aria-hidden="true" tabindex="-1"></a><span class="in">                        vardir = "vardir", </span></span>
<span id="cb49-339"><a href="#cb49-339" aria-hidden="true" tabindex="-1"></a><span class="in">                        transformation = "arcsin", </span></span>
<span id="cb49-340"><a href="#cb49-340" aria-hidden="true" tabindex="-1"></a><span class="in">                        eff_smpsize = "n_eff")</span></span>
<span id="cb49-341"><a href="#cb49-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-342"><a href="#cb49-342" aria-hidden="true" tabindex="-1"></a><span class="in">print(fh_step$fixed)</span></span>
<span id="cb49-343"><a href="#cb49-343" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-344"><a href="#cb49-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-345"><a href="#cb49-345" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model estimation of FH point and their MSE estimates.</span></span>
<span id="cb49-346"><a href="#cb49-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-347"><a href="#cb49-347" aria-hidden="true" tabindex="-1"></a>In this example, we use the function <span class="in">`fh`</span> to calculate the FH estimates. Because we want to estimate a ratio, we need to apply the arcsin transformation to guarantee that the results lie between 0 and 1. For that, we choose "arcsin" as <span class="in">`transformation`</span>, and a bias-corrected <span class="in">`backtransformation`</span> ("bc"). Additionally, the effective sample size, which equals the sample size of each area divided by the design effect, is needed for the arcsin transformation. We set the <span class="in">`MSE`</span> estimation to <span class="in">`TRUE`</span>, the <span class="in">`mse_type`</span> to "boot" (necessary for the type of transformation) and determine the number of bootstrap iterations. For practical applications, values larger than 200 are recommended. In case, no transformation is desired, the <span class="in">`transformation`</span> argument must be set to "no" and the inputs <span class="in">`backtransformation`</span> and <span class="in">`eff_smpsize`</span> are no longer needed.</span>
<span id="cb49-348"><a href="#cb49-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-349"><a href="#cb49-349" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model_est, message = FALSE, warning = FALSE}</span></span>
<span id="cb49-350"><a href="#cb49-350" aria-hidden="true" tabindex="-1"></a><span class="in">fh_model &lt;- fh(fixed = formula(fh_step$fixed),</span></span>
<span id="cb49-351"><a href="#cb49-351" aria-hidden="true" tabindex="-1"></a><span class="in">               vardir = "vardir", </span></span>
<span id="cb49-352"><a href="#cb49-352" aria-hidden="true" tabindex="-1"></a><span class="in">               combined_data = comb_Data, </span></span>
<span id="cb49-353"><a href="#cb49-353" aria-hidden="true" tabindex="-1"></a><span class="in">               domains = "Domain",</span></span>
<span id="cb49-354"><a href="#cb49-354" aria-hidden="true" tabindex="-1"></a><span class="in">               method = "ml", </span></span>
<span id="cb49-355"><a href="#cb49-355" aria-hidden="true" tabindex="-1"></a><span class="in">               transformation = "arcsin", </span></span>
<span id="cb49-356"><a href="#cb49-356" aria-hidden="true" tabindex="-1"></a><span class="in">               backtransformation = "bc",</span></span>
<span id="cb49-357"><a href="#cb49-357" aria-hidden="true" tabindex="-1"></a><span class="in">               eff_smpsize = "n_eff", </span></span>
<span id="cb49-358"><a href="#cb49-358" aria-hidden="true" tabindex="-1"></a><span class="in">               MSE = TRUE, </span></span>
<span id="cb49-359"><a href="#cb49-359" aria-hidden="true" tabindex="-1"></a><span class="in">               mse_type = "boot", B = c(50, 0)) </span></span>
<span id="cb49-360"><a href="#cb49-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-361"><a href="#cb49-361" aria-hidden="true" tabindex="-1"></a><span class="in">## In case, no transformation is desired, the call would like this:</span></span>
<span id="cb49-362"><a href="#cb49-362" aria-hidden="true" tabindex="-1"></a><span class="in"># fh_model &lt;- fh(</span></span>
<span id="cb49-363"><a href="#cb49-363" aria-hidden="true" tabindex="-1"></a><span class="in">#   fixed = Direct ~ age2 + age3 + age4 + age5 + educ1 + ntl + schyrs, #formula(fh_step$fixed),</span></span>
<span id="cb49-364"><a href="#cb49-364" aria-hidden="true" tabindex="-1"></a><span class="in">#   vardir = "vardir", combined_data = comb_Data, domains = "Domain",</span></span>
<span id="cb49-365"><a href="#cb49-365" aria-hidden="true" tabindex="-1"></a><span class="in">#   method = "ml", MSE = TRUE) </span></span>
<span id="cb49-366"><a href="#cb49-366" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-367"><a href="#cb49-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-368"><a href="#cb49-368" aria-hidden="true" tabindex="-1"></a><span class="fu">## Assessment of the estimated model.</span></span>
<span id="cb49-369"><a href="#cb49-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-370"><a href="#cb49-370" aria-hidden="true" tabindex="-1"></a>With the help of the <span class="in">`summary`</span> method of <span class="in">`emdi`</span>, we gain detailed insights into the data and model components. It includes information on the estimation methods used, the number of domains, the log-likelihood, and information criteria as proposed by @Marhuenda2014. It also reports the adjusted $R^2$ from a standard linear model and the adjusted $R^2$ specific to FH models, as introduced by @Lahiri2015. It also offers diagnostic measures to assess model assumptions regarding the standardized realized residuals and random effects. These include skewness and kurtosis (based on the <span class="in">`moments`</span> package by @Komsta2015), as well as Shapiro-Wilk test statistics and corresponding p-values to evaluate the normality of both error components.</span>
<span id="cb49-371"><a href="#cb49-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-372"><a href="#cb49-372" aria-hidden="true" tabindex="-1"></a><span class="in">```{r summary, message = FALSE, warning = FALSE}</span></span>
<span id="cb49-373"><a href="#cb49-373" aria-hidden="true" tabindex="-1"></a><span class="in">summary(fh_model)</span></span>
<span id="cb49-374"><a href="#cb49-374" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-375"><a href="#cb49-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-376"><a href="#cb49-376" aria-hidden="true" tabindex="-1"></a>We can see, that 49 domains are in-sample domains. The 3 out-of-sample domains belong to the domains with 0 direct and variance estimates that we set to <span class="in">`NA`</span> in the beginning. The variance of the random effects equals 7.643268e-05. All of the included auxiliary variables are significant on a 0.05 significance level and their explanatory power is large with an adjusted $R^2$ (for FH models) of around 0.74. The results of the Shapiro-Wilk-test indicate that normality is not rejected for both errors.</span>
<span id="cb49-377"><a href="#cb49-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-378"><a href="#cb49-378" aria-hidden="true" tabindex="-1"></a><span class="fu">### Diagnostic plots</span></span>
<span id="cb49-379"><a href="#cb49-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-380"><a href="#cb49-380" aria-hidden="true" tabindex="-1"></a>We produce normal quantile-quantile (Q-Q) plots of the standardized realized residuals and random effects and plots of the kernel densities of the distribution of both error terms by the <span class="in">`plot`</span> method of <span class="in">`emdi`</span>.</span>
<span id="cb49-381"><a href="#cb49-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-382"><a href="#cb49-382" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot, message = FALSE, warning = FALSE}</span></span>
<span id="cb49-383"><a href="#cb49-383" aria-hidden="true" tabindex="-1"></a><span class="in">plot(fh_model)</span></span>
<span id="cb49-384"><a href="#cb49-384" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-385"><a href="#cb49-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-386"><a href="#cb49-386" aria-hidden="true" tabindex="-1"></a>The plots show slight deviations of the distributions from normality, but together with the results of the Shapiro-Wilk-test, we do not reject the normality assumption.</span>
<span id="cb49-387"><a href="#cb49-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-388"><a href="#cb49-388" aria-hidden="true" tabindex="-1"></a><span class="fu">## Comparison of the FH results with the direct estimates.</span></span>
<span id="cb49-389"><a href="#cb49-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-390"><a href="#cb49-390" aria-hidden="true" tabindex="-1"></a>The FH estimates are expected to align closely with the direct estimates in domains with small direct MSEs and/or large sample sizes. Moreover, incorporating auxiliary information should enhance the precision of the direct estimates. We produce a scatter plot proposed by @Brown2001 and a line plot. The fitted regression and the identity line of the scatter plot should not differ too much. The FH estimates should track the direct estimates within the line plot especially for domains with a large sample size/small MSE of the direct estimator. Furthermore, we compare the MSE and CV estimates for the direct and FH estimators using boxplots and ordered scatter plots (by setting the input arguments <span class="in">`MSE`</span> and <span class="in">`CV`</span> to <span class="in">`TRUE`</span>).</span>
<span id="cb49-391"><a href="#cb49-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-392"><a href="#cb49-392" aria-hidden="true" tabindex="-1"></a>Additionally, we compute a correlation coefficient of the direct estimates and the estimates of the regression-synthetic part of the FH model <span class="co">[</span><span class="ot">@Chandra2015</span><span class="co">]</span> and a goodness of fit diagnostic <span class="co">[</span><span class="ot">@Brown2001</span><span class="co">]</span>.</span>
<span id="cb49-393"><a href="#cb49-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-394"><a href="#cb49-394" aria-hidden="true" tabindex="-1"></a><span class="in">```{r compare, message = FALSE, warning = FALSE}</span></span>
<span id="cb49-395"><a href="#cb49-395" aria-hidden="true" tabindex="-1"></a><span class="in">compare_plot(fh_model, MSE = TRUE, CV = TRUE)</span></span>
<span id="cb49-396"><a href="#cb49-396" aria-hidden="true" tabindex="-1"></a><span class="in">compare(fh_model)</span></span>
<span id="cb49-397"><a href="#cb49-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-398"><a href="#cb49-398" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-399"><a href="#cb49-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-400"><a href="#cb49-400" aria-hidden="true" tabindex="-1"></a>The direct estimates are tracked by most of the FH estimates within the line plot. The precision of the direct estimates could be improved by the usage of the FH model in terms of MSEs and CVs. The null hypothesis of the Brown test is not rejected and the correlation coefficient indicates a positive correlation (0.68) between the direct and FH estimates.</span>
<span id="cb49-401"><a href="#cb49-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-402"><a href="#cb49-402" aria-hidden="true" tabindex="-1"></a>If the result of the model assessment is not satisfactory, the following should be checked again: Can the direct estimation including variance estimation be improved? Are there further auxiliary variables and/or must possible interaction effects be taken into account? Does a (different) transformation need to be used?</span>
<span id="cb49-403"><a href="#cb49-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-404"><a href="#cb49-404" aria-hidden="true" tabindex="-1"></a><span class="fu">## Benchmark the FH point estimates for consistency with higher results.</span></span>
<span id="cb49-405"><a href="#cb49-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-406"><a href="#cb49-406" aria-hidden="true" tabindex="-1"></a>Benchmarking is based on the principle that aggregated FH estimates should sum up to the estimates at a higher regional level. For the benchmark function, a benchmark value and a vector containing the shares of the population size per area ($N_d/N$) is required. Please note, that only the FH estimates are benchmarked and not their MSE estimates. As benchmark types "raking", "ratio" and "MSE_adj" can be chosen. For further details about using the function, please refer to the <span class="in">`emdi`</span> vignette and for general information about the benchmarking options to @Datta2011.</span>
<span id="cb49-407"><a href="#cb49-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-408"><a href="#cb49-408" aria-hidden="true" tabindex="-1"></a><span class="in">```{r benchmarking, message = FALSE, warning = FALSE}</span></span>
<span id="cb49-409"><a href="#cb49-409" aria-hidden="true" tabindex="-1"></a><span class="in">## create the poverty indicator</span></span>
<span id="cb49-410"><a href="#cb49-410" aria-hidden="true" tabindex="-1"></a><span class="in">income_dt &lt;- </span></span>
<span id="cb49-411"><a href="#cb49-411" aria-hidden="true" tabindex="-1"></a><span class="in">  income_dt |&gt;</span></span>
<span id="cb49-412"><a href="#cb49-412" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(poor2012 = ifelse(income2012 &lt; povline2012, 1, 0))</span></span>
<span id="cb49-413"><a href="#cb49-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-414"><a href="#cb49-414" aria-hidden="true" tabindex="-1"></a><span class="in">## compute the benchmark value (mean of poor2012 for the whole country of Spain)</span></span>
<span id="cb49-415"><a href="#cb49-415" aria-hidden="true" tabindex="-1"></a><span class="in">benchmark_value &lt;- weighted.mean(income_dt$poor2012, income_dt$weight)</span></span>
<span id="cb49-416"><a href="#cb49-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-417"><a href="#cb49-417" aria-hidden="true" tabindex="-1"></a><span class="in">## compute the share of population size in the total population size (N_d/N) per area</span></span>
<span id="cb49-418"><a href="#cb49-418" aria-hidden="true" tabindex="-1"></a><span class="in">data("sizeprov")</span></span>
<span id="cb49-419"><a href="#cb49-419" aria-hidden="true" tabindex="-1"></a><span class="in">comb_Data &lt;- comb_Data |&gt;</span></span>
<span id="cb49-420"><a href="#cb49-420" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(sizeprov |&gt;</span></span>
<span id="cb49-421"><a href="#cb49-421" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(ratio_n = Nd/sum(Nd)), by = c("Domain" ="provlab"))</span></span>
<span id="cb49-422"><a href="#cb49-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-423"><a href="#cb49-423" aria-hidden="true" tabindex="-1"></a><span class="in">fh_bench &lt;- benchmark(fh_model,</span></span>
<span id="cb49-424"><a href="#cb49-424" aria-hidden="true" tabindex="-1"></a><span class="in">                      benchmark = benchmark_value,</span></span>
<span id="cb49-425"><a href="#cb49-425" aria-hidden="true" tabindex="-1"></a><span class="in">                      share = comb_Data$ratio_n, </span></span>
<span id="cb49-426"><a href="#cb49-426" aria-hidden="true" tabindex="-1"></a><span class="in">                      type = "ratio",</span></span>
<span id="cb49-427"><a href="#cb49-427" aria-hidden="true" tabindex="-1"></a><span class="in">                      overwrite = TRUE)</span></span>
<span id="cb49-428"><a href="#cb49-428" aria-hidden="true" tabindex="-1"></a><span class="in">head(fh_bench$ind)</span></span>
<span id="cb49-429"><a href="#cb49-429" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-430"><a href="#cb49-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-431"><a href="#cb49-431" aria-hidden="true" tabindex="-1"></a><span class="fu">## Preparation of the results.</span></span>
<span id="cb49-432"><a href="#cb49-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-433"><a href="#cb49-433" aria-hidden="true" tabindex="-1"></a>Create one dataframe that contains the direct and FH estimation results including MSE and CV results.</span>
<span id="cb49-434"><a href="#cb49-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-435"><a href="#cb49-435" aria-hidden="true" tabindex="-1"></a><span class="in">```{r res_prep, message = FALSE, warning = FALSE}</span></span>
<span id="cb49-436"><a href="#cb49-436" aria-hidden="true" tabindex="-1"></a><span class="in">results &lt;-as.data.frame(estimators(fh_model, MSE = TRUE, CV = TRUE))</span></span>
<span id="cb49-437"><a href="#cb49-437" aria-hidden="true" tabindex="-1"></a><span class="in">head(results)</span></span>
<span id="cb49-438"><a href="#cb49-438" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-439"><a href="#cb49-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-440"><a href="#cb49-440" aria-hidden="true" tabindex="-1"></a><span class="fu">### Poverty map</span></span>
<span id="cb49-441"><a href="#cb49-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-442"><a href="#cb49-442" aria-hidden="true" tabindex="-1"></a>With the help of geographical maps, the results can be presented in a user-friendly way and differences among the areas can be detected more easily. For the map, a shape file is reqired. The domain identifiers in the results object (<span class="in">`fh_model`</span>) need to match to the respective identifiers of the shape file. Therefore, we create a mapping table first and then produce the map by <span class="in">`emdi::map_plot`</span>.</span>
<span id="cb49-443"><a href="#cb49-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-444"><a href="#cb49-444" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-povmap}</span></span>
<span id="cb49-445"><a href="#cb49-445" aria-hidden="true" tabindex="-1"></a><span class="in">## load the shapefile dataframe and convert it to an object of type sf which is a necessary input for the map_plot function</span></span>
<span id="cb49-446"><a href="#cb49-446" aria-hidden="true" tabindex="-1"></a><span class="in">spain_dt &lt;- readRDS("data/shapes/spainshape.RDS")</span></span>
<span id="cb49-447"><a href="#cb49-447" aria-hidden="true" tabindex="-1"></a><span class="in">spain_dt &lt;- sf::st_as_sf(spain_dt)</span></span>
<span id="cb49-448"><a href="#cb49-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-449"><a href="#cb49-449" aria-hidden="true" tabindex="-1"></a><span class="in">## Create a suitable mapping table</span></span>
<span id="cb49-450"><a href="#cb49-450" aria-hidden="true" tabindex="-1"></a><span class="in">## Find the right order</span></span>
<span id="cb49-451"><a href="#cb49-451" aria-hidden="true" tabindex="-1"></a><span class="in">domain_ord &lt;- match(spain_dt$provlab, fh_model$ind$Domain)</span></span>
<span id="cb49-452"><a href="#cb49-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-453"><a href="#cb49-453" aria-hidden="true" tabindex="-1"></a><span class="in">## Create the mapping table based on the order obtained above</span></span>
<span id="cb49-454"><a href="#cb49-454" aria-hidden="true" tabindex="-1"></a><span class="in">map_tab &lt;- data.frame(pop_data_id = fh_model$ind$Domain[domain_ord],</span></span>
<span id="cb49-455"><a href="#cb49-455" aria-hidden="true" tabindex="-1"></a><span class="in">                      shape_id = spain_dt$provlab)</span></span>
<span id="cb49-456"><a href="#cb49-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-457"><a href="#cb49-457" aria-hidden="true" tabindex="-1"></a><span class="in">## Create map</span></span>
<span id="cb49-458"><a href="#cb49-458" aria-hidden="true" tabindex="-1"></a><span class="in">map_plot(object = fh_model, MSE = TRUE, map_obj = spain_dt,</span></span>
<span id="cb49-459"><a href="#cb49-459" aria-hidden="true" tabindex="-1"></a><span class="in"> map_dom_id = "provlab", map_tab = map_tab)</span></span>
<span id="cb49-460"><a href="#cb49-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-461"><a href="#cb49-461" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-462"><a href="#cb49-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-463"><a href="#cb49-463" aria-hidden="true" tabindex="-1"></a><span class="fu">## Saving the results.</span></span>
<span id="cb49-464"><a href="#cb49-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-465"><a href="#cb49-465" aria-hidden="true" tabindex="-1"></a><span class="fu">### Save workspace.</span></span>
<span id="cb49-466"><a href="#cb49-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-467"><a href="#cb49-467" aria-hidden="true" tabindex="-1"></a><span class="in">```{r save, message = FALSE, warning = FALSE, eval = FALSE}</span></span>
<span id="cb49-468"><a href="#cb49-468" aria-hidden="true" tabindex="-1"></a><span class="in">save.image("fh_estimation.RData")</span></span>
<span id="cb49-469"><a href="#cb49-469" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-470"><a href="#cb49-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-471"><a href="#cb49-471" aria-hidden="true" tabindex="-1"></a><span class="fu">### Export the model output and estimation results.</span></span>
<span id="cb49-472"><a href="#cb49-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-473"><a href="#cb49-473" aria-hidden="true" tabindex="-1"></a><span class="in">```{r saveexcel, message = FALSE, warning = FALSE, eval = FALSE}</span></span>
<span id="cb49-474"><a href="#cb49-474" aria-hidden="true" tabindex="-1"></a><span class="in">write.excel(fh_model,</span></span>
<span id="cb49-475"><a href="#cb49-475" aria-hidden="true" tabindex="-1"></a><span class="in">  file = "fh_model_output.xlsx",</span></span>
<span id="cb49-476"><a href="#cb49-476" aria-hidden="true" tabindex="-1"></a><span class="in">  MSE = TRUE, CV = TRUE</span></span>
<span id="cb49-477"><a href="#cb49-477" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb49-478"><a href="#cb49-478" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>