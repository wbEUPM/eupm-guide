<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>3&nbsp; Unit-Level Models – EUPM Practitioners Guide</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./references.html" rel="next">
<link href="./data.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-de84f8d6bb715db06a919283c2d1e787.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-dab9f7089602d7cfcae6e9e20dddb093.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="site_libs/tabwid-1.1.3/tabwid.css" rel="stylesheet">

<script src="site_libs/tabwid-1.1.3/tabwid.js"></script>



</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./ul.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Unit-Level Models</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">EUPM Practitioners Guide</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Small Area Estimations for the poverty mapping: an overview</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data preparation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ul.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Unit-Level Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">3.1</span> Introduction</a></li>
  <li><a href="#the-data" id="toc-the-data" class="nav-link" data-scroll-target="#the-data"><span class="header-section-number">3.2</span> The Data</a></li>
  <li><a href="#data-preparation-for-unit-level-model" id="toc-data-preparation-for-unit-level-model" class="nav-link" data-scroll-target="#data-preparation-for-unit-level-model"><span class="header-section-number">3.3</span> Data Preparation for unit level model</a>
  <ul class="collapse">
  <li><a href="#creating-variable-interactions" id="toc-creating-variable-interactions" class="nav-link" data-scroll-target="#creating-variable-interactions"><span class="header-section-number">3.3.1</span> Creating Variable Interactions</a></li>
  <li><a href="#computing-target-area-averages-and-regional-dummies" id="toc-computing-target-area-averages-and-regional-dummies" class="nav-link" data-scroll-target="#computing-target-area-averages-and-regional-dummies"><span class="header-section-number">3.3.2</span> Computing target area averages and regional dummies</a></li>
  <li><a href="#final-preparations-for-variable-selection" id="toc-final-preparations-for-variable-selection" class="nav-link" data-scroll-target="#final-preparations-for-variable-selection"><span class="header-section-number">3.3.3</span> Final Preparations for Variable Selection</a></li>
  </ul></li>
  <li><a href="#the-variable-selection-process" id="toc-the-variable-selection-process" class="nav-link" data-scroll-target="#the-variable-selection-process"><span class="header-section-number">3.4</span> The Variable Selection Process</a></li>
  <li><a href="#post-estimation-diagnostics" id="toc-post-estimation-diagnostics" class="nav-link" data-scroll-target="#post-estimation-diagnostics"><span class="header-section-number">3.5</span> Post Estimation Diagnostics</a>
  <ul class="collapse">
  <li><a href="#checking-the-quality-of-in-sample-prediction" id="toc-checking-the-quality-of-in-sample-prediction" class="nav-link" data-scroll-target="#checking-the-quality-of-in-sample-prediction"><span class="header-section-number">3.5.1</span> Checking the quality of in-sample prediction</a></li>
  <li><a href="#cv-estimation" id="toc-cv-estimation" class="nav-link" data-scroll-target="#cv-estimation"><span class="header-section-number">3.5.2</span> CV Estimation</a></li>
  </ul></li>
  <li><a href="#poverty-map" id="toc-poverty-map" class="nav-link" data-scroll-target="#poverty-map"><span class="header-section-number">3.6</span> Poverty map</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Unit-Level Models</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">3.1</span> Introduction</h2>
<p>In this section, we will present an implementation of the Empirical Best Prediction (EBP) unit modelling approach in R based on World Bank’s Small Area Estimation Guidelines, <span class="citation" data-cites="corral2022guidelines">(<a href="references.html#ref-corral2022guidelines" role="doc-biblioref">Corral et al. 2022</a>)</span>, as well as <span class="citation" data-cites="molina2010small">(<a href="references.html#ref-molina2010small" role="doc-biblioref">Molina and Rao 2010</a>)</span> and <span class="citation" data-cites="rao2015small">(<a href="references.html#ref-rao2015small" role="doc-biblioref">Rao and Molina 2015</a>)</span>. Similar to the disclaimer made in the previous section, this practical manual does not present a theoretical statistical primer on unit level poverty mapping. Rather, it presents a combination of practical and simple R scripts with appropriate explanations to expose the simplicity of performing these tasks in R to the user. The studies previously cited are excellent starting points for those interested in understanding the theoretical underpinnings for the code being presented here.</p>
<p>This chapter is subdivided as follows to show the whole game of the EBP linear mixed effect modelling approach:</p>
<ol type="A">
<li><p>The Data: In this subsection, we present a brief checklist of data items needed for the unit level poverty mapping as well as present the specific data to be used in this chapter.</p></li>
<li><p>Data Preparation: Here we present the process of transforming the data in</p></li>
<li><p>into what is needed for variable selection and then estimating a unit level poverty map</p></li>
<li><p>Variable Selection: We present the LASSO methodology of the GLMNET, <code>glmmLasso</code> and <code>hdm</code> R packages as well as another implementation that uses the stepwise model</p></li>
<li><p>EBP Unit Level Model Estimation: Having selected the set of variables, we proceed to use the <code>povmap</code> package’s <code>povmap::ebp()</code> function to estimate the poverty map.</p></li>
<li><p>Post Estimation Diagnostics: We proceed to test model assumptions of the EBP linear mixed effects model and present functions within the <code>povmap</code> package for producing report ready figure and tables.</p></li>
</ol>
</section>
<section id="the-data" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="the-data"><span class="header-section-number">3.2</span> The Data</h2>
<p>The main idea of SAE is to combine multiple data sources. Typically, there is a survey data set and a census or administrative/register dataset both at an individual and/or household unit level. The target variable (typically household welfare/income for poverty mapping) is available in the survey but not in the census data. The goal of the exercise is to estimate welfare/income for each unit within the census or administrative register dataset by developing a model of welfare or income within the survey. It is important that the outcome variable has the same definition within the census or administrative dataset as the case maybe. It would be inappropriate to estimate household welfare/income within the survey and use the same model to predict income at the individual level of the census. Below is a brief checklist of data requirements needed for unit level poverty mapping with the povmap R package:</p>
<ul>
<li><p>A unit level survey <code>data.frame</code> object with individual and household characteristics including the target area variable, outcome variable (welfare aggregates, income per capita etc)</p></li>
<li><p>A unit census/administrative register <code>dataframe</code> object with individual and household characteristics including the target area variable. The outcome variable is typically missing since the topic of this tutorial is estimating it.</p></li>
</ul>
<p>For the purposes of this tutorial, we will use the European Union Statistics on Income and Living Conditions (EU-SILC) in Austria from 2006. Please see <span class="citation" data-cites="kreutzmann2019r">(<a href="references.html#ref-kreutzmann2019r" role="doc-biblioref">Kreutzmann et al. 2019</a>)</span> for the full description of the dataset</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">### load the data</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>survey_dt <span class="ot">&lt;-</span> eusilcA_smp <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>()</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="do">## ignore the eqIncome variable that has been left in the eusilcA_pop dataset</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>census_dt <span class="ot">&lt;-</span> eusilcA_pop <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>()</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="do">#### the survey dataset</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(survey_dt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 1,945
Columns: 18
$ eqIncome    &lt;dbl&gt; 23485.320, 22704.460, 25946.340, 16152.538, 22587.480, 204…
$ gender      &lt;fct&gt; male, male, female, male, male, male, female, male, female…
$ eqsize      &lt;dbl&gt; 2.5, 2.0, 1.0, 2.1, 1.5, 2.0, 1.5, 2.0, 1.8, 1.5, 1.5, 1.0…
$ cash        &lt;dbl&gt; 33003.39, 20073.23, 0.00, 19972.35, 21503.23, 22282.23, 21…
$ self_empl   &lt;dbl&gt; 0.00, 0.00, 24736.06, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, …
$ unempl_ben  &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ age_ben     &lt;dbl&gt; 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 15219.13, 3956.04, 0.0…
$ surv_ben    &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ sick_ben    &lt;dbl&gt; 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 3016.55, 0.00, 0.00, 0…
$ dis_ben     &lt;dbl&gt; 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00…
$ rent        &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ fam_allow   &lt;dbl&gt; 0.00, 0.00, 0.00, 5247.33, 2031.03, 0.00, 0.00, 0.00, 1860…
$ house_allow &lt;dbl&gt; 0.00, 0.00, 1083.95, 0.00, 0.00, 3312.42, 0.00, 0.00, 0.00…
$ cap_inv     &lt;dbl&gt; 17158.84, 4.70, 126.33, 195.32, 19.92, 0.00, 5.96, 1.05, 0…
$ tax_adj     &lt;dbl&gt; -10972.65, -940.77, 0.00, 0.00, 0.00, 0.00, 0.00, -526.30,…
$ state       &lt;chr&gt; "Burgenland", "Burgenland", "Burgenland", "Burgenland", "B…
$ district    &lt;fct&gt; Neusiedl am See, Neusiedl am See, Neusiedl am See, Neusied…
$ weight      &lt;dbl&gt; 9.6875, 9.6875, 9.6875, 9.6875, 9.6875, 9.6875, 9.6875, 9.…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### the census dataset</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(census_dt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 25,000
Columns: 17
$ eqIncome    &lt;dbl&gt; 81304.78, 78017.33, 70096.30, 66120.34, 65166.87, 66703.96…
$ gender      &lt;fct&gt; female, female, female, male, female, male, female, female…
$ eqsize      &lt;dbl&gt; 2.1, 2.0, 1.8, 1.5, 2.0, 1.8, 2.3, 3.0, 1.8, 2.1, 1.5, 1.5…
$ cash        &lt;dbl&gt; 51722.85, 0.00, 16259.90, 0.00, 14272.49, 99867.41, 22551.…
$ self_empl   &lt;dbl&gt; 0.00, 24399.91, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, …
$ unempl_ben  &lt;dbl&gt; 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00…
$ age_ben     &lt;dbl&gt; 0.00, 0.00, 0.00, 51131.52, 0.00, 0.00, 0.00, 0.00, 0.00, …
$ surv_ben    &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ sick_ben    &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ dis_ben     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ rent        &lt;dbl&gt; 90994.14, 104914.06, 0.00, 0.00, 54269.12, 0.00, 93416.01,…
$ fam_allow   &lt;dbl&gt; 34641.47, 0.00, 28256.15, 0.00, 35017.15, 5036.37, 3778.09…
$ house_allow &lt;dbl&gt; 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 3554…
$ cap_inv     &lt;dbl&gt; 0.00, 262.29, 64799.93, 1983.63, 0.00, 388.84, 4865.42, 0.…
$ tax_adj     &lt;dbl&gt; 40947.36, -349.71, -1126.10, 0.00, -376.87, 0.00, -5838.50…
$ state       &lt;chr&gt; "Vorarlberg", "Vorarlberg", "Vorarlberg", "Vorarlberg", "V…
$ district    &lt;fct&gt; Bregenz, Bregenz, Bregenz, Bregenz, Bregenz, Bregenz, Breg…</code></pre>
</div>
</div>
<ul>
<li><p>All target areas within the survey must be present within the census.</p>
<p>The <code>emdi::ebp()</code> and <code>povmap::ebp()</code> function calls will result in an error message if values in the target area variable are missing within the survey, this includes <code>NA</code> values within the survey target area column that are not in the census’ target area column.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="do">### counting the number of districts (i.e. target areas) </span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="do">### within the survey that are not a subset of the census districts. </span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="do">### When 0 is returned below: there are no areas as such</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>survey_dt <span class="sc">|&gt;</span> <span class="fu">anti_join</span>(census_dt, <span class="fu">join_by</span>(district)) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
</div>
<p>Other important data for poverty mapping include:</p>
<ul>
<li><p>A shapefile of the sub-national boundaries.</p>
<p>While a table of poverty rates would suffice, a picture is worth more than a 1000 words and as such <code>emdi</code> and <code>povmap</code> have functionality for converting the resulting estimates into a map using the <code>plot()</code> function within the <code>emdi</code> and <code>povmap</code> packages. It is essential that the target area variable in the census and survey (which by now should be consistent between the survey and census) should also match with the target area variable within the shapefile in order to use the <code>plot()</code> function within <code>emdi</code> or <code>povmap</code>.</p></li>
</ul>
<p>Once the following steps have been taken, the next stage is to prepare the set of variables for estimating a model of household welfare and predicting the consumption aggregates into the census.</p>
</section>
<section id="data-preparation-for-unit-level-model" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="data-preparation-for-unit-level-model"><span class="header-section-number">3.3</span> Data Preparation for unit level model</h2>
<p>In this section, we describe a few common techniques for creating variables with strong correlations to the outcome variable. This includes creating:</p>
<ul>
<li><p>variable interactions</p></li>
<li><p>target area average variables</p></li>
<li><p>dummy variables (at the lowest level of national representation, regional dummies, as well as other dummy variables to capture some non-linear relationships between the certain variables and the outcome variable)</p></li>
</ul>
<p>First a little bit of housekeeping is in order:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="do">### subset the set of candidate variables into a character vector</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>candidate_vars <span class="ot">&lt;-</span> survey_dt <span class="sc">|&gt;</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">any_of</span>(<span class="fu">c</span>(<span class="st">"eqIncome"</span>, <span class="st">"weight"</span>, <span class="st">"state"</span>, <span class="st">"district"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>()</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="do">### we have to ensure candidate variables are numbers:</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="do">###   (numeric or integer class)</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="do">### the only variable that does not meet this criteria is the </span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="do">### gender variable</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>survey_dt <span class="ot">&lt;-</span> survey_dt <span class="sc">|&gt;</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gender =</span> <span class="fu">ifelse</span>(gender <span class="sc">==</span> <span class="st">"female"</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>census_dt <span class="ot">&lt;-</span> census_dt <span class="sc">|&gt;</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gender =</span> <span class="fu">ifelse</span>(gender <span class="sc">==</span> <span class="st">"female"</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="creating-variable-interactions" class="level3" data-number="3.3.1">
<h3 data-number="3.3.1" class="anchored" data-anchor-id="creating-variable-interactions"><span class="header-section-number">3.3.1</span> Creating Variable Interactions</h3>
<p>The <code>create_interactions()</code> function employed in the subsequent code block interacts a specified variable <code>interacter_var</code> with a list of variables of interest <code>var_list</code>. This should be applied to both census and survey data to ensure the same variables are created in both instances.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="do">### show the function we have used to automate interactions between variables</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' A function to interact a variables with a set of variables</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param dt a data.frame</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param interacter_var the variable to be interacted</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param var_list the set of variables to interact with</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>create_interactions <span class="ot">&lt;-</span> <span class="cf">function</span>(dt, interacter_var, var_list) {</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure dt is a data.table</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="st">"data.frame"</span> <span class="sc">%in%</span> <span class="fu">class</span>(dt)) {</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    dt <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(dt)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if interacter_var exists in the dataset</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(interacter_var <span class="sc">%in%</span> <span class="fu">names</span>(dt))) {</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="fu">paste</span>(interacter_var, <span class="st">"not found in dataset"</span>))</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if var_list contains valid variables that exist in the dataset</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(<span class="sc">!</span>var_list <span class="sc">%in%</span> <span class="fu">names</span>(dt))) {</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Some variables in var_list are not found in the dataset."</span>)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create an empty data.table to store interactions</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>  int_dt <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="at">nrow =</span> <span class="fu">nrow</span>(dt)))</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop over var_list to create interaction terms</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (var <span class="cf">in</span> var_list) {</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    interaction_name <span class="ot">&lt;-</span> <span class="fu">paste0</span>(var, <span class="st">"_X_"</span>, interacter_var)</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    int_dt[[interaction_name]] <span class="ot">&lt;-</span> dt[[var]] <span class="sc">*</span> dt[[interacter_var]]</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>  int_dt <span class="ot">&lt;-</span> int_dt[, <span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(int_dt)</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>survey_dt <span class="ot">&lt;-</span> survey_dt <span class="sc">|&gt;</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">create_interactions</span>(</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">dt =</span> survey_dt,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">interacter_var =</span> <span class="st">"gender"</span>,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">var_list =</span> candidate_vars[<span class="sc">!</span>candidate_vars <span class="sc">%in%</span> <span class="st">"gender"</span>]</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span> </span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as_tibble</span>()</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>census_dt <span class="ot">&lt;-</span> census_dt <span class="sc">|&gt;</span> </span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">create_interactions</span>(</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">dt =</span> census_dt,</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">interacter_var =</span> <span class="st">"gender"</span>,</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">var_list =</span> candidate_vars[<span class="sc">!</span>candidate_vars <span class="sc">%in%</span> <span class="st">"gender"</span>]</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span> </span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as_tibble</span>()</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="computing-target-area-averages-and-regional-dummies" class="level3" data-number="3.3.2">
<h3 data-number="3.3.2" class="anchored" data-anchor-id="computing-target-area-averages-and-regional-dummies"><span class="header-section-number">3.3.2</span> Computing target area averages and regional dummies</h3>
<p>It is often useful to compute target area averages to improve the explanation of intra-area variation in the dependent variable. Below is some efficient code that employs the power of the <code>data.table</code> package to compute the averages and simultaneously include them within the census and survey datasets.</p>
<p>In addition, creating dummy variables for the lowest resolution administrative division which is also national representative may help control for some unobserved regional heterogeneity, improving model fit and prediction accuracy, capture spatial dependence in welfare patterns. In rear cases, it should be noted that dummy variables with too few observations in any class might introduce high multicollinearity</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### compute target area level averages to include in the model</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>candidate_vars <span class="ot">&lt;-</span> survey_dt <span class="sc">|&gt;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">any_of</span>(candidate_vars), <span class="fu">contains</span>(<span class="st">"_X_"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>()</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>survey_dt <span class="ot">&lt;-</span> </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  survey_dt <span class="sc">|&gt;</span> </span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(district) <span class="sc">|&gt;</span> </span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">any_of</span>(candidate_vars),</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span> <span class="fu">weighted.mean</span>(<span class="at">x =</span> ., <span class="at">w =</span> weight, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), </span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">.names =</span> <span class="st">"{.col}_targetmean"</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>census_dt <span class="ot">&lt;-</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  census_dt <span class="sc">|&gt;</span> </span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(district) <span class="sc">|&gt;</span> </span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">any_of</span>(candidate_vars),</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span> <span class="fu">weighted.mean</span>(<span class="at">x =</span> ., <span class="at">na.rm =</span> <span class="cn">TRUE</span>), </span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">.names =</span> <span class="st">"{.col}_targetmean"</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="do">#### create regional dummies</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>survey_dt <span class="ot">&lt;-</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>  survey_dt <span class="sc">|&gt;</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dummy =</span> <span class="dv">1</span>, <span class="at">state2 =</span> state) <span class="sc">|&gt;</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> state2,</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>              <span class="at">names_prefix =</span> <span class="st">"state_"</span>,</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_from =</span> dummy,</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">str_replace</span>(., <span class="st">" "</span>, <span class="st">""</span>), <span class="fu">starts_with</span>(<span class="st">"state_"</span>)) </span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>census_dt <span class="ot">&lt;-</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>  census_dt <span class="sc">|&gt;</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dummy =</span> <span class="dv">1</span>, <span class="at">state2 =</span> state) <span class="sc">|&gt;</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> state2,</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>              <span class="at">names_prefix =</span> <span class="st">"state_"</span>,</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_from =</span> dummy,</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">str_replace</span>(., <span class="st">" "</span>, <span class="st">""</span>), <span class="fu">starts_with</span>(<span class="st">"state_"</span>))</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a><span class="do">#### lets update the set of candidate variables</span></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>candidate_vars <span class="ot">&lt;-</span> survey_dt <span class="sc">|&gt;</span> </span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">any_of</span>(candidate_vars), <span class="fu">contains</span>(<span class="st">"state_"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In rear cases, it should be noted that dummy variables with too few observations in any class might introduce high multicollinearity or reduce the degrees of freedom.</p>
</section>
<section id="final-preparations-for-variable-selection" class="level3" data-number="3.3.3">
<h3 data-number="3.3.3" class="anchored" data-anchor-id="final-preparations-for-variable-selection"><span class="header-section-number">3.3.3</span> Final Preparations for Variable Selection</h3>
<p>Certain diagnostics checks ought to be performed before the variable selection process is implemented. First, we check the distribution of the non-transformed outcome variable. In the case of income or household consumption, it is typically expected and preferred that the income/household consumption variable can be transformed into a normally distributed random variable. We apply the log and boxcox transformations as seen in the code below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### let's create the set of outcome variables for the different potential</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="do">#### income transformations we might be interested in doing</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="do">###### log transformation</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>survey_dt <span class="ot">&lt;-</span> </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  survey_dt <span class="sc">|&gt;</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">logeqIncome =</span> <span class="fu">log</span>(eqIncome))</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="do">###### boxcox transformation</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="do">#### apply box-cox transformation</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>boxcox_result <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">boxcox</span>(<span class="fu">lm</span>(eqIncome <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> survey_dt), </span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>                              <span class="at">lambda =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">2</span>, <span class="at">by =</span> <span class="fl">0.1</span>))</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>lambda_opt <span class="ot">&lt;-</span> boxcox_result<span class="sc">$</span>x[<span class="fu">which.max</span>(boxcox_result<span class="sc">$</span>y)]</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Optimal Lambda:"</span>, lambda_opt, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimal Lambda: 0.3030303 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Apply the transformation manually</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (lambda_opt <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  survey_dt <span class="ot">&lt;-</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    survey_dt <span class="sc">|&gt;</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">bcxeqIncome =</span> <span class="fu">log</span>(eqIncome))</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  survey_dt <span class="ot">&lt;-</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    survey_dt <span class="sc">|&gt;</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">bcxeqIncome =</span> (eqIncome<span class="sc">^</span>lambda_opt <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">/</span> lambda_opt)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="do">#### compare the distributions of the outcome variables created</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  survey_dt <span class="sc">|&gt;</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> logeqIncome),</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">binwidth =</span> <span class="fl">0.5</span>,</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"blue"</span>,</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"black"</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Log Income Distribution"</span>) <span class="sc">+</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>  survey_dt <span class="sc">|&gt;</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> bcxeqIncome),</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">binwidth =</span> <span class="fl">0.5</span>,</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"red"</span>,</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"black"</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Box-Cox Income Distribution"</span>) <span class="sc">+</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">+</span> p2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-dist-boxcox-1" class="quarto-float quarto-figure quarto-figure-center anchored" width="768">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dist-boxcox-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="ul_files/figure-html/fig-dist-boxcox-1.png" id="fig-dist-boxcox-1" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-dist-boxcox-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.1
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display">
<div id="fig-dist-boxcox-2" class="quarto-float quarto-figure quarto-figure-center anchored" width="768">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dist-boxcox-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="ul_files/figure-html/fig-dist-boxcox-2.png" id="fig-dist-boxcox-2" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-dist-boxcox-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.2
</figcaption>
</figure>
</div>
</div>
</div>
<p>Several other transformations are also possible including the ordernorm transformation. See <code>bestNormalize::orderNorm()</code> documentation for more details.</p>
<p>Next, we ensure the candidate variables in the survey and census come from similar distributions. One assumption of the linear mixed effects approach is that the variables selected are drawn from the same distribution.</p>
<p>In the following chunk, we apply the <code>povmap::ebp_test_means()</code> function to present a table of means for each survey and census and show the results of the standard z-tests. It is common to drop values that reject the null hypothesis (at the 95% level) that the survey variable (for any given variable) has a different mean from the same variable in the census.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>test_dt <span class="ot">&lt;-</span> povmap<span class="sc">::</span><span class="fu">ebp_test_means</span>(<span class="at">varlist =</span> candidate_vars,</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">smp_data =</span> survey_dt,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">pop_data =</span> census_dt,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">weights =</span> <span class="st">"weight"</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>test_dt <span class="sc">|&gt;</span> <span class="fu">flextable</span>() <span class="sc">|&gt;</span> <span class="fu">colformat_double</span>(<span class="at">big.mark =</span> <span class="st">""</span>, <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="tbl-means-eqivalence" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl quarto-uncaptioned" id="tbl-means-eqivalence-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3.1
</figcaption>
<div aria-describedby="tbl-means-eqivalence-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div class="tabwid"><style>.cl-b0af1bba{}.cl-afbd682e{font-family:'Arial';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-b0a361a8{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-b0a361bc{margin:0;text-align:right;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-b0a39c86{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b0a39c90{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b0a39c91{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b0a39c9a{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b0a39c9b{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b0a39ca4{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}</style><table data-quarto-disable-processing="true" class="cl-b0af1bba"><thead><tr style="overflow-wrap:break-word;"><th class="cl-b0a39c86"><p class="cl-b0a361a8"><span class="cl-afbd682e">variable</span></p></th><th class="cl-b0a39c90"><p class="cl-b0a361bc"><span class="cl-afbd682e">smp_means</span></p></th><th class="cl-b0a39c90"><p class="cl-b0a361bc"><span class="cl-afbd682e">pop_means</span></p></th><th class="cl-b0a39c90"><p class="cl-b0a361bc"><span class="cl-afbd682e">diff</span></p></th><th class="cl-b0a39c90"><p class="cl-b0a361bc"><span class="cl-afbd682e">pvalue</span></p></th></tr></thead><tbody><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">age_ben</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">5478.610</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">5304.057</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">-174.553</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.990</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">age_ben_X_gender</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">2550.185</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">2369.536</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">-180.649</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.984</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">cap_inv</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">487.266</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">456.851</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">-30.414</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.994</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">cap_inv_X_gender</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">215.913</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">205.825</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">-10.088</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.997</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">cash</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">12712.233</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">12706.449</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">-5.784</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">1.000</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">cash_X_gender</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">2982.124</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">3379.769</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">397.645</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.972</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">dis_ben</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">523.440</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">542.326</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">18.885</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.997</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">dis_ben_X_gender</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">227.350</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">257.057</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">29.707</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.991</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">eqsize</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">1.610</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">1.603</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">-0.007</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.994</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">eqsize_X_gender</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.509</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.539</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.030</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.977</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">fam_allow</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">1617.488</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">1624.958</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">7.470</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.999</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">fam_allow_X_gender</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">442.459</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">506.068</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">63.609</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.983</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">gender</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.372</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.391</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.019</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.978</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">house_allow</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">61.820</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">65.414</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">3.594</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.995</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">house_allow_X_gender</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">26.149</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">23.319</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">-2.830</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.993</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">rent</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">608.004</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">770.358</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">162.353</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.986</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">rent_X_gender</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">184.389</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">387.367</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">202.978</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.973</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">self_empl</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">2039.125</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">1966.965</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">-72.160</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.995</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">self_empl_X_gender</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">413.684</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">495.885</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">82.201</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.987</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">sick_ben</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">61.837</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">67.451</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">5.614</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.996</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">sick_ben_X_gender</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">31.423</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">21.924</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">-9.499</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.987</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">state_Burgenland</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.013</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.032</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.019</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.929</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">state_Carinthia</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.068</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.069</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.001</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.999</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">state_LowerAustria</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.166</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.185</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.019</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.972</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">state_Salzburg</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.070</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.067</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">-0.003</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.993</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">state_Styria</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.144</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.135</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">-0.008</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.987</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">state_Tyrol</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.073</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.076</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.002</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.995</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">state_UpperAustria</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.168</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.163</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">-0.005</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.992</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">state_Vienna</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.255</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.234</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">-0.020</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.974</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">state_Vorarlberg</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.043</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.039</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">-0.003</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.990</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">surv_ben</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">61.918</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">88.952</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">27.035</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.984</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">surv_ben_X_gender</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">24.142</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">44.821</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">20.679</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.982</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">tax_adj</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">-76.558</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">-82.540</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">-5.982</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.998</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">tax_adj_X_gender</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">-18.444</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">-31.138</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">-12.694</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.994</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c91"><p class="cl-b0a361a8"><span class="cl-afbd682e">unempl_ben</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">463.508</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">429.382</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">-34.126</span></p></td><td class="cl-b0a39c9a"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.990</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b0a39c9b"><p class="cl-b0a361a8"><span class="cl-afbd682e">unempl_ben_X_gender</span></p></td><td class="cl-b0a39ca4"><p class="cl-b0a361bc"><span class="cl-afbd682e">207.672</span></p></td><td class="cl-b0a39ca4"><p class="cl-b0a361bc"><span class="cl-afbd682e">178.941</span></p></td><td class="cl-b0a39ca4"><p class="cl-b0a361bc"><span class="cl-afbd682e">-28.730</span></p></td><td class="cl-b0a39ca4"><p class="cl-b0a361bc"><span class="cl-afbd682e">0.987</span></p></td></tr></tbody></table></div>
</div>
</div>
</figure>
</div>
</div>
<p>However, the <code>ebp_test_means</code> function doesn’t control for the fact that the variables are national representative at the state level. We implement another variant to the <code>ebp_test_means</code> that will allow users to cluster the standard errors at the state level.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Perform test for difference between survey and census means </span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function computes weighted means of the same set of variables within the census and survey controlling for a cluster level. A test for </span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' difference of the means are performed for each variable with two-tailed p-values returned and the cluster level has to be specified for the</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' estimation of variance</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param varlist character vector, the set of variables of interest</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param smp_data the survey data</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param pop_data the population data</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param weights a character string containing the name of a variable that indicates weights in the sample data. If a character string is </span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' provided a weighted version of the ebp will be used.</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param pop_weights a character string containing the name of a variable that indicates population weights in the population data. If a </span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co">#' If a character string is provided weighted indicators are estimated using population weights. The variable has to be numeric. </span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="co">#' Defaults to NULL. </span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="co">#' @import survey</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>ebp_test_means_clustered <span class="ot">&lt;-</span> <span class="cf">function</span>(varlist, </span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>                                     smp_data, </span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>                                     pop_data, </span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>                                     cluster, </span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">weights =</span> <span class="cn">NULL</span>, </span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">pop_weights =</span> <span class="cn">NULL</span>) {</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(weights)) {</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    smp_data<span class="sc">$</span>weights <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(smp_data))</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    weights <span class="ot">&lt;-</span> <span class="st">"weights"</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(pop_weights)) {</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    pop_data<span class="sc">$</span>pop_weights <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(pop_data))</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    pop_weights <span class="ot">&lt;-</span> <span class="st">"pop_weights"</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>    pop_data<span class="sc">$</span>pop_weights <span class="ot">&lt;-</span> pop_data[[pop_weights]]</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>  smp_df <span class="ot">&lt;-</span> smp_data[<span class="fu">complete.cases</span>(smp_data[, <span class="fu">c</span>(varlist, weights, cluster)]), <span class="fu">c</span>(varlist, weights, cluster)]</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>  pop_df <span class="ot">&lt;-</span> pop_data[<span class="fu">complete.cases</span>(pop_data[, <span class="fu">c</span>(varlist, <span class="st">"pop_weights"</span>, cluster)]), <span class="fu">c</span>(varlist, <span class="st">"pop_weights"</span>, cluster)]</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>  smp_df <span class="ot">&lt;-</span> smp_df <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">all_of</span>(varlist), as.numeric))</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>  pop_df <span class="ot">&lt;-</span> pop_df <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">all_of</span>(varlist), as.numeric))</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define survey design with clustering</span></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>  smp_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">id =</span> <span class="sc">~</span><span class="fu">get</span>(cluster), <span class="at">weights =</span> <span class="sc">~</span><span class="fu">get</span>(weights), <span class="at">data =</span> smp_df)</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>  pop_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">id =</span> <span class="sc">~</span><span class="fu">get</span>(cluster), <span class="at">weights =</span> <span class="sc">~</span>pop_weights, <span class="at">data =</span> pop_df)</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>  smp_means_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">smp_means =</span> <span class="fu">sapply</span>(varlist, <span class="cf">function</span>(var) <span class="fu">svymean</span>(<span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="st">"~"</span>, var)), smp_design)[<span class="dv">1</span>]),</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">smp_se =</span> <span class="fu">sapply</span>(varlist, <span class="cf">function</span>(var) <span class="fu">SE</span>(<span class="fu">svymean</span>(<span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="st">"~"</span>, var)), smp_design))),</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">variable =</span> varlist</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>  pop_means_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_means =</span> <span class="fu">sapply</span>(varlist, <span class="cf">function</span>(var) <span class="fu">svymean</span>(<span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="st">"~"</span>, var)), pop_design)[<span class="dv">1</span>]),</span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_se =</span> <span class="fu">sapply</span>(varlist, <span class="cf">function</span>(var) <span class="fu">SE</span>(<span class="fu">svymean</span>(<span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="st">"~"</span>, var)), pop_design))),</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">variable =</span> varlist</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>  means_df <span class="ot">&lt;-</span> <span class="fu">merge</span>(smp_means_df, pop_means_df, <span class="at">by =</span> <span class="st">"variable"</span>)</span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>  means_df<span class="sc">$</span>diff <span class="ot">&lt;-</span> means_df<span class="sc">$</span>pop_means <span class="sc">-</span> means_df<span class="sc">$</span>smp_means</span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>  means_df<span class="sc">$</span>diff_se <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(means_df<span class="sc">$</span>smp_se<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> means_df<span class="sc">$</span>pop_se<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>  means_df<span class="sc">$</span>zscore <span class="ot">&lt;-</span> means_df<span class="sc">$</span>diff <span class="sc">/</span> means_df<span class="sc">$</span>diff_se</span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>  means_df<span class="sc">$</span>pvalue <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">pnorm</span>(<span class="fu">abs</span>(means_df<span class="sc">$</span>zscore)))</span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(means_df[, <span class="fu">c</span>(<span class="st">"variable"</span>, <span class="st">"smp_means"</span>, <span class="st">"pop_means"</span>, <span class="st">"diff"</span>, <span class="st">"pvalue"</span>)])</span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>test_dt <span class="ot">&lt;-</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ebp_test_means_clustered</span>(</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">varlist =</span> candidate_vars,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">smp_data =</span> survey_dt,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_data =</span> census_dt,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">cluster =</span> <span class="st">"state"</span>,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> <span class="st">"weight"</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>test_dt <span class="sc">|&gt;</span> <span class="fu">flextable</span>() <span class="sc">|&gt;</span> <span class="fu">colformat_double</span>(<span class="at">big.mark =</span> <span class="st">""</span>, <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="tbl-mean-eq-clustered" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl quarto-uncaptioned" id="tbl-mean-eq-clustered-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3.2
</figcaption>
<div aria-describedby="tbl-mean-eq-clustered-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div class="tabwid"><style>.cl-b333c584{}.cl-b324f95a{font-family:'Arial';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-b32bba2e{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-b32bba38{margin:0;text-align:right;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-b32bec42{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b32bec56{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b32bec6a{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b32bec74{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b32bec7e{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b32bec92{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}</style><table data-quarto-disable-processing="true" class="cl-b333c584"><thead><tr style="overflow-wrap:break-word;"><th class="cl-b32bec42"><p class="cl-b32bba2e"><span class="cl-b324f95a">variable</span></p></th><th class="cl-b32bec56"><p class="cl-b32bba38"><span class="cl-b324f95a">smp_means</span></p></th><th class="cl-b32bec56"><p class="cl-b32bba38"><span class="cl-b324f95a">pop_means</span></p></th><th class="cl-b32bec56"><p class="cl-b32bba38"><span class="cl-b324f95a">diff</span></p></th><th class="cl-b32bec56"><p class="cl-b32bba38"><span class="cl-b324f95a">pvalue</span></p></th></tr></thead><tbody><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">age_ben</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">5478.610</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">5304.057</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">-174.553</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.550</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">age_ben_X_gender</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">2550.185</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">2369.536</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">-180.649</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.387</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">cap_inv</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">487.266</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">456.851</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">-30.414</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.726</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">cap_inv_X_gender</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">215.913</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">205.825</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">-10.088</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.829</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">cash</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">12712.233</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">12706.449</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">-5.784</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.991</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">cash_X_gender</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">2982.124</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">3379.769</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">397.645</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.261</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">dis_ben</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">523.440</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">542.326</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">18.885</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.786</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">dis_ben_X_gender</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">227.350</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">257.057</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">29.707</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.346</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">eqsize</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">1.610</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">1.603</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">-0.007</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.915</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">eqsize_X_gender</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.509</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.539</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.030</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.353</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">fam_allow</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">1617.488</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">1624.958</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">7.470</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.973</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">fam_allow_X_gender</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">442.459</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">506.068</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">63.609</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.210</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">gender</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.372</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.391</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.019</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.524</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">house_allow</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">61.820</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">65.414</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">3.594</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.717</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">house_allow_X_gender</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">26.149</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">23.319</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">-2.830</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.763</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">rent</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">608.004</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">770.358</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">162.353</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.418</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">rent_X_gender</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">184.389</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">387.367</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">202.978</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.078</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">self_empl</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">2039.125</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">1966.965</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">-72.160</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.728</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">self_empl_X_gender</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">413.684</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">495.885</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">82.201</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.356</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">sick_ben</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">61.837</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">67.451</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">5.614</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.687</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">sick_ben_X_gender</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">31.423</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">21.924</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">-9.499</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.249</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">state_Burgenland</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.013</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.032</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.019</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.626</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">state_Carinthia</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.068</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.069</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.001</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.996</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">state_LowerAustria</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.166</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.185</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.019</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.935</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">state_Salzburg</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.070</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.067</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">-0.003</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.977</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">state_Styria</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.144</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.135</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">-0.008</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.966</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">state_Tyrol</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.073</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.076</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.002</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.985</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">state_UpperAustria</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.168</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.163</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">-0.005</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.981</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">state_Vienna</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.255</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.234</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">-0.020</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.946</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">state_Vorarlberg</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.043</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.039</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">-0.003</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.957</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">surv_ben</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">61.918</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">88.952</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">27.035</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.357</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">surv_ben_X_gender</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">24.142</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">44.821</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">20.679</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.138</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">tax_adj</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">-76.558</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">-82.540</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">-5.982</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.844</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">tax_adj_X_gender</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">-18.444</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">-31.138</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">-12.694</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.659</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec6a"><p class="cl-b32bba2e"><span class="cl-b324f95a">unempl_ben</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">463.508</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">429.382</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">-34.126</span></p></td><td class="cl-b32bec74"><p class="cl-b32bba38"><span class="cl-b324f95a">0.678</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b32bec7e"><p class="cl-b32bba2e"><span class="cl-b324f95a">unempl_ben_X_gender</span></p></td><td class="cl-b32bec92"><p class="cl-b32bba38"><span class="cl-b324f95a">207.672</span></p></td><td class="cl-b32bec92"><p class="cl-b32bba38"><span class="cl-b324f95a">178.941</span></p></td><td class="cl-b32bec92"><p class="cl-b32bba38"><span class="cl-b324f95a">-28.730</span></p></td><td class="cl-b32bec92"><p class="cl-b32bba38"><span class="cl-b324f95a">0.514</span></p></td></tr></tbody></table></div>
</div>
</div>
</figure>
</div>
</div>
<p>In the next section, we fold the final checks into the variable selection process. We drop variables that are highly correlated and set a sparsity threshold. The sparsity threshold ensures that variables that do not have a certain proportion of non-missing observations are dropped. We have folded both these checks into the <code>glmnetlasso_vselect()</code> function.</p>
</section>
</section>
<section id="the-variable-selection-process" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="the-variable-selection-process"><span class="header-section-number">3.4</span> The Variable Selection Process</h2>
<p>The <code>glmnetlasso_vselect()</code> function takes the dependent variable (welfare or income variable) as well as the set of potential candidate variables which just created and applies the lasso methodology (run <code>here(glmnet::glmnet)</code> for more details). This includes the option to perform a reproducible n-fold cross validation to reduce the risk of overfitting the model. In this instance, we have run applied this function to select the best predictors of household welfare based on the 3 welfare transformations i.e.&nbsp;3 separate runs of the function, one for each transformation. See below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' A function for variable selection using the GLMNET R package</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function acts as a wrapper to the GLMNET R package which performs variable selection with nfold cross validation. </span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @details This function cleans the data `dt` first by standardizing the predictors, dropping columns with missing values, very low variance (near</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' zero variance), highly correlated variables based on a certain `correlation_threshold`. The function also drops variables with an high percentage #' of zeros based on a `sparsity_threshold`. It then fits the lasso regression with the GLMNET package before returning the best combination of</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' predictive variables based on the `lambda_type` selection criteria. </span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param dt data.frame or data.table</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param candidate_vars character, the set of potential predictors within `dt`</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param y character, the variable name of the outcome variable within `dt`</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param weights character, weight variable name</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param alpha integer, 1 for LASSO and 0 for ridge regression</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param nfolds integer, the number of cross fold validations to perform</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param seed integer, randomization seed </span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param lambda_type, either "lambda.min" or "lambda.1se". see `glmnet::glmnet()` for more information</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param correlation_threshold numeric, the threshold for dropping correlated variables (value between 0 and 1)</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param variance_threshold numeric, threshold for dropping variables that appear almost constant by specifying a minimum variance that must be met</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param sparsity_threshold numeric, threshold for dropping sparse variables</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="co">#' @import glmnet </span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom caret findCorrelation</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>glmnetlasso_vselect <span class="ot">&lt;-</span> <span class="cf">function</span>(dt, </span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>                                candidate_vars, </span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>                                y, </span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>                                weights, </span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>                                <span class="at">alpha =</span> <span class="dv">1</span>, </span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>                                nfolds, </span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>                                <span class="at">seed =</span> <span class="dv">123</span>,</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>                                <span class="at">lambda_type =</span> <span class="st">"lambda.min"</span>,</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>                                <span class="at">correlation_threshold =</span> <span class="fl">0.9</span>, <span class="co"># Threshold for dropping correlated variables</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>                                <span class="at">variance_threshold =</span> <span class="fl">1e-4</span>,</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>                                <span class="at">sparsity_threshold =</span> <span class="fl">0.99</span>,<span class="co"># Threshold for dropping sparse variables</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>                                ...) {</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load necessary library</span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"glmnet"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"The glmnet package is required. Please install it."</span>)</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"caret"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(<span class="st">"caret"</span>)</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure reproducibility</span></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Standardize predictors</span></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>  X_scaled <span class="ot">&lt;-</span> <span class="fu">scale</span>(dt[, candidate_vars])</span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> dt[[y]]</span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>  weights <span class="ot">&lt;-</span> dt[[weights]]</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Drop any columns with missing values in X_scaled</span></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>  X_scaled <span class="ot">&lt;-</span> X_scaled[, <span class="fu">colSums</span>(<span class="fu">is.na</span>(X_scaled)) <span class="sc">==</span> <span class="dv">0</span>]</span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Drop variables with very low variance</span></span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>  variances <span class="ot">&lt;-</span> <span class="fu">apply</span>(X_scaled, <span class="dv">2</span>, var)</span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>  X_scaled <span class="ot">&lt;-</span> X_scaled[, variances <span class="sc">&gt;</span> variance_threshold]</span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Drop highly correlated variables</span></span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>  correlation_matrix <span class="ot">&lt;-</span> <span class="fu">cor</span>(X_scaled)</span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>  high_corr <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">findCorrelation</span>(correlation_matrix, </span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">cutoff =</span> correlation_threshold, </span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(high_corr) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>    X_scaled <span class="ot">&lt;-</span> X_scaled[, <span class="sc">-</span>high_corr]</span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Identify and drop variables with 99% or more zeros</span></span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate proportion of zeros for each column</span></span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a>  proportion_zeros <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(X_scaled <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter out columns where proportion of zeros is above the threshold</span></span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a>  X_scaled <span class="ot">&lt;-</span> X_scaled[, proportion_zeros <span class="sc">&lt;</span> sparsity_threshold]</span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for problematic values</span></span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">anyNA</span>(X_scaled) <span class="sc">||</span> <span class="fu">any</span>(<span class="fu">is.infinite</span>(X_scaled)) <span class="sc">||</span> <span class="fu">any</span>(<span class="fu">is.nan</span>(X_scaled))) {</span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Predictor matrix contains NA, Inf, or NaN values."</span>)</span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(weights <span class="sc">&lt;=</span> <span class="dv">0</span>)) {</span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Weights contain non-positive values."</span>)</span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-86"><a href="#cb17-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-87"><a href="#cb17-87" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit lasso model with cross-validation</span></span>
<span id="cb17-88"><a href="#cb17-88" aria-hidden="true" tabindex="-1"></a>  cv_model <span class="ot">&lt;-</span> glmnet<span class="sc">::</span><span class="fu">cv.glmnet</span>(</span>
<span id="cb17-89"><a href="#cb17-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> X_scaled,</span>
<span id="cb17-90"><a href="#cb17-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> y,</span>
<span id="cb17-91"><a href="#cb17-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> weights,</span>
<span id="cb17-92"><a href="#cb17-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> alpha,  <span class="co"># alpha = 1 for lasso, 0 &lt; alpha &lt; 1 for elastic net</span></span>
<span id="cb17-93"><a href="#cb17-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">nfolds =</span> nfolds,</span>
<span id="cb17-94"><a href="#cb17-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">"gaussian"</span>, <span class="co"># Change to "binomial" or "poisson" for other models</span></span>
<span id="cb17-95"><a href="#cb17-95" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb17-96"><a href="#cb17-96" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-97"><a href="#cb17-97" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-98"><a href="#cb17-98" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract coefficients at the lambda with minimum cross-validated error</span></span>
<span id="cb17-99"><a href="#cb17-99" aria-hidden="true" tabindex="-1"></a>  selected_model <span class="ot">&lt;-</span> glmnet<span class="sc">::</span><span class="fu">glmnet</span>(</span>
<span id="cb17-100"><a href="#cb17-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> X_scaled,</span>
<span id="cb17-101"><a href="#cb17-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> y,</span>
<span id="cb17-102"><a href="#cb17-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> weights,</span>
<span id="cb17-103"><a href="#cb17-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> alpha,</span>
<span id="cb17-104"><a href="#cb17-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">lambda =</span> cv_model[[lambda_type]],</span>
<span id="cb17-105"><a href="#cb17-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">"gaussian"</span>,</span>
<span id="cb17-106"><a href="#cb17-106" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb17-107"><a href="#cb17-107" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-108"><a href="#cb17-108" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-109"><a href="#cb17-109" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Identify selected variables</span></span>
<span id="cb17-110"><a href="#cb17-110" aria-hidden="true" tabindex="-1"></a>  selected_variables <span class="ot">&lt;-</span> <span class="fu">rownames</span>(<span class="fu">as.matrix</span>(<span class="fu">coef</span>(selected_model)))[<span class="fu">as.matrix</span>(<span class="fu">coef</span>(selected_model)) <span class="sc">!=</span> <span class="dv">0</span>]</span>
<span id="cb17-111"><a href="#cb17-111" aria-hidden="true" tabindex="-1"></a>  selected_variables <span class="ot">&lt;-</span> selected_variables[selected_variables <span class="sc">!=</span> <span class="st">"(Intercept)"</span>]</span>
<span id="cb17-112"><a href="#cb17-112" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-113"><a href="#cb17-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(selected_variables)</span>
<span id="cb17-114"><a href="#cb17-114" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-115"><a href="#cb17-115" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-116"><a href="#cb17-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-117"><a href="#cb17-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-118"><a href="#cb17-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-119"><a href="#cb17-119" aria-hidden="true" tabindex="-1"></a><span class="do">#### lets call this function to model selection for each transformation</span></span>
<span id="cb17-120"><a href="#cb17-120" aria-hidden="true" tabindex="-1"></a>notglmnet_list <span class="ot">&lt;-</span> </span>
<span id="cb17-121"><a href="#cb17-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glmnetlasso_vselect</span>(<span class="at">dt =</span> survey_dt,</span>
<span id="cb17-122"><a href="#cb17-122" aria-hidden="true" tabindex="-1"></a>                      <span class="at">candidate_vars =</span> candidate_vars,</span>
<span id="cb17-123"><a href="#cb17-123" aria-hidden="true" tabindex="-1"></a>                      <span class="at">y =</span> <span class="st">"eqIncome"</span>,</span>
<span id="cb17-124"><a href="#cb17-124" aria-hidden="true" tabindex="-1"></a>                      <span class="at">weights =</span> <span class="st">"weight"</span>,</span>
<span id="cb17-125"><a href="#cb17-125" aria-hidden="true" tabindex="-1"></a>                      <span class="at">nfolds =</span> <span class="dv">10</span>,</span>
<span id="cb17-126"><a href="#cb17-126" aria-hidden="true" tabindex="-1"></a>                      <span class="at">seed =</span> <span class="dv">123</span>,</span>
<span id="cb17-127"><a href="#cb17-127" aria-hidden="true" tabindex="-1"></a>                      <span class="at">lambda_type =</span> <span class="st">"lambda.1se"</span>,</span>
<span id="cb17-128"><a href="#cb17-128" aria-hidden="true" tabindex="-1"></a>                      <span class="at">sparsity_threshold =</span> <span class="fl">0.99</span>)</span>
<span id="cb17-129"><a href="#cb17-129" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb17-130"><a href="#cb17-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-131"><a href="#cb17-131" aria-hidden="true" tabindex="-1"></a>logglmnet_list <span class="ot">&lt;-</span> </span>
<span id="cb17-132"><a href="#cb17-132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glmnetlasso_vselect</span>(<span class="at">dt =</span> survey_dt,</span>
<span id="cb17-133"><a href="#cb17-133" aria-hidden="true" tabindex="-1"></a>                      <span class="at">candidate_vars =</span> candidate_vars,</span>
<span id="cb17-134"><a href="#cb17-134" aria-hidden="true" tabindex="-1"></a>                      <span class="at">y =</span> <span class="st">"logeqIncome"</span>,</span>
<span id="cb17-135"><a href="#cb17-135" aria-hidden="true" tabindex="-1"></a>                      <span class="at">weights =</span> <span class="st">"weight"</span>,</span>
<span id="cb17-136"><a href="#cb17-136" aria-hidden="true" tabindex="-1"></a>                      <span class="at">nfolds =</span> <span class="dv">10</span>,</span>
<span id="cb17-137"><a href="#cb17-137" aria-hidden="true" tabindex="-1"></a>                      <span class="at">seed =</span> <span class="dv">123</span>,</span>
<span id="cb17-138"><a href="#cb17-138" aria-hidden="true" tabindex="-1"></a>                      <span class="at">lambda_type =</span> <span class="st">"lambda.1se"</span>,</span>
<span id="cb17-139"><a href="#cb17-139" aria-hidden="true" tabindex="-1"></a>                      <span class="at">sparsity_threshold =</span> <span class="fl">0.99</span>)</span>
<span id="cb17-140"><a href="#cb17-140" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb17-141"><a href="#cb17-141" aria-hidden="true" tabindex="-1"></a>bcxglmnet_list <span class="ot">&lt;-</span> </span>
<span id="cb17-142"><a href="#cb17-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glmnetlasso_vselect</span>(<span class="at">dt =</span> survey_dt,</span>
<span id="cb17-143"><a href="#cb17-143" aria-hidden="true" tabindex="-1"></a>                      <span class="at">candidate_vars =</span> candidate_vars,</span>
<span id="cb17-144"><a href="#cb17-144" aria-hidden="true" tabindex="-1"></a>                      <span class="at">y =</span> <span class="st">"bcxeqIncome"</span>,</span>
<span id="cb17-145"><a href="#cb17-145" aria-hidden="true" tabindex="-1"></a>                      <span class="at">weights =</span> <span class="st">"weight"</span>,</span>
<span id="cb17-146"><a href="#cb17-146" aria-hidden="true" tabindex="-1"></a>                      <span class="at">nfolds =</span> <span class="dv">10</span>,</span>
<span id="cb17-147"><a href="#cb17-147" aria-hidden="true" tabindex="-1"></a>                      <span class="at">seed =</span> <span class="dv">123</span>,</span>
<span id="cb17-148"><a href="#cb17-148" aria-hidden="true" tabindex="-1"></a>                      <span class="at">lambda_type =</span> <span class="st">"lambda.1se"</span>,</span>
<span id="cb17-149"><a href="#cb17-149" aria-hidden="true" tabindex="-1"></a>                      <span class="at">sparsity_threshold =</span> <span class="fl">0.99</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we have selected variables for each outcome variable transformation. We are ready to apply this <code>povmap::ebp()</code> to estimate a poverty map for Austria. The function will estimate a linear mixed effects model of the income in Austria from which the poverty line will be applied to estimate the poverty rates. Please run <code>help(povmap::ebp)</code> for details about the structure of the resulting object produced.</p>
<p>For the proper functioning of the <code>povmap::ebp</code> function, the following conditions must be met:</p>
<ul>
<li><p>the arguments <code>pop_data</code> and <code>smp_data</code> require the survey and census datasets must be of class <code>data.frame</code>.</p></li>
<li><p><code>pop_data</code> and <code>smp_data</code> must contain no missing observations across all the variables. Use the <code>na.omit()</code> function to ensure only complete cases are included within each object.</p></li>
<li><p>All target areas (or domains) within the <code>smp_domains</code> must be found within <code>pop_domains</code> i.e.&nbsp;for the Austria example, all domains/target areas in the survey must be found in the census.</p></li>
<li><p><code>rescale_weights</code> argument set to TRUE may solve parameter estimation convergence issues. This is not available within the <code>emdi::ebp()</code> function.</p></li>
<li><p>Notice the specification of the <code>Ydump</code> argument. This is one difference between the <code>emdi::ebp()</code> and <code>povmap::ebp()</code>. This argument returns the result of <code>L</code> unit-level welfare simulated predictions from which other poverty estimations maybe carried out, as different from the default results present within <code>ebp</code> class object returned by <code>ebp()</code>.</p></li>
<li><p>Also noteworthy, is the use of the <code>weight_type</code> argument present within the <code>povmap::ebp()</code> but not in the <code>emdi::ebp()</code>. Please see documentation for more details.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>fldr_temp <span class="ot">&lt;-</span> <span class="st">"data-temp"</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">file.path</span>(fldr_temp, <span class="st">"Ydump"</span>) <span class="sc">|&gt;</span> <span class="fu">dir.create</span>(<span class="at">recursive =</span> T, <span class="at">showWarnings =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># using the ebp function to first estimate into the household survey. </span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># We need to see how well the model will estimate poverty first into </span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"># the training set i.e. the household survey. this helps to check the</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># quality of in-sample estimation without any potential prediction bias</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>model_formula <span class="ot">&lt;-</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="st">"eqIncome ~ "</span>, <span class="fu">paste</span>(logglmnet_list, <span class="at">collapse =</span> <span class="st">" + "</span>)) <span class="sc">|&gt;</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.formula</span>()</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>log_smodel <span class="ot">&lt;-</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  povmap<span class="sc">::</span><span class="fu">ebp</span>(</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">fixed =</span> model_formula,</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_data =</span> survey_dt[, <span class="fu">c</span>(logglmnet_list, <span class="st">"district"</span>)],</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_domains =</span> <span class="st">"district"</span>,</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">smp_data =</span> survey_dt[, <span class="fu">c</span>(<span class="st">"eqIncome"</span>, logglmnet_list, <span class="st">"district"</span>, <span class="st">"weight"</span>)],</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">smp_domains =</span> <span class="st">"district"</span>,</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">MSE =</span> <span class="cn">TRUE</span>,</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">threshold =</span> <span class="fl">18207.2</span>,</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">transformation =</span> <span class="st">"log"</span>,</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">B =</span> <span class="dv">50</span>,</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">L =</span> <span class="dv">50</span>,</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> <span class="st">"weight"</span>,</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">rescale_weights =</span> <span class="cn">TRUE</span>,</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ydump =</span> <span class="fu">file.path</span>(fldr_temp, <span class="st">"Ydump/unitsurvey_logYdump_glmnet.csv"</span>),</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">cpus =</span> <span class="dv">30</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(log_smodel, <span class="fu">file.path</span>(fldr_temp, <span class="st">"log_surveymodel.RDS"</span>))</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>model_formula <span class="ot">&lt;-</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="st">"eqIncome ~ "</span>, <span class="fu">paste</span>(bcxglmnet_list, <span class="at">collapse =</span> <span class="st">" + "</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.formula</span>()</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>bcx_smodel <span class="ot">&lt;-</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>  povmap<span class="sc">::</span><span class="fu">ebp</span>(</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">fixed =</span> model_formula,</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_data =</span> survey_dt[, <span class="fu">c</span>(bcxglmnet_list, <span class="st">"district"</span>)],</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_domains =</span> <span class="st">"district"</span>,</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">smp_data =</span> survey_dt[, <span class="fu">c</span>(bcxglmnet_list, <span class="st">"district"</span>, <span class="st">"eqIncome"</span>, <span class="st">"weight"</span>)],</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">smp_domains =</span> <span class="st">"district"</span>,</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">MSE =</span> <span class="cn">TRUE</span>,</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">threshold =</span> <span class="fl">18207.2</span>,</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">transformation =</span> <span class="st">"box.cox"</span>,</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">B =</span> <span class="dv">50</span>,</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">L =</span> <span class="dv">50</span>,</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> <span class="st">"weight"</span>,</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">rescale_weights =</span> <span class="cn">TRUE</span>,</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ydump =</span> <span class="fu">file.path</span>(fldr_temp, <span class="st">"Ydump/unitsurvey_bcxYdump_glmnet.csv"</span>),</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">cpus =</span> <span class="dv">30</span>,</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights_type =</span> <span class="st">"nlme_lambda"</span></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(bcx_smodel, <span class="fu">file.path</span>(fldr_temp, <span class="st">"bcx_surveymodel.RDS"</span>))</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>model_formula <span class="ot">&lt;-</span> </span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="st">"eqIncome ~ "</span>, <span class="fu">paste</span>(notglmnet_list, <span class="at">collapse =</span> <span class="st">" + "</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.formula</span>()</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>not_smodel <span class="ot">&lt;-</span></span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>  povmap<span class="sc">::</span><span class="fu">ebp</span>(</span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">fixed =</span> model_formula,</span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_data =</span> survey_dt[, <span class="fu">c</span>(notglmnet_list, <span class="st">"district"</span>)],</span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_domains =</span> <span class="st">"district"</span>,</span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">smp_data =</span> survey_dt[, <span class="fu">c</span>(notglmnet_list, <span class="st">"district"</span>, <span class="st">"eqIncome"</span>, <span class="st">"weight"</span>)],</span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">smp_domains =</span> <span class="st">"district"</span>,</span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">MSE =</span> <span class="cn">TRUE</span>,</span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">threshold =</span> <span class="fl">18207.2</span>,</span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">transformation =</span> <span class="st">"no"</span>,</span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">B =</span> <span class="dv">50</span>,</span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">L =</span> <span class="dv">50</span>,</span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> <span class="st">"weight"</span>,</span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">rescale_weights =</span> <span class="cn">TRUE</span>,</span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ydump =</span> <span class="st">"data/Ydump/unitsurvey_notYdump_glmnet.csv"</span>,</span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">cpus =</span> <span class="dv">30</span></span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(not_smodel, <span class="fu">file.path</span>(fldr_temp, <span class="st">"not_surveymodel.RDS"</span>))</span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a><span class="do">### then we actually estimate the census level estimation</span></span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a>model_formula <span class="ot">&lt;-</span> </span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="st">"eqIncome ~ "</span>, <span class="fu">paste</span>(logglmnet_list, <span class="at">collapse =</span> <span class="st">" + "</span>)) <span class="sc">|&gt;</span></span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.formula</span>()</span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a>log_model <span class="ot">&lt;-</span></span>
<span id="cb19-85"><a href="#cb19-85" aria-hidden="true" tabindex="-1"></a>  povmap<span class="sc">::</span><span class="fu">ebp</span>(</span>
<span id="cb19-86"><a href="#cb19-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">fixed =</span> model_formula,</span>
<span id="cb19-87"><a href="#cb19-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_data =</span> census_dt[, <span class="fu">c</span>(logglmnet_list, <span class="st">"district"</span>)],</span>
<span id="cb19-88"><a href="#cb19-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_domains =</span> <span class="st">"district"</span>,</span>
<span id="cb19-89"><a href="#cb19-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">smp_data =</span> survey_dt[, <span class="fu">c</span>(<span class="st">"eqIncome"</span>, logglmnet_list, <span class="st">"district"</span>, <span class="st">"weight"</span>)],</span>
<span id="cb19-90"><a href="#cb19-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">smp_domains =</span> <span class="st">"district"</span>,</span>
<span id="cb19-91"><a href="#cb19-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">MSE =</span> <span class="cn">TRUE</span>,</span>
<span id="cb19-92"><a href="#cb19-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">threshold =</span> <span class="fl">18207.2</span>,</span>
<span id="cb19-93"><a href="#cb19-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">transformation =</span> <span class="st">"log"</span>,</span>
<span id="cb19-94"><a href="#cb19-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">B =</span> <span class="dv">50</span>,</span>
<span id="cb19-95"><a href="#cb19-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">L =</span> <span class="dv">50</span>,</span>
<span id="cb19-96"><a href="#cb19-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> <span class="st">"weight"</span>,</span>
<span id="cb19-97"><a href="#cb19-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">rescale_weights =</span> <span class="cn">TRUE</span>,</span>
<span id="cb19-98"><a href="#cb19-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ydump =</span> <span class="fu">file.path</span>(fldr_temp, <span class="st">"Ydump/unitcensus_logYdump_glmnet.csv"</span>),</span>
<span id="cb19-99"><a href="#cb19-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">cpus =</span> <span class="dv">30</span></span>
<span id="cb19-100"><a href="#cb19-100" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb19-101"><a href="#cb19-101" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(log_model, <span class="fu">file.path</span>(fldr_temp, <span class="st">"log_censusmodel.RDS"</span>))</span>
<span id="cb19-102"><a href="#cb19-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-103"><a href="#cb19-103" aria-hidden="true" tabindex="-1"></a>model_formula <span class="ot">&lt;-</span></span>
<span id="cb19-104"><a href="#cb19-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="st">"eqIncome ~ "</span>, <span class="fu">paste</span>(bcxglmnet_list, <span class="at">collapse =</span> <span class="st">" + "</span>)) <span class="sc">|&gt;</span></span>
<span id="cb19-105"><a href="#cb19-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.formula</span>()</span>
<span id="cb19-106"><a href="#cb19-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-107"><a href="#cb19-107" aria-hidden="true" tabindex="-1"></a>bcx_model <span class="ot">&lt;-</span></span>
<span id="cb19-108"><a href="#cb19-108" aria-hidden="true" tabindex="-1"></a>  povmap<span class="sc">::</span><span class="fu">ebp</span>(</span>
<span id="cb19-109"><a href="#cb19-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">fixed =</span> model_formula,</span>
<span id="cb19-110"><a href="#cb19-110" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_data =</span> census_dt[, <span class="fu">c</span>(bcxglmnet_list, <span class="st">"district"</span>)],</span>
<span id="cb19-111"><a href="#cb19-111" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_domains =</span> <span class="st">"district"</span>,</span>
<span id="cb19-112"><a href="#cb19-112" aria-hidden="true" tabindex="-1"></a>    <span class="at">smp_data =</span> survey_dt[, <span class="fu">c</span>(bcxglmnet_list, <span class="st">"district"</span>, <span class="st">"eqIncome"</span>, <span class="st">"weight"</span>)],</span>
<span id="cb19-113"><a href="#cb19-113" aria-hidden="true" tabindex="-1"></a>    <span class="at">smp_domains =</span> <span class="st">"district"</span>,</span>
<span id="cb19-114"><a href="#cb19-114" aria-hidden="true" tabindex="-1"></a>    <span class="at">MSE =</span> <span class="cn">TRUE</span>,</span>
<span id="cb19-115"><a href="#cb19-115" aria-hidden="true" tabindex="-1"></a>    <span class="at">threshold =</span> <span class="fl">18207.2</span>,</span>
<span id="cb19-116"><a href="#cb19-116" aria-hidden="true" tabindex="-1"></a>    <span class="at">transformation =</span> <span class="st">"box.cox"</span>,</span>
<span id="cb19-117"><a href="#cb19-117" aria-hidden="true" tabindex="-1"></a>    <span class="at">B =</span> <span class="dv">50</span>,</span>
<span id="cb19-118"><a href="#cb19-118" aria-hidden="true" tabindex="-1"></a>    <span class="at">L =</span> <span class="dv">50</span>,</span>
<span id="cb19-119"><a href="#cb19-119" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> <span class="st">"weight"</span>,</span>
<span id="cb19-120"><a href="#cb19-120" aria-hidden="true" tabindex="-1"></a>    <span class="at">rescale_weights =</span> <span class="cn">TRUE</span>,</span>
<span id="cb19-121"><a href="#cb19-121" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ydump =</span> <span class="fu">file.path</span>(fldr_temp, <span class="st">"data/Ydump/unitcensus_bcxYdump_glmnet.csv"</span>),</span>
<span id="cb19-122"><a href="#cb19-122" aria-hidden="true" tabindex="-1"></a>    <span class="at">cpus =</span> <span class="dv">30</span>,</span>
<span id="cb19-123"><a href="#cb19-123" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights_type =</span> <span class="st">"nlme_lambda"</span></span>
<span id="cb19-124"><a href="#cb19-124" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb19-125"><a href="#cb19-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-126"><a href="#cb19-126" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(bcx_model, <span class="fu">file.path</span>(fldr_temp, <span class="st">"bcx_censusmodel.RDS"</span>))</span>
<span id="cb19-127"><a href="#cb19-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-128"><a href="#cb19-128" aria-hidden="true" tabindex="-1"></a>model_formula <span class="ot">&lt;-</span> </span>
<span id="cb19-129"><a href="#cb19-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="st">"eqIncome ~ "</span>, <span class="fu">paste</span>(notglmnet_list, <span class="at">collapse =</span> <span class="st">" + "</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb19-130"><a href="#cb19-130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.formula</span>()</span>
<span id="cb19-131"><a href="#cb19-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-132"><a href="#cb19-132" aria-hidden="true" tabindex="-1"></a>not_model <span class="ot">&lt;-</span></span>
<span id="cb19-133"><a href="#cb19-133" aria-hidden="true" tabindex="-1"></a>  povmap<span class="sc">::</span><span class="fu">ebp</span>(</span>
<span id="cb19-134"><a href="#cb19-134" aria-hidden="true" tabindex="-1"></a>    <span class="at">fixed =</span> model_formula,</span>
<span id="cb19-135"><a href="#cb19-135" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_data =</span> census_dt[, <span class="fu">c</span>(notglmnet_list, <span class="st">"district"</span>)],</span>
<span id="cb19-136"><a href="#cb19-136" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_domains =</span> <span class="st">"district"</span>,</span>
<span id="cb19-137"><a href="#cb19-137" aria-hidden="true" tabindex="-1"></a>    <span class="at">smp_data =</span> survey_dt[, <span class="fu">c</span>(notglmnet_list, <span class="st">"district"</span>, <span class="st">"eqIncome"</span>, <span class="st">"weight"</span>)],</span>
<span id="cb19-138"><a href="#cb19-138" aria-hidden="true" tabindex="-1"></a>    <span class="at">smp_domains =</span> <span class="st">"district"</span>,</span>
<span id="cb19-139"><a href="#cb19-139" aria-hidden="true" tabindex="-1"></a>    <span class="at">MSE =</span> <span class="cn">TRUE</span>,</span>
<span id="cb19-140"><a href="#cb19-140" aria-hidden="true" tabindex="-1"></a>    <span class="at">threshold =</span> <span class="fl">18207.2</span>,</span>
<span id="cb19-141"><a href="#cb19-141" aria-hidden="true" tabindex="-1"></a>    <span class="at">transformation =</span> <span class="st">"no"</span>,</span>
<span id="cb19-142"><a href="#cb19-142" aria-hidden="true" tabindex="-1"></a>    <span class="at">B =</span> <span class="dv">50</span>,</span>
<span id="cb19-143"><a href="#cb19-143" aria-hidden="true" tabindex="-1"></a>    <span class="at">L =</span> <span class="dv">50</span>,</span>
<span id="cb19-144"><a href="#cb19-144" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> <span class="st">"weight"</span>,</span>
<span id="cb19-145"><a href="#cb19-145" aria-hidden="true" tabindex="-1"></a>    <span class="at">rescale_weights =</span> <span class="cn">TRUE</span>,</span>
<span id="cb19-146"><a href="#cb19-146" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ydump =</span> <span class="fu">file.path</span>(fldr_temp, <span class="st">"Ydump/unitcensus_notYdump_glmnet.csv"</span>),</span>
<span id="cb19-147"><a href="#cb19-147" aria-hidden="true" tabindex="-1"></a>    <span class="at">cpus =</span> <span class="dv">30</span></span>
<span id="cb19-148"><a href="#cb19-148" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb19-149"><a href="#cb19-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-150"><a href="#cb19-150" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(not_model, <span class="fu">file.path</span>(fldr_temp, <span class="st">"data/not_censusmodel.RDS"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>log_smodel <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(fldr_temp, <span class="st">"log_surveymodel.RDS"</span>))</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>bcx_smodel <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(fldr_temp, <span class="st">"bcx_surveymodel.RDS"</span>))</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>not_smodel <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(fldr_temp, <span class="st">"not_surveymodel.RDS"</span>))</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>log_model <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(fldr_temp, <span class="st">"log_censusmodel.RDS"</span>))</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>bcx_model <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(fldr_temp, <span class="st">"bcx_censusmodel.RDS"</span>))</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>not_model <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(fldr_temp, <span class="st">"not_censusmodel.RDS"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="post-estimation-diagnostics" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="post-estimation-diagnostics"><span class="header-section-number">3.5</span> Post Estimation Diagnostics</h2>
<p>Once the model has been estimated. It is essential to test the validity of the model based on the model assumptions. Below are the set of typical tests which we will perform:</p>
<section id="checking-the-quality-of-in-sample-prediction" class="level3" data-number="3.5.1">
<h3 data-number="3.5.1" class="anchored" data-anchor-id="checking-the-quality-of-in-sample-prediction"><span class="header-section-number">3.5.1</span> Checking the quality of in-sample prediction</h3>
<section id="aggregate-poverty-rates-at-the-lowest-level-of-national-representativeness-for-ebp-vs-direct-poverty-rates" class="level4" data-number="3.5.1.1">
<h4 data-number="3.5.1.1" class="anchored" data-anchor-id="aggregate-poverty-rates-at-the-lowest-level-of-national-representativeness-for-ebp-vs-direct-poverty-rates"><span class="header-section-number">3.5.1.1</span> Aggregate Poverty Rates at the lowest level of National Representativeness for EBP vs Direct Poverty Rates</h4>
<p>The first test is to ensure the model is able to replicate the welfare distribution within the same survey. If this test fails, there is no reason to expect our model to provide unbiased estimates out of sample. We run the function <code>ebp_national_pov()</code> below to compare estimated poverty rates aggregated to the state level to the direct estimates from the survey. We apply the function to each model. Ideally, we want the estimated state poverty rates to be as close as possible to the direct estimates at the same level (typically within the 95% confidence level).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### first let us look at the quality of in-sample prediction</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' A function to estimate poverty rates in levels different from the target area</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function will take the ebp object (result of ebp()) as well as the population data to estimate </span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' poverty rates at a level different from the designated target area level stipulated for poverty </span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' mapping in the `ebp()` function. </span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param ebp_obj object of class `"ebp" "emdi"`</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param wgt_var chr, the weight variable name </span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param pop_domain chr, the population domain used for `ebp()`</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param est_domain chr, the estimation domain</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param pop_dt data.frame, the population dataset/census</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param indicators chr, a character or vector of characters for the indicators of interest</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="co">#' @import data.table dplyr</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>ebp_national_pov <span class="ot">&lt;-</span> <span class="cf">function</span>(ebp_obj,</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>                             wgt_var,</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>                             pop_domain,</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>                             est_domain,</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>                             pop_dt,</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>                             <span class="at">indicators =</span> <span class="fu">c</span>(<span class="st">"Head_Count"</span>)) {</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>  pop_dt <span class="ot">&lt;-</span> </span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    pop_dt <span class="sc">|&gt;</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(<span class="sc">!!</span><span class="fu">sym</span>(pop_domain), <span class="sc">!!</span><span class="fu">sym</span>(est_domain)) <span class="sc">|&gt;</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">population =</span> <span class="fu">sum</span>(<span class="sc">!!</span><span class="fu">sym</span>(wgt_var), <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Merge the ebp object data with population data</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> <span class="fu">merge</span>(ebp_obj<span class="sc">$</span>ind, </span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>              pop_dt[, <span class="fu">c</span>(pop_domain, <span class="st">"population"</span>, est_domain)], </span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>              <span class="at">by.x =</span> <span class="st">"Domain"</span>, </span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>              <span class="at">by.y =</span> pop_domain, </span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>              <span class="at">all.x =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute weighted means for all indicators</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>  pov_dt <span class="ot">&lt;-</span> </span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>    dt <span class="sc">%&gt;%</span></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.data.table</span>() <span class="sc">%&gt;%</span></span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>    .[, <span class="fu">lapply</span>(.SD, weighted.mean, <span class="at">w =</span> population, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>      .SDcols <span class="ot">=</span> indicators,</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>      by <span class="ot">=</span> est_domain]</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(pov_dt)</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>ebpsurveypov_dt <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> <span class="fu">list</span>(not_smodel, bcx_smodel, log_smodel),</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">FUN =</span> <span class="cf">function</span>(ebp_obj) {</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">&lt;-</span> <span class="fu">ebp_national_pov</span>(</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">ebp_obj =</span> ebp_obj,</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">wgt_var =</span> <span class="st">"weight"</span>,</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">pop_domain =</span> <span class="st">"district"</span>,</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">pop_dt =</span> survey_dt,</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">est_domain =</span> <span class="st">"state"</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(z)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="do">### rename headcount columns appropriately</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>ebpsurveypov_dt <span class="ot">&lt;-</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mapply</span>(</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">pov_dt =</span> ebpsurveypov_dt,</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">name_obj =</span> <span class="fu">c</span>(<span class="st">"not"</span>, <span class="st">"bcx"</span>, <span class="st">"log"</span>),</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">FUN =</span> <span class="cf">function</span>(pov_dt, name_obj) {</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>      pov_dt <span class="sc">|&gt;</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">paste0</span>(name_obj, .), <span class="at">.cols =</span> <span class="st">"Head_Count"</span>)</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>ebpsurveypov_dt <span class="ot">&lt;-</span> <span class="fu">Reduce</span>(<span class="at">f =</span> merge,</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>                          <span class="at">x =</span> ebpsurveypov_dt)</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a><span class="do">### we create some fake clusters within the districts to show how to </span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a><span class="do">### use the survey package to estimate the standard errors on the </span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a><span class="do">### poverty rates, ideally these would already exist within your survey</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a><span class="do">#### for simplicity we will assume there are 5 clusters in each district</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>survey_dt <span class="ot">&lt;-</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>  survey_dt <span class="sc">%&gt;%</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(district) <span class="sc">%&gt;%</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">num_clusters =</span> <span class="fu">pmax</span>(<span class="dv">2</span>, <span class="fu">round</span>(<span class="fu">n</span>() <span class="sc">/</span> <span class="fu">sample</span>(<span class="dv">5</span><span class="sc">:</span><span class="dv">15</span>, <span class="dv">1</span>))), </span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>         <span class="at">cluster =</span> <span class="fu">sample</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>num_clusters, <span class="at">length.out =</span> <span class="fu">n</span>()))) <span class="sc">%&gt;%</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cluster_id =</span> <span class="fu">dense_rank</span>(<span class="fu">interaction</span>(district, cluster)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: There were 70 warnings in `mutate()`.
The first warning was:
ℹ In argument: `cluster = sample(rep(1:num_clusters, length.out = n()))`.
ℹ In group 1: `district = Neusiedl am See`.
Caused by warning in `1:num_clusters`:
! numerical expression has 16 elements: only the first used
ℹ Run `dplyr::last_dplyr_warnings()` to see the 69 remaining warnings.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>svy_obj <span class="ot">&lt;-</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  survey_dt <span class="sc">%&gt;%</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">poor =</span> <span class="fu">ifelse</span>(eqIncome <span class="sc">&lt;</span> <span class="fl">18207.2</span>, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(district, weight, state, poor, cluster_id) <span class="sc">%&gt;%</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  survey<span class="sc">::</span><span class="fu">svydesign</span>(</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">ids =</span> <span class="sc">~</span> cluster_id,</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> <span class="sc">~</span> weight,</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">strata =</span> <span class="sc">~</span> state,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">survey.lonely.psu =</span> <span class="st">"adjust"</span>,</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> .</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>var_dt <span class="ot">&lt;-</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">svyby</span>(<span class="sc">~</span> poor, <span class="sc">~</span> state, svy_obj, svymean) <span class="sc">%&gt;%</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">poorLB =</span> poor <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> se, <span class="at">poorUB =</span> poor <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> se)</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>ebpsurveypov_dt <span class="ot">&lt;-</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>  ebpsurveypov_dt <span class="sc">|&gt;</span> </span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>    var_dt <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="fu">any_of</span>(<span class="fu">c</span>(<span class="st">"state"</span>, <span class="st">"poor"</span>, <span class="st">"poorLB"</span>, <span class="st">"poorUB"</span>))),</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">join_by</span>(<span class="st">"state"</span>)</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="compare-survey-ebp-poverty-rates-to-direct-poverty-rates-at-different-poverty-lines" class="level5" data-number="3.5.1.1.1">
<h5 data-number="3.5.1.1.1" class="anchored" data-anchor-id="compare-survey-ebp-poverty-rates-to-direct-poverty-rates-at-different-poverty-lines"><span class="header-section-number">3.5.1.1.1</span> Compare Survey EBP Poverty Rates to Direct Poverty Rates at different poverty lines</h5>
<p>Another check for the quality of prediction within the survey is testing the predictive power of the model at different poverty lines along the entire income distribution. In the example below, we show compare the predicted poverty rate to the direct poverty rate using each 5th percentile increment in income i.e.&nbsp;using poverty ventile. We implement a function <code>compare_surveyebp_atpovline()</code> which computes poverty from the simulated welfare data (produced by <code>Ydump</code> argument in ebp()) and the survey at each poverty line. The function allows the user specify the percentiles at which poverty lines will be specified. The default is set at every 5th percentile (<code>seq(0, 1, 0.05)</code>).</p>
<p>We apply <code>compare_surveyebp_at_povline()</code> to each of the estimated models in comparison with the direct survey estimates at poverty line ventiles (every 5th percentile).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="do">### first let's read in the data ydump data</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>ydumppath_list <span class="ot">&lt;-</span> <span class="fu">list.files</span>(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">path =</span> <span class="fu">file.path</span>(fldr_temp, <span class="st">"Ydump"</span>),</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">pattern =</span> <span class="st">"^unitsurvey_.*Ydump_glmnet.csv"</span>,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">full.names =</span> <span class="cn">TRUE</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="do">### the following code will read in the Ydump data into a list of </span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="do">###    data.frame objects and sequentially: </span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="do">### - combine the ydump with household survey</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="do">### - compute poverty rates at each threshold</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="do">#### lets write a function to do this for one of our models</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>ydump_dtlist <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="at">X =</span> ydumppath_list, <span class="at">FUN =</span> fread)</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(ydump_dtlist) <span class="ot">&lt;-</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">basename</span>(ydumppath_list) <span class="sc">%&gt;%</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sub</span>(<span class="at">pattern =</span> <span class="st">"^unitsurvey_"</span>, <span class="at">replacement =</span> <span class="st">""</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sub</span>(<span class="at">pattern =</span> <span class="st">"_glmnet.csv"</span>, <span class="at">replacement =</span> <span class="st">""</span>)</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a><span class="do">### a simple function to carry out the poverty rate comparisons (model vs actual at each poverty ventile, 5% increments) &amp; plot the result</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a><span class="co">#' Compute direct poverty rates and simulated outcome variables at specified poverty lines</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a><span class="co">#' The function uses the simulated outcome from `povmap::ebp()`'s `Ydump` argument and the survey data to compute estimated and direct poverty    </span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a><span class="co">#' rates at a specified level than is estimated with `ebp()` at different poverty lines. </span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param ydump_data data.frame, the simulated welfare/income data from non-null `Ydump` argument within the `povmap::ebp()`</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param smp_data data.frame, the survey data</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param smp_domains character, a variable name for the domain/geographic level at which poverty rates will be estimated</span></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param smp_weights character, the weight variable</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param pline_increment numeric vector, a set of percentiles at which poverty rates should be estimated. </span></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a><span class="co">#' @import data.table dplyr</span></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>compare_surveyebp_atpovline <span class="ot">&lt;-</span> <span class="cf">function</span>(ydump_data,</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>                                        smp_data,</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>                                        smp_domains,</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>                                        smp_weights,</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>                                        outcome_var,</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">pline_increment =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.05</span>)){</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>  ydump_dt <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(ydump_data)</span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>  smp_dt <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(smp_data[, <span class="fu">c</span>(smp_domains, smp_weights, outcome_var)])</span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>  ydump_dt <span class="ot">&lt;-</span> <span class="fu">cbind</span>(ydump_dt, </span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>                    smp_dt[, <span class="fu">c</span>(smp_domains, smp_weights), <span class="at">with =</span> <span class="cn">FALSE</span>] <span class="sc">%&gt;%</span></span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">arrange</span>(smp_domains))</span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>  threshold_list <span class="ot">&lt;-</span></span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">wtd.quantile</span>(<span class="at">x =</span> smp_dt[[outcome_var]],</span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>                 <span class="at">weights =</span> smp_dt[[smp_weights]],</span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>                 <span class="at">probs =</span> pline_increment)</span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a>  compute_ptile_pov <span class="ot">&lt;-</span> <span class="cf">function</span>(welfare_dt,</span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>                                weights,</span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a>                                welfare,</span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a>                                thresholds){</span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a>    pov_list <span class="ot">&lt;-</span> </span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(<span class="at">X =</span> thresholds,</span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a>           <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a>             </span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a>             yy <span class="ot">&lt;-</span> </span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a>               welfare_dt <span class="sc">%&gt;%</span></span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a>               <span class="fu">mutate</span>(<span class="at">poor =</span> <span class="fu">ifelse</span>(<span class="sc">!!</span><span class="fu">sym</span>(welfare) <span class="sc">&lt;</span> x, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a>               <span class="fu">summarize</span>(<span class="at">prate =</span> <span class="fu">weighted.mean</span>(<span class="at">x =</span> poor,</span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">w =</span> <span class="sc">!!</span><span class="fu">sym</span>(weights),</span>
<span id="cb25-73"><a href="#cb25-73" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb25-74"><a href="#cb25-74" aria-hidden="true" tabindex="-1"></a>             </span>
<span id="cb25-75"><a href="#cb25-75" aria-hidden="true" tabindex="-1"></a>             <span class="fu">return</span>(yy)</span>
<span id="cb25-76"><a href="#cb25-76" aria-hidden="true" tabindex="-1"></a>             </span>
<span id="cb25-77"><a href="#cb25-77" aria-hidden="true" tabindex="-1"></a>           })</span>
<span id="cb25-78"><a href="#cb25-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-79"><a href="#cb25-79" aria-hidden="true" tabindex="-1"></a>    pov_list <span class="ot">&lt;-</span> </span>
<span id="cb25-80"><a href="#cb25-80" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unlist</span>(pov_list) <span class="sc">%&gt;%</span></span>
<span id="cb25-81"><a href="#cb25-81" aria-hidden="true" tabindex="-1"></a>      <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb25-82"><a href="#cb25-82" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setNames</span>(<span class="st">"pov"</span>)</span>
<span id="cb25-83"><a href="#cb25-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-84"><a href="#cb25-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-85"><a href="#cb25-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(pov_list)</span>
<span id="cb25-86"><a href="#cb25-86" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-87"><a href="#cb25-87" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-88"><a href="#cb25-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-89"><a href="#cb25-89" aria-hidden="true" tabindex="-1"></a>  pov_dt <span class="ot">&lt;-</span> <span class="fu">compute_ptile_pov</span>(<span class="at">welfare_dt =</span> ydump_dt,</span>
<span id="cb25-90"><a href="#cb25-90" aria-hidden="true" tabindex="-1"></a>                              <span class="at">weights =</span> smp_weights,</span>
<span id="cb25-91"><a href="#cb25-91" aria-hidden="true" tabindex="-1"></a>                              <span class="at">welfare =</span> <span class="st">"Simulated_Y"</span>,</span>
<span id="cb25-92"><a href="#cb25-92" aria-hidden="true" tabindex="-1"></a>                              <span class="at">thresholds =</span> threshold_list)</span>
<span id="cb25-93"><a href="#cb25-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-94"><a href="#cb25-94" aria-hidden="true" tabindex="-1"></a>  pov_dt <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">ebp_poverty =</span> pov_dt,</span>
<span id="cb25-95"><a href="#cb25-95" aria-hidden="true" tabindex="-1"></a>                       <span class="at">probs =</span> <span class="fu">as.character</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.05</span>)))</span>
<span id="cb25-96"><a href="#cb25-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-97"><a href="#cb25-97" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-98"><a href="#cb25-98" aria-hidden="true" tabindex="-1"></a>  <span class="co"># povcheck_plots &lt;- </span></span>
<span id="cb25-99"><a href="#cb25-99" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   pov_dt %&gt;%</span></span>
<span id="cb25-100"><a href="#cb25-100" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   mutate(y )</span></span>
<span id="cb25-101"><a href="#cb25-101" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   ggplot(aes(x = as.numeric(probs)))</span></span>
<span id="cb25-102"><a href="#cb25-102" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-103"><a href="#cb25-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(pov_dt)</span>
<span id="cb25-104"><a href="#cb25-104" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-105"><a href="#cb25-105" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-106"><a href="#cb25-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-107"><a href="#cb25-107" aria-hidden="true" tabindex="-1"></a><span class="do">### now lets plot the results</span></span>
<span id="cb25-108"><a href="#cb25-108" aria-hidden="true" tabindex="-1"></a>svyplinecomp_list <span class="ot">&lt;-</span></span>
<span id="cb25-109"><a href="#cb25-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb25-110"><a href="#cb25-110" aria-hidden="true" tabindex="-1"></a>    <span class="at">X =</span> ydump_dtlist,</span>
<span id="cb25-111"><a href="#cb25-111" aria-hidden="true" tabindex="-1"></a>    <span class="at">FUN =</span> <span class="cf">function</span>(ydump) {</span>
<span id="cb25-112"><a href="#cb25-112" aria-hidden="true" tabindex="-1"></a>      <span class="fu">compare_surveyebp_atpovline</span>(</span>
<span id="cb25-113"><a href="#cb25-113" aria-hidden="true" tabindex="-1"></a>        <span class="at">ydump_data =</span> ydump,</span>
<span id="cb25-114"><a href="#cb25-114" aria-hidden="true" tabindex="-1"></a>        <span class="at">smp_data =</span> survey_dt,</span>
<span id="cb25-115"><a href="#cb25-115" aria-hidden="true" tabindex="-1"></a>        <span class="at">smp_domains =</span> <span class="st">"district"</span>,</span>
<span id="cb25-116"><a href="#cb25-116" aria-hidden="true" tabindex="-1"></a>        <span class="at">smp_weights =</span> <span class="st">"weight"</span>,</span>
<span id="cb25-117"><a href="#cb25-117" aria-hidden="true" tabindex="-1"></a>        <span class="at">outcome_var =</span> <span class="st">"eqIncome"</span></span>
<span id="cb25-118"><a href="#cb25-118" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb25-119"><a href="#cb25-119" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-120"><a href="#cb25-120" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-121"><a href="#cb25-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-122"><a href="#cb25-122" aria-hidden="true" tabindex="-1"></a><span class="do">## a bit of cleaning and then making the plots</span></span>
<span id="cb25-123"><a href="#cb25-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-124"><a href="#cb25-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-125"><a href="#cb25-125" aria-hidden="true" tabindex="-1"></a>svyplinecomp_dt <span class="ot">&lt;-</span></span>
<span id="cb25-126"><a href="#cb25-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mapply</span>(</span>
<span id="cb25-127"><a href="#cb25-127" aria-hidden="true" tabindex="-1"></a>    <span class="at">comp_dt =</span> svyplinecomp_list,</span>
<span id="cb25-128"><a href="#cb25-128" aria-hidden="true" tabindex="-1"></a>    <span class="at">name_list =</span> <span class="fu">names</span>(svyplinecomp_list),</span>
<span id="cb25-129"><a href="#cb25-129" aria-hidden="true" tabindex="-1"></a>    <span class="at">FUN =</span> <span class="cf">function</span>(comp_dt, name_list) {</span>
<span id="cb25-130"><a href="#cb25-130" aria-hidden="true" tabindex="-1"></a>      comp_dt <span class="sc">%&gt;%</span></span>
<span id="cb25-131"><a href="#cb25-131" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rename</span>(<span class="at">ebp =</span> <span class="st">"ebp_poverty.pov"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-132"><a href="#cb25-132" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">probs =</span> <span class="fu">as.numeric</span>(probs)) <span class="sc">%&gt;%</span></span>
<span id="cb25-133"><a href="#cb25-133" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">diff =</span> <span class="fu">abs</span>(ebp <span class="sc">-</span> probs) <span class="sc">/</span> probs) <span class="sc">%&gt;%</span></span>
<span id="cb25-134"><a href="#cb25-134" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">transformation =</span> <span class="fu">sub</span>(<span class="st">"Ydump"</span>, <span class="st">""</span>, name_list))</span>
<span id="cb25-135"><a href="#cb25-135" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb25-136"><a href="#cb25-136" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb25-137"><a href="#cb25-137" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb25-138"><a href="#cb25-138" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb25-139"><a href="#cb25-139" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We plot the absolute value of the percent difference between both poverty rates at each ventile as seen in the plot below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>svyplinecomp_dt <span class="sc">%&gt;%</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> probs,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">y =</span> diff,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> transformation)) <span class="sc">+</span> </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ul_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="evaluating-the-standard-normality-assumptions" class="level4" data-number="3.5.1.2">
<h4 data-number="3.5.1.2" class="anchored" data-anchor-id="evaluating-the-standard-normality-assumptions"><span class="header-section-number">3.5.1.2</span> Evaluating the Standard Normality Assumptions</h4>
<ul>
<li><p>Presenting the regression table estimates (use povmap::ebp_reportcoef_table() and then translate into a flextable which can be rendered in Word, PDF or HTML)</p></li>
<li><p>Checking that all model assumptions hold (normality assumptions for the miu and epsilon terms), using povmap::ebp_normalityfit() to present skewness and kurtosis for both errors. Then show a function that uses ebp object to plot the distribution of the errors and compute the kolmogrov-smirnov test statistics. We can also include the shapiro-wilks which will break down for larger sample sizes but is equally well known. Another function that produces q-q plots for miu and epsilon terms from ebp object.</p></li>
<li><p>Check on model validity: Create a plot to show how poverty rates vary at each ventile i.e.&nbsp;at 5% poverty line increments. This is to show how to check the quality of model prediction without the added bias of out of sample prediction</p></li>
<li><p>Computing MSE and CVs and computing the statistical gains made from performing small area estimation i.e.&nbsp;in practical terms, how much bigger would the survey have to be the get the same level of precision that SAE now gives us with the census data.</p></li>
<li><p>Final validation: EBP estimates vs Direct Estimates (supposedly truth) at the highest resolution level that is considered nationally representative, this is usually the regional level in Africa.</p></li>
<li><p>Plotting the poverty map using the ebp object and the shapefile</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### presenting the results of the linear mixed effects regression</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>specify_decimal <span class="ot">&lt;-</span> <span class="cf">function</span>(x, k) <span class="fu">trimws</span>(<span class="fu">format</span>(<span class="fu">round</span>(x, k), <span class="at">nsmall=</span>k))</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="do">### to quickly create coefficients table</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>coef_dt <span class="ot">&lt;-</span> povmap<span class="sc">::</span><span class="fu">ebp_reportcoef_table</span>(log_model) </span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="do">## showing how to present the skewness and kurtosis of the random effects </span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="do">##   and model errors</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>err_dt <span class="ot">&lt;-</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  povmap<span class="sc">::</span><span class="fu">ebp_normalityfit</span>(log_model) <span class="sc">%&gt;%</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">specify_decimal</span>(value, <span class="dv">3</span>))</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="do">### to convert this into a publication ready report</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>create_regression_table <span class="ot">&lt;-</span> <span class="cf">function</span>(coef_table, eval_table) {</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rename columns for consistency</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>  coef_table <span class="ot">&lt;-</span> </span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    coef_table <span class="sc">%&gt;%</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">Description =</span> Variable,</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>           <span class="at">Estimate =</span> coeff, </span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Std. Error</span><span class="st">`</span> <span class="ot">=</span> std_error) <span class="sc">%&gt;%</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Type =</span> <span class="st">"Coefficients"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Format std. error under estimates</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Estimate =</span> <span class="fu">paste0</span>(Estimate, <span class="st">"</span><span class="sc">\n</span><span class="st">("</span>, <span class="st">`</span><span class="at">Std. Error</span><span class="st">`</span>, <span class="st">")"</span>)) <span class="sc">%&gt;%</span>  </span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(Type, Description, Estimate)</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>  eval_table <span class="ot">&lt;-</span> eval_table <span class="sc">%&gt;%</span></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">Description =</span> indicator, <span class="at">Estimate =</span> value) <span class="sc">%&gt;%</span></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Type =</span> <span class="st">"Diagnostics"</span>)</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combine coefficient and diagnostic tables</span></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>  full_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(coef_table, </span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>                      eval_table <span class="sc">%&gt;%</span></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>                        dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">colnames</span>(coef_table)))</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Identify where diagnostics start</span></span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>  diag_start <span class="ot">&lt;-</span> <span class="fu">nrow</span>(coef_table) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create flextable</span></span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>  regression_table <span class="ot">&lt;-</span> </span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">flextable</span>(full_table) <span class="sc">%&gt;%</span></span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_header_labels</span>(</span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">Type =</span> <span class="st">"Type"</span>,</span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">Description =</span> <span class="st">"Description"</span>,</span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">Estimate =</span> <span class="st">"Estimate"</span></span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">hline</span>(<span class="at">part =</span> <span class="st">"all"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">merge_v</span>(<span class="at">j =</span> <span class="st">"Type"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">align</span>(<span class="at">j =</span> <span class="st">"Description"</span>, <span class="at">align =</span> <span class="st">"left"</span>, <span class="at">part =</span> <span class="st">"all"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">align</span>(<span class="at">j =</span> <span class="st">"Estimate"</span>, <span class="at">align =</span> <span class="st">"center"</span>, <span class="at">part =</span> <span class="st">"all"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">vline</span>(<span class="at">j =</span> <span class="dv">1</span>, <span class="at">border =</span> <span class="fu">fp_border</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">width =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">hline</span>(<span class="at">i =</span> diag_start <span class="sc">-</span> <span class="dv">1</span>, <span class="at">border =</span> <span class="fu">fp_border</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">width =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb27-54"><a href="#cb27-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">autofit</span>() <span class="sc">%&gt;%</span></span>
<span id="cb27-55"><a href="#cb27-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">width</span>(<span class="at">j =</span> <span class="st">"Type"</span>, <span class="at">width =</span> <span class="fl">1.2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-56"><a href="#cb27-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">width</span>(<span class="at">j =</span> <span class="st">"Description"</span>, <span class="at">width =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-57"><a href="#cb27-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">width</span>(<span class="at">j =</span> <span class="st">"Estimate"</span>, <span class="at">width =</span> <span class="fl">1.5</span>)</span>
<span id="cb27-58"><a href="#cb27-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-59"><a href="#cb27-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Styling for diagnostics</span></span>
<span id="cb27-60"><a href="#cb27-60" aria-hidden="true" tabindex="-1"></a>  regression_table <span class="ot">&lt;-</span> regression_table <span class="sc">%&gt;%</span></span>
<span id="cb27-61"><a href="#cb27-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bold</span>(<span class="at">i =</span> diag_start<span class="sc">:</span><span class="fu">nrow</span>(full_table), <span class="at">bold =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-62"><a href="#cb27-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">italic</span>(<span class="at">i =</span> diag_start<span class="sc">:</span><span class="fu">nrow</span>(full_table), <span class="at">italic =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-63"><a href="#cb27-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">font</span>(<span class="at">fontname =</span> <span class="st">"Times New Roman"</span>, <span class="at">part =</span> <span class="st">"all"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-64"><a href="#cb27-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fontsize</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">part =</span> <span class="st">"all"</span>)</span>
<span id="cb27-65"><a href="#cb27-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-66"><a href="#cb27-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(regression_table)</span>
<span id="cb27-67"><a href="#cb27-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-68"><a href="#cb27-68" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-69"><a href="#cb27-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-70"><a href="#cb27-70" aria-hidden="true" tabindex="-1"></a><span class="do">### regression tables</span></span>
<span id="cb27-71"><a href="#cb27-71" aria-hidden="true" tabindex="-1"></a><span class="fu">create_regression_table</span>(<span class="at">coef_table =</span> coef_dt,</span>
<span id="cb27-72"><a href="#cb27-72" aria-hidden="true" tabindex="-1"></a>                        <span class="at">eval_table =</span> err_dt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="tabwid"><style>.cl-b8fce25c{}.cl-b8eb168a{font-family:'Times New Roman';font-size:10pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-b8eb16a8{font-family:'Times New Roman';font-size:10pt;font-weight:bold;font-style:italic;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-b8f12f5c{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-b8f12f70{margin:0;text-align:center;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-b8f15ec8{width:1.2in;background-color:transparent;vertical-align: middle;border-bottom: 1pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 1pt solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b8f15ee6{width:2in;background-color:transparent;vertical-align: middle;border-bottom: 1pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 1pt solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b8f15efa{width:1.5in;background-color:transparent;vertical-align: middle;border-bottom: 1pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b8f15efb{width:1.2in;background-color:transparent;vertical-align: middle;border-bottom: 1pt solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 1pt solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b8f15f04{width:2in;background-color:transparent;vertical-align: middle;border-bottom: 1pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 1pt solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b8f15f18{width:1.5in;background-color:transparent;vertical-align: middle;border-bottom: 1pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b8f15f22{width:1.2in;background-color:transparent;vertical-align: middle;border-bottom: 1pt solid rgba(102, 102, 102, 1.00);border-top: 1pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 1pt solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b8f15f23{width:2in;background-color:transparent;vertical-align: middle;border-bottom: 1pt solid rgba(102, 102, 102, 1.00);border-top: 1pt solid rgba(102, 102, 102, 1.00);border-left: 1pt solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b8f15f2c{width:1.5in;background-color:transparent;vertical-align: middle;border-bottom: 1pt solid rgba(102, 102, 102, 1.00);border-top: 1pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b8f15f40{width:1.2in;background-color:transparent;vertical-align: middle;border-bottom: 1pt solid rgba(102, 102, 102, 1.00);border-top: 1pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 1pt solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b8f15f4a{width:2in;background-color:transparent;vertical-align: middle;border-bottom: 1pt solid rgba(102, 102, 102, 1.00);border-top: 1pt solid rgba(102, 102, 102, 1.00);border-left: 1pt solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b8f15f68{width:1.5in;background-color:transparent;vertical-align: middle;border-bottom: 1pt solid rgba(102, 102, 102, 1.00);border-top: 1pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b8f15f72{width:1.2in;background-color:transparent;vertical-align: middle;border-bottom: 1pt solid rgba(102, 102, 102, 1.00);border-top: 1pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 1pt solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b8f15f7c{width:2in;background-color:transparent;vertical-align: middle;border-bottom: 1pt solid rgba(102, 102, 102, 1.00);border-top: 1pt solid rgba(102, 102, 102, 1.00);border-left: 1pt solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b8f15f7d{width:1.5in;background-color:transparent;vertical-align: middle;border-bottom: 1pt solid rgba(102, 102, 102, 1.00);border-top: 1pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b8f15f86{width:1.2in;background-color:transparent;vertical-align: middle;border-bottom: 1pt solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 1pt solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b8f15f90{width:2in;background-color:transparent;vertical-align: middle;border-bottom: 1pt solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(102, 102, 102, 1.00);border-left: 1pt solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b8f15f9a{width:1.5in;background-color:transparent;vertical-align: middle;border-bottom: 1pt solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b8f15fa4{width:1.2in;background-color:transparent;vertical-align: middle;border-bottom: 1pt solid rgba(102, 102, 102, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 1pt solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b8f15fa5{width:2in;background-color:transparent;vertical-align: middle;border-bottom: 1pt solid rgba(102, 102, 102, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 1pt solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b8f15fae{width:1.5in;background-color:transparent;vertical-align: middle;border-bottom: 1pt solid rgba(102, 102, 102, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b8f15faf{width:1.2in;background-color:transparent;vertical-align: middle;border-bottom: 1pt solid rgba(102, 102, 102, 1.00);border-top: 1pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 1pt solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b8f15fc2{width:2in;background-color:transparent;vertical-align: middle;border-bottom: 1pt solid rgba(102, 102, 102, 1.00);border-top: 1pt solid rgba(102, 102, 102, 1.00);border-left: 1pt solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-b8f15fcc{width:1.5in;background-color:transparent;vertical-align: middle;border-bottom: 1pt solid rgba(102, 102, 102, 1.00);border-top: 1pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}</style><table data-quarto-disable-processing="true" class="cl-b8fce25c"><thead><tr style="overflow-wrap:break-word;"><th class="cl-b8f15ec8"><p class="cl-b8f12f5c"><span class="cl-b8eb168a">Type</span></p></th><th class="cl-b8f15ee6"><p class="cl-b8f12f5c"><span class="cl-b8eb168a">Description</span></p></th><th class="cl-b8f15efa"><p class="cl-b8f12f70"><span class="cl-b8eb168a">Estimate</span></p></th></tr></thead><tbody><tr style="overflow-wrap:break-word;"><td rowspan="18" class="cl-b8f15efb"><p class="cl-b8f12f5c"><span class="cl-b8eb168a">Coefficients</span></p></td><td class="cl-b8f15f04"><p class="cl-b8f12f5c"><span class="cl-b8eb168a">(Intercept)</span></p></td><td class="cl-b8f15f18"><p class="cl-b8f12f70"><span class="cl-b8eb168a">9.161***</span><br><span class="cl-b8eb168a">(0.032)</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b8f15f23"><p class="cl-b8f12f5c"><span class="cl-b8eb168a">eqsize</span></p></td><td class="cl-b8f15f2c"><p class="cl-b8f12f70"><span class="cl-b8eb168a">-0.043***</span><br><span class="cl-b8eb168a">(0.013)</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b8f15f23"><p class="cl-b8f12f5c"><span class="cl-b8eb168a">cash</span></p></td><td class="cl-b8f15f2c"><p class="cl-b8f12f70"><span class="cl-b8eb168a">0.00003***</span><br><span class="cl-b8eb168a">(0.0000008)</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b8f15f4a"><p class="cl-b8f12f5c"><span class="cl-b8eb168a">self_empl</span></p></td><td class="cl-b8f15f68"><p class="cl-b8f12f70"><span class="cl-b8eb168a">0.000022***</span><br><span class="cl-b8eb168a">(0.000001)</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b8f15f4a"><p class="cl-b8f12f5c"><span class="cl-b8eb168a">unempl_ben</span></p></td><td class="cl-b8f15f68"><p class="cl-b8f12f70"><span class="cl-b8eb168a">0.000021***</span><br><span class="cl-b8eb168a">(0.0000038)</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b8f15f23"><p class="cl-b8f12f5c"><span class="cl-b8eb168a">age_ben</span></p></td><td class="cl-b8f15f2c"><p class="cl-b8f12f70"><span class="cl-b8eb168a">0.00003***</span><br><span class="cl-b8eb168a">(0.0000011)</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b8f15f23"><p class="cl-b8f12f5c"><span class="cl-b8eb168a">surv_ben</span></p></td><td class="cl-b8f15f2c"><p class="cl-b8f12f70"><span class="cl-b8eb168a">0.000032***</span><br><span class="cl-b8eb168a">(0.0000078)</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b8f15f4a"><p class="cl-b8f12f5c"><span class="cl-b8eb168a">sick_ben</span></p></td><td class="cl-b8f15f68"><p class="cl-b8f12f70"><span class="cl-b8eb168a">0.000028**</span><br><span class="cl-b8eb168a">(0.00001)</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b8f15f23"><p class="cl-b8f12f5c"><span class="cl-b8eb168a">dis_ben</span></p></td><td class="cl-b8f15f2c"><p class="cl-b8f12f70"><span class="cl-b8eb168a">0.000036***</span><br><span class="cl-b8eb168a">(0.0000025)</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b8f15f23"><p class="cl-b8f12f5c"><span class="cl-b8eb168a">rent</span></p></td><td class="cl-b8f15f2c"><p class="cl-b8f12f70"><span class="cl-b8eb168a">0.000013***</span><br><span class="cl-b8eb168a">(0.0000014)</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b8f15f4a"><p class="cl-b8f12f5c"><span class="cl-b8eb168a">house_allow</span></p></td><td class="cl-b8f15f68"><p class="cl-b8f12f70"><span class="cl-b8eb168a">0.000051**</span><br><span class="cl-b8eb168a">(0.000021)</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b8f15f4a"><p class="cl-b8f12f5c"><span class="cl-b8eb168a">cap_inv</span></p></td><td class="cl-b8f15f68"><p class="cl-b8f12f70"><span class="cl-b8eb168a">0.000015***</span><br><span class="cl-b8eb168a">(0.0000027)</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b8f15f4a"><p class="cl-b8f12f5c"><span class="cl-b8eb168a">tax_adj</span></p></td><td class="cl-b8f15f68"><p class="cl-b8f12f70"><span class="cl-b8eb168a">-0.000014**</span><br><span class="cl-b8eb168a">(0.0000043)</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b8f15f4a"><p class="cl-b8f12f5c"><span class="cl-b8eb168a">cash_X_gender</span></p></td><td class="cl-b8f15f68"><p class="cl-b8f12f70"><span class="cl-b8eb168a">0.0000047***</span><br><span class="cl-b8eb168a">(0.000001)</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b8f15f4a"><p class="cl-b8f12f5c"><span class="cl-b8eb168a">self_empl_X_gender</span></p></td><td class="cl-b8f15f68"><p class="cl-b8f12f70"><span class="cl-b8eb168a">0.0000082***</span><br><span class="cl-b8eb168a">(0.0000023)</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b8f15f7c"><p class="cl-b8f12f5c"><span class="cl-b8eb168a">age_ben_X_gender</span></p></td><td class="cl-b8f15f7d"><p class="cl-b8f12f70"><span class="cl-b8eb168a">0.0000022</span><br><span class="cl-b8eb168a">(0.0000014)</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b8f15f4a"><p class="cl-b8f12f5c"><span class="cl-b8eb168a">rent_X_gender</span></p></td><td class="cl-b8f15f68"><p class="cl-b8f12f70"><span class="cl-b8eb168a">0.0000055**</span><br><span class="cl-b8eb168a">(0.0000025)</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b8f15f90"><p class="cl-b8f12f5c"><span class="cl-b8eb168a">cap_inv_X_gender</span></p></td><td class="cl-b8f15f9a"><p class="cl-b8f12f70"><span class="cl-b8eb168a">0.0000078</span><br><span class="cl-b8eb168a">(0.0000043)</span></p></td></tr><tr style="overflow-wrap:break-word;"><td rowspan="6" class="cl-b8f15fa4"><p class="cl-b8f12f5c"><span class="cl-b8eb16a8">Diagnostics</span></p></td><td class="cl-b8f15fa5"><p class="cl-b8f12f5c"><span class="cl-b8eb16a8">rsq_marginal</span></p></td><td class="cl-b8f15fae"><p class="cl-b8f12f70"><span class="cl-b8eb16a8">0.518</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b8f15fc2"><p class="cl-b8f12f5c"><span class="cl-b8eb16a8">rsq_conditional</span></p></td><td class="cl-b8f15fcc"><p class="cl-b8f12f70"><span class="cl-b8eb16a8">0.601</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b8f15fc2"><p class="cl-b8f12f5c"><span class="cl-b8eb16a8">epsilon_skewness</span></p></td><td class="cl-b8f15fcc"><p class="cl-b8f12f70"><span class="cl-b8eb16a8">-2.213</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b8f15fc2"><p class="cl-b8f12f5c"><span class="cl-b8eb16a8">epsilon_kurtosis</span></p></td><td class="cl-b8f15fcc"><p class="cl-b8f12f70"><span class="cl-b8eb16a8">18.270</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b8f15fc2"><p class="cl-b8f12f5c"><span class="cl-b8eb16a8">random_skewness</span></p></td><td class="cl-b8f15fcc"><p class="cl-b8f12f70"><span class="cl-b8eb16a8">-0.721</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-b8f15fc2"><p class="cl-b8f12f5c"><span class="cl-b8eb16a8">random_kurtosis</span></p></td><td class="cl-b8f15fcc"><p class="cl-b8f12f70"><span class="cl-b8eb16a8">3.508</span></p></td></tr></tbody></table></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="do">### start by explaining that the plot function could be used in R </span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="do">###  to show the error diagnostics as follows</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co"># plot(log_model, whitch = 1)</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="do">### a more thorough test on normality using the Kolmogrov-Smirnov tests</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>ebp_kstest <span class="ot">&lt;-</span> <span class="cf">function</span>(ebp_obj) {</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  epsilon_values <span class="ot">&lt;-</span> <span class="fu">residuals</span>(ebp_obj<span class="sc">$</span>model, <span class="at">level =</span> <span class="dv">0</span>, <span class="at">type =</span> <span class="st">"pearson"</span>) <span class="sc">|&gt;</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.numeric</span>()</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  mu_values <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(nlme<span class="sc">::</span><span class="fu">ranef</span>(ebp_obj<span class="sc">$</span>model)<span class="sc">$</span><span class="st">"(Intercept)"</span>)</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  mu_values <span class="ot">&lt;-</span> (mu_values <span class="sc">-</span> <span class="fu">mean</span>(mu_values, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">/</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sd</span>(mu_values, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>  xx <span class="ot">&lt;-</span> <span class="fu">ks.test</span>(</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> epsilon_values,</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"pnorm"</span>,</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">mean</span>(epsilon_values),</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd =</span> <span class="fu">sd</span>(epsilon_values)</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>  yy <span class="ot">&lt;-</span> <span class="fu">ks.test</span>(</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> mu_values,</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"pnorm"</span>,</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">mean</span>(mu_values),</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd =</span> <span class="fu">sd</span>(mu_values)</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>  plot_random <span class="ot">&lt;-</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>    mu_values <span class="sc">%&gt;%</span></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.data.table</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setnames</span>(<span class="at">new =</span> <span class="st">"values"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">x =</span> values), <span class="at">fill =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Random Effects"</span>, </span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Density"</span>, </span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Random Effect Residuals (\u03BC)"</span></span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlim</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>      <span class="st">"richtext"</span>,</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="dv">0</span>,</span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="fl">0.3</span>,</span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">label =</span> <span class="st">"&lt;b&gt;Kolmogrov-Smirnov Normality Test&lt;/b&gt;"</span>,</span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> <span class="cn">NA</span>,</span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>      <span class="at">label.color =</span> <span class="cn">NA</span></span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(</span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a>      <span class="st">"text"</span>,</span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="dv">0</span>,</span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="fl">0.28</span>,</span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a>      <span class="at">label =</span></span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a>        <span class="fu">paste0</span>(</span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>          <span class="st">"D-stat = "</span>,</span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a>          <span class="fu">specify_decimal</span>(yy<span class="sc">$</span>statistic, <span class="dv">3</span>),</span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a>          <span class="st">"; p-value = "</span>,</span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a>          <span class="fu">specify_decimal</span>(yy<span class="sc">$</span>p.value, <span class="dv">3</span>)</span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a>      <span class="at">size =</span> <span class="dv">3</span></span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a>  plot_error <span class="ot">&lt;-</span></span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a>    epsilon_values <span class="sc">%&gt;%</span></span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.data.table</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setnames</span>(<span class="at">new =</span> <span class="st">"values"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">x =</span> values), <span class="at">fill =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Model Error Terms"</span>,</span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Density"</span>, </span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a>         <span class="at">title =</span> <span class="st">"Standardized Error Residuals (\u03B5)"</span>) <span class="sc">+</span></span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(</span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a>      <span class="st">"richtext"</span>,</span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fl">0.75</span>,</span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="fl">0.3</span>,</span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a>      <span class="at">label =</span> <span class="st">"&lt;b&gt;Kolmogrov-Smirnov Normality Test&lt;/b&gt;"</span>,</span>
<span id="cb28-80"><a href="#cb28-80" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> <span class="cn">NA</span>,</span>
<span id="cb28-81"><a href="#cb28-81" aria-hidden="true" tabindex="-1"></a>      <span class="at">label.color =</span> <span class="cn">NA</span></span>
<span id="cb28-82"><a href="#cb28-82" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb28-83"><a href="#cb28-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(</span>
<span id="cb28-84"><a href="#cb28-84" aria-hidden="true" tabindex="-1"></a>      <span class="st">"text"</span>,</span>
<span id="cb28-85"><a href="#cb28-85" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="dv">0</span>,</span>
<span id="cb28-86"><a href="#cb28-86" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="fl">0.28</span>,</span>
<span id="cb28-87"><a href="#cb28-87" aria-hidden="true" tabindex="-1"></a>      <span class="at">label =</span> <span class="fu">paste0</span>(</span>
<span id="cb28-88"><a href="#cb28-88" aria-hidden="true" tabindex="-1"></a>        <span class="st">"D-stat = "</span>,</span>
<span id="cb28-89"><a href="#cb28-89" aria-hidden="true" tabindex="-1"></a>        <span class="fu">specify_decimal</span>(xx<span class="sc">$</span>statistic, <span class="dv">3</span>),</span>
<span id="cb28-90"><a href="#cb28-90" aria-hidden="true" tabindex="-1"></a>        <span class="st">"; p-value = "</span>,</span>
<span id="cb28-91"><a href="#cb28-91" aria-hidden="true" tabindex="-1"></a>        <span class="fu">specify_decimal</span>(xx<span class="sc">$</span>p.value, <span class="dv">3</span>)</span>
<span id="cb28-92"><a href="#cb28-92" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb28-93"><a href="#cb28-93" aria-hidden="true" tabindex="-1"></a>      <span class="at">size =</span> <span class="dv">3</span></span>
<span id="cb28-94"><a href="#cb28-94" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-95"><a href="#cb28-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-96"><a href="#cb28-96" aria-hidden="true" tabindex="-1"></a>  plot_random <span class="sc">+</span> plot_error</span>
<span id="cb28-97"><a href="#cb28-97" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-98"><a href="#cb28-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-99"><a href="#cb28-99" aria-hidden="true" tabindex="-1"></a><span class="fu">ebp_kstest</span>(log_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ul_files/figure-html/qual-check-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="cv-estimation" class="level3" data-number="3.5.2">
<h3 data-number="3.5.2" class="anchored" data-anchor-id="cv-estimation"><span class="header-section-number">3.5.2</span> CV Estimation</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="do">### it is important to compare Coefficient of Variation between the survey direct estimates and the census computations. </span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="do">#### first using the povmap::direct() function to estimate the direct and model estimate cvs for the poverty rates</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>ebp_compare_cv <span class="ot">&lt;-</span> <span class="cf">function</span>(ebp_obj, ...) {</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to data.table</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  ind_dt <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(ebp_obj<span class="sc">$</span>ind)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  mse_dt <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(ebp_obj<span class="sc">$</span>MSE)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure mse_dt and ind_dt are numeric except Domain</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  mse_numeric <span class="ot">&lt;-</span> mse_dt[, <span class="sc">!</span>(<span class="st">"Domain"</span>), with <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>  ind_numeric <span class="ot">&lt;-</span> ind_dt[, <span class="sc">!</span>(<span class="st">"Domain"</span>), with <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute CV</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>  ebpcv_dt <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(mse_numeric) <span class="sc">/</span> ind_numeric</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add Domain back</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>  ebpcv_dt[, Domain <span class="sc">:</span><span class="er">=</span> ind_dt<span class="sc">$</span>Domain]</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute direct estimation</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>  direct_dt <span class="ot">&lt;-</span> povmap<span class="sc">::</span><span class="fu">direct</span>(...)</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Identify numeric columns common to both</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>  common_cols <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(direct_dt<span class="sc">$</span>ind), <span class="fu">names</span>(direct_dt<span class="sc">$</span>MSE))</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>  numeric_cols <span class="ot">&lt;-</span> common_cols[<span class="fu">sapply</span>(<span class="fu">as.data.table</span>(direct_dt<span class="sc">$</span>ind)[, ..common_cols], is.numeric)]</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute CV for direct estimation</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>  directcv_dt <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">as.data.table</span>(direct_dt<span class="sc">$</span>MSE)[, ..numeric_cols]) <span class="sc">/</span> </span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">as.data.table</span>(direct_dt<span class="sc">$</span>ind)[, ..numeric_cols]</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add Domain back and rename</span></span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>  directcv_dt <span class="ot">&lt;-</span> </span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cbind</span>(<span class="fu">as.data.table</span>(direct_dt<span class="sc">$</span>ind)[, .(Domain)], directcv_dt) <span class="sc">%&gt;%</span></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(Domain, Head_Count) <span class="sc">%&gt;%</span></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>          <span class="fu">rename</span>(<span class="at">HT_Head_Count =</span> Head_Count)</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Merge direct and EBP results</span></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>  cv_dt <span class="ot">&lt;-</span> directcv_dt[ebpcv_dt, on <span class="ot">=</span> <span class="st">"Domain"</span>]</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rename columns for clarity</span></span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setnames</span>(cv_dt, <span class="st">"Head_Count"</span>, <span class="st">"Head_Count_CV"</span>)</span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setnames</span>(cv_dt, <span class="st">"HT_Head_Count"</span>, <span class="st">"HT_Head_Count_CV"</span>)</span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(cv_dt)</span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a>cv_dt <span class="ot">&lt;-</span> <span class="fu">ebp_compare_cv</span>(<span class="at">ebp_obj =</span> log_model,</span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a>                        <span class="at">y =</span> <span class="st">"eqIncome"</span>,</span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a>                        <span class="at">smp_data =</span> survey_dt,</span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a>                        <span class="at">smp_domains =</span> <span class="st">"district"</span>,</span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a>                        <span class="at">weights =</span> <span class="st">"weight"</span>,</span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a>                        <span class="at">var =</span> <span class="cn">TRUE</span>,</span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a>                        <span class="at">threshold =</span> <span class="fl">18207.2</span>,</span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a>                        <span class="at">design =</span> <span class="st">"state"</span>,</span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a>                        <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a>                        <span class="at">HT =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-61"><a href="#cb29-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-62"><a href="#cb29-62" aria-hidden="true" tabindex="-1"></a><span class="do">### it is useful to be able to be able to figure out how </span></span>
<span id="cb29-63"><a href="#cb29-63" aria-hidden="true" tabindex="-1"></a>gains_value <span class="ot">&lt;-</span> </span>
<span id="cb29-64"><a href="#cb29-64" aria-hidden="true" tabindex="-1"></a>  cv_dt <span class="sc">|&gt;</span></span>
<span id="cb29-65"><a href="#cb29-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gains =</span> HT_Head_Count_CV <span class="sc">/</span> Head_Count_CV) <span class="sc">|&gt;</span></span>
<span id="cb29-66"><a href="#cb29-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">mean</span>(gains, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb29-67"><a href="#cb29-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-68"><a href="#cb29-68" aria-hidden="true" tabindex="-1"></a><span class="do">#### create visualization to show how the EBP CVs are an improvement on the Horwitz-Thompson Headcount CVs</span></span>
<span id="cb29-69"><a href="#cb29-69" aria-hidden="true" tabindex="-1"></a><span class="do">#### as a result of SAE</span></span>
<span id="cb29-70"><a href="#cb29-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-71"><a href="#cb29-71" aria-hidden="true" tabindex="-1"></a>cv_dt <span class="sc">|&gt;</span></span>
<span id="cb29-72"><a href="#cb29-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb29-73"><a href="#cb29-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> Head_Count_CV, <span class="at">x =</span> HT_Head_Count_CV)) <span class="sc">+</span> </span>
<span id="cb29-74"><a href="#cb29-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span> </span>
<span id="cb29-75"><a href="#cb29-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Horwitz-Thompson Headcount CV"</span>,</span>
<span id="cb29-76"><a href="#cb29-76" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"EBP Head Count CV"</span>) <span class="sc">+</span> </span>
<span id="cb29-77"><a href="#cb29-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>, <span class="fl">1.5</span>) <span class="sc">+</span> </span>
<span id="cb29-78"><a href="#cb29-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="fl">1.5</span>) <span class="sc">+</span> </span>
<span id="cb29-79"><a href="#cb29-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">"plasma"</span>) <span class="sc">+</span> </span>
<span id="cb29-80"><a href="#cb29-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 26 rows containing missing values or values outside the scale range
(`geom_point()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ul_files/figure-html/qual-check-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="poverty-map" class="level2" data-number="3.6">
<h2 data-number="3.6" class="anchored" data-anchor-id="poverty-map"><span class="header-section-number">3.6</span> Poverty map</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="do">### plot the poverty map</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="do">#### load the shapefile from the povmap</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>povmap<span class="sc">::</span><span class="fu">load_shapeaustria</span>()</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>log_model<span class="sc">$</span>ind[<span class="fu">c</span>(<span class="st">"Domain"</span>, <span class="st">"Head_Count"</span>)] <span class="sc">|&gt;</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">merge</span>(shape_austria_dis[, <span class="fu">c</span>(<span class="st">"PB"</span>)],</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">by.x =</span> <span class="st">"Domain"</span>, <span class="at">by.y =</span> <span class="st">"PB"</span>) <span class="sc">|&gt;</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>(<span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">|&gt;</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> Head_Count)) <span class="sc">+</span> </span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">"magma"</span>,</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>                       <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>                       <span class="at">name =</span> <span class="st">"Poverty Rate"</span>) <span class="sc">+</span> </span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Poverty Map: Austria"</span>) <span class="sc">+</span> </span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> </span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title =</span> <span class="fu">element_blank</span>(), <span class="co"># Remove axis labels</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text =</span> <span class="fu">element_blank</span>(),  <span class="co"># Remove axis text</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>(), <span class="co"># Remove grid lines</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">16</span>), <span class="co"># Center and style title</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">12</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-povmap" class="quarto-float quarto-figure quarto-figure-center anchored" width="672">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-povmap-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="ul_files/figure-html/fig-povmap-1.png" id="fig-povmap" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-povmap-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.3
</figcaption>
</figure>
</div>
</div>
</div>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-corral2022guidelines" class="csl-entry" role="listitem">
Corral, Paul, Isabel Molina, Alexandru Cojocaru, and Sandra Segovia. 2022. <em>Guidelines to Small Area Estimation for Poverty Mapping</em>. World Bank Washington.
</div>
<div id="ref-kreutzmann2019r" class="csl-entry" role="listitem">
Kreutzmann, Ann-Kristin, Sören Pannier, Natalia Rojas-Perilla, Timo Schmid, Matthias Templ, and Nikos Tzavidis. 2019. <span>“The r Package Emdi for Estimating and Mapping Regionally Disaggregated Indicators.”</span> <em>Journal of Statistical Software</em> 91: 1–33.
</div>
<div id="ref-molina2010small" class="csl-entry" role="listitem">
Molina, Isabel, and Jon NK Rao. 2010. <span>“Small Area Estimation of Poverty Indicators.”</span> <em>Canadian Journal of Statistics</em> 38 (3): 369–85.
</div>
<div id="ref-rao2015small" class="csl-entry" role="listitem">
Rao, John NK, and Isabel Molina. 2015. <em>Small Area Estimation</em>. John Wiley &amp; Sons.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./data.html" class="pagination-link" aria-label="Data preparation">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data preparation</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./references.html" class="pagination-link" aria-label="References">
        <span class="nav-page-text">References</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb32" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span><span class="co"> source</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="an">editor_options:</span><span class="co"> </span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co">  chunk_output_type: console</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="fu"># Unit-Level Models</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup-packages, echo=FALSE, include=TRUE}</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="in">if (sum(installed.packages()[,1] %in% "pacman") != 1) {</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="in">  install.packages("pacman")</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="in">pacman::p_load(</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="in">  povmap, emdi, </span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="in">  data.table, glmnet, glmmLasso, MASS, nlme, </span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="in">  future, survey, flextable, officer,</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot2, ggtext, gridExtra, survey, patchwork,</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="in">  stringr,  dplyr, tidyr)</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>In this section, we will present an implementation of the Empirical Best Prediction (EBP) unit modelling approach in R based on World Bank's Small Area Estimation Guidelines, <span class="co">[</span><span class="ot">@corral2022guidelines</span><span class="co">]</span>, as well as <span class="co">[</span><span class="ot">@molina2010small</span><span class="co">]</span> and <span class="co">[</span><span class="ot">@rao2015small</span><span class="co">]</span>. Similar to the disclaimer made in the previous section, this practical manual does not present a theoretical statistical primer on unit level poverty mapping. Rather, it presents a combination of practical and simple R scripts with appropriate explanations to expose the simplicity of performing these tasks in R to the user. The studies previously cited are excellent starting points for those interested in understanding the theoretical underpinnings for the code being presented here.</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>This chapter is subdivided as follows to show the whole game of the EBP linear mixed effect modelling approach:</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>(A) The Data: In this subsection, we present a brief checklist of data items needed for the unit level poverty mapping as well as present the specific data to be used in this chapter.</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>(B) Data Preparation: Here we present the process of transforming the data in </span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>(A) into what is needed for variable selection and then estimating a unit level poverty map</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>(C) Variable Selection: We present the LASSO methodology of the GLMNET, <span class="in">`glmmLasso`</span> and <span class="in">`hdm`</span> R packages as well as another implementation that uses the stepwise model</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>(D) EBP Unit Level Model Estimation: Having selected the set of variables, we proceed to use the <span class="in">`povmap`</span> package's <span class="in">`povmap::ebp()`</span> function to estimate the poverty map.</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>(E) Post Estimation Diagnostics: We proceed to test model assumptions of the EBP linear mixed effects model and present functions within the <span class="in">`povmap`</span> package for producing report ready figure and tables.</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Data</span></span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>The main idea of SAE is to combine multiple data sources. Typically, there is a survey data set and a census or administrative/register dataset both at an individual and/or household unit level. The target variable (typically household welfare/income for poverty mapping) is available in the survey but not in the census data. The goal of the exercise is to estimate welfare/income for each unit within the census or administrative register dataset by developing a model of welfare or income within the survey. It is important that the outcome variable has the same definition within the census or administrative dataset as the case maybe. It would be inappropriate to estimate household welfare/income within the survey and use the same model to predict income at the individual level of the census. Below is a brief checklist of data requirements needed for unit level poverty mapping with the povmap R package:</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>A unit level survey <span class="in">`data.frame`</span> object with individual and household characteristics including the target area variable, outcome variable (welfare aggregates, income per capita etc)</span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>A unit census/administrative register <span class="in">`dataframe`</span> object with individual and household characteristics including the target area variable. The outcome variable is typically missing since the topic of this tutorial is estimating it.</span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>For the purposes of this tutorial, we will use the European Union Statistics on Income and Living Conditions (EU-SILC) in Austria from 2006. Please see <span class="co">[</span><span class="ot">@kreutzmann2019r</span><span class="co">]</span> for the full description of the dataset</span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a><span class="in">```{r dta-load}</span></span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a><span class="in">### load the data</span></span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a><span class="in">survey_dt &lt;- eusilcA_smp |&gt; as_tibble()</span></span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a><span class="in">## ignore the eqIncome variable that has been left in the eusilcA_pop dataset</span></span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a><span class="in">census_dt &lt;- eusilcA_pop |&gt; as_tibble()</span></span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a><span class="in">#### the survey dataset</span></span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a><span class="in">glimpse(survey_dt)</span></span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a><span class="in">#### the census dataset</span></span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a><span class="in">glimpse(census_dt)</span></span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>All target areas within the survey must be present within the census.</span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a>    The <span class="in">`emdi::ebp()`</span> and <span class="in">`povmap::ebp()`</span> function calls will result in an error message if values in the target area variable are missing within the survey, this includes <span class="in">`NA`</span> values within the survey target area column that are not in the census' target area column.</span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a><span class="in">```{r dta-check}</span></span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a><span class="in">### counting the number of districts (i.e. target areas) </span></span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a><span class="in">### within the survey that are not a subset of the census districts. </span></span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a><span class="in">### When 0 is returned below: there are no areas as such</span></span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a><span class="in">survey_dt |&gt; anti_join(census_dt, join_by(district)) |&gt; nrow()</span></span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a>Other important data for poverty mapping include:</span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>A shapefile of the sub-national boundaries.</span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a>    While a table of poverty rates would suffice, a picture is worth more than a 1000 words and as such <span class="in">`emdi`</span> and <span class="in">`povmap`</span> have functionality for converting the resulting estimates into a map using the <span class="in">`plot()`</span> function within the <span class="in">`emdi`</span> and <span class="in">`povmap`</span> packages. It is essential that the target area variable in the census and survey (which by now should be consistent between the survey and census) should also match with the target area variable within the shapefile in order to use the <span class="in">`plot()`</span> function within <span class="in">`emdi`</span> or <span class="in">`povmap`</span>.</span>
<span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-82"><a href="#cb32-82" aria-hidden="true" tabindex="-1"></a>Once the following steps have been taken, the next stage is to prepare the set of variables for estimating a model of household welfare and predicting the consumption aggregates into the census.</span>
<span id="cb32-83"><a href="#cb32-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-84"><a href="#cb32-84" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Preparation for unit level model</span></span>
<span id="cb32-85"><a href="#cb32-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-86"><a href="#cb32-86" aria-hidden="true" tabindex="-1"></a>In this section, we describe a few common techniques for creating variables with strong correlations to the outcome variable. This includes creating:</span>
<span id="cb32-87"><a href="#cb32-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-88"><a href="#cb32-88" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>variable interactions</span>
<span id="cb32-89"><a href="#cb32-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-90"><a href="#cb32-90" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>target area average variables</span>
<span id="cb32-91"><a href="#cb32-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-92"><a href="#cb32-92" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>dummy variables (at the lowest level of national representation, regional dummies, as well as other dummy variables to capture some non-linear relationships between the certain variables and the outcome variable)</span>
<span id="cb32-93"><a href="#cb32-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-94"><a href="#cb32-94" aria-hidden="true" tabindex="-1"></a>First a little bit of housekeeping is in order:</span>
<span id="cb32-95"><a href="#cb32-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-96"><a href="#cb32-96" aria-hidden="true" tabindex="-1"></a><span class="in">```{r dta-prep-1}</span></span>
<span id="cb32-97"><a href="#cb32-97" aria-hidden="true" tabindex="-1"></a><span class="in">### subset the set of candidate variables into a character vector</span></span>
<span id="cb32-98"><a href="#cb32-98" aria-hidden="true" tabindex="-1"></a><span class="in">candidate_vars &lt;- survey_dt |&gt; </span></span>
<span id="cb32-99"><a href="#cb32-99" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::select(-any_of(c("eqIncome", "weight", "state", "district"))) |&gt; </span></span>
<span id="cb32-100"><a href="#cb32-100" aria-hidden="true" tabindex="-1"></a><span class="in">  names()</span></span>
<span id="cb32-101"><a href="#cb32-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-102"><a href="#cb32-102" aria-hidden="true" tabindex="-1"></a><span class="in">### we have to ensure candidate variables are numbers:</span></span>
<span id="cb32-103"><a href="#cb32-103" aria-hidden="true" tabindex="-1"></a><span class="in">###   (numeric or integer class)</span></span>
<span id="cb32-104"><a href="#cb32-104" aria-hidden="true" tabindex="-1"></a><span class="in">### the only variable that does not meet this criteria is the </span></span>
<span id="cb32-105"><a href="#cb32-105" aria-hidden="true" tabindex="-1"></a><span class="in">### gender variable</span></span>
<span id="cb32-106"><a href="#cb32-106" aria-hidden="true" tabindex="-1"></a><span class="in">survey_dt &lt;- survey_dt |&gt;</span></span>
<span id="cb32-107"><a href="#cb32-107" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(gender = ifelse(gender == "female", 1, 0))</span></span>
<span id="cb32-108"><a href="#cb32-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-109"><a href="#cb32-109" aria-hidden="true" tabindex="-1"></a><span class="in">census_dt &lt;- census_dt |&gt;</span></span>
<span id="cb32-110"><a href="#cb32-110" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(gender = ifelse(gender == "female", 1, 0))</span></span>
<span id="cb32-111"><a href="#cb32-111" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-112"><a href="#cb32-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-113"><a href="#cb32-113" aria-hidden="true" tabindex="-1"></a><span class="fu">### Creating Variable Interactions</span></span>
<span id="cb32-114"><a href="#cb32-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-115"><a href="#cb32-115" aria-hidden="true" tabindex="-1"></a>The <span class="in">`create_interactions()`</span> function employed in the subsequent code block interacts a specified variable <span class="in">`interacter_var`</span> with a list of variables of interest <span class="in">`var_list`</span>. This should be applied to both census and survey data to ensure the same variables are created in both instances.</span>
<span id="cb32-116"><a href="#cb32-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-117"><a href="#cb32-117" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fn-create_interactions}</span></span>
<span id="cb32-118"><a href="#cb32-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-119"><a href="#cb32-119" aria-hidden="true" tabindex="-1"></a><span class="in">### show the function we have used to automate interactions between variables</span></span>
<span id="cb32-120"><a href="#cb32-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-121"><a href="#cb32-121" aria-hidden="true" tabindex="-1"></a><span class="in">#' A function to interact a variables with a set of variables</span></span>
<span id="cb32-122"><a href="#cb32-122" aria-hidden="true" tabindex="-1"></a><span class="in">#' </span></span>
<span id="cb32-123"><a href="#cb32-123" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param dt a data.frame</span></span>
<span id="cb32-124"><a href="#cb32-124" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param interacter_var the variable to be interacted</span></span>
<span id="cb32-125"><a href="#cb32-125" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param var_list the set of variables to interact with</span></span>
<span id="cb32-126"><a href="#cb32-126" aria-hidden="true" tabindex="-1"></a><span class="in">#' </span></span>
<span id="cb32-127"><a href="#cb32-127" aria-hidden="true" tabindex="-1"></a><span class="in">#' @export</span></span>
<span id="cb32-128"><a href="#cb32-128" aria-hidden="true" tabindex="-1"></a><span class="in">#' </span></span>
<span id="cb32-129"><a href="#cb32-129" aria-hidden="true" tabindex="-1"></a><span class="in">create_interactions &lt;- function(dt, interacter_var, var_list) {</span></span>
<span id="cb32-130"><a href="#cb32-130" aria-hidden="true" tabindex="-1"></a><span class="in">  # Ensure dt is a data.table</span></span>
<span id="cb32-131"><a href="#cb32-131" aria-hidden="true" tabindex="-1"></a><span class="in">  if (!"data.frame" %in% class(dt)) {</span></span>
<span id="cb32-132"><a href="#cb32-132" aria-hidden="true" tabindex="-1"></a><span class="in">    dt &lt;- as.data.table(dt)</span></span>
<span id="cb32-133"><a href="#cb32-133" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb32-134"><a href="#cb32-134" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-135"><a href="#cb32-135" aria-hidden="true" tabindex="-1"></a><span class="in">  # Check if interacter_var exists in the dataset</span></span>
<span id="cb32-136"><a href="#cb32-136" aria-hidden="true" tabindex="-1"></a><span class="in">  if (!(interacter_var %in% names(dt))) {</span></span>
<span id="cb32-137"><a href="#cb32-137" aria-hidden="true" tabindex="-1"></a><span class="in">    stop(paste(interacter_var, "not found in dataset"))</span></span>
<span id="cb32-138"><a href="#cb32-138" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb32-139"><a href="#cb32-139" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-140"><a href="#cb32-140" aria-hidden="true" tabindex="-1"></a><span class="in">  # Check if var_list contains valid variables that exist in the dataset</span></span>
<span id="cb32-141"><a href="#cb32-141" aria-hidden="true" tabindex="-1"></a><span class="in">  if (any(!var_list %in% names(dt))) {</span></span>
<span id="cb32-142"><a href="#cb32-142" aria-hidden="true" tabindex="-1"></a><span class="in">    stop("Some variables in var_list are not found in the dataset.")</span></span>
<span id="cb32-143"><a href="#cb32-143" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb32-144"><a href="#cb32-144" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-145"><a href="#cb32-145" aria-hidden="true" tabindex="-1"></a><span class="in">  # Create an empty data.table to store interactions</span></span>
<span id="cb32-146"><a href="#cb32-146" aria-hidden="true" tabindex="-1"></a><span class="in">  int_dt &lt;- data.frame(matrix(nrow = nrow(dt)))</span></span>
<span id="cb32-147"><a href="#cb32-147" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-148"><a href="#cb32-148" aria-hidden="true" tabindex="-1"></a><span class="in">  # Loop over var_list to create interaction terms</span></span>
<span id="cb32-149"><a href="#cb32-149" aria-hidden="true" tabindex="-1"></a><span class="in">  for (var in var_list) {</span></span>
<span id="cb32-150"><a href="#cb32-150" aria-hidden="true" tabindex="-1"></a><span class="in">    interaction_name &lt;- paste0(var, "_X_", interacter_var)</span></span>
<span id="cb32-151"><a href="#cb32-151" aria-hidden="true" tabindex="-1"></a><span class="in">    int_dt[[interaction_name]] &lt;- dt[[var]] * dt[[interacter_var]]</span></span>
<span id="cb32-152"><a href="#cb32-152" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb32-153"><a href="#cb32-153" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-154"><a href="#cb32-154" aria-hidden="true" tabindex="-1"></a><span class="in">  int_dt &lt;- int_dt[, -1]</span></span>
<span id="cb32-155"><a href="#cb32-155" aria-hidden="true" tabindex="-1"></a><span class="in">  return(int_dt)</span></span>
<span id="cb32-156"><a href="#cb32-156" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb32-157"><a href="#cb32-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-158"><a href="#cb32-158" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-159"><a href="#cb32-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-160"><a href="#cb32-160" aria-hidden="true" tabindex="-1"></a><span class="in">```{r dta-prep-2}</span></span>
<span id="cb32-161"><a href="#cb32-161" aria-hidden="true" tabindex="-1"></a><span class="in">survey_dt &lt;- survey_dt |&gt; </span></span>
<span id="cb32-162"><a href="#cb32-162" aria-hidden="true" tabindex="-1"></a><span class="in">  bind_cols(</span></span>
<span id="cb32-163"><a href="#cb32-163" aria-hidden="true" tabindex="-1"></a><span class="in">    create_interactions(</span></span>
<span id="cb32-164"><a href="#cb32-164" aria-hidden="true" tabindex="-1"></a><span class="in">      dt = survey_dt,</span></span>
<span id="cb32-165"><a href="#cb32-165" aria-hidden="true" tabindex="-1"></a><span class="in">      interacter_var = "gender",</span></span>
<span id="cb32-166"><a href="#cb32-166" aria-hidden="true" tabindex="-1"></a><span class="in">      var_list = candidate_vars[!candidate_vars %in% "gender"]</span></span>
<span id="cb32-167"><a href="#cb32-167" aria-hidden="true" tabindex="-1"></a><span class="in">      ) |&gt; </span></span>
<span id="cb32-168"><a href="#cb32-168" aria-hidden="true" tabindex="-1"></a><span class="in">      as_tibble()</span></span>
<span id="cb32-169"><a href="#cb32-169" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb32-170"><a href="#cb32-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-171"><a href="#cb32-171" aria-hidden="true" tabindex="-1"></a><span class="in">census_dt &lt;- census_dt |&gt; </span></span>
<span id="cb32-172"><a href="#cb32-172" aria-hidden="true" tabindex="-1"></a><span class="in">  bind_cols(</span></span>
<span id="cb32-173"><a href="#cb32-173" aria-hidden="true" tabindex="-1"></a><span class="in">    create_interactions(</span></span>
<span id="cb32-174"><a href="#cb32-174" aria-hidden="true" tabindex="-1"></a><span class="in">      dt = census_dt,</span></span>
<span id="cb32-175"><a href="#cb32-175" aria-hidden="true" tabindex="-1"></a><span class="in">      interacter_var = "gender",</span></span>
<span id="cb32-176"><a href="#cb32-176" aria-hidden="true" tabindex="-1"></a><span class="in">      var_list = candidate_vars[!candidate_vars %in% "gender"]</span></span>
<span id="cb32-177"><a href="#cb32-177" aria-hidden="true" tabindex="-1"></a><span class="in">      ) |&gt; </span></span>
<span id="cb32-178"><a href="#cb32-178" aria-hidden="true" tabindex="-1"></a><span class="in">      as_tibble()</span></span>
<span id="cb32-179"><a href="#cb32-179" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb32-180"><a href="#cb32-180" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-181"><a href="#cb32-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-182"><a href="#cb32-182" aria-hidden="true" tabindex="-1"></a><span class="fu">### Computing target area averages and regional dummies</span></span>
<span id="cb32-183"><a href="#cb32-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-184"><a href="#cb32-184" aria-hidden="true" tabindex="-1"></a>It is often useful to compute target area averages to improve the explanation of intra-area variation in the dependent variable. Below is some efficient code that employs the power of the <span class="in">`data.table`</span> package to compute the averages and simultaneously include them within the census and survey datasets.</span>
<span id="cb32-185"><a href="#cb32-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-186"><a href="#cb32-186" aria-hidden="true" tabindex="-1"></a>In addition, creating dummy variables for the lowest resolution administrative division which is also national representative may help control for some unobserved regional heterogeneity, improving model fit and prediction accuracy, capture spatial dependence in welfare patterns. In rear cases, it should be noted that dummy variables with too few observations in any class might introduce high multicollinearity</span>
<span id="cb32-187"><a href="#cb32-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-188"><a href="#cb32-188" aria-hidden="true" tabindex="-1"></a><span class="in">```{r dta-prep-3}</span></span>
<span id="cb32-189"><a href="#cb32-189" aria-hidden="true" tabindex="-1"></a><span class="in">#### compute target area level averages to include in the model</span></span>
<span id="cb32-190"><a href="#cb32-190" aria-hidden="true" tabindex="-1"></a><span class="in">candidate_vars &lt;- survey_dt |&gt;</span></span>
<span id="cb32-191"><a href="#cb32-191" aria-hidden="true" tabindex="-1"></a><span class="in">  select(any_of(candidate_vars), contains("_X_")) |&gt;</span></span>
<span id="cb32-192"><a href="#cb32-192" aria-hidden="true" tabindex="-1"></a><span class="in">  names()</span></span>
<span id="cb32-193"><a href="#cb32-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-194"><a href="#cb32-194" aria-hidden="true" tabindex="-1"></a><span class="in">survey_dt &lt;- </span></span>
<span id="cb32-195"><a href="#cb32-195" aria-hidden="true" tabindex="-1"></a><span class="in">  survey_dt |&gt; </span></span>
<span id="cb32-196"><a href="#cb32-196" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(district) |&gt; </span></span>
<span id="cb32-197"><a href="#cb32-197" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb32-198"><a href="#cb32-198" aria-hidden="true" tabindex="-1"></a><span class="in">    across(</span></span>
<span id="cb32-199"><a href="#cb32-199" aria-hidden="true" tabindex="-1"></a><span class="in">      any_of(candidate_vars),</span></span>
<span id="cb32-200"><a href="#cb32-200" aria-hidden="true" tabindex="-1"></a><span class="in">      ~ weighted.mean(x = ., w = weight, na.rm = TRUE), </span></span>
<span id="cb32-201"><a href="#cb32-201" aria-hidden="true" tabindex="-1"></a><span class="in">      .names = "{.col}_targetmean"</span></span>
<span id="cb32-202"><a href="#cb32-202" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb32-203"><a href="#cb32-203" aria-hidden="true" tabindex="-1"></a><span class="in">  ) |&gt; </span></span>
<span id="cb32-204"><a href="#cb32-204" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup()</span></span>
<span id="cb32-205"><a href="#cb32-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-206"><a href="#cb32-206" aria-hidden="true" tabindex="-1"></a><span class="in">census_dt &lt;-</span></span>
<span id="cb32-207"><a href="#cb32-207" aria-hidden="true" tabindex="-1"></a><span class="in">  census_dt |&gt; </span></span>
<span id="cb32-208"><a href="#cb32-208" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(district) |&gt; </span></span>
<span id="cb32-209"><a href="#cb32-209" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb32-210"><a href="#cb32-210" aria-hidden="true" tabindex="-1"></a><span class="in">    across(</span></span>
<span id="cb32-211"><a href="#cb32-211" aria-hidden="true" tabindex="-1"></a><span class="in">      any_of(candidate_vars),</span></span>
<span id="cb32-212"><a href="#cb32-212" aria-hidden="true" tabindex="-1"></a><span class="in">      ~ weighted.mean(x = ., na.rm = TRUE), </span></span>
<span id="cb32-213"><a href="#cb32-213" aria-hidden="true" tabindex="-1"></a><span class="in">      .names = "{.col}_targetmean"</span></span>
<span id="cb32-214"><a href="#cb32-214" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb32-215"><a href="#cb32-215" aria-hidden="true" tabindex="-1"></a><span class="in">  ) |&gt; </span></span>
<span id="cb32-216"><a href="#cb32-216" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup()</span></span>
<span id="cb32-217"><a href="#cb32-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-218"><a href="#cb32-218" aria-hidden="true" tabindex="-1"></a><span class="in">#### create regional dummies</span></span>
<span id="cb32-219"><a href="#cb32-219" aria-hidden="true" tabindex="-1"></a><span class="in">survey_dt &lt;-</span></span>
<span id="cb32-220"><a href="#cb32-220" aria-hidden="true" tabindex="-1"></a><span class="in">  survey_dt |&gt;</span></span>
<span id="cb32-221"><a href="#cb32-221" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(dummy = 1, state2 = state) |&gt;</span></span>
<span id="cb32-222"><a href="#cb32-222" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_wider(names_from = state2,</span></span>
<span id="cb32-223"><a href="#cb32-223" aria-hidden="true" tabindex="-1"></a><span class="in">              names_prefix = "state_",</span></span>
<span id="cb32-224"><a href="#cb32-224" aria-hidden="true" tabindex="-1"></a><span class="in">              values_from = dummy,</span></span>
<span id="cb32-225"><a href="#cb32-225" aria-hidden="true" tabindex="-1"></a><span class="in">              values_fill = 0) |&gt;</span></span>
<span id="cb32-226"><a href="#cb32-226" aria-hidden="true" tabindex="-1"></a><span class="in">  rename_with(~ str_replace(., " ", ""), starts_with("state_")) </span></span>
<span id="cb32-227"><a href="#cb32-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-228"><a href="#cb32-228" aria-hidden="true" tabindex="-1"></a><span class="in">census_dt &lt;-</span></span>
<span id="cb32-229"><a href="#cb32-229" aria-hidden="true" tabindex="-1"></a><span class="in">  census_dt |&gt;</span></span>
<span id="cb32-230"><a href="#cb32-230" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(dummy = 1, state2 = state) |&gt;</span></span>
<span id="cb32-231"><a href="#cb32-231" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_wider(names_from = state2,</span></span>
<span id="cb32-232"><a href="#cb32-232" aria-hidden="true" tabindex="-1"></a><span class="in">              names_prefix = "state_",</span></span>
<span id="cb32-233"><a href="#cb32-233" aria-hidden="true" tabindex="-1"></a><span class="in">              values_from = dummy,</span></span>
<span id="cb32-234"><a href="#cb32-234" aria-hidden="true" tabindex="-1"></a><span class="in">              values_fill = 0) |&gt;</span></span>
<span id="cb32-235"><a href="#cb32-235" aria-hidden="true" tabindex="-1"></a><span class="in">  rename_with(~ str_replace(., " ", ""), starts_with("state_"))</span></span>
<span id="cb32-236"><a href="#cb32-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-237"><a href="#cb32-237" aria-hidden="true" tabindex="-1"></a><span class="in">#### lets update the set of candidate variables</span></span>
<span id="cb32-238"><a href="#cb32-238" aria-hidden="true" tabindex="-1"></a><span class="in">candidate_vars &lt;- survey_dt |&gt; </span></span>
<span id="cb32-239"><a href="#cb32-239" aria-hidden="true" tabindex="-1"></a><span class="in">  select(any_of(candidate_vars), contains("state_")) |&gt; </span></span>
<span id="cb32-240"><a href="#cb32-240" aria-hidden="true" tabindex="-1"></a><span class="in">  names()</span></span>
<span id="cb32-241"><a href="#cb32-241" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-242"><a href="#cb32-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-243"><a href="#cb32-243" aria-hidden="true" tabindex="-1"></a>In rear cases, it should be noted that dummy variables with too few observations in any class might introduce high multicollinearity or reduce the degrees of freedom.</span>
<span id="cb32-244"><a href="#cb32-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-245"><a href="#cb32-245" aria-hidden="true" tabindex="-1"></a><span class="fu">### Final Preparations for Variable Selection</span></span>
<span id="cb32-246"><a href="#cb32-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-247"><a href="#cb32-247" aria-hidden="true" tabindex="-1"></a>Certain diagnostics checks ought to be performed before the variable selection process is implemented. First, we check the distribution of the non-transformed outcome variable. In the case of income or household consumption, it is typically expected and preferred that the income/household consumption variable can be transformed into a normally distributed random variable. We apply the log and boxcox transformations as seen in the code below:</span>
<span id="cb32-248"><a href="#cb32-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-249"><a href="#cb32-249" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-dist-boxcox, fig.width = 8}</span></span>
<span id="cb32-250"><a href="#cb32-250" aria-hidden="true" tabindex="-1"></a><span class="in">#### let's create the set of outcome variables for the different potential</span></span>
<span id="cb32-251"><a href="#cb32-251" aria-hidden="true" tabindex="-1"></a><span class="in">#### income transformations we might be interested in doing</span></span>
<span id="cb32-252"><a href="#cb32-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-253"><a href="#cb32-253" aria-hidden="true" tabindex="-1"></a><span class="in">###### log transformation</span></span>
<span id="cb32-254"><a href="#cb32-254" aria-hidden="true" tabindex="-1"></a><span class="in">survey_dt &lt;- </span></span>
<span id="cb32-255"><a href="#cb32-255" aria-hidden="true" tabindex="-1"></a><span class="in">  survey_dt |&gt;</span></span>
<span id="cb32-256"><a href="#cb32-256" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(logeqIncome = log(eqIncome))</span></span>
<span id="cb32-257"><a href="#cb32-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-258"><a href="#cb32-258" aria-hidden="true" tabindex="-1"></a><span class="in">###### boxcox transformation</span></span>
<span id="cb32-259"><a href="#cb32-259" aria-hidden="true" tabindex="-1"></a><span class="in">#### apply box-cox transformation</span></span>
<span id="cb32-260"><a href="#cb32-260" aria-hidden="true" tabindex="-1"></a><span class="in">boxcox_result &lt;- MASS::boxcox(lm(eqIncome ~ 1, data = survey_dt), </span></span>
<span id="cb32-261"><a href="#cb32-261" aria-hidden="true" tabindex="-1"></a><span class="in">                              lambda = seq(-2, 2, by = 0.1))</span></span>
<span id="cb32-262"><a href="#cb32-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-263"><a href="#cb32-263" aria-hidden="true" tabindex="-1"></a><span class="in">lambda_opt &lt;- boxcox_result$x[which.max(boxcox_result$y)]</span></span>
<span id="cb32-264"><a href="#cb32-264" aria-hidden="true" tabindex="-1"></a><span class="in">cat("Optimal Lambda:", lambda_opt, "\n")</span></span>
<span id="cb32-265"><a href="#cb32-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-266"><a href="#cb32-266" aria-hidden="true" tabindex="-1"></a><span class="in">## Apply the transformation manually</span></span>
<span id="cb32-267"><a href="#cb32-267" aria-hidden="true" tabindex="-1"></a><span class="in">if (lambda_opt == 0) {</span></span>
<span id="cb32-268"><a href="#cb32-268" aria-hidden="true" tabindex="-1"></a><span class="in">  survey_dt &lt;-</span></span>
<span id="cb32-269"><a href="#cb32-269" aria-hidden="true" tabindex="-1"></a><span class="in">    survey_dt |&gt;</span></span>
<span id="cb32-270"><a href="#cb32-270" aria-hidden="true" tabindex="-1"></a><span class="in">    mutate(bcxeqIncome = log(eqIncome))</span></span>
<span id="cb32-271"><a href="#cb32-271" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-272"><a href="#cb32-272" aria-hidden="true" tabindex="-1"></a><span class="in">} else {</span></span>
<span id="cb32-273"><a href="#cb32-273" aria-hidden="true" tabindex="-1"></a><span class="in">  survey_dt &lt;-</span></span>
<span id="cb32-274"><a href="#cb32-274" aria-hidden="true" tabindex="-1"></a><span class="in">    survey_dt |&gt;</span></span>
<span id="cb32-275"><a href="#cb32-275" aria-hidden="true" tabindex="-1"></a><span class="in">    mutate(bcxeqIncome = (eqIncome^lambda_opt - 1) / lambda_opt)</span></span>
<span id="cb32-276"><a href="#cb32-276" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-277"><a href="#cb32-277" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb32-278"><a href="#cb32-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-279"><a href="#cb32-279" aria-hidden="true" tabindex="-1"></a><span class="in">#### compare the distributions of the outcome variables created</span></span>
<span id="cb32-280"><a href="#cb32-280" aria-hidden="true" tabindex="-1"></a><span class="in">p1 &lt;-</span></span>
<span id="cb32-281"><a href="#cb32-281" aria-hidden="true" tabindex="-1"></a><span class="in">  survey_dt |&gt;</span></span>
<span id="cb32-282"><a href="#cb32-282" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot() +</span></span>
<span id="cb32-283"><a href="#cb32-283" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_histogram(</span></span>
<span id="cb32-284"><a href="#cb32-284" aria-hidden="true" tabindex="-1"></a><span class="in">    aes(x = logeqIncome),</span></span>
<span id="cb32-285"><a href="#cb32-285" aria-hidden="true" tabindex="-1"></a><span class="in">    binwidth = 0.5,</span></span>
<span id="cb32-286"><a href="#cb32-286" aria-hidden="true" tabindex="-1"></a><span class="in">    fill = "blue",</span></span>
<span id="cb32-287"><a href="#cb32-287" aria-hidden="true" tabindex="-1"></a><span class="in">    color = "black"</span></span>
<span id="cb32-288"><a href="#cb32-288" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb32-289"><a href="#cb32-289" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = "Log Income Distribution") +</span></span>
<span id="cb32-290"><a href="#cb32-290" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_minimal()</span></span>
<span id="cb32-291"><a href="#cb32-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-292"><a href="#cb32-292" aria-hidden="true" tabindex="-1"></a><span class="in">p2 &lt;-</span></span>
<span id="cb32-293"><a href="#cb32-293" aria-hidden="true" tabindex="-1"></a><span class="in">  survey_dt |&gt;</span></span>
<span id="cb32-294"><a href="#cb32-294" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot() +</span></span>
<span id="cb32-295"><a href="#cb32-295" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_histogram(</span></span>
<span id="cb32-296"><a href="#cb32-296" aria-hidden="true" tabindex="-1"></a><span class="in">    aes(x = bcxeqIncome),</span></span>
<span id="cb32-297"><a href="#cb32-297" aria-hidden="true" tabindex="-1"></a><span class="in">    binwidth = 0.5,</span></span>
<span id="cb32-298"><a href="#cb32-298" aria-hidden="true" tabindex="-1"></a><span class="in">    fill = "red",</span></span>
<span id="cb32-299"><a href="#cb32-299" aria-hidden="true" tabindex="-1"></a><span class="in">    color = "black"</span></span>
<span id="cb32-300"><a href="#cb32-300" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb32-301"><a href="#cb32-301" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = "Box-Cox Income Distribution") +</span></span>
<span id="cb32-302"><a href="#cb32-302" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_minimal()</span></span>
<span id="cb32-303"><a href="#cb32-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-304"><a href="#cb32-304" aria-hidden="true" tabindex="-1"></a><span class="in">p1 + p2</span></span>
<span id="cb32-305"><a href="#cb32-305" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-306"><a href="#cb32-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-307"><a href="#cb32-307" aria-hidden="true" tabindex="-1"></a>Several other transformations are also possible including the ordernorm transformation. See <span class="in">`bestNormalize::orderNorm()`</span> documentation for more details.</span>
<span id="cb32-308"><a href="#cb32-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-309"><a href="#cb32-309" aria-hidden="true" tabindex="-1"></a>Next, we ensure the candidate variables in the survey and census come from similar distributions. One assumption of the linear mixed effects approach is that the variables selected are drawn from the same distribution. </span>
<span id="cb32-310"><a href="#cb32-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-311"><a href="#cb32-311" aria-hidden="true" tabindex="-1"></a>In the following chunk, we apply the <span class="in">`povmap::ebp_test_means()`</span> function to present a table of means for each survey and census and show the results of the standard z-tests. It is common to drop values that reject the null hypothesis (at the 95% level) that the survey variable (for any given variable) has a different mean from the same variable in the census.</span>
<span id="cb32-312"><a href="#cb32-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-313"><a href="#cb32-313" aria-hidden="true" tabindex="-1"></a><span class="in">```{r tbl-means-eqivalence}</span></span>
<span id="cb32-314"><a href="#cb32-314" aria-hidden="true" tabindex="-1"></a><span class="in">test_dt &lt;- povmap::ebp_test_means(varlist = candidate_vars,</span></span>
<span id="cb32-315"><a href="#cb32-315" aria-hidden="true" tabindex="-1"></a><span class="in">                                  smp_data = survey_dt,</span></span>
<span id="cb32-316"><a href="#cb32-316" aria-hidden="true" tabindex="-1"></a><span class="in">                                  pop_data = census_dt,</span></span>
<span id="cb32-317"><a href="#cb32-317" aria-hidden="true" tabindex="-1"></a><span class="in">                                  weights = "weight")</span></span>
<span id="cb32-318"><a href="#cb32-318" aria-hidden="true" tabindex="-1"></a><span class="in">test_dt |&gt; flextable() |&gt; colformat_double(big.mark = "", digits = 3)</span></span>
<span id="cb32-319"><a href="#cb32-319" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-320"><a href="#cb32-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-321"><a href="#cb32-321" aria-hidden="true" tabindex="-1"></a>However, the <span class="in">`ebp_test_means`</span> function doesn't control for the fact that the variables are national representative at the state level. We implement another variant to the <span class="in">`ebp_test_means`</span> that will allow users to cluster the standard errors at the state level.</span>
<span id="cb32-322"><a href="#cb32-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-323"><a href="#cb32-323" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fn-ebp_test_means_clustered}</span></span>
<span id="cb32-324"><a href="#cb32-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-325"><a href="#cb32-325" aria-hidden="true" tabindex="-1"></a><span class="in">#' Perform test for difference between survey and census means </span></span>
<span id="cb32-326"><a href="#cb32-326" aria-hidden="true" tabindex="-1"></a><span class="in">#' </span></span>
<span id="cb32-327"><a href="#cb32-327" aria-hidden="true" tabindex="-1"></a><span class="in">#' This function computes weighted means of the same set of variables within the census and survey controlling for a cluster level. A test for </span></span>
<span id="cb32-328"><a href="#cb32-328" aria-hidden="true" tabindex="-1"></a><span class="in">#' difference of the means are performed for each variable with two-tailed p-values returned and the cluster level has to be specified for the</span></span>
<span id="cb32-329"><a href="#cb32-329" aria-hidden="true" tabindex="-1"></a><span class="in">#' estimation of variance</span></span>
<span id="cb32-330"><a href="#cb32-330" aria-hidden="true" tabindex="-1"></a><span class="in">#' </span></span>
<span id="cb32-331"><a href="#cb32-331" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param varlist character vector, the set of variables of interest</span></span>
<span id="cb32-332"><a href="#cb32-332" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param smp_data the survey data</span></span>
<span id="cb32-333"><a href="#cb32-333" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param pop_data the population data</span></span>
<span id="cb32-334"><a href="#cb32-334" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param weights a character string containing the name of a variable that indicates weights in the sample data. If a character string is </span></span>
<span id="cb32-335"><a href="#cb32-335" aria-hidden="true" tabindex="-1"></a><span class="in">#' provided a weighted version of the ebp will be used.</span></span>
<span id="cb32-336"><a href="#cb32-336" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param pop_weights a character string containing the name of a variable that indicates population weights in the population data. If a </span></span>
<span id="cb32-337"><a href="#cb32-337" aria-hidden="true" tabindex="-1"></a><span class="in">#' If a character string is provided weighted indicators are estimated using population weights. The variable has to be numeric. </span></span>
<span id="cb32-338"><a href="#cb32-338" aria-hidden="true" tabindex="-1"></a><span class="in">#' Defaults to NULL. </span></span>
<span id="cb32-339"><a href="#cb32-339" aria-hidden="true" tabindex="-1"></a><span class="in">#' </span></span>
<span id="cb32-340"><a href="#cb32-340" aria-hidden="true" tabindex="-1"></a><span class="in">#' @import survey</span></span>
<span id="cb32-341"><a href="#cb32-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-342"><a href="#cb32-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-343"><a href="#cb32-343" aria-hidden="true" tabindex="-1"></a><span class="in">ebp_test_means_clustered &lt;- function(varlist, </span></span>
<span id="cb32-344"><a href="#cb32-344" aria-hidden="true" tabindex="-1"></a><span class="in">                                     smp_data, </span></span>
<span id="cb32-345"><a href="#cb32-345" aria-hidden="true" tabindex="-1"></a><span class="in">                                     pop_data, </span></span>
<span id="cb32-346"><a href="#cb32-346" aria-hidden="true" tabindex="-1"></a><span class="in">                                     cluster, </span></span>
<span id="cb32-347"><a href="#cb32-347" aria-hidden="true" tabindex="-1"></a><span class="in">                                     weights = NULL, </span></span>
<span id="cb32-348"><a href="#cb32-348" aria-hidden="true" tabindex="-1"></a><span class="in">                                     pop_weights = NULL) {</span></span>
<span id="cb32-349"><a href="#cb32-349" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-350"><a href="#cb32-350" aria-hidden="true" tabindex="-1"></a><span class="in">  if (is.null(weights)) {</span></span>
<span id="cb32-351"><a href="#cb32-351" aria-hidden="true" tabindex="-1"></a><span class="in">    smp_data$weights &lt;- rep(1, nrow(smp_data))</span></span>
<span id="cb32-352"><a href="#cb32-352" aria-hidden="true" tabindex="-1"></a><span class="in">    weights &lt;- "weights"</span></span>
<span id="cb32-353"><a href="#cb32-353" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb32-354"><a href="#cb32-354" aria-hidden="true" tabindex="-1"></a><span class="in">  if (is.null(pop_weights)) {</span></span>
<span id="cb32-355"><a href="#cb32-355" aria-hidden="true" tabindex="-1"></a><span class="in">    pop_data$pop_weights &lt;- rep(1, nrow(pop_data))</span></span>
<span id="cb32-356"><a href="#cb32-356" aria-hidden="true" tabindex="-1"></a><span class="in">    pop_weights &lt;- "pop_weights"</span></span>
<span id="cb32-357"><a href="#cb32-357" aria-hidden="true" tabindex="-1"></a><span class="in">  } else {</span></span>
<span id="cb32-358"><a href="#cb32-358" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb32-359"><a href="#cb32-359" aria-hidden="true" tabindex="-1"></a><span class="in">    pop_data$pop_weights &lt;- pop_data[[pop_weights]]</span></span>
<span id="cb32-360"><a href="#cb32-360" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb32-361"><a href="#cb32-361" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb32-362"><a href="#cb32-362" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-363"><a href="#cb32-363" aria-hidden="true" tabindex="-1"></a><span class="in">  smp_df &lt;- smp_data[complete.cases(smp_data[, c(varlist, weights, cluster)]), c(varlist, weights, cluster)]</span></span>
<span id="cb32-364"><a href="#cb32-364" aria-hidden="true" tabindex="-1"></a><span class="in">  pop_df &lt;- pop_data[complete.cases(pop_data[, c(varlist, "pop_weights", cluster)]), c(varlist, "pop_weights", cluster)]</span></span>
<span id="cb32-365"><a href="#cb32-365" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-366"><a href="#cb32-366" aria-hidden="true" tabindex="-1"></a><span class="in">  smp_df &lt;- smp_df |&gt; mutate(across(all_of(varlist), as.numeric))</span></span>
<span id="cb32-367"><a href="#cb32-367" aria-hidden="true" tabindex="-1"></a><span class="in">  pop_df &lt;- pop_df |&gt; mutate(across(all_of(varlist), as.numeric))</span></span>
<span id="cb32-368"><a href="#cb32-368" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-369"><a href="#cb32-369" aria-hidden="true" tabindex="-1"></a><span class="in">  # Define survey design with clustering</span></span>
<span id="cb32-370"><a href="#cb32-370" aria-hidden="true" tabindex="-1"></a><span class="in">  smp_design &lt;- svydesign(id = ~get(cluster), weights = ~get(weights), data = smp_df)</span></span>
<span id="cb32-371"><a href="#cb32-371" aria-hidden="true" tabindex="-1"></a><span class="in">  pop_design &lt;- svydesign(id = ~get(cluster), weights = ~pop_weights, data = pop_df)</span></span>
<span id="cb32-372"><a href="#cb32-372" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-373"><a href="#cb32-373" aria-hidden="true" tabindex="-1"></a><span class="in">  smp_means_df &lt;- data.frame(</span></span>
<span id="cb32-374"><a href="#cb32-374" aria-hidden="true" tabindex="-1"></a><span class="in">    smp_means = sapply(varlist, function(var) svymean(as.formula(paste("~", var)), smp_design)[1]),</span></span>
<span id="cb32-375"><a href="#cb32-375" aria-hidden="true" tabindex="-1"></a><span class="in">    smp_se = sapply(varlist, function(var) SE(svymean(as.formula(paste("~", var)), smp_design))),</span></span>
<span id="cb32-376"><a href="#cb32-376" aria-hidden="true" tabindex="-1"></a><span class="in">    variable = varlist</span></span>
<span id="cb32-377"><a href="#cb32-377" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb32-378"><a href="#cb32-378" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-379"><a href="#cb32-379" aria-hidden="true" tabindex="-1"></a><span class="in">  pop_means_df &lt;- data.frame(</span></span>
<span id="cb32-380"><a href="#cb32-380" aria-hidden="true" tabindex="-1"></a><span class="in">    pop_means = sapply(varlist, function(var) svymean(as.formula(paste("~", var)), pop_design)[1]),</span></span>
<span id="cb32-381"><a href="#cb32-381" aria-hidden="true" tabindex="-1"></a><span class="in">    pop_se = sapply(varlist, function(var) SE(svymean(as.formula(paste("~", var)), pop_design))),</span></span>
<span id="cb32-382"><a href="#cb32-382" aria-hidden="true" tabindex="-1"></a><span class="in">    variable = varlist</span></span>
<span id="cb32-383"><a href="#cb32-383" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb32-384"><a href="#cb32-384" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-385"><a href="#cb32-385" aria-hidden="true" tabindex="-1"></a><span class="in">  means_df &lt;- merge(smp_means_df, pop_means_df, by = "variable")</span></span>
<span id="cb32-386"><a href="#cb32-386" aria-hidden="true" tabindex="-1"></a><span class="in">  means_df$diff &lt;- means_df$pop_means - means_df$smp_means</span></span>
<span id="cb32-387"><a href="#cb32-387" aria-hidden="true" tabindex="-1"></a><span class="in">  means_df$diff_se &lt;- sqrt(means_df$smp_se^2 + means_df$pop_se^2)</span></span>
<span id="cb32-388"><a href="#cb32-388" aria-hidden="true" tabindex="-1"></a><span class="in">  means_df$zscore &lt;- means_df$diff / means_df$diff_se</span></span>
<span id="cb32-389"><a href="#cb32-389" aria-hidden="true" tabindex="-1"></a><span class="in">  means_df$pvalue &lt;- 2 * (1 - pnorm(abs(means_df$zscore)))</span></span>
<span id="cb32-390"><a href="#cb32-390" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-391"><a href="#cb32-391" aria-hidden="true" tabindex="-1"></a><span class="in">  return(means_df[, c("variable", "smp_means", "pop_means", "diff", "pvalue")])</span></span>
<span id="cb32-392"><a href="#cb32-392" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-393"><a href="#cb32-393" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb32-394"><a href="#cb32-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-395"><a href="#cb32-395" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-396"><a href="#cb32-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-397"><a href="#cb32-397" aria-hidden="true" tabindex="-1"></a><span class="in">```{r tbl-mean-eq-clustered}</span></span>
<span id="cb32-398"><a href="#cb32-398" aria-hidden="true" tabindex="-1"></a><span class="in">test_dt &lt;- </span></span>
<span id="cb32-399"><a href="#cb32-399" aria-hidden="true" tabindex="-1"></a><span class="in">  ebp_test_means_clustered(</span></span>
<span id="cb32-400"><a href="#cb32-400" aria-hidden="true" tabindex="-1"></a><span class="in">    varlist = candidate_vars,</span></span>
<span id="cb32-401"><a href="#cb32-401" aria-hidden="true" tabindex="-1"></a><span class="in">    smp_data = survey_dt,</span></span>
<span id="cb32-402"><a href="#cb32-402" aria-hidden="true" tabindex="-1"></a><span class="in">    pop_data = census_dt,</span></span>
<span id="cb32-403"><a href="#cb32-403" aria-hidden="true" tabindex="-1"></a><span class="in">    cluster = "state",</span></span>
<span id="cb32-404"><a href="#cb32-404" aria-hidden="true" tabindex="-1"></a><span class="in">    weights = "weight"</span></span>
<span id="cb32-405"><a href="#cb32-405" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb32-406"><a href="#cb32-406" aria-hidden="true" tabindex="-1"></a><span class="in">test_dt |&gt; flextable() |&gt; colformat_double(big.mark = "", digits = 3)</span></span>
<span id="cb32-407"><a href="#cb32-407" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-408"><a href="#cb32-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-409"><a href="#cb32-409" aria-hidden="true" tabindex="-1"></a>In the next section, we fold the final checks into the variable selection process. We drop variables that are highly correlated and set a sparsity threshold. The sparsity threshold ensures that variables that do not have a certain proportion of non-missing observations are dropped. We have folded both these checks into the <span class="in">`glmnetlasso_vselect()`</span> function.</span>
<span id="cb32-410"><a href="#cb32-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-411"><a href="#cb32-411" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Variable Selection Process</span></span>
<span id="cb32-412"><a href="#cb32-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-413"><a href="#cb32-413" aria-hidden="true" tabindex="-1"></a>The <span class="in">`glmnetlasso_vselect()`</span> function takes the dependent variable (welfare or income variable) as well as the set of potential candidate variables which just created and applies the lasso methodology (run <span class="in">`here(glmnet::glmnet)`</span> for more details). This includes the option to perform a reproducible n-fold cross validation to reduce the risk of overfitting the model. In this instance, we have run applied this function to select the best predictors of household welfare based on the 3 welfare transformations i.e. 3 separate runs of the function, one for each transformation. See below:</span>
<span id="cb32-414"><a href="#cb32-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-415"><a href="#cb32-415" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fn-glmnetlasso_vselect}</span></span>
<span id="cb32-416"><a href="#cb32-416" aria-hidden="true" tabindex="-1"></a><span class="in">#' A function for variable selection using the GLMNET R package</span></span>
<span id="cb32-417"><a href="#cb32-417" aria-hidden="true" tabindex="-1"></a><span class="in">#' </span></span>
<span id="cb32-418"><a href="#cb32-418" aria-hidden="true" tabindex="-1"></a><span class="in">#' This function acts as a wrapper to the GLMNET R package which performs variable selection with nfold cross validation. </span></span>
<span id="cb32-419"><a href="#cb32-419" aria-hidden="true" tabindex="-1"></a><span class="in">#' </span></span>
<span id="cb32-420"><a href="#cb32-420" aria-hidden="true" tabindex="-1"></a><span class="in">#' @details This function cleans the data `dt` first by standardizing the predictors, dropping columns with missing values, very low variance (near</span></span>
<span id="cb32-421"><a href="#cb32-421" aria-hidden="true" tabindex="-1"></a><span class="in">#' zero variance), highly correlated variables based on a certain `correlation_threshold`. The function also drops variables with an high percentage #' of zeros based on a `sparsity_threshold`. It then fits the lasso regression with the GLMNET package before returning the best combination of</span></span>
<span id="cb32-422"><a href="#cb32-422" aria-hidden="true" tabindex="-1"></a><span class="in">#' predictive variables based on the `lambda_type` selection criteria. </span></span>
<span id="cb32-423"><a href="#cb32-423" aria-hidden="true" tabindex="-1"></a><span class="in">#' </span></span>
<span id="cb32-424"><a href="#cb32-424" aria-hidden="true" tabindex="-1"></a><span class="in">#' </span></span>
<span id="cb32-425"><a href="#cb32-425" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param dt data.frame or data.table</span></span>
<span id="cb32-426"><a href="#cb32-426" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param candidate_vars character, the set of potential predictors within `dt`</span></span>
<span id="cb32-427"><a href="#cb32-427" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param y character, the variable name of the outcome variable within `dt`</span></span>
<span id="cb32-428"><a href="#cb32-428" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param weights character, weight variable name</span></span>
<span id="cb32-429"><a href="#cb32-429" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param alpha integer, 1 for LASSO and 0 for ridge regression</span></span>
<span id="cb32-430"><a href="#cb32-430" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param nfolds integer, the number of cross fold validations to perform</span></span>
<span id="cb32-431"><a href="#cb32-431" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param seed integer, randomization seed </span></span>
<span id="cb32-432"><a href="#cb32-432" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param lambda_type, either "lambda.min" or "lambda.1se". see `glmnet::glmnet()` for more information</span></span>
<span id="cb32-433"><a href="#cb32-433" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param correlation_threshold numeric, the threshold for dropping correlated variables (value between 0 and 1)</span></span>
<span id="cb32-434"><a href="#cb32-434" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param variance_threshold numeric, threshold for dropping variables that appear almost constant by specifying a minimum variance that must be met</span></span>
<span id="cb32-435"><a href="#cb32-435" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param sparsity_threshold numeric, threshold for dropping sparse variables</span></span>
<span id="cb32-436"><a href="#cb32-436" aria-hidden="true" tabindex="-1"></a><span class="in">#' </span></span>
<span id="cb32-437"><a href="#cb32-437" aria-hidden="true" tabindex="-1"></a><span class="in">#' @export</span></span>
<span id="cb32-438"><a href="#cb32-438" aria-hidden="true" tabindex="-1"></a><span class="in">#' </span></span>
<span id="cb32-439"><a href="#cb32-439" aria-hidden="true" tabindex="-1"></a><span class="in">#' @import glmnet </span></span>
<span id="cb32-440"><a href="#cb32-440" aria-hidden="true" tabindex="-1"></a><span class="in">#' @importFrom caret findCorrelation</span></span>
<span id="cb32-441"><a href="#cb32-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-442"><a href="#cb32-442" aria-hidden="true" tabindex="-1"></a><span class="in">glmnetlasso_vselect &lt;- function(dt, </span></span>
<span id="cb32-443"><a href="#cb32-443" aria-hidden="true" tabindex="-1"></a><span class="in">                                candidate_vars, </span></span>
<span id="cb32-444"><a href="#cb32-444" aria-hidden="true" tabindex="-1"></a><span class="in">                                y, </span></span>
<span id="cb32-445"><a href="#cb32-445" aria-hidden="true" tabindex="-1"></a><span class="in">                                weights, </span></span>
<span id="cb32-446"><a href="#cb32-446" aria-hidden="true" tabindex="-1"></a><span class="in">                                alpha = 1, </span></span>
<span id="cb32-447"><a href="#cb32-447" aria-hidden="true" tabindex="-1"></a><span class="in">                                nfolds, </span></span>
<span id="cb32-448"><a href="#cb32-448" aria-hidden="true" tabindex="-1"></a><span class="in">                                seed = 123,</span></span>
<span id="cb32-449"><a href="#cb32-449" aria-hidden="true" tabindex="-1"></a><span class="in">                                lambda_type = "lambda.min",</span></span>
<span id="cb32-450"><a href="#cb32-450" aria-hidden="true" tabindex="-1"></a><span class="in">                                correlation_threshold = 0.9, # Threshold for dropping correlated variables</span></span>
<span id="cb32-451"><a href="#cb32-451" aria-hidden="true" tabindex="-1"></a><span class="in">                                variance_threshold = 1e-4,</span></span>
<span id="cb32-452"><a href="#cb32-452" aria-hidden="true" tabindex="-1"></a><span class="in">                                sparsity_threshold = 0.99,# Threshold for dropping sparse variables</span></span>
<span id="cb32-453"><a href="#cb32-453" aria-hidden="true" tabindex="-1"></a><span class="in">                                ...) {</span></span>
<span id="cb32-454"><a href="#cb32-454" aria-hidden="true" tabindex="-1"></a><span class="in">  # Load necessary library</span></span>
<span id="cb32-455"><a href="#cb32-455" aria-hidden="true" tabindex="-1"></a><span class="in">  if (!requireNamespace("glmnet", quietly = TRUE)) {</span></span>
<span id="cb32-456"><a href="#cb32-456" aria-hidden="true" tabindex="-1"></a><span class="in">    stop("The glmnet package is required. Please install it.")</span></span>
<span id="cb32-457"><a href="#cb32-457" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb32-458"><a href="#cb32-458" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-459"><a href="#cb32-459" aria-hidden="true" tabindex="-1"></a><span class="in">  if (!requireNamespace("caret", quietly = TRUE)) {</span></span>
<span id="cb32-460"><a href="#cb32-460" aria-hidden="true" tabindex="-1"></a><span class="in">    install.packages("caret")</span></span>
<span id="cb32-461"><a href="#cb32-461" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb32-462"><a href="#cb32-462" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-463"><a href="#cb32-463" aria-hidden="true" tabindex="-1"></a><span class="in">  # Ensure reproducibility</span></span>
<span id="cb32-464"><a href="#cb32-464" aria-hidden="true" tabindex="-1"></a><span class="in">  set.seed(seed)</span></span>
<span id="cb32-465"><a href="#cb32-465" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-466"><a href="#cb32-466" aria-hidden="true" tabindex="-1"></a><span class="in">  # Standardize predictors</span></span>
<span id="cb32-467"><a href="#cb32-467" aria-hidden="true" tabindex="-1"></a><span class="in">  X_scaled &lt;- scale(dt[, candidate_vars])</span></span>
<span id="cb32-468"><a href="#cb32-468" aria-hidden="true" tabindex="-1"></a><span class="in">  y &lt;- dt[[y]]</span></span>
<span id="cb32-469"><a href="#cb32-469" aria-hidden="true" tabindex="-1"></a><span class="in">  weights &lt;- dt[[weights]]</span></span>
<span id="cb32-470"><a href="#cb32-470" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-471"><a href="#cb32-471" aria-hidden="true" tabindex="-1"></a><span class="in">  # Drop any columns with missing values in X_scaled</span></span>
<span id="cb32-472"><a href="#cb32-472" aria-hidden="true" tabindex="-1"></a><span class="in">  X_scaled &lt;- X_scaled[, colSums(is.na(X_scaled)) == 0]</span></span>
<span id="cb32-473"><a href="#cb32-473" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-474"><a href="#cb32-474" aria-hidden="true" tabindex="-1"></a><span class="in">  # Drop variables with very low variance</span></span>
<span id="cb32-475"><a href="#cb32-475" aria-hidden="true" tabindex="-1"></a><span class="in">  variances &lt;- apply(X_scaled, 2, var)</span></span>
<span id="cb32-476"><a href="#cb32-476" aria-hidden="true" tabindex="-1"></a><span class="in">  X_scaled &lt;- X_scaled[, variances &gt; variance_threshold]</span></span>
<span id="cb32-477"><a href="#cb32-477" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-478"><a href="#cb32-478" aria-hidden="true" tabindex="-1"></a><span class="in">  # Drop highly correlated variables</span></span>
<span id="cb32-479"><a href="#cb32-479" aria-hidden="true" tabindex="-1"></a><span class="in">  correlation_matrix &lt;- cor(X_scaled)</span></span>
<span id="cb32-480"><a href="#cb32-480" aria-hidden="true" tabindex="-1"></a><span class="in">  high_corr &lt;- caret::findCorrelation(correlation_matrix, </span></span>
<span id="cb32-481"><a href="#cb32-481" aria-hidden="true" tabindex="-1"></a><span class="in">                                      cutoff = correlation_threshold, </span></span>
<span id="cb32-482"><a href="#cb32-482" aria-hidden="true" tabindex="-1"></a><span class="in">                                      verbose = FALSE)</span></span>
<span id="cb32-483"><a href="#cb32-483" aria-hidden="true" tabindex="-1"></a><span class="in">  if (length(high_corr) &gt; 0) {</span></span>
<span id="cb32-484"><a href="#cb32-484" aria-hidden="true" tabindex="-1"></a><span class="in">    X_scaled &lt;- X_scaled[, -high_corr]</span></span>
<span id="cb32-485"><a href="#cb32-485" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb32-486"><a href="#cb32-486" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-487"><a href="#cb32-487" aria-hidden="true" tabindex="-1"></a><span class="in">  # Identify and drop variables with 99% or more zeros</span></span>
<span id="cb32-488"><a href="#cb32-488" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calculate proportion of zeros for each column</span></span>
<span id="cb32-489"><a href="#cb32-489" aria-hidden="true" tabindex="-1"></a><span class="in">  proportion_zeros &lt;- colMeans(X_scaled == 0)</span></span>
<span id="cb32-490"><a href="#cb32-490" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-491"><a href="#cb32-491" aria-hidden="true" tabindex="-1"></a><span class="in">  # Filter out columns where proportion of zeros is above the threshold</span></span>
<span id="cb32-492"><a href="#cb32-492" aria-hidden="true" tabindex="-1"></a><span class="in">  X_scaled &lt;- X_scaled[, proportion_zeros &lt; sparsity_threshold]</span></span>
<span id="cb32-493"><a href="#cb32-493" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-494"><a href="#cb32-494" aria-hidden="true" tabindex="-1"></a><span class="in">  # Check for problematic values</span></span>
<span id="cb32-495"><a href="#cb32-495" aria-hidden="true" tabindex="-1"></a><span class="in">  if (anyNA(X_scaled) || any(is.infinite(X_scaled)) || any(is.nan(X_scaled))) {</span></span>
<span id="cb32-496"><a href="#cb32-496" aria-hidden="true" tabindex="-1"></a><span class="in">    stop("Predictor matrix contains NA, Inf, or NaN values.")</span></span>
<span id="cb32-497"><a href="#cb32-497" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb32-498"><a href="#cb32-498" aria-hidden="true" tabindex="-1"></a><span class="in">  if (any(weights &lt;= 0)) {</span></span>
<span id="cb32-499"><a href="#cb32-499" aria-hidden="true" tabindex="-1"></a><span class="in">    stop("Weights contain non-positive values.")</span></span>
<span id="cb32-500"><a href="#cb32-500" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb32-501"><a href="#cb32-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-502"><a href="#cb32-502" aria-hidden="true" tabindex="-1"></a><span class="in">  # Fit lasso model with cross-validation</span></span>
<span id="cb32-503"><a href="#cb32-503" aria-hidden="true" tabindex="-1"></a><span class="in">  cv_model &lt;- glmnet::cv.glmnet(</span></span>
<span id="cb32-504"><a href="#cb32-504" aria-hidden="true" tabindex="-1"></a><span class="in">    x = X_scaled,</span></span>
<span id="cb32-505"><a href="#cb32-505" aria-hidden="true" tabindex="-1"></a><span class="in">    y = y,</span></span>
<span id="cb32-506"><a href="#cb32-506" aria-hidden="true" tabindex="-1"></a><span class="in">    weights = weights,</span></span>
<span id="cb32-507"><a href="#cb32-507" aria-hidden="true" tabindex="-1"></a><span class="in">    alpha = alpha,  # alpha = 1 for lasso, 0 &lt; alpha &lt; 1 for elastic net</span></span>
<span id="cb32-508"><a href="#cb32-508" aria-hidden="true" tabindex="-1"></a><span class="in">    nfolds = nfolds,</span></span>
<span id="cb32-509"><a href="#cb32-509" aria-hidden="true" tabindex="-1"></a><span class="in">    family = "gaussian", # Change to "binomial" or "poisson" for other models</span></span>
<span id="cb32-510"><a href="#cb32-510" aria-hidden="true" tabindex="-1"></a><span class="in">    ...</span></span>
<span id="cb32-511"><a href="#cb32-511" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb32-512"><a href="#cb32-512" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-513"><a href="#cb32-513" aria-hidden="true" tabindex="-1"></a><span class="in">  # Extract coefficients at the lambda with minimum cross-validated error</span></span>
<span id="cb32-514"><a href="#cb32-514" aria-hidden="true" tabindex="-1"></a><span class="in">  selected_model &lt;- glmnet::glmnet(</span></span>
<span id="cb32-515"><a href="#cb32-515" aria-hidden="true" tabindex="-1"></a><span class="in">    x = X_scaled,</span></span>
<span id="cb32-516"><a href="#cb32-516" aria-hidden="true" tabindex="-1"></a><span class="in">    y = y,</span></span>
<span id="cb32-517"><a href="#cb32-517" aria-hidden="true" tabindex="-1"></a><span class="in">    weights = weights,</span></span>
<span id="cb32-518"><a href="#cb32-518" aria-hidden="true" tabindex="-1"></a><span class="in">    alpha = alpha,</span></span>
<span id="cb32-519"><a href="#cb32-519" aria-hidden="true" tabindex="-1"></a><span class="in">    lambda = cv_model[[lambda_type]],</span></span>
<span id="cb32-520"><a href="#cb32-520" aria-hidden="true" tabindex="-1"></a><span class="in">    family = "gaussian",</span></span>
<span id="cb32-521"><a href="#cb32-521" aria-hidden="true" tabindex="-1"></a><span class="in">    ...</span></span>
<span id="cb32-522"><a href="#cb32-522" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb32-523"><a href="#cb32-523" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-524"><a href="#cb32-524" aria-hidden="true" tabindex="-1"></a><span class="in">  # Identify selected variables</span></span>
<span id="cb32-525"><a href="#cb32-525" aria-hidden="true" tabindex="-1"></a><span class="in">  selected_variables &lt;- rownames(as.matrix(coef(selected_model)))[as.matrix(coef(selected_model)) != 0]</span></span>
<span id="cb32-526"><a href="#cb32-526" aria-hidden="true" tabindex="-1"></a><span class="in">  selected_variables &lt;- selected_variables[selected_variables != "(Intercept)"]</span></span>
<span id="cb32-527"><a href="#cb32-527" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-528"><a href="#cb32-528" aria-hidden="true" tabindex="-1"></a><span class="in">  return(selected_variables)</span></span>
<span id="cb32-529"><a href="#cb32-529" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-530"><a href="#cb32-530" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb32-531"><a href="#cb32-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-532"><a href="#cb32-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-533"><a href="#cb32-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-534"><a href="#cb32-534" aria-hidden="true" tabindex="-1"></a><span class="in">#### lets call this function to model selection for each transformation</span></span>
<span id="cb32-535"><a href="#cb32-535" aria-hidden="true" tabindex="-1"></a><span class="in">notglmnet_list &lt;- </span></span>
<span id="cb32-536"><a href="#cb32-536" aria-hidden="true" tabindex="-1"></a><span class="in">  glmnetlasso_vselect(dt = survey_dt,</span></span>
<span id="cb32-537"><a href="#cb32-537" aria-hidden="true" tabindex="-1"></a><span class="in">                      candidate_vars = candidate_vars,</span></span>
<span id="cb32-538"><a href="#cb32-538" aria-hidden="true" tabindex="-1"></a><span class="in">                      y = "eqIncome",</span></span>
<span id="cb32-539"><a href="#cb32-539" aria-hidden="true" tabindex="-1"></a><span class="in">                      weights = "weight",</span></span>
<span id="cb32-540"><a href="#cb32-540" aria-hidden="true" tabindex="-1"></a><span class="in">                      nfolds = 10,</span></span>
<span id="cb32-541"><a href="#cb32-541" aria-hidden="true" tabindex="-1"></a><span class="in">                      seed = 123,</span></span>
<span id="cb32-542"><a href="#cb32-542" aria-hidden="true" tabindex="-1"></a><span class="in">                      lambda_type = "lambda.1se",</span></span>
<span id="cb32-543"><a href="#cb32-543" aria-hidden="true" tabindex="-1"></a><span class="in">                      sparsity_threshold = 0.99)</span></span>
<span id="cb32-544"><a href="#cb32-544" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb32-545"><a href="#cb32-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-546"><a href="#cb32-546" aria-hidden="true" tabindex="-1"></a><span class="in">logglmnet_list &lt;- </span></span>
<span id="cb32-547"><a href="#cb32-547" aria-hidden="true" tabindex="-1"></a><span class="in">  glmnetlasso_vselect(dt = survey_dt,</span></span>
<span id="cb32-548"><a href="#cb32-548" aria-hidden="true" tabindex="-1"></a><span class="in">                      candidate_vars = candidate_vars,</span></span>
<span id="cb32-549"><a href="#cb32-549" aria-hidden="true" tabindex="-1"></a><span class="in">                      y = "logeqIncome",</span></span>
<span id="cb32-550"><a href="#cb32-550" aria-hidden="true" tabindex="-1"></a><span class="in">                      weights = "weight",</span></span>
<span id="cb32-551"><a href="#cb32-551" aria-hidden="true" tabindex="-1"></a><span class="in">                      nfolds = 10,</span></span>
<span id="cb32-552"><a href="#cb32-552" aria-hidden="true" tabindex="-1"></a><span class="in">                      seed = 123,</span></span>
<span id="cb32-553"><a href="#cb32-553" aria-hidden="true" tabindex="-1"></a><span class="in">                      lambda_type = "lambda.1se",</span></span>
<span id="cb32-554"><a href="#cb32-554" aria-hidden="true" tabindex="-1"></a><span class="in">                      sparsity_threshold = 0.99)</span></span>
<span id="cb32-555"><a href="#cb32-555" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb32-556"><a href="#cb32-556" aria-hidden="true" tabindex="-1"></a><span class="in">bcxglmnet_list &lt;- </span></span>
<span id="cb32-557"><a href="#cb32-557" aria-hidden="true" tabindex="-1"></a><span class="in">  glmnetlasso_vselect(dt = survey_dt,</span></span>
<span id="cb32-558"><a href="#cb32-558" aria-hidden="true" tabindex="-1"></a><span class="in">                      candidate_vars = candidate_vars,</span></span>
<span id="cb32-559"><a href="#cb32-559" aria-hidden="true" tabindex="-1"></a><span class="in">                      y = "bcxeqIncome",</span></span>
<span id="cb32-560"><a href="#cb32-560" aria-hidden="true" tabindex="-1"></a><span class="in">                      weights = "weight",</span></span>
<span id="cb32-561"><a href="#cb32-561" aria-hidden="true" tabindex="-1"></a><span class="in">                      nfolds = 10,</span></span>
<span id="cb32-562"><a href="#cb32-562" aria-hidden="true" tabindex="-1"></a><span class="in">                      seed = 123,</span></span>
<span id="cb32-563"><a href="#cb32-563" aria-hidden="true" tabindex="-1"></a><span class="in">                      lambda_type = "lambda.1se",</span></span>
<span id="cb32-564"><a href="#cb32-564" aria-hidden="true" tabindex="-1"></a><span class="in">                      sparsity_threshold = 0.99)</span></span>
<span id="cb32-565"><a href="#cb32-565" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb32-566"><a href="#cb32-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-567"><a href="#cb32-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-568"><a href="#cb32-568" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-569"><a href="#cb32-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-570"><a href="#cb32-570" aria-hidden="true" tabindex="-1"></a>Now that we have selected variables for each outcome variable transformation. We are ready to apply this <span class="in">`povmap::ebp()`</span> to estimate a poverty map for Austria. The function will estimate a linear mixed effects model of the income in Austria from which the poverty line will be applied to estimate the poverty rates. Please run <span class="in">`help(povmap::ebp)`</span> for details about the structure of the resulting object produced.</span>
<span id="cb32-571"><a href="#cb32-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-572"><a href="#cb32-572" aria-hidden="true" tabindex="-1"></a>For the proper functioning of the <span class="in">`povmap::ebp`</span> function, the following conditions must be met:</span>
<span id="cb32-573"><a href="#cb32-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-574"><a href="#cb32-574" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>the arguments <span class="in">`pop_data`</span> and <span class="in">`smp_data`</span> require the survey and census datasets must be of class <span class="in">`data.frame`</span>.</span>
<span id="cb32-575"><a href="#cb32-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-576"><a href="#cb32-576" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`pop_data`</span> and <span class="in">`smp_data`</span> must contain no missing observations across all the variables. Use the <span class="in">`na.omit()`</span> function to ensure only complete cases are included within each object.</span>
<span id="cb32-577"><a href="#cb32-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-578"><a href="#cb32-578" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>All target areas (or domains) within the <span class="in">`smp_domains`</span> must be found within <span class="in">`pop_domains`</span> i.e. for the Austria example, all domains/target areas in the survey must be found in the census.</span>
<span id="cb32-579"><a href="#cb32-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-580"><a href="#cb32-580" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`rescale_weights`</span> argument set to TRUE may solve parameter estimation convergence issues. This is not available within the <span class="in">`emdi::ebp()`</span> function.</span>
<span id="cb32-581"><a href="#cb32-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-582"><a href="#cb32-582" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Notice the specification of the <span class="in">`Ydump`</span> argument. This is one difference between the <span class="in">`emdi::ebp()`</span> and <span class="in">`povmap::ebp()`</span>. This argument returns the result of <span class="in">`L`</span> unit-level welfare simulated predictions from which other poverty estimations maybe carried out, as different from the default results present within <span class="in">`ebp`</span> class object returned by <span class="in">`ebp()`</span>.</span>
<span id="cb32-583"><a href="#cb32-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-584"><a href="#cb32-584" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Also noteworthy, is the use of the <span class="in">`weight_type`</span> argument present within the <span class="in">`povmap::ebp()`</span> but not in the <span class="in">`emdi::ebp()`</span>. Please see documentation for more details.</span>
<span id="cb32-585"><a href="#cb32-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-586"><a href="#cb32-586" aria-hidden="true" tabindex="-1"></a><span class="in">```{r esp-prep}</span></span>
<span id="cb32-587"><a href="#cb32-587" aria-hidden="true" tabindex="-1"></a><span class="in">fldr_temp &lt;- "data-temp"</span></span>
<span id="cb32-588"><a href="#cb32-588" aria-hidden="true" tabindex="-1"></a><span class="in">file.path(fldr_temp, "Ydump") |&gt; dir.create(recursive = T, showWarnings = F)</span></span>
<span id="cb32-589"><a href="#cb32-589" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-590"><a href="#cb32-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-591"><a href="#cb32-591" aria-hidden="true" tabindex="-1"></a><span class="in">```{r est-run, message=FALSE, warning=FALSE, error=FALSE, eval=FALSE}</span></span>
<span id="cb32-592"><a href="#cb32-592" aria-hidden="true" tabindex="-1"></a><span class="in"># using the ebp function to first estimate into the household survey. </span></span>
<span id="cb32-593"><a href="#cb32-593" aria-hidden="true" tabindex="-1"></a><span class="in"># We need to see how well the model will estimate poverty first into </span></span>
<span id="cb32-594"><a href="#cb32-594" aria-hidden="true" tabindex="-1"></a><span class="in"># the training set i.e. the household survey. this helps to check the</span></span>
<span id="cb32-595"><a href="#cb32-595" aria-hidden="true" tabindex="-1"></a><span class="in"># quality of in-sample estimation without any potential prediction bias</span></span>
<span id="cb32-596"><a href="#cb32-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-597"><a href="#cb32-597" aria-hidden="true" tabindex="-1"></a><span class="in">model_formula &lt;-</span></span>
<span id="cb32-598"><a href="#cb32-598" aria-hidden="true" tabindex="-1"></a><span class="in">  paste0("eqIncome ~ ", paste(logglmnet_list, collapse = " + ")) |&gt;</span></span>
<span id="cb32-599"><a href="#cb32-599" aria-hidden="true" tabindex="-1"></a><span class="in">  as.formula()</span></span>
<span id="cb32-600"><a href="#cb32-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-601"><a href="#cb32-601" aria-hidden="true" tabindex="-1"></a><span class="in">log_smodel &lt;-</span></span>
<span id="cb32-602"><a href="#cb32-602" aria-hidden="true" tabindex="-1"></a><span class="in">  povmap::ebp(</span></span>
<span id="cb32-603"><a href="#cb32-603" aria-hidden="true" tabindex="-1"></a><span class="in">    fixed = model_formula,</span></span>
<span id="cb32-604"><a href="#cb32-604" aria-hidden="true" tabindex="-1"></a><span class="in">    pop_data = survey_dt[, c(logglmnet_list, "district")],</span></span>
<span id="cb32-605"><a href="#cb32-605" aria-hidden="true" tabindex="-1"></a><span class="in">    pop_domains = "district",</span></span>
<span id="cb32-606"><a href="#cb32-606" aria-hidden="true" tabindex="-1"></a><span class="in">    smp_data = survey_dt[, c("eqIncome", logglmnet_list, "district", "weight")],</span></span>
<span id="cb32-607"><a href="#cb32-607" aria-hidden="true" tabindex="-1"></a><span class="in">    smp_domains = "district",</span></span>
<span id="cb32-608"><a href="#cb32-608" aria-hidden="true" tabindex="-1"></a><span class="in">    MSE = TRUE,</span></span>
<span id="cb32-609"><a href="#cb32-609" aria-hidden="true" tabindex="-1"></a><span class="in">    threshold = 18207.2,</span></span>
<span id="cb32-610"><a href="#cb32-610" aria-hidden="true" tabindex="-1"></a><span class="in">    transformation = "log",</span></span>
<span id="cb32-611"><a href="#cb32-611" aria-hidden="true" tabindex="-1"></a><span class="in">    B = 50,</span></span>
<span id="cb32-612"><a href="#cb32-612" aria-hidden="true" tabindex="-1"></a><span class="in">    L = 50,</span></span>
<span id="cb32-613"><a href="#cb32-613" aria-hidden="true" tabindex="-1"></a><span class="in">    weights = "weight",</span></span>
<span id="cb32-614"><a href="#cb32-614" aria-hidden="true" tabindex="-1"></a><span class="in">    rescale_weights = TRUE,</span></span>
<span id="cb32-615"><a href="#cb32-615" aria-hidden="true" tabindex="-1"></a><span class="in">    Ydump = file.path(fldr_temp, "Ydump/unitsurvey_logYdump_glmnet.csv"),</span></span>
<span id="cb32-616"><a href="#cb32-616" aria-hidden="true" tabindex="-1"></a><span class="in">    cpus = 30</span></span>
<span id="cb32-617"><a href="#cb32-617" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb32-618"><a href="#cb32-618" aria-hidden="true" tabindex="-1"></a><span class="in">saveRDS(log_smodel, file.path(fldr_temp, "log_surveymodel.RDS"))</span></span>
<span id="cb32-619"><a href="#cb32-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-620"><a href="#cb32-620" aria-hidden="true" tabindex="-1"></a><span class="in">model_formula &lt;-</span></span>
<span id="cb32-621"><a href="#cb32-621" aria-hidden="true" tabindex="-1"></a><span class="in">  paste0("eqIncome ~ ", paste(bcxglmnet_list, collapse = " + ")) |&gt; </span></span>
<span id="cb32-622"><a href="#cb32-622" aria-hidden="true" tabindex="-1"></a><span class="in">  as.formula()</span></span>
<span id="cb32-623"><a href="#cb32-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-624"><a href="#cb32-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-625"><a href="#cb32-625" aria-hidden="true" tabindex="-1"></a><span class="in">bcx_smodel &lt;-</span></span>
<span id="cb32-626"><a href="#cb32-626" aria-hidden="true" tabindex="-1"></a><span class="in">  povmap::ebp(</span></span>
<span id="cb32-627"><a href="#cb32-627" aria-hidden="true" tabindex="-1"></a><span class="in">    fixed = model_formula,</span></span>
<span id="cb32-628"><a href="#cb32-628" aria-hidden="true" tabindex="-1"></a><span class="in">    pop_data = survey_dt[, c(bcxglmnet_list, "district")],</span></span>
<span id="cb32-629"><a href="#cb32-629" aria-hidden="true" tabindex="-1"></a><span class="in">    pop_domains = "district",</span></span>
<span id="cb32-630"><a href="#cb32-630" aria-hidden="true" tabindex="-1"></a><span class="in">    smp_data = survey_dt[, c(bcxglmnet_list, "district", "eqIncome", "weight")],</span></span>
<span id="cb32-631"><a href="#cb32-631" aria-hidden="true" tabindex="-1"></a><span class="in">    smp_domains = "district",</span></span>
<span id="cb32-632"><a href="#cb32-632" aria-hidden="true" tabindex="-1"></a><span class="in">    MSE = TRUE,</span></span>
<span id="cb32-633"><a href="#cb32-633" aria-hidden="true" tabindex="-1"></a><span class="in">    threshold = 18207.2,</span></span>
<span id="cb32-634"><a href="#cb32-634" aria-hidden="true" tabindex="-1"></a><span class="in">    transformation = "box.cox",</span></span>
<span id="cb32-635"><a href="#cb32-635" aria-hidden="true" tabindex="-1"></a><span class="in">    B = 50,</span></span>
<span id="cb32-636"><a href="#cb32-636" aria-hidden="true" tabindex="-1"></a><span class="in">    L = 50,</span></span>
<span id="cb32-637"><a href="#cb32-637" aria-hidden="true" tabindex="-1"></a><span class="in">    weights = "weight",</span></span>
<span id="cb32-638"><a href="#cb32-638" aria-hidden="true" tabindex="-1"></a><span class="in">    rescale_weights = TRUE,</span></span>
<span id="cb32-639"><a href="#cb32-639" aria-hidden="true" tabindex="-1"></a><span class="in">    Ydump = file.path(fldr_temp, "Ydump/unitsurvey_bcxYdump_glmnet.csv"),</span></span>
<span id="cb32-640"><a href="#cb32-640" aria-hidden="true" tabindex="-1"></a><span class="in">    cpus = 30,</span></span>
<span id="cb32-641"><a href="#cb32-641" aria-hidden="true" tabindex="-1"></a><span class="in">    weights_type = "nlme_lambda"</span></span>
<span id="cb32-642"><a href="#cb32-642" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb32-643"><a href="#cb32-643" aria-hidden="true" tabindex="-1"></a><span class="in">saveRDS(bcx_smodel, file.path(fldr_temp, "bcx_surveymodel.RDS"))</span></span>
<span id="cb32-644"><a href="#cb32-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-645"><a href="#cb32-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-646"><a href="#cb32-646" aria-hidden="true" tabindex="-1"></a><span class="in">model_formula &lt;- </span></span>
<span id="cb32-647"><a href="#cb32-647" aria-hidden="true" tabindex="-1"></a><span class="in">  paste0("eqIncome ~ ", paste(notglmnet_list, collapse = " + ")) |&gt; </span></span>
<span id="cb32-648"><a href="#cb32-648" aria-hidden="true" tabindex="-1"></a><span class="in">  as.formula()</span></span>
<span id="cb32-649"><a href="#cb32-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-650"><a href="#cb32-650" aria-hidden="true" tabindex="-1"></a><span class="in">not_smodel &lt;-</span></span>
<span id="cb32-651"><a href="#cb32-651" aria-hidden="true" tabindex="-1"></a><span class="in">  povmap::ebp(</span></span>
<span id="cb32-652"><a href="#cb32-652" aria-hidden="true" tabindex="-1"></a><span class="in">    fixed = model_formula,</span></span>
<span id="cb32-653"><a href="#cb32-653" aria-hidden="true" tabindex="-1"></a><span class="in">    pop_data = survey_dt[, c(notglmnet_list, "district")],</span></span>
<span id="cb32-654"><a href="#cb32-654" aria-hidden="true" tabindex="-1"></a><span class="in">    pop_domains = "district",</span></span>
<span id="cb32-655"><a href="#cb32-655" aria-hidden="true" tabindex="-1"></a><span class="in">    smp_data = survey_dt[, c(notglmnet_list, "district", "eqIncome", "weight")],</span></span>
<span id="cb32-656"><a href="#cb32-656" aria-hidden="true" tabindex="-1"></a><span class="in">    smp_domains = "district",</span></span>
<span id="cb32-657"><a href="#cb32-657" aria-hidden="true" tabindex="-1"></a><span class="in">    MSE = TRUE,</span></span>
<span id="cb32-658"><a href="#cb32-658" aria-hidden="true" tabindex="-1"></a><span class="in">    threshold = 18207.2,</span></span>
<span id="cb32-659"><a href="#cb32-659" aria-hidden="true" tabindex="-1"></a><span class="in">    transformation = "no",</span></span>
<span id="cb32-660"><a href="#cb32-660" aria-hidden="true" tabindex="-1"></a><span class="in">    B = 50,</span></span>
<span id="cb32-661"><a href="#cb32-661" aria-hidden="true" tabindex="-1"></a><span class="in">    L = 50,</span></span>
<span id="cb32-662"><a href="#cb32-662" aria-hidden="true" tabindex="-1"></a><span class="in">    weights = "weight",</span></span>
<span id="cb32-663"><a href="#cb32-663" aria-hidden="true" tabindex="-1"></a><span class="in">    rescale_weights = TRUE,</span></span>
<span id="cb32-664"><a href="#cb32-664" aria-hidden="true" tabindex="-1"></a><span class="in">    Ydump = "data/Ydump/unitsurvey_notYdump_glmnet.csv",</span></span>
<span id="cb32-665"><a href="#cb32-665" aria-hidden="true" tabindex="-1"></a><span class="in">    cpus = 30</span></span>
<span id="cb32-666"><a href="#cb32-666" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb32-667"><a href="#cb32-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-668"><a href="#cb32-668" aria-hidden="true" tabindex="-1"></a><span class="in">saveRDS(not_smodel, file.path(fldr_temp, "not_surveymodel.RDS"))</span></span>
<span id="cb32-669"><a href="#cb32-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-670"><a href="#cb32-670" aria-hidden="true" tabindex="-1"></a><span class="in">### then we actually estimate the census level estimation</span></span>
<span id="cb32-671"><a href="#cb32-671" aria-hidden="true" tabindex="-1"></a><span class="in">model_formula &lt;- </span></span>
<span id="cb32-672"><a href="#cb32-672" aria-hidden="true" tabindex="-1"></a><span class="in">  paste0("eqIncome ~ ", paste(logglmnet_list, collapse = " + ")) |&gt;</span></span>
<span id="cb32-673"><a href="#cb32-673" aria-hidden="true" tabindex="-1"></a><span class="in">  as.formula()</span></span>
<span id="cb32-674"><a href="#cb32-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-675"><a href="#cb32-675" aria-hidden="true" tabindex="-1"></a><span class="in">log_model &lt;-</span></span>
<span id="cb32-676"><a href="#cb32-676" aria-hidden="true" tabindex="-1"></a><span class="in">  povmap::ebp(</span></span>
<span id="cb32-677"><a href="#cb32-677" aria-hidden="true" tabindex="-1"></a><span class="in">    fixed = model_formula,</span></span>
<span id="cb32-678"><a href="#cb32-678" aria-hidden="true" tabindex="-1"></a><span class="in">    pop_data = census_dt[, c(logglmnet_list, "district")],</span></span>
<span id="cb32-679"><a href="#cb32-679" aria-hidden="true" tabindex="-1"></a><span class="in">    pop_domains = "district",</span></span>
<span id="cb32-680"><a href="#cb32-680" aria-hidden="true" tabindex="-1"></a><span class="in">    smp_data = survey_dt[, c("eqIncome", logglmnet_list, "district", "weight")],</span></span>
<span id="cb32-681"><a href="#cb32-681" aria-hidden="true" tabindex="-1"></a><span class="in">    smp_domains = "district",</span></span>
<span id="cb32-682"><a href="#cb32-682" aria-hidden="true" tabindex="-1"></a><span class="in">    MSE = TRUE,</span></span>
<span id="cb32-683"><a href="#cb32-683" aria-hidden="true" tabindex="-1"></a><span class="in">    threshold = 18207.2,</span></span>
<span id="cb32-684"><a href="#cb32-684" aria-hidden="true" tabindex="-1"></a><span class="in">    transformation = "log",</span></span>
<span id="cb32-685"><a href="#cb32-685" aria-hidden="true" tabindex="-1"></a><span class="in">    B = 50,</span></span>
<span id="cb32-686"><a href="#cb32-686" aria-hidden="true" tabindex="-1"></a><span class="in">    L = 50,</span></span>
<span id="cb32-687"><a href="#cb32-687" aria-hidden="true" tabindex="-1"></a><span class="in">    weights = "weight",</span></span>
<span id="cb32-688"><a href="#cb32-688" aria-hidden="true" tabindex="-1"></a><span class="in">    rescale_weights = TRUE,</span></span>
<span id="cb32-689"><a href="#cb32-689" aria-hidden="true" tabindex="-1"></a><span class="in">    Ydump = file.path(fldr_temp, "Ydump/unitcensus_logYdump_glmnet.csv"),</span></span>
<span id="cb32-690"><a href="#cb32-690" aria-hidden="true" tabindex="-1"></a><span class="in">    cpus = 30</span></span>
<span id="cb32-691"><a href="#cb32-691" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb32-692"><a href="#cb32-692" aria-hidden="true" tabindex="-1"></a><span class="in">saveRDS(log_model, file.path(fldr_temp, "log_censusmodel.RDS"))</span></span>
<span id="cb32-693"><a href="#cb32-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-694"><a href="#cb32-694" aria-hidden="true" tabindex="-1"></a><span class="in">model_formula &lt;-</span></span>
<span id="cb32-695"><a href="#cb32-695" aria-hidden="true" tabindex="-1"></a><span class="in">  paste0("eqIncome ~ ", paste(bcxglmnet_list, collapse = " + ")) |&gt;</span></span>
<span id="cb32-696"><a href="#cb32-696" aria-hidden="true" tabindex="-1"></a><span class="in">  as.formula()</span></span>
<span id="cb32-697"><a href="#cb32-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-698"><a href="#cb32-698" aria-hidden="true" tabindex="-1"></a><span class="in">bcx_model &lt;-</span></span>
<span id="cb32-699"><a href="#cb32-699" aria-hidden="true" tabindex="-1"></a><span class="in">  povmap::ebp(</span></span>
<span id="cb32-700"><a href="#cb32-700" aria-hidden="true" tabindex="-1"></a><span class="in">    fixed = model_formula,</span></span>
<span id="cb32-701"><a href="#cb32-701" aria-hidden="true" tabindex="-1"></a><span class="in">    pop_data = census_dt[, c(bcxglmnet_list, "district")],</span></span>
<span id="cb32-702"><a href="#cb32-702" aria-hidden="true" tabindex="-1"></a><span class="in">    pop_domains = "district",</span></span>
<span id="cb32-703"><a href="#cb32-703" aria-hidden="true" tabindex="-1"></a><span class="in">    smp_data = survey_dt[, c(bcxglmnet_list, "district", "eqIncome", "weight")],</span></span>
<span id="cb32-704"><a href="#cb32-704" aria-hidden="true" tabindex="-1"></a><span class="in">    smp_domains = "district",</span></span>
<span id="cb32-705"><a href="#cb32-705" aria-hidden="true" tabindex="-1"></a><span class="in">    MSE = TRUE,</span></span>
<span id="cb32-706"><a href="#cb32-706" aria-hidden="true" tabindex="-1"></a><span class="in">    threshold = 18207.2,</span></span>
<span id="cb32-707"><a href="#cb32-707" aria-hidden="true" tabindex="-1"></a><span class="in">    transformation = "box.cox",</span></span>
<span id="cb32-708"><a href="#cb32-708" aria-hidden="true" tabindex="-1"></a><span class="in">    B = 50,</span></span>
<span id="cb32-709"><a href="#cb32-709" aria-hidden="true" tabindex="-1"></a><span class="in">    L = 50,</span></span>
<span id="cb32-710"><a href="#cb32-710" aria-hidden="true" tabindex="-1"></a><span class="in">    weights = "weight",</span></span>
<span id="cb32-711"><a href="#cb32-711" aria-hidden="true" tabindex="-1"></a><span class="in">    rescale_weights = TRUE,</span></span>
<span id="cb32-712"><a href="#cb32-712" aria-hidden="true" tabindex="-1"></a><span class="in">    Ydump = file.path(fldr_temp, "data/Ydump/unitcensus_bcxYdump_glmnet.csv"),</span></span>
<span id="cb32-713"><a href="#cb32-713" aria-hidden="true" tabindex="-1"></a><span class="in">    cpus = 30,</span></span>
<span id="cb32-714"><a href="#cb32-714" aria-hidden="true" tabindex="-1"></a><span class="in">    weights_type = "nlme_lambda"</span></span>
<span id="cb32-715"><a href="#cb32-715" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb32-716"><a href="#cb32-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-717"><a href="#cb32-717" aria-hidden="true" tabindex="-1"></a><span class="in">saveRDS(bcx_model, file.path(fldr_temp, "bcx_censusmodel.RDS"))</span></span>
<span id="cb32-718"><a href="#cb32-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-719"><a href="#cb32-719" aria-hidden="true" tabindex="-1"></a><span class="in">model_formula &lt;- </span></span>
<span id="cb32-720"><a href="#cb32-720" aria-hidden="true" tabindex="-1"></a><span class="in">  paste0("eqIncome ~ ", paste(notglmnet_list, collapse = " + ")) |&gt; </span></span>
<span id="cb32-721"><a href="#cb32-721" aria-hidden="true" tabindex="-1"></a><span class="in">  as.formula()</span></span>
<span id="cb32-722"><a href="#cb32-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-723"><a href="#cb32-723" aria-hidden="true" tabindex="-1"></a><span class="in">not_model &lt;-</span></span>
<span id="cb32-724"><a href="#cb32-724" aria-hidden="true" tabindex="-1"></a><span class="in">  povmap::ebp(</span></span>
<span id="cb32-725"><a href="#cb32-725" aria-hidden="true" tabindex="-1"></a><span class="in">    fixed = model_formula,</span></span>
<span id="cb32-726"><a href="#cb32-726" aria-hidden="true" tabindex="-1"></a><span class="in">    pop_data = census_dt[, c(notglmnet_list, "district")],</span></span>
<span id="cb32-727"><a href="#cb32-727" aria-hidden="true" tabindex="-1"></a><span class="in">    pop_domains = "district",</span></span>
<span id="cb32-728"><a href="#cb32-728" aria-hidden="true" tabindex="-1"></a><span class="in">    smp_data = survey_dt[, c(notglmnet_list, "district", "eqIncome", "weight")],</span></span>
<span id="cb32-729"><a href="#cb32-729" aria-hidden="true" tabindex="-1"></a><span class="in">    smp_domains = "district",</span></span>
<span id="cb32-730"><a href="#cb32-730" aria-hidden="true" tabindex="-1"></a><span class="in">    MSE = TRUE,</span></span>
<span id="cb32-731"><a href="#cb32-731" aria-hidden="true" tabindex="-1"></a><span class="in">    threshold = 18207.2,</span></span>
<span id="cb32-732"><a href="#cb32-732" aria-hidden="true" tabindex="-1"></a><span class="in">    transformation = "no",</span></span>
<span id="cb32-733"><a href="#cb32-733" aria-hidden="true" tabindex="-1"></a><span class="in">    B = 50,</span></span>
<span id="cb32-734"><a href="#cb32-734" aria-hidden="true" tabindex="-1"></a><span class="in">    L = 50,</span></span>
<span id="cb32-735"><a href="#cb32-735" aria-hidden="true" tabindex="-1"></a><span class="in">    weights = "weight",</span></span>
<span id="cb32-736"><a href="#cb32-736" aria-hidden="true" tabindex="-1"></a><span class="in">    rescale_weights = TRUE,</span></span>
<span id="cb32-737"><a href="#cb32-737" aria-hidden="true" tabindex="-1"></a><span class="in">    Ydump = file.path(fldr_temp, "Ydump/unitcensus_notYdump_glmnet.csv"),</span></span>
<span id="cb32-738"><a href="#cb32-738" aria-hidden="true" tabindex="-1"></a><span class="in">    cpus = 30</span></span>
<span id="cb32-739"><a href="#cb32-739" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb32-740"><a href="#cb32-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-741"><a href="#cb32-741" aria-hidden="true" tabindex="-1"></a><span class="in">saveRDS(not_model, file.path(fldr_temp, "data/not_censusmodel.RDS"))</span></span>
<span id="cb32-742"><a href="#cb32-742" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-743"><a href="#cb32-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-744"><a href="#cb32-744" aria-hidden="true" tabindex="-1"></a><span class="in">```{r main-est-load}</span></span>
<span id="cb32-745"><a href="#cb32-745" aria-hidden="true" tabindex="-1"></a><span class="in">log_smodel &lt;- readRDS(file.path(fldr_temp, "log_surveymodel.RDS"))</span></span>
<span id="cb32-746"><a href="#cb32-746" aria-hidden="true" tabindex="-1"></a><span class="in">bcx_smodel &lt;- readRDS(file.path(fldr_temp, "bcx_surveymodel.RDS"))</span></span>
<span id="cb32-747"><a href="#cb32-747" aria-hidden="true" tabindex="-1"></a><span class="in">not_smodel &lt;- readRDS(file.path(fldr_temp, "not_surveymodel.RDS"))</span></span>
<span id="cb32-748"><a href="#cb32-748" aria-hidden="true" tabindex="-1"></a><span class="in">log_model &lt;- readRDS(file.path(fldr_temp, "log_censusmodel.RDS"))</span></span>
<span id="cb32-749"><a href="#cb32-749" aria-hidden="true" tabindex="-1"></a><span class="in">bcx_model &lt;- readRDS(file.path(fldr_temp, "bcx_censusmodel.RDS"))</span></span>
<span id="cb32-750"><a href="#cb32-750" aria-hidden="true" tabindex="-1"></a><span class="in">not_model &lt;- readRDS(file.path(fldr_temp, "not_censusmodel.RDS"))</span></span>
<span id="cb32-751"><a href="#cb32-751" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-752"><a href="#cb32-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-753"><a href="#cb32-753" aria-hidden="true" tabindex="-1"></a><span class="fu">## Post Estimation Diagnostics</span></span>
<span id="cb32-754"><a href="#cb32-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-755"><a href="#cb32-755" aria-hidden="true" tabindex="-1"></a>Once the model has been estimated. It is essential to test the validity of the model based on the model assumptions. Below are the set of typical tests which we will perform:</span>
<span id="cb32-756"><a href="#cb32-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-757"><a href="#cb32-757" aria-hidden="true" tabindex="-1"></a><span class="fu">### Checking the quality of in-sample prediction</span></span>
<span id="cb32-758"><a href="#cb32-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-759"><a href="#cb32-759" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Aggregate Poverty Rates at the lowest level of National Representativeness for EBP vs Direct Poverty Rates</span></span>
<span id="cb32-760"><a href="#cb32-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-761"><a href="#cb32-761" aria-hidden="true" tabindex="-1"></a>The first test is to ensure the model is able to replicate the welfare distribution within the same survey. If this test fails, there is no reason to expect our model to provide unbiased estimates out of sample. We run the function <span class="in">`ebp_national_pov()`</span> below to compare estimated poverty rates aggregated to the state level to the direct estimates from the survey. We apply the function to each model. Ideally, we want the estimated state poverty rates to be as close as possible to the direct estimates at the same level (typically within the 95% confidence level).</span>
<span id="cb32-762"><a href="#cb32-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-763"><a href="#cb32-763" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fn-ebp_national_pov}</span></span>
<span id="cb32-764"><a href="#cb32-764" aria-hidden="true" tabindex="-1"></a><span class="in">#### first let us look at the quality of in-sample prediction</span></span>
<span id="cb32-765"><a href="#cb32-765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-766"><a href="#cb32-766" aria-hidden="true" tabindex="-1"></a><span class="in">#' A function to estimate poverty rates in levels different from the target area</span></span>
<span id="cb32-767"><a href="#cb32-767" aria-hidden="true" tabindex="-1"></a><span class="in">#' </span></span>
<span id="cb32-768"><a href="#cb32-768" aria-hidden="true" tabindex="-1"></a><span class="in">#' This function will take the ebp object (result of ebp()) as well as the population data to estimate </span></span>
<span id="cb32-769"><a href="#cb32-769" aria-hidden="true" tabindex="-1"></a><span class="in">#' poverty rates at a level different from the designated target area level stipulated for poverty </span></span>
<span id="cb32-770"><a href="#cb32-770" aria-hidden="true" tabindex="-1"></a><span class="in">#' mapping in the `ebp()` function. </span></span>
<span id="cb32-771"><a href="#cb32-771" aria-hidden="true" tabindex="-1"></a><span class="in">#' </span></span>
<span id="cb32-772"><a href="#cb32-772" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param ebp_obj object of class `"ebp" "emdi"`</span></span>
<span id="cb32-773"><a href="#cb32-773" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param wgt_var chr, the weight variable name </span></span>
<span id="cb32-774"><a href="#cb32-774" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param pop_domain chr, the population domain used for `ebp()`</span></span>
<span id="cb32-775"><a href="#cb32-775" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param est_domain chr, the estimation domain</span></span>
<span id="cb32-776"><a href="#cb32-776" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param pop_dt data.frame, the population dataset/census</span></span>
<span id="cb32-777"><a href="#cb32-777" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param indicators chr, a character or vector of characters for the indicators of interest</span></span>
<span id="cb32-778"><a href="#cb32-778" aria-hidden="true" tabindex="-1"></a><span class="in">#' </span></span>
<span id="cb32-779"><a href="#cb32-779" aria-hidden="true" tabindex="-1"></a><span class="in">#' @import data.table dplyr</span></span>
<span id="cb32-780"><a href="#cb32-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-781"><a href="#cb32-781" aria-hidden="true" tabindex="-1"></a><span class="in">ebp_national_pov &lt;- function(ebp_obj,</span></span>
<span id="cb32-782"><a href="#cb32-782" aria-hidden="true" tabindex="-1"></a><span class="in">                             wgt_var,</span></span>
<span id="cb32-783"><a href="#cb32-783" aria-hidden="true" tabindex="-1"></a><span class="in">                             pop_domain,</span></span>
<span id="cb32-784"><a href="#cb32-784" aria-hidden="true" tabindex="-1"></a><span class="in">                             est_domain,</span></span>
<span id="cb32-785"><a href="#cb32-785" aria-hidden="true" tabindex="-1"></a><span class="in">                             pop_dt,</span></span>
<span id="cb32-786"><a href="#cb32-786" aria-hidden="true" tabindex="-1"></a><span class="in">                             indicators = c("Head_Count")) {</span></span>
<span id="cb32-787"><a href="#cb32-787" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-788"><a href="#cb32-788" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-789"><a href="#cb32-789" aria-hidden="true" tabindex="-1"></a><span class="in">  pop_dt &lt;- </span></span>
<span id="cb32-790"><a href="#cb32-790" aria-hidden="true" tabindex="-1"></a><span class="in">    pop_dt |&gt;</span></span>
<span id="cb32-791"><a href="#cb32-791" aria-hidden="true" tabindex="-1"></a><span class="in">    group_by(!!sym(pop_domain), !!sym(est_domain)) |&gt;</span></span>
<span id="cb32-792"><a href="#cb32-792" aria-hidden="true" tabindex="-1"></a><span class="in">    summarise(population = sum(!!sym(wgt_var), na.rm = TRUE), .groups = "drop")</span></span>
<span id="cb32-793"><a href="#cb32-793" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-794"><a href="#cb32-794" aria-hidden="true" tabindex="-1"></a><span class="in">  # Merge the ebp object data with population data</span></span>
<span id="cb32-795"><a href="#cb32-795" aria-hidden="true" tabindex="-1"></a><span class="in">  dt &lt;- merge(ebp_obj$ind, </span></span>
<span id="cb32-796"><a href="#cb32-796" aria-hidden="true" tabindex="-1"></a><span class="in">              pop_dt[, c(pop_domain, "population", est_domain)], </span></span>
<span id="cb32-797"><a href="#cb32-797" aria-hidden="true" tabindex="-1"></a><span class="in">              by.x = "Domain", </span></span>
<span id="cb32-798"><a href="#cb32-798" aria-hidden="true" tabindex="-1"></a><span class="in">              by.y = pop_domain, </span></span>
<span id="cb32-799"><a href="#cb32-799" aria-hidden="true" tabindex="-1"></a><span class="in">              all.x = TRUE)</span></span>
<span id="cb32-800"><a href="#cb32-800" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-801"><a href="#cb32-801" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute weighted means for all indicators</span></span>
<span id="cb32-802"><a href="#cb32-802" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-803"><a href="#cb32-803" aria-hidden="true" tabindex="-1"></a><span class="in">  pov_dt &lt;- </span></span>
<span id="cb32-804"><a href="#cb32-804" aria-hidden="true" tabindex="-1"></a><span class="in">    dt %&gt;%</span></span>
<span id="cb32-805"><a href="#cb32-805" aria-hidden="true" tabindex="-1"></a><span class="in">    as.data.table() %&gt;%</span></span>
<span id="cb32-806"><a href="#cb32-806" aria-hidden="true" tabindex="-1"></a><span class="in">    .[, lapply(.SD, weighted.mean, w = population, na.rm = TRUE),</span></span>
<span id="cb32-807"><a href="#cb32-807" aria-hidden="true" tabindex="-1"></a><span class="in">      .SDcols = indicators,</span></span>
<span id="cb32-808"><a href="#cb32-808" aria-hidden="true" tabindex="-1"></a><span class="in">      by = est_domain]</span></span>
<span id="cb32-809"><a href="#cb32-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-810"><a href="#cb32-810" aria-hidden="true" tabindex="-1"></a><span class="in">  return(pov_dt)</span></span>
<span id="cb32-811"><a href="#cb32-811" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-812"><a href="#cb32-812" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb32-813"><a href="#cb32-813" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-814"><a href="#cb32-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-815"><a href="#cb32-815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-816"><a href="#cb32-816" aria-hidden="true" tabindex="-1"></a><span class="in">```{r qual-check-1}</span></span>
<span id="cb32-817"><a href="#cb32-817" aria-hidden="true" tabindex="-1"></a><span class="in">ebpsurveypov_dt &lt;- lapply(</span></span>
<span id="cb32-818"><a href="#cb32-818" aria-hidden="true" tabindex="-1"></a><span class="in">  X = list(not_smodel, bcx_smodel, log_smodel),</span></span>
<span id="cb32-819"><a href="#cb32-819" aria-hidden="true" tabindex="-1"></a><span class="in">  FUN = function(ebp_obj) {</span></span>
<span id="cb32-820"><a href="#cb32-820" aria-hidden="true" tabindex="-1"></a><span class="in">    z &lt;- ebp_national_pov(</span></span>
<span id="cb32-821"><a href="#cb32-821" aria-hidden="true" tabindex="-1"></a><span class="in">      ebp_obj = ebp_obj,</span></span>
<span id="cb32-822"><a href="#cb32-822" aria-hidden="true" tabindex="-1"></a><span class="in">      wgt_var = "weight",</span></span>
<span id="cb32-823"><a href="#cb32-823" aria-hidden="true" tabindex="-1"></a><span class="in">      pop_domain = "district",</span></span>
<span id="cb32-824"><a href="#cb32-824" aria-hidden="true" tabindex="-1"></a><span class="in">      pop_dt = survey_dt,</span></span>
<span id="cb32-825"><a href="#cb32-825" aria-hidden="true" tabindex="-1"></a><span class="in">      est_domain = "state"</span></span>
<span id="cb32-826"><a href="#cb32-826" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb32-827"><a href="#cb32-827" aria-hidden="true" tabindex="-1"></a><span class="in">    return(z)</span></span>
<span id="cb32-828"><a href="#cb32-828" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb32-829"><a href="#cb32-829" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb32-830"><a href="#cb32-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-831"><a href="#cb32-831" aria-hidden="true" tabindex="-1"></a><span class="in">### rename headcount columns appropriately</span></span>
<span id="cb32-832"><a href="#cb32-832" aria-hidden="true" tabindex="-1"></a><span class="in">ebpsurveypov_dt &lt;-</span></span>
<span id="cb32-833"><a href="#cb32-833" aria-hidden="true" tabindex="-1"></a><span class="in">  mapply(</span></span>
<span id="cb32-834"><a href="#cb32-834" aria-hidden="true" tabindex="-1"></a><span class="in">    pov_dt = ebpsurveypov_dt,</span></span>
<span id="cb32-835"><a href="#cb32-835" aria-hidden="true" tabindex="-1"></a><span class="in">    name_obj = c("not", "bcx", "log"),</span></span>
<span id="cb32-836"><a href="#cb32-836" aria-hidden="true" tabindex="-1"></a><span class="in">    FUN = function(pov_dt, name_obj) {</span></span>
<span id="cb32-837"><a href="#cb32-837" aria-hidden="true" tabindex="-1"></a><span class="in">      pov_dt |&gt;</span></span>
<span id="cb32-838"><a href="#cb32-838" aria-hidden="true" tabindex="-1"></a><span class="in">        rename_with(~ paste0(name_obj, .), .cols = "Head_Count")</span></span>
<span id="cb32-839"><a href="#cb32-839" aria-hidden="true" tabindex="-1"></a><span class="in">    },</span></span>
<span id="cb32-840"><a href="#cb32-840" aria-hidden="true" tabindex="-1"></a><span class="in">    SIMPLIFY = FALSE</span></span>
<span id="cb32-841"><a href="#cb32-841" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb32-842"><a href="#cb32-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-843"><a href="#cb32-843" aria-hidden="true" tabindex="-1"></a><span class="in">ebpsurveypov_dt &lt;- Reduce(f = merge,</span></span>
<span id="cb32-844"><a href="#cb32-844" aria-hidden="true" tabindex="-1"></a><span class="in">                          x = ebpsurveypov_dt)</span></span>
<span id="cb32-845"><a href="#cb32-845" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-846"><a href="#cb32-846" aria-hidden="true" tabindex="-1"></a><span class="in">### we create some fake clusters within the districts to show how to </span></span>
<span id="cb32-847"><a href="#cb32-847" aria-hidden="true" tabindex="-1"></a><span class="in">### use the survey package to estimate the standard errors on the </span></span>
<span id="cb32-848"><a href="#cb32-848" aria-hidden="true" tabindex="-1"></a><span class="in">### poverty rates, ideally these would already exist within your survey</span></span>
<span id="cb32-849"><a href="#cb32-849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-850"><a href="#cb32-850" aria-hidden="true" tabindex="-1"></a><span class="in">#### for simplicity we will assume there are 5 clusters in each district</span></span>
<span id="cb32-851"><a href="#cb32-851" aria-hidden="true" tabindex="-1"></a><span class="in">survey_dt &lt;-</span></span>
<span id="cb32-852"><a href="#cb32-852" aria-hidden="true" tabindex="-1"></a><span class="in">  survey_dt %&gt;%</span></span>
<span id="cb32-853"><a href="#cb32-853" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(district) %&gt;%</span></span>
<span id="cb32-854"><a href="#cb32-854" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(num_clusters = pmax(2, round(n() / sample(5:15, 1))), </span></span>
<span id="cb32-855"><a href="#cb32-855" aria-hidden="true" tabindex="-1"></a><span class="in">         cluster = sample(rep(1:num_clusters, length.out = n()))) %&gt;%</span></span>
<span id="cb32-856"><a href="#cb32-856" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup() %&gt;%</span></span>
<span id="cb32-857"><a href="#cb32-857" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(cluster_id = dense_rank(interaction(district, cluster)))</span></span>
<span id="cb32-858"><a href="#cb32-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-859"><a href="#cb32-859" aria-hidden="true" tabindex="-1"></a><span class="in">svy_obj &lt;-</span></span>
<span id="cb32-860"><a href="#cb32-860" aria-hidden="true" tabindex="-1"></a><span class="in">  survey_dt %&gt;%</span></span>
<span id="cb32-861"><a href="#cb32-861" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(poor = ifelse(eqIncome &lt; 18207.2, 1, 0)) %&gt;%</span></span>
<span id="cb32-862"><a href="#cb32-862" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::select(district, weight, state, poor, cluster_id) %&gt;%</span></span>
<span id="cb32-863"><a href="#cb32-863" aria-hidden="true" tabindex="-1"></a><span class="in">  survey::svydesign(</span></span>
<span id="cb32-864"><a href="#cb32-864" aria-hidden="true" tabindex="-1"></a><span class="in">    ids = ~ cluster_id,</span></span>
<span id="cb32-865"><a href="#cb32-865" aria-hidden="true" tabindex="-1"></a><span class="in">    weights = ~ weight,</span></span>
<span id="cb32-866"><a href="#cb32-866" aria-hidden="true" tabindex="-1"></a><span class="in">    strata = ~ state,</span></span>
<span id="cb32-867"><a href="#cb32-867" aria-hidden="true" tabindex="-1"></a><span class="in">    survey.lonely.psu = "adjust",</span></span>
<span id="cb32-868"><a href="#cb32-868" aria-hidden="true" tabindex="-1"></a><span class="in">    data = .</span></span>
<span id="cb32-869"><a href="#cb32-869" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb32-870"><a href="#cb32-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-871"><a href="#cb32-871" aria-hidden="true" tabindex="-1"></a><span class="in">var_dt &lt;-</span></span>
<span id="cb32-872"><a href="#cb32-872" aria-hidden="true" tabindex="-1"></a><span class="in">  svyby(~ poor, ~ state, svy_obj, svymean) %&gt;%</span></span>
<span id="cb32-873"><a href="#cb32-873" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(poorLB = poor - 1.96 * se, poorUB = poor + 1.96 * se)</span></span>
<span id="cb32-874"><a href="#cb32-874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-875"><a href="#cb32-875" aria-hidden="true" tabindex="-1"></a><span class="in">ebpsurveypov_dt &lt;-</span></span>
<span id="cb32-876"><a href="#cb32-876" aria-hidden="true" tabindex="-1"></a><span class="in">  ebpsurveypov_dt |&gt; </span></span>
<span id="cb32-877"><a href="#cb32-877" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(</span></span>
<span id="cb32-878"><a href="#cb32-878" aria-hidden="true" tabindex="-1"></a><span class="in">    var_dt |&gt; select(any_of(c("state", "poor", "poorLB", "poorUB"))),</span></span>
<span id="cb32-879"><a href="#cb32-879" aria-hidden="true" tabindex="-1"></a><span class="in">    join_by("state")</span></span>
<span id="cb32-880"><a href="#cb32-880" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb32-881"><a href="#cb32-881" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-882"><a href="#cb32-882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-883"><a href="#cb32-883" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Compare Survey EBP Poverty Rates to Direct Poverty Rates at different poverty lines</span></span>
<span id="cb32-884"><a href="#cb32-884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-885"><a href="#cb32-885" aria-hidden="true" tabindex="-1"></a>Another check for the quality of prediction within the survey is testing the predictive power of the model at different poverty lines along the entire income distribution. In the example below, we show compare the predicted poverty rate to the direct poverty rate using each 5th percentile increment in income i.e. using poverty ventile. We implement a function <span class="in">`compare_surveyebp_atpovline()`</span> which computes poverty from the simulated welfare data (produced by <span class="in">`Ydump`</span> argument in ebp()) and the survey at each poverty line. The function allows the user specify the percentiles at which poverty lines will be specified. The default is set at every 5th percentile (<span class="in">`seq(0, 1, 0.05)`</span>).</span>
<span id="cb32-886"><a href="#cb32-886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-887"><a href="#cb32-887" aria-hidden="true" tabindex="-1"></a>We apply <span class="in">`compare_surveyebp_at_povline()`</span> to each of the estimated models in comparison with the direct survey estimates at poverty line ventiles (every 5th percentile).</span>
<span id="cb32-888"><a href="#cb32-888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-889"><a href="#cb32-889" aria-hidden="true" tabindex="-1"></a><span class="in">```{r qual-check-2}</span></span>
<span id="cb32-890"><a href="#cb32-890" aria-hidden="true" tabindex="-1"></a><span class="in">### first let's read in the data ydump data</span></span>
<span id="cb32-891"><a href="#cb32-891" aria-hidden="true" tabindex="-1"></a><span class="in">ydumppath_list &lt;- list.files(</span></span>
<span id="cb32-892"><a href="#cb32-892" aria-hidden="true" tabindex="-1"></a><span class="in">  path = file.path(fldr_temp, "Ydump"),</span></span>
<span id="cb32-893"><a href="#cb32-893" aria-hidden="true" tabindex="-1"></a><span class="in">  pattern = "^unitsurvey_.*Ydump_glmnet.csv",</span></span>
<span id="cb32-894"><a href="#cb32-894" aria-hidden="true" tabindex="-1"></a><span class="in">  full.names = TRUE</span></span>
<span id="cb32-895"><a href="#cb32-895" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb32-896"><a href="#cb32-896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-897"><a href="#cb32-897" aria-hidden="true" tabindex="-1"></a><span class="in">### the following code will read in the Ydump data into a list of </span></span>
<span id="cb32-898"><a href="#cb32-898" aria-hidden="true" tabindex="-1"></a><span class="in">###    data.frame objects and sequentially: </span></span>
<span id="cb32-899"><a href="#cb32-899" aria-hidden="true" tabindex="-1"></a><span class="in">### - combine the ydump with household survey</span></span>
<span id="cb32-900"><a href="#cb32-900" aria-hidden="true" tabindex="-1"></a><span class="in">### - compute poverty rates at each threshold</span></span>
<span id="cb32-901"><a href="#cb32-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-902"><a href="#cb32-902" aria-hidden="true" tabindex="-1"></a><span class="in">#### lets write a function to do this for one of our models</span></span>
<span id="cb32-903"><a href="#cb32-903" aria-hidden="true" tabindex="-1"></a><span class="in">ydump_dtlist &lt;- lapply(X = ydumppath_list, FUN = fread)</span></span>
<span id="cb32-904"><a href="#cb32-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-905"><a href="#cb32-905" aria-hidden="true" tabindex="-1"></a><span class="in">names(ydump_dtlist) &lt;-</span></span>
<span id="cb32-906"><a href="#cb32-906" aria-hidden="true" tabindex="-1"></a><span class="in">  basename(ydumppath_list) %&gt;%</span></span>
<span id="cb32-907"><a href="#cb32-907" aria-hidden="true" tabindex="-1"></a><span class="in">  sub(pattern = "^unitsurvey_", replacement = "") %&gt;%</span></span>
<span id="cb32-908"><a href="#cb32-908" aria-hidden="true" tabindex="-1"></a><span class="in">  sub(pattern = "_glmnet.csv", replacement = "")</span></span>
<span id="cb32-909"><a href="#cb32-909" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-910"><a href="#cb32-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-911"><a href="#cb32-911" aria-hidden="true" tabindex="-1"></a><span class="in">### a simple function to carry out the poverty rate comparisons (model vs actual at each poverty ventile, 5% increments) &amp; plot the result</span></span>
<span id="cb32-912"><a href="#cb32-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-913"><a href="#cb32-913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-914"><a href="#cb32-914" aria-hidden="true" tabindex="-1"></a><span class="in">#' Compute direct poverty rates and simulated outcome variables at specified poverty lines</span></span>
<span id="cb32-915"><a href="#cb32-915" aria-hidden="true" tabindex="-1"></a><span class="in">#' </span></span>
<span id="cb32-916"><a href="#cb32-916" aria-hidden="true" tabindex="-1"></a><span class="in">#' The function uses the simulated outcome from `povmap::ebp()`'s `Ydump` argument and the survey data to compute estimated and direct poverty    </span></span>
<span id="cb32-917"><a href="#cb32-917" aria-hidden="true" tabindex="-1"></a><span class="in">#' rates at a specified level than is estimated with `ebp()` at different poverty lines. </span></span>
<span id="cb32-918"><a href="#cb32-918" aria-hidden="true" tabindex="-1"></a><span class="in">#' </span></span>
<span id="cb32-919"><a href="#cb32-919" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param ydump_data data.frame, the simulated welfare/income data from non-null `Ydump` argument within the `povmap::ebp()`</span></span>
<span id="cb32-920"><a href="#cb32-920" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param smp_data data.frame, the survey data</span></span>
<span id="cb32-921"><a href="#cb32-921" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param smp_domains character, a variable name for the domain/geographic level at which poverty rates will be estimated</span></span>
<span id="cb32-922"><a href="#cb32-922" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param smp_weights character, the weight variable</span></span>
<span id="cb32-923"><a href="#cb32-923" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param pline_increment numeric vector, a set of percentiles at which poverty rates should be estimated. </span></span>
<span id="cb32-924"><a href="#cb32-924" aria-hidden="true" tabindex="-1"></a><span class="in">#' </span></span>
<span id="cb32-925"><a href="#cb32-925" aria-hidden="true" tabindex="-1"></a><span class="in">#' @import data.table dplyr</span></span>
<span id="cb32-926"><a href="#cb32-926" aria-hidden="true" tabindex="-1"></a><span class="in">#' </span></span>
<span id="cb32-927"><a href="#cb32-927" aria-hidden="true" tabindex="-1"></a><span class="in">#' @export</span></span>
<span id="cb32-928"><a href="#cb32-928" aria-hidden="true" tabindex="-1"></a><span class="in">#' </span></span>
<span id="cb32-929"><a href="#cb32-929" aria-hidden="true" tabindex="-1"></a><span class="in">compare_surveyebp_atpovline &lt;- function(ydump_data,</span></span>
<span id="cb32-930"><a href="#cb32-930" aria-hidden="true" tabindex="-1"></a><span class="in">                                        smp_data,</span></span>
<span id="cb32-931"><a href="#cb32-931" aria-hidden="true" tabindex="-1"></a><span class="in">                                        smp_domains,</span></span>
<span id="cb32-932"><a href="#cb32-932" aria-hidden="true" tabindex="-1"></a><span class="in">                                        smp_weights,</span></span>
<span id="cb32-933"><a href="#cb32-933" aria-hidden="true" tabindex="-1"></a><span class="in">                                        outcome_var,</span></span>
<span id="cb32-934"><a href="#cb32-934" aria-hidden="true" tabindex="-1"></a><span class="in">                                        pline_increment = seq(0, 1, 0.05)){</span></span>
<span id="cb32-935"><a href="#cb32-935" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-936"><a href="#cb32-936" aria-hidden="true" tabindex="-1"></a><span class="in">  ydump_dt &lt;- as.data.table(ydump_data)</span></span>
<span id="cb32-937"><a href="#cb32-937" aria-hidden="true" tabindex="-1"></a><span class="in">  smp_dt &lt;- as.data.table(smp_data[, c(smp_domains, smp_weights, outcome_var)])</span></span>
<span id="cb32-938"><a href="#cb32-938" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-939"><a href="#cb32-939" aria-hidden="true" tabindex="-1"></a><span class="in">  ydump_dt &lt;- cbind(ydump_dt, </span></span>
<span id="cb32-940"><a href="#cb32-940" aria-hidden="true" tabindex="-1"></a><span class="in">                    smp_dt[, c(smp_domains, smp_weights), with = FALSE] %&gt;%</span></span>
<span id="cb32-941"><a href="#cb32-941" aria-hidden="true" tabindex="-1"></a><span class="in">                      arrange(smp_domains))</span></span>
<span id="cb32-942"><a href="#cb32-942" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-943"><a href="#cb32-943" aria-hidden="true" tabindex="-1"></a><span class="in">  threshold_list &lt;-</span></span>
<span id="cb32-944"><a href="#cb32-944" aria-hidden="true" tabindex="-1"></a><span class="in">    wtd.quantile(x = smp_dt[[outcome_var]],</span></span>
<span id="cb32-945"><a href="#cb32-945" aria-hidden="true" tabindex="-1"></a><span class="in">                 weights = smp_dt[[smp_weights]],</span></span>
<span id="cb32-946"><a href="#cb32-946" aria-hidden="true" tabindex="-1"></a><span class="in">                 probs = pline_increment)</span></span>
<span id="cb32-947"><a href="#cb32-947" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-948"><a href="#cb32-948" aria-hidden="true" tabindex="-1"></a><span class="in">  compute_ptile_pov &lt;- function(welfare_dt,</span></span>
<span id="cb32-949"><a href="#cb32-949" aria-hidden="true" tabindex="-1"></a><span class="in">                                weights,</span></span>
<span id="cb32-950"><a href="#cb32-950" aria-hidden="true" tabindex="-1"></a><span class="in">                                welfare,</span></span>
<span id="cb32-951"><a href="#cb32-951" aria-hidden="true" tabindex="-1"></a><span class="in">                                thresholds){</span></span>
<span id="cb32-952"><a href="#cb32-952" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-953"><a href="#cb32-953" aria-hidden="true" tabindex="-1"></a><span class="in">    pov_list &lt;- </span></span>
<span id="cb32-954"><a href="#cb32-954" aria-hidden="true" tabindex="-1"></a><span class="in">    lapply(X = thresholds,</span></span>
<span id="cb32-955"><a href="#cb32-955" aria-hidden="true" tabindex="-1"></a><span class="in">           FUN = function(x){</span></span>
<span id="cb32-956"><a href="#cb32-956" aria-hidden="true" tabindex="-1"></a><span class="in">             </span></span>
<span id="cb32-957"><a href="#cb32-957" aria-hidden="true" tabindex="-1"></a><span class="in">             yy &lt;- </span></span>
<span id="cb32-958"><a href="#cb32-958" aria-hidden="true" tabindex="-1"></a><span class="in">               welfare_dt %&gt;%</span></span>
<span id="cb32-959"><a href="#cb32-959" aria-hidden="true" tabindex="-1"></a><span class="in">               mutate(poor = ifelse(!!sym(welfare) &lt; x, 1, 0)) %&gt;%</span></span>
<span id="cb32-960"><a href="#cb32-960" aria-hidden="true" tabindex="-1"></a><span class="in">               summarize(prate = weighted.mean(x = poor,</span></span>
<span id="cb32-961"><a href="#cb32-961" aria-hidden="true" tabindex="-1"></a><span class="in">                                               w = !!sym(weights),</span></span>
<span id="cb32-962"><a href="#cb32-962" aria-hidden="true" tabindex="-1"></a><span class="in">                                               na.rm = TRUE))</span></span>
<span id="cb32-963"><a href="#cb32-963" aria-hidden="true" tabindex="-1"></a><span class="in">             </span></span>
<span id="cb32-964"><a href="#cb32-964" aria-hidden="true" tabindex="-1"></a><span class="in">             return(yy)</span></span>
<span id="cb32-965"><a href="#cb32-965" aria-hidden="true" tabindex="-1"></a><span class="in">             </span></span>
<span id="cb32-966"><a href="#cb32-966" aria-hidden="true" tabindex="-1"></a><span class="in">           })</span></span>
<span id="cb32-967"><a href="#cb32-967" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb32-968"><a href="#cb32-968" aria-hidden="true" tabindex="-1"></a><span class="in">    pov_list &lt;- </span></span>
<span id="cb32-969"><a href="#cb32-969" aria-hidden="true" tabindex="-1"></a><span class="in">      unlist(pov_list) %&gt;%</span></span>
<span id="cb32-970"><a href="#cb32-970" aria-hidden="true" tabindex="-1"></a><span class="in">      data.frame() %&gt;%</span></span>
<span id="cb32-971"><a href="#cb32-971" aria-hidden="true" tabindex="-1"></a><span class="in">      setNames("pov")</span></span>
<span id="cb32-972"><a href="#cb32-972" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb32-973"><a href="#cb32-973" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb32-974"><a href="#cb32-974" aria-hidden="true" tabindex="-1"></a><span class="in">    return(pov_list)</span></span>
<span id="cb32-975"><a href="#cb32-975" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb32-976"><a href="#cb32-976" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb32-977"><a href="#cb32-977" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-978"><a href="#cb32-978" aria-hidden="true" tabindex="-1"></a><span class="in">  pov_dt &lt;- compute_ptile_pov(welfare_dt = ydump_dt,</span></span>
<span id="cb32-979"><a href="#cb32-979" aria-hidden="true" tabindex="-1"></a><span class="in">                              weights = smp_weights,</span></span>
<span id="cb32-980"><a href="#cb32-980" aria-hidden="true" tabindex="-1"></a><span class="in">                              welfare = "Simulated_Y",</span></span>
<span id="cb32-981"><a href="#cb32-981" aria-hidden="true" tabindex="-1"></a><span class="in">                              thresholds = threshold_list)</span></span>
<span id="cb32-982"><a href="#cb32-982" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-983"><a href="#cb32-983" aria-hidden="true" tabindex="-1"></a><span class="in">  pov_dt &lt;- data.table(ebp_poverty = pov_dt,</span></span>
<span id="cb32-984"><a href="#cb32-984" aria-hidden="true" tabindex="-1"></a><span class="in">                       probs = as.character(seq(0, 1, 0.05)))</span></span>
<span id="cb32-985"><a href="#cb32-985" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-986"><a href="#cb32-986" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-987"><a href="#cb32-987" aria-hidden="true" tabindex="-1"></a><span class="in">  # povcheck_plots &lt;- </span></span>
<span id="cb32-988"><a href="#cb32-988" aria-hidden="true" tabindex="-1"></a><span class="in">  #   pov_dt %&gt;%</span></span>
<span id="cb32-989"><a href="#cb32-989" aria-hidden="true" tabindex="-1"></a><span class="in">  #   mutate(y )</span></span>
<span id="cb32-990"><a href="#cb32-990" aria-hidden="true" tabindex="-1"></a><span class="in">  #   ggplot(aes(x = as.numeric(probs)))</span></span>
<span id="cb32-991"><a href="#cb32-991" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-992"><a href="#cb32-992" aria-hidden="true" tabindex="-1"></a><span class="in">  return(pov_dt)</span></span>
<span id="cb32-993"><a href="#cb32-993" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-994"><a href="#cb32-994" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb32-995"><a href="#cb32-995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-996"><a href="#cb32-996" aria-hidden="true" tabindex="-1"></a><span class="in">### now lets plot the results</span></span>
<span id="cb32-997"><a href="#cb32-997" aria-hidden="true" tabindex="-1"></a><span class="in">svyplinecomp_list &lt;-</span></span>
<span id="cb32-998"><a href="#cb32-998" aria-hidden="true" tabindex="-1"></a><span class="in">  lapply(</span></span>
<span id="cb32-999"><a href="#cb32-999" aria-hidden="true" tabindex="-1"></a><span class="in">    X = ydump_dtlist,</span></span>
<span id="cb32-1000"><a href="#cb32-1000" aria-hidden="true" tabindex="-1"></a><span class="in">    FUN = function(ydump) {</span></span>
<span id="cb32-1001"><a href="#cb32-1001" aria-hidden="true" tabindex="-1"></a><span class="in">      compare_surveyebp_atpovline(</span></span>
<span id="cb32-1002"><a href="#cb32-1002" aria-hidden="true" tabindex="-1"></a><span class="in">        ydump_data = ydump,</span></span>
<span id="cb32-1003"><a href="#cb32-1003" aria-hidden="true" tabindex="-1"></a><span class="in">        smp_data = survey_dt,</span></span>
<span id="cb32-1004"><a href="#cb32-1004" aria-hidden="true" tabindex="-1"></a><span class="in">        smp_domains = "district",</span></span>
<span id="cb32-1005"><a href="#cb32-1005" aria-hidden="true" tabindex="-1"></a><span class="in">        smp_weights = "weight",</span></span>
<span id="cb32-1006"><a href="#cb32-1006" aria-hidden="true" tabindex="-1"></a><span class="in">        outcome_var = "eqIncome"</span></span>
<span id="cb32-1007"><a href="#cb32-1007" aria-hidden="true" tabindex="-1"></a><span class="in">      )</span></span>
<span id="cb32-1008"><a href="#cb32-1008" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb32-1009"><a href="#cb32-1009" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb32-1010"><a href="#cb32-1010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1011"><a href="#cb32-1011" aria-hidden="true" tabindex="-1"></a><span class="in">## a bit of cleaning and then making the plots</span></span>
<span id="cb32-1012"><a href="#cb32-1012" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1013"><a href="#cb32-1013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1014"><a href="#cb32-1014" aria-hidden="true" tabindex="-1"></a><span class="in">svyplinecomp_dt &lt;-</span></span>
<span id="cb32-1015"><a href="#cb32-1015" aria-hidden="true" tabindex="-1"></a><span class="in">  mapply(</span></span>
<span id="cb32-1016"><a href="#cb32-1016" aria-hidden="true" tabindex="-1"></a><span class="in">    comp_dt = svyplinecomp_list,</span></span>
<span id="cb32-1017"><a href="#cb32-1017" aria-hidden="true" tabindex="-1"></a><span class="in">    name_list = names(svyplinecomp_list),</span></span>
<span id="cb32-1018"><a href="#cb32-1018" aria-hidden="true" tabindex="-1"></a><span class="in">    FUN = function(comp_dt, name_list) {</span></span>
<span id="cb32-1019"><a href="#cb32-1019" aria-hidden="true" tabindex="-1"></a><span class="in">      comp_dt %&gt;%</span></span>
<span id="cb32-1020"><a href="#cb32-1020" aria-hidden="true" tabindex="-1"></a><span class="in">        rename(ebp = "ebp_poverty.pov") %&gt;%</span></span>
<span id="cb32-1021"><a href="#cb32-1021" aria-hidden="true" tabindex="-1"></a><span class="in">        mutate(probs = as.numeric(probs)) %&gt;%</span></span>
<span id="cb32-1022"><a href="#cb32-1022" aria-hidden="true" tabindex="-1"></a><span class="in">        mutate(diff = abs(ebp - probs) / probs) %&gt;%</span></span>
<span id="cb32-1023"><a href="#cb32-1023" aria-hidden="true" tabindex="-1"></a><span class="in">        mutate(transformation = sub("Ydump", "", name_list))</span></span>
<span id="cb32-1024"><a href="#cb32-1024" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb32-1025"><a href="#cb32-1025" aria-hidden="true" tabindex="-1"></a><span class="in">    },</span></span>
<span id="cb32-1026"><a href="#cb32-1026" aria-hidden="true" tabindex="-1"></a><span class="in">    SIMPLIFY = FALSE</span></span>
<span id="cb32-1027"><a href="#cb32-1027" aria-hidden="true" tabindex="-1"></a><span class="in">  ) |&gt; </span></span>
<span id="cb32-1028"><a href="#cb32-1028" aria-hidden="true" tabindex="-1"></a><span class="in">  bind_rows()</span></span>
<span id="cb32-1029"><a href="#cb32-1029" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1030"><a href="#cb32-1030" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1031"><a href="#cb32-1031" aria-hidden="true" tabindex="-1"></a>We plot the absolute value of the percent difference between both poverty rates at each ventile as seen in the plot below.</span>
<span id="cb32-1032"><a href="#cb32-1032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1035"><a href="#cb32-1035" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-1036"><a href="#cb32-1036" aria-hidden="true" tabindex="-1"></a>svyplinecomp_dt <span class="sc">%&gt;%</span></span>
<span id="cb32-1037"><a href="#cb32-1037" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb32-1038"><a href="#cb32-1038" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> probs,</span>
<span id="cb32-1039"><a href="#cb32-1039" aria-hidden="true" tabindex="-1"></a>                <span class="at">y =</span> diff,</span>
<span id="cb32-1040"><a href="#cb32-1040" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> transformation)) <span class="sc">+</span> </span>
<span id="cb32-1041"><a href="#cb32-1041" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb32-1042"><a href="#cb32-1042" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1043"><a href="#cb32-1043" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1044"><a href="#cb32-1044" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Evaluating the Standard Normality Assumptions</span></span>
<span id="cb32-1045"><a href="#cb32-1045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1046"><a href="#cb32-1046" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Presenting the regression table estimates (use povmap::ebp_reportcoef_table() and then translate into a flextable which can be rendered in Word, PDF or HTML)</span>
<span id="cb32-1047"><a href="#cb32-1047" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1048"><a href="#cb32-1048" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Checking that all model assumptions hold (normality assumptions for the miu and epsilon terms), using povmap::ebp_normalityfit() to present skewness and kurtosis for both errors. Then show a function that uses ebp object to plot the distribution of the errors and compute the kolmogrov-smirnov test statistics. We can also include the shapiro-wilks which will break down for larger sample sizes but is equally well known. Another function that produces q-q plots for miu and epsilon terms from ebp object.</span>
<span id="cb32-1049"><a href="#cb32-1049" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1050"><a href="#cb32-1050" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Check on model validity: Create a plot to show how poverty rates vary at each ventile i.e. at 5% poverty line increments. This is to show how to check the quality of model prediction without the added bias of out of sample prediction</span>
<span id="cb32-1051"><a href="#cb32-1051" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1052"><a href="#cb32-1052" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Computing MSE and CVs and computing the statistical gains made from performing small area estimation i.e. in practical terms, how much bigger would the survey have to be the get the same level of precision that SAE now gives us with the census data.</span>
<span id="cb32-1053"><a href="#cb32-1053" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1054"><a href="#cb32-1054" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Final validation: EBP estimates vs Direct Estimates (supposedly truth) at the highest resolution level that is considered nationally representative, this is usually the regional level in Africa.</span>
<span id="cb32-1055"><a href="#cb32-1055" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1056"><a href="#cb32-1056" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Plotting the poverty map using the ebp object and the shapefile</span>
<span id="cb32-1057"><a href="#cb32-1057" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1058"><a href="#cb32-1058" aria-hidden="true" tabindex="-1"></a><span class="in">```{r qual-check-3}</span></span>
<span id="cb32-1059"><a href="#cb32-1059" aria-hidden="true" tabindex="-1"></a><span class="in">#### presenting the results of the linear mixed effects regression</span></span>
<span id="cb32-1060"><a href="#cb32-1060" aria-hidden="true" tabindex="-1"></a><span class="in">specify_decimal &lt;- function(x, k) trimws(format(round(x, k), nsmall=k))</span></span>
<span id="cb32-1061"><a href="#cb32-1061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1062"><a href="#cb32-1062" aria-hidden="true" tabindex="-1"></a><span class="in">### to quickly create coefficients table</span></span>
<span id="cb32-1063"><a href="#cb32-1063" aria-hidden="true" tabindex="-1"></a><span class="in">coef_dt &lt;- povmap::ebp_reportcoef_table(log_model) </span></span>
<span id="cb32-1064"><a href="#cb32-1064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1065"><a href="#cb32-1065" aria-hidden="true" tabindex="-1"></a><span class="in">## showing how to present the skewness and kurtosis of the random effects </span></span>
<span id="cb32-1066"><a href="#cb32-1066" aria-hidden="true" tabindex="-1"></a><span class="in">##   and model errors</span></span>
<span id="cb32-1067"><a href="#cb32-1067" aria-hidden="true" tabindex="-1"></a><span class="in">err_dt &lt;-</span></span>
<span id="cb32-1068"><a href="#cb32-1068" aria-hidden="true" tabindex="-1"></a><span class="in">  povmap::ebp_normalityfit(log_model) %&gt;%</span></span>
<span id="cb32-1069"><a href="#cb32-1069" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(value = specify_decimal(value, 3))</span></span>
<span id="cb32-1070"><a href="#cb32-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1071"><a href="#cb32-1071" aria-hidden="true" tabindex="-1"></a><span class="in">### to convert this into a publication ready report</span></span>
<span id="cb32-1072"><a href="#cb32-1072" aria-hidden="true" tabindex="-1"></a><span class="in">create_regression_table &lt;- function(coef_table, eval_table) {</span></span>
<span id="cb32-1073"><a href="#cb32-1073" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-1074"><a href="#cb32-1074" aria-hidden="true" tabindex="-1"></a><span class="in">  # Rename columns for consistency</span></span>
<span id="cb32-1075"><a href="#cb32-1075" aria-hidden="true" tabindex="-1"></a><span class="in">  coef_table &lt;- </span></span>
<span id="cb32-1076"><a href="#cb32-1076" aria-hidden="true" tabindex="-1"></a><span class="in">    coef_table %&gt;%</span></span>
<span id="cb32-1077"><a href="#cb32-1077" aria-hidden="true" tabindex="-1"></a><span class="in">    rename(Description = Variable,</span></span>
<span id="cb32-1078"><a href="#cb32-1078" aria-hidden="true" tabindex="-1"></a><span class="in">           Estimate = coeff, </span></span>
<span id="cb32-1079"><a href="#cb32-1079" aria-hidden="true" tabindex="-1"></a><span class="in">           `Std. Error` = std_error) %&gt;%</span></span>
<span id="cb32-1080"><a href="#cb32-1080" aria-hidden="true" tabindex="-1"></a><span class="in">    mutate(Type = "Coefficients") %&gt;%</span></span>
<span id="cb32-1081"><a href="#cb32-1081" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb32-1082"><a href="#cb32-1082" aria-hidden="true" tabindex="-1"></a><span class="in">    # Format std. error under estimates</span></span>
<span id="cb32-1083"><a href="#cb32-1083" aria-hidden="true" tabindex="-1"></a><span class="in">    mutate(Estimate = paste0(Estimate, "\n(", `Std. Error`, ")")) %&gt;%  </span></span>
<span id="cb32-1084"><a href="#cb32-1084" aria-hidden="true" tabindex="-1"></a><span class="in">    dplyr::select(Type, Description, Estimate)</span></span>
<span id="cb32-1085"><a href="#cb32-1085" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1086"><a href="#cb32-1086" aria-hidden="true" tabindex="-1"></a><span class="in">  eval_table &lt;- eval_table %&gt;%</span></span>
<span id="cb32-1087"><a href="#cb32-1087" aria-hidden="true" tabindex="-1"></a><span class="in">    rename(Description = indicator, Estimate = value) %&gt;%</span></span>
<span id="cb32-1088"><a href="#cb32-1088" aria-hidden="true" tabindex="-1"></a><span class="in">    mutate(Type = "Diagnostics")</span></span>
<span id="cb32-1089"><a href="#cb32-1089" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1090"><a href="#cb32-1090" aria-hidden="true" tabindex="-1"></a><span class="in">  # Combine coefficient and diagnostic tables</span></span>
<span id="cb32-1091"><a href="#cb32-1091" aria-hidden="true" tabindex="-1"></a><span class="in">  full_table &lt;- rbind(coef_table, </span></span>
<span id="cb32-1092"><a href="#cb32-1092" aria-hidden="true" tabindex="-1"></a><span class="in">                      eval_table %&gt;%</span></span>
<span id="cb32-1093"><a href="#cb32-1093" aria-hidden="true" tabindex="-1"></a><span class="in">                        dplyr::select(colnames(coef_table)))</span></span>
<span id="cb32-1094"><a href="#cb32-1094" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1095"><a href="#cb32-1095" aria-hidden="true" tabindex="-1"></a><span class="in">  # Identify where diagnostics start</span></span>
<span id="cb32-1096"><a href="#cb32-1096" aria-hidden="true" tabindex="-1"></a><span class="in">  diag_start &lt;- nrow(coef_table) + 1</span></span>
<span id="cb32-1097"><a href="#cb32-1097" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1098"><a href="#cb32-1098" aria-hidden="true" tabindex="-1"></a><span class="in">  # Create flextable</span></span>
<span id="cb32-1099"><a href="#cb32-1099" aria-hidden="true" tabindex="-1"></a><span class="in">  regression_table &lt;- </span></span>
<span id="cb32-1100"><a href="#cb32-1100" aria-hidden="true" tabindex="-1"></a><span class="in">  flextable(full_table) %&gt;%</span></span>
<span id="cb32-1101"><a href="#cb32-1101" aria-hidden="true" tabindex="-1"></a><span class="in">    set_header_labels(</span></span>
<span id="cb32-1102"><a href="#cb32-1102" aria-hidden="true" tabindex="-1"></a><span class="in">      Type = "Type",</span></span>
<span id="cb32-1103"><a href="#cb32-1103" aria-hidden="true" tabindex="-1"></a><span class="in">      Description = "Description",</span></span>
<span id="cb32-1104"><a href="#cb32-1104" aria-hidden="true" tabindex="-1"></a><span class="in">      Estimate = "Estimate"</span></span>
<span id="cb32-1105"><a href="#cb32-1105" aria-hidden="true" tabindex="-1"></a><span class="in">    ) %&gt;%</span></span>
<span id="cb32-1106"><a href="#cb32-1106" aria-hidden="true" tabindex="-1"></a><span class="in">    hline(part = "all") %&gt;%</span></span>
<span id="cb32-1107"><a href="#cb32-1107" aria-hidden="true" tabindex="-1"></a><span class="in">    merge_v(j = "Type") %&gt;%</span></span>
<span id="cb32-1108"><a href="#cb32-1108" aria-hidden="true" tabindex="-1"></a><span class="in">    align(j = "Description", align = "left", part = "all") %&gt;%</span></span>
<span id="cb32-1109"><a href="#cb32-1109" aria-hidden="true" tabindex="-1"></a><span class="in">    align(j = "Estimate", align = "center", part = "all") %&gt;%</span></span>
<span id="cb32-1110"><a href="#cb32-1110" aria-hidden="true" tabindex="-1"></a><span class="in">    vline(j = 1, border = fp_border(color = "black", width = 1)) %&gt;%</span></span>
<span id="cb32-1111"><a href="#cb32-1111" aria-hidden="true" tabindex="-1"></a><span class="in">    hline(i = diag_start - 1, border = fp_border(color = "black", width = 1)) %&gt;%</span></span>
<span id="cb32-1112"><a href="#cb32-1112" aria-hidden="true" tabindex="-1"></a><span class="in">    autofit() %&gt;%</span></span>
<span id="cb32-1113"><a href="#cb32-1113" aria-hidden="true" tabindex="-1"></a><span class="in">    width(j = "Type", width = 1.2) %&gt;%</span></span>
<span id="cb32-1114"><a href="#cb32-1114" aria-hidden="true" tabindex="-1"></a><span class="in">    width(j = "Description", width = 2) %&gt;%</span></span>
<span id="cb32-1115"><a href="#cb32-1115" aria-hidden="true" tabindex="-1"></a><span class="in">    width(j = "Estimate", width = 1.5)</span></span>
<span id="cb32-1116"><a href="#cb32-1116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1117"><a href="#cb32-1117" aria-hidden="true" tabindex="-1"></a><span class="in">  # Styling for diagnostics</span></span>
<span id="cb32-1118"><a href="#cb32-1118" aria-hidden="true" tabindex="-1"></a><span class="in">  regression_table &lt;- regression_table %&gt;%</span></span>
<span id="cb32-1119"><a href="#cb32-1119" aria-hidden="true" tabindex="-1"></a><span class="in">    bold(i = diag_start:nrow(full_table), bold = TRUE) %&gt;%</span></span>
<span id="cb32-1120"><a href="#cb32-1120" aria-hidden="true" tabindex="-1"></a><span class="in">    italic(i = diag_start:nrow(full_table), italic = TRUE) %&gt;%</span></span>
<span id="cb32-1121"><a href="#cb32-1121" aria-hidden="true" tabindex="-1"></a><span class="in">    font(fontname = "Times New Roman", part = "all") %&gt;%</span></span>
<span id="cb32-1122"><a href="#cb32-1122" aria-hidden="true" tabindex="-1"></a><span class="in">    fontsize(size = 10, part = "all")</span></span>
<span id="cb32-1123"><a href="#cb32-1123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1124"><a href="#cb32-1124" aria-hidden="true" tabindex="-1"></a><span class="in">  return(regression_table)</span></span>
<span id="cb32-1125"><a href="#cb32-1125" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-1126"><a href="#cb32-1126" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb32-1127"><a href="#cb32-1127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1128"><a href="#cb32-1128" aria-hidden="true" tabindex="-1"></a><span class="in">### regression tables</span></span>
<span id="cb32-1129"><a href="#cb32-1129" aria-hidden="true" tabindex="-1"></a><span class="in">create_regression_table(coef_table = coef_dt,</span></span>
<span id="cb32-1130"><a href="#cb32-1130" aria-hidden="true" tabindex="-1"></a><span class="in">                        eval_table = err_dt)</span></span>
<span id="cb32-1131"><a href="#cb32-1131" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1132"><a href="#cb32-1132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1133"><a href="#cb32-1133" aria-hidden="true" tabindex="-1"></a><span class="in">```{r qual-check-5}</span></span>
<span id="cb32-1134"><a href="#cb32-1134" aria-hidden="true" tabindex="-1"></a><span class="in">### start by explaining that the plot function could be used in R </span></span>
<span id="cb32-1135"><a href="#cb32-1135" aria-hidden="true" tabindex="-1"></a><span class="in">###  to show the error diagnostics as follows</span></span>
<span id="cb32-1136"><a href="#cb32-1136" aria-hidden="true" tabindex="-1"></a><span class="in"># plot(log_model, whitch = 1)</span></span>
<span id="cb32-1137"><a href="#cb32-1137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1138"><a href="#cb32-1138" aria-hidden="true" tabindex="-1"></a><span class="in">### a more thorough test on normality using the Kolmogrov-Smirnov tests</span></span>
<span id="cb32-1139"><a href="#cb32-1139" aria-hidden="true" tabindex="-1"></a><span class="in">ebp_kstest &lt;- function(ebp_obj) {</span></span>
<span id="cb32-1140"><a href="#cb32-1140" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-1141"><a href="#cb32-1141" aria-hidden="true" tabindex="-1"></a><span class="in">  epsilon_values &lt;- residuals(ebp_obj$model, level = 0, type = "pearson") |&gt;</span></span>
<span id="cb32-1142"><a href="#cb32-1142" aria-hidden="true" tabindex="-1"></a><span class="in">    as.numeric()</span></span>
<span id="cb32-1143"><a href="#cb32-1143" aria-hidden="true" tabindex="-1"></a><span class="in">  mu_values &lt;- as.numeric(nlme::ranef(ebp_obj$model)$"(Intercept)")</span></span>
<span id="cb32-1144"><a href="#cb32-1144" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-1145"><a href="#cb32-1145" aria-hidden="true" tabindex="-1"></a><span class="in">  mu_values &lt;- (mu_values - mean(mu_values, na.rm = TRUE)) /</span></span>
<span id="cb32-1146"><a href="#cb32-1146" aria-hidden="true" tabindex="-1"></a><span class="in">    sd(mu_values, na.rm = TRUE)</span></span>
<span id="cb32-1147"><a href="#cb32-1147" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-1148"><a href="#cb32-1148" aria-hidden="true" tabindex="-1"></a><span class="in">  xx &lt;- ks.test(</span></span>
<span id="cb32-1149"><a href="#cb32-1149" aria-hidden="true" tabindex="-1"></a><span class="in">    x = epsilon_values,</span></span>
<span id="cb32-1150"><a href="#cb32-1150" aria-hidden="true" tabindex="-1"></a><span class="in">    y = "pnorm",</span></span>
<span id="cb32-1151"><a href="#cb32-1151" aria-hidden="true" tabindex="-1"></a><span class="in">    mean = mean(epsilon_values),</span></span>
<span id="cb32-1152"><a href="#cb32-1152" aria-hidden="true" tabindex="-1"></a><span class="in">    sd = sd(epsilon_values)</span></span>
<span id="cb32-1153"><a href="#cb32-1153" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb32-1154"><a href="#cb32-1154" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-1155"><a href="#cb32-1155" aria-hidden="true" tabindex="-1"></a><span class="in">  yy &lt;- ks.test(</span></span>
<span id="cb32-1156"><a href="#cb32-1156" aria-hidden="true" tabindex="-1"></a><span class="in">    x = mu_values,</span></span>
<span id="cb32-1157"><a href="#cb32-1157" aria-hidden="true" tabindex="-1"></a><span class="in">    y = "pnorm",</span></span>
<span id="cb32-1158"><a href="#cb32-1158" aria-hidden="true" tabindex="-1"></a><span class="in">    mean = mean(mu_values),</span></span>
<span id="cb32-1159"><a href="#cb32-1159" aria-hidden="true" tabindex="-1"></a><span class="in">    sd = sd(mu_values)</span></span>
<span id="cb32-1160"><a href="#cb32-1160" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb32-1161"><a href="#cb32-1161" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-1162"><a href="#cb32-1162" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_random &lt;-</span></span>
<span id="cb32-1163"><a href="#cb32-1163" aria-hidden="true" tabindex="-1"></a><span class="in">    mu_values %&gt;%</span></span>
<span id="cb32-1164"><a href="#cb32-1164" aria-hidden="true" tabindex="-1"></a><span class="in">    as.data.table() %&gt;%</span></span>
<span id="cb32-1165"><a href="#cb32-1165" aria-hidden="true" tabindex="-1"></a><span class="in">    setnames(new = "values") %&gt;%</span></span>
<span id="cb32-1166"><a href="#cb32-1166" aria-hidden="true" tabindex="-1"></a><span class="in">    ggplot() +</span></span>
<span id="cb32-1167"><a href="#cb32-1167" aria-hidden="true" tabindex="-1"></a><span class="in">    geom_density(aes(x = values), fill = "blue", alpha = 0.5) +</span></span>
<span id="cb32-1168"><a href="#cb32-1168" aria-hidden="true" tabindex="-1"></a><span class="in">    labs(</span></span>
<span id="cb32-1169"><a href="#cb32-1169" aria-hidden="true" tabindex="-1"></a><span class="in">      x = "Random Effects", </span></span>
<span id="cb32-1170"><a href="#cb32-1170" aria-hidden="true" tabindex="-1"></a><span class="in">      y = "Density", </span></span>
<span id="cb32-1171"><a href="#cb32-1171" aria-hidden="true" tabindex="-1"></a><span class="in">      title = "Random Effect Residuals (\u03BC)"</span></span>
<span id="cb32-1172"><a href="#cb32-1172" aria-hidden="true" tabindex="-1"></a><span class="in">    ) +</span></span>
<span id="cb32-1173"><a href="#cb32-1173" aria-hidden="true" tabindex="-1"></a><span class="in">    theme_minimal() +</span></span>
<span id="cb32-1174"><a href="#cb32-1174" aria-hidden="true" tabindex="-1"></a><span class="in">    ylim(0, 0.4) +</span></span>
<span id="cb32-1175"><a href="#cb32-1175" aria-hidden="true" tabindex="-1"></a><span class="in">    xlim(-4, 4) +</span></span>
<span id="cb32-1176"><a href="#cb32-1176" aria-hidden="true" tabindex="-1"></a><span class="in">    annotate(</span></span>
<span id="cb32-1177"><a href="#cb32-1177" aria-hidden="true" tabindex="-1"></a><span class="in">      "richtext",</span></span>
<span id="cb32-1178"><a href="#cb32-1178" aria-hidden="true" tabindex="-1"></a><span class="in">      x = 0,</span></span>
<span id="cb32-1179"><a href="#cb32-1179" aria-hidden="true" tabindex="-1"></a><span class="in">      y = 0.3,</span></span>
<span id="cb32-1180"><a href="#cb32-1180" aria-hidden="true" tabindex="-1"></a><span class="in">      label = "&lt;b&gt;Kolmogrov-Smirnov Normality Test&lt;/b&gt;",</span></span>
<span id="cb32-1181"><a href="#cb32-1181" aria-hidden="true" tabindex="-1"></a><span class="in">      fill = NA,</span></span>
<span id="cb32-1182"><a href="#cb32-1182" aria-hidden="true" tabindex="-1"></a><span class="in">      label.color = NA</span></span>
<span id="cb32-1183"><a href="#cb32-1183" aria-hidden="true" tabindex="-1"></a><span class="in">    ) +</span></span>
<span id="cb32-1184"><a href="#cb32-1184" aria-hidden="true" tabindex="-1"></a><span class="in">    annotate(</span></span>
<span id="cb32-1185"><a href="#cb32-1185" aria-hidden="true" tabindex="-1"></a><span class="in">      "text",</span></span>
<span id="cb32-1186"><a href="#cb32-1186" aria-hidden="true" tabindex="-1"></a><span class="in">      x = 0,</span></span>
<span id="cb32-1187"><a href="#cb32-1187" aria-hidden="true" tabindex="-1"></a><span class="in">      y = 0.28,</span></span>
<span id="cb32-1188"><a href="#cb32-1188" aria-hidden="true" tabindex="-1"></a><span class="in">      label =</span></span>
<span id="cb32-1189"><a href="#cb32-1189" aria-hidden="true" tabindex="-1"></a><span class="in">        paste0(</span></span>
<span id="cb32-1190"><a href="#cb32-1190" aria-hidden="true" tabindex="-1"></a><span class="in">          "D-stat = ",</span></span>
<span id="cb32-1191"><a href="#cb32-1191" aria-hidden="true" tabindex="-1"></a><span class="in">          specify_decimal(yy$statistic, 3),</span></span>
<span id="cb32-1192"><a href="#cb32-1192" aria-hidden="true" tabindex="-1"></a><span class="in">          "; p-value = ",</span></span>
<span id="cb32-1193"><a href="#cb32-1193" aria-hidden="true" tabindex="-1"></a><span class="in">          specify_decimal(yy$p.value, 3)</span></span>
<span id="cb32-1194"><a href="#cb32-1194" aria-hidden="true" tabindex="-1"></a><span class="in">        ),</span></span>
<span id="cb32-1195"><a href="#cb32-1195" aria-hidden="true" tabindex="-1"></a><span class="in">      size = 3</span></span>
<span id="cb32-1196"><a href="#cb32-1196" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb32-1197"><a href="#cb32-1197" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-1198"><a href="#cb32-1198" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_error &lt;-</span></span>
<span id="cb32-1199"><a href="#cb32-1199" aria-hidden="true" tabindex="-1"></a><span class="in">    epsilon_values %&gt;%</span></span>
<span id="cb32-1200"><a href="#cb32-1200" aria-hidden="true" tabindex="-1"></a><span class="in">    as.data.table() %&gt;%</span></span>
<span id="cb32-1201"><a href="#cb32-1201" aria-hidden="true" tabindex="-1"></a><span class="in">    setnames(new = "values") %&gt;%</span></span>
<span id="cb32-1202"><a href="#cb32-1202" aria-hidden="true" tabindex="-1"></a><span class="in">    ggplot() +</span></span>
<span id="cb32-1203"><a href="#cb32-1203" aria-hidden="true" tabindex="-1"></a><span class="in">    geom_density(aes(x = values), fill = "blue", alpha = 0.5) +</span></span>
<span id="cb32-1204"><a href="#cb32-1204" aria-hidden="true" tabindex="-1"></a><span class="in">    labs(x = "Model Error Terms",</span></span>
<span id="cb32-1205"><a href="#cb32-1205" aria-hidden="true" tabindex="-1"></a><span class="in">         y = "Density", </span></span>
<span id="cb32-1206"><a href="#cb32-1206" aria-hidden="true" tabindex="-1"></a><span class="in">         title = "Standardized Error Residuals (\u03B5)") +</span></span>
<span id="cb32-1207"><a href="#cb32-1207" aria-hidden="true" tabindex="-1"></a><span class="in">    theme_minimal() +</span></span>
<span id="cb32-1208"><a href="#cb32-1208" aria-hidden="true" tabindex="-1"></a><span class="in">    annotate(</span></span>
<span id="cb32-1209"><a href="#cb32-1209" aria-hidden="true" tabindex="-1"></a><span class="in">      "richtext",</span></span>
<span id="cb32-1210"><a href="#cb32-1210" aria-hidden="true" tabindex="-1"></a><span class="in">      x = 0.75,</span></span>
<span id="cb32-1211"><a href="#cb32-1211" aria-hidden="true" tabindex="-1"></a><span class="in">      y = 0.3,</span></span>
<span id="cb32-1212"><a href="#cb32-1212" aria-hidden="true" tabindex="-1"></a><span class="in">      label = "&lt;b&gt;Kolmogrov-Smirnov Normality Test&lt;/b&gt;",</span></span>
<span id="cb32-1213"><a href="#cb32-1213" aria-hidden="true" tabindex="-1"></a><span class="in">      fill = NA,</span></span>
<span id="cb32-1214"><a href="#cb32-1214" aria-hidden="true" tabindex="-1"></a><span class="in">      label.color = NA</span></span>
<span id="cb32-1215"><a href="#cb32-1215" aria-hidden="true" tabindex="-1"></a><span class="in">    ) +</span></span>
<span id="cb32-1216"><a href="#cb32-1216" aria-hidden="true" tabindex="-1"></a><span class="in">    annotate(</span></span>
<span id="cb32-1217"><a href="#cb32-1217" aria-hidden="true" tabindex="-1"></a><span class="in">      "text",</span></span>
<span id="cb32-1218"><a href="#cb32-1218" aria-hidden="true" tabindex="-1"></a><span class="in">      x = 0,</span></span>
<span id="cb32-1219"><a href="#cb32-1219" aria-hidden="true" tabindex="-1"></a><span class="in">      y = 0.28,</span></span>
<span id="cb32-1220"><a href="#cb32-1220" aria-hidden="true" tabindex="-1"></a><span class="in">      label = paste0(</span></span>
<span id="cb32-1221"><a href="#cb32-1221" aria-hidden="true" tabindex="-1"></a><span class="in">        "D-stat = ",</span></span>
<span id="cb32-1222"><a href="#cb32-1222" aria-hidden="true" tabindex="-1"></a><span class="in">        specify_decimal(xx$statistic, 3),</span></span>
<span id="cb32-1223"><a href="#cb32-1223" aria-hidden="true" tabindex="-1"></a><span class="in">        "; p-value = ",</span></span>
<span id="cb32-1224"><a href="#cb32-1224" aria-hidden="true" tabindex="-1"></a><span class="in">        specify_decimal(xx$p.value, 3)</span></span>
<span id="cb32-1225"><a href="#cb32-1225" aria-hidden="true" tabindex="-1"></a><span class="in">      ),</span></span>
<span id="cb32-1226"><a href="#cb32-1226" aria-hidden="true" tabindex="-1"></a><span class="in">      size = 3</span></span>
<span id="cb32-1227"><a href="#cb32-1227" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb32-1228"><a href="#cb32-1228" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-1229"><a href="#cb32-1229" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_random + plot_error</span></span>
<span id="cb32-1230"><a href="#cb32-1230" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb32-1231"><a href="#cb32-1231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1232"><a href="#cb32-1232" aria-hidden="true" tabindex="-1"></a><span class="in">ebp_kstest(log_model)</span></span>
<span id="cb32-1233"><a href="#cb32-1233" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1234"><a href="#cb32-1234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1235"><a href="#cb32-1235" aria-hidden="true" tabindex="-1"></a><span class="fu">### CV Estimation</span></span>
<span id="cb32-1236"><a href="#cb32-1236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1237"><a href="#cb32-1237" aria-hidden="true" tabindex="-1"></a><span class="in">```{r qual-check-4}</span></span>
<span id="cb32-1238"><a href="#cb32-1238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1239"><a href="#cb32-1239" aria-hidden="true" tabindex="-1"></a><span class="in">### it is important to compare Coefficient of Variation between the survey direct estimates and the census computations. </span></span>
<span id="cb32-1240"><a href="#cb32-1240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1241"><a href="#cb32-1241" aria-hidden="true" tabindex="-1"></a><span class="in">#### first using the povmap::direct() function to estimate the direct and model estimate cvs for the poverty rates</span></span>
<span id="cb32-1242"><a href="#cb32-1242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1243"><a href="#cb32-1243" aria-hidden="true" tabindex="-1"></a><span class="in">ebp_compare_cv &lt;- function(ebp_obj, ...) {</span></span>
<span id="cb32-1244"><a href="#cb32-1244" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-1245"><a href="#cb32-1245" aria-hidden="true" tabindex="-1"></a><span class="in">  # Convert to data.table</span></span>
<span id="cb32-1246"><a href="#cb32-1246" aria-hidden="true" tabindex="-1"></a><span class="in">  ind_dt &lt;- as.data.table(ebp_obj$ind)</span></span>
<span id="cb32-1247"><a href="#cb32-1247" aria-hidden="true" tabindex="-1"></a><span class="in">  mse_dt &lt;- as.data.table(ebp_obj$MSE)</span></span>
<span id="cb32-1248"><a href="#cb32-1248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1249"><a href="#cb32-1249" aria-hidden="true" tabindex="-1"></a><span class="in">  # Ensure mse_dt and ind_dt are numeric except Domain</span></span>
<span id="cb32-1250"><a href="#cb32-1250" aria-hidden="true" tabindex="-1"></a><span class="in">  mse_numeric &lt;- mse_dt[, !("Domain"), with = FALSE]</span></span>
<span id="cb32-1251"><a href="#cb32-1251" aria-hidden="true" tabindex="-1"></a><span class="in">  ind_numeric &lt;- ind_dt[, !("Domain"), with = FALSE]</span></span>
<span id="cb32-1252"><a href="#cb32-1252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1253"><a href="#cb32-1253" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute CV</span></span>
<span id="cb32-1254"><a href="#cb32-1254" aria-hidden="true" tabindex="-1"></a><span class="in">  ebpcv_dt &lt;- sqrt(mse_numeric) / ind_numeric</span></span>
<span id="cb32-1255"><a href="#cb32-1255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1256"><a href="#cb32-1256" aria-hidden="true" tabindex="-1"></a><span class="in">  # Add Domain back</span></span>
<span id="cb32-1257"><a href="#cb32-1257" aria-hidden="true" tabindex="-1"></a><span class="in">  ebpcv_dt[, Domain := ind_dt$Domain]</span></span>
<span id="cb32-1258"><a href="#cb32-1258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1259"><a href="#cb32-1259" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute direct estimation</span></span>
<span id="cb32-1260"><a href="#cb32-1260" aria-hidden="true" tabindex="-1"></a><span class="in">  direct_dt &lt;- povmap::direct(...)</span></span>
<span id="cb32-1261"><a href="#cb32-1261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1262"><a href="#cb32-1262" aria-hidden="true" tabindex="-1"></a><span class="in">  # Identify numeric columns common to both</span></span>
<span id="cb32-1263"><a href="#cb32-1263" aria-hidden="true" tabindex="-1"></a><span class="in">  common_cols &lt;- intersect(names(direct_dt$ind), names(direct_dt$MSE))</span></span>
<span id="cb32-1264"><a href="#cb32-1264" aria-hidden="true" tabindex="-1"></a><span class="in">  numeric_cols &lt;- common_cols[sapply(as.data.table(direct_dt$ind)[, ..common_cols], is.numeric)]</span></span>
<span id="cb32-1265"><a href="#cb32-1265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1266"><a href="#cb32-1266" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute CV for direct estimation</span></span>
<span id="cb32-1267"><a href="#cb32-1267" aria-hidden="true" tabindex="-1"></a><span class="in">  directcv_dt &lt;- sqrt(as.data.table(direct_dt$MSE)[, ..numeric_cols]) / </span></span>
<span id="cb32-1268"><a href="#cb32-1268" aria-hidden="true" tabindex="-1"></a><span class="in">                 as.data.table(direct_dt$ind)[, ..numeric_cols]</span></span>
<span id="cb32-1269"><a href="#cb32-1269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1270"><a href="#cb32-1270" aria-hidden="true" tabindex="-1"></a><span class="in">  # Add Domain back and rename</span></span>
<span id="cb32-1271"><a href="#cb32-1271" aria-hidden="true" tabindex="-1"></a><span class="in">  directcv_dt &lt;- </span></span>
<span id="cb32-1272"><a href="#cb32-1272" aria-hidden="true" tabindex="-1"></a><span class="in">    cbind(as.data.table(direct_dt$ind)[, .(Domain)], directcv_dt) %&gt;%</span></span>
<span id="cb32-1273"><a href="#cb32-1273" aria-hidden="true" tabindex="-1"></a><span class="in">          dplyr::select(Domain, Head_Count) %&gt;%</span></span>
<span id="cb32-1274"><a href="#cb32-1274" aria-hidden="true" tabindex="-1"></a><span class="in">          rename(HT_Head_Count = Head_Count)</span></span>
<span id="cb32-1275"><a href="#cb32-1275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1276"><a href="#cb32-1276" aria-hidden="true" tabindex="-1"></a><span class="in">  # Merge direct and EBP results</span></span>
<span id="cb32-1277"><a href="#cb32-1277" aria-hidden="true" tabindex="-1"></a><span class="in">  cv_dt &lt;- directcv_dt[ebpcv_dt, on = "Domain"]</span></span>
<span id="cb32-1278"><a href="#cb32-1278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1279"><a href="#cb32-1279" aria-hidden="true" tabindex="-1"></a><span class="in">  # Rename columns for clarity</span></span>
<span id="cb32-1280"><a href="#cb32-1280" aria-hidden="true" tabindex="-1"></a><span class="in">  setnames(cv_dt, "Head_Count", "Head_Count_CV")</span></span>
<span id="cb32-1281"><a href="#cb32-1281" aria-hidden="true" tabindex="-1"></a><span class="in">  setnames(cv_dt, "HT_Head_Count", "HT_Head_Count_CV")</span></span>
<span id="cb32-1282"><a href="#cb32-1282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1283"><a href="#cb32-1283" aria-hidden="true" tabindex="-1"></a><span class="in">  return(cv_dt)</span></span>
<span id="cb32-1284"><a href="#cb32-1284" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb32-1285"><a href="#cb32-1285" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb32-1286"><a href="#cb32-1286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1287"><a href="#cb32-1287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1288"><a href="#cb32-1288" aria-hidden="true" tabindex="-1"></a><span class="in">cv_dt &lt;- ebp_compare_cv(ebp_obj = log_model,</span></span>
<span id="cb32-1289"><a href="#cb32-1289" aria-hidden="true" tabindex="-1"></a><span class="in">                        y = "eqIncome",</span></span>
<span id="cb32-1290"><a href="#cb32-1290" aria-hidden="true" tabindex="-1"></a><span class="in">                        smp_data = survey_dt,</span></span>
<span id="cb32-1291"><a href="#cb32-1291" aria-hidden="true" tabindex="-1"></a><span class="in">                        smp_domains = "district",</span></span>
<span id="cb32-1292"><a href="#cb32-1292" aria-hidden="true" tabindex="-1"></a><span class="in">                        weights = "weight",</span></span>
<span id="cb32-1293"><a href="#cb32-1293" aria-hidden="true" tabindex="-1"></a><span class="in">                        var = TRUE,</span></span>
<span id="cb32-1294"><a href="#cb32-1294" aria-hidden="true" tabindex="-1"></a><span class="in">                        threshold = 18207.2,</span></span>
<span id="cb32-1295"><a href="#cb32-1295" aria-hidden="true" tabindex="-1"></a><span class="in">                        design = "state",</span></span>
<span id="cb32-1296"><a href="#cb32-1296" aria-hidden="true" tabindex="-1"></a><span class="in">                        na.rm = TRUE,</span></span>
<span id="cb32-1297"><a href="#cb32-1297" aria-hidden="true" tabindex="-1"></a><span class="in">                        HT = TRUE)</span></span>
<span id="cb32-1298"><a href="#cb32-1298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1299"><a href="#cb32-1299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1300"><a href="#cb32-1300" aria-hidden="true" tabindex="-1"></a><span class="in">### it is useful to be able to be able to figure out how </span></span>
<span id="cb32-1301"><a href="#cb32-1301" aria-hidden="true" tabindex="-1"></a><span class="in">gains_value &lt;- </span></span>
<span id="cb32-1302"><a href="#cb32-1302" aria-hidden="true" tabindex="-1"></a><span class="in">  cv_dt |&gt;</span></span>
<span id="cb32-1303"><a href="#cb32-1303" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(gains = HT_Head_Count_CV / Head_Count_CV) |&gt;</span></span>
<span id="cb32-1304"><a href="#cb32-1304" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(mean(gains, na.rm = TRUE))</span></span>
<span id="cb32-1305"><a href="#cb32-1305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1306"><a href="#cb32-1306" aria-hidden="true" tabindex="-1"></a><span class="in">#### create visualization to show how the EBP CVs are an improvement on the Horwitz-Thompson Headcount CVs</span></span>
<span id="cb32-1307"><a href="#cb32-1307" aria-hidden="true" tabindex="-1"></a><span class="in">#### as a result of SAE</span></span>
<span id="cb32-1308"><a href="#cb32-1308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1309"><a href="#cb32-1309" aria-hidden="true" tabindex="-1"></a><span class="in">cv_dt |&gt;</span></span>
<span id="cb32-1310"><a href="#cb32-1310" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot() + </span></span>
<span id="cb32-1311"><a href="#cb32-1311" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(aes(y = Head_Count_CV, x = HT_Head_Count_CV)) + </span></span>
<span id="cb32-1312"><a href="#cb32-1312" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "blue") + </span></span>
<span id="cb32-1313"><a href="#cb32-1313" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Horwitz-Thompson Headcount CV",</span></span>
<span id="cb32-1314"><a href="#cb32-1314" aria-hidden="true" tabindex="-1"></a><span class="in">       y = "EBP Head Count CV") + </span></span>
<span id="cb32-1315"><a href="#cb32-1315" aria-hidden="true" tabindex="-1"></a><span class="in">  xlim(0, 1.5) + </span></span>
<span id="cb32-1316"><a href="#cb32-1316" aria-hidden="true" tabindex="-1"></a><span class="in">  ylim(0, 1.5) + </span></span>
<span id="cb32-1317"><a href="#cb32-1317" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_viridis_d(option = "plasma") + </span></span>
<span id="cb32-1318"><a href="#cb32-1318" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_minimal()</span></span>
<span id="cb32-1319"><a href="#cb32-1319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1320"><a href="#cb32-1320" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1321"><a href="#cb32-1321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1322"><a href="#cb32-1322" aria-hidden="true" tabindex="-1"></a><span class="fu">## Poverty map</span></span>
<span id="cb32-1323"><a href="#cb32-1323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1324"><a href="#cb32-1324" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-povmap}</span></span>
<span id="cb32-1325"><a href="#cb32-1325" aria-hidden="true" tabindex="-1"></a><span class="in">### plot the poverty map</span></span>
<span id="cb32-1326"><a href="#cb32-1326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1327"><a href="#cb32-1327" aria-hidden="true" tabindex="-1"></a><span class="in">#### load the shapefile from the povmap</span></span>
<span id="cb32-1328"><a href="#cb32-1328" aria-hidden="true" tabindex="-1"></a><span class="in">povmap::load_shapeaustria()</span></span>
<span id="cb32-1329"><a href="#cb32-1329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1330"><a href="#cb32-1330" aria-hidden="true" tabindex="-1"></a><span class="in">log_model$ind[c("Domain", "Head_Count")] |&gt;</span></span>
<span id="cb32-1331"><a href="#cb32-1331" aria-hidden="true" tabindex="-1"></a><span class="in">  merge(shape_austria_dis[, c("PB")],</span></span>
<span id="cb32-1332"><a href="#cb32-1332" aria-hidden="true" tabindex="-1"></a><span class="in">        by.x = "Domain", by.y = "PB") |&gt;</span></span>
<span id="cb32-1333"><a href="#cb32-1333" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_as_sf(crs = 4326) |&gt;</span></span>
<span id="cb32-1334"><a href="#cb32-1334" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot() + </span></span>
<span id="cb32-1335"><a href="#cb32-1335" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(aes(fill = Head_Count)) + </span></span>
<span id="cb32-1336"><a href="#cb32-1336" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_viridis_c(option = "magma",</span></span>
<span id="cb32-1337"><a href="#cb32-1337" aria-hidden="true" tabindex="-1"></a><span class="in">                       direction = -1,</span></span>
<span id="cb32-1338"><a href="#cb32-1338" aria-hidden="true" tabindex="-1"></a><span class="in">                       name = "Poverty Rate") + </span></span>
<span id="cb32-1339"><a href="#cb32-1339" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = "Poverty Map: Austria") + </span></span>
<span id="cb32-1340"><a href="#cb32-1340" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_minimal() + </span></span>
<span id="cb32-1341"><a href="#cb32-1341" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(axis.title = element_blank(), # Remove axis labels</span></span>
<span id="cb32-1342"><a href="#cb32-1342" aria-hidden="true" tabindex="-1"></a><span class="in">        axis.text = element_blank(),  # Remove axis text</span></span>
<span id="cb32-1343"><a href="#cb32-1343" aria-hidden="true" tabindex="-1"></a><span class="in">        panel.grid = element_blank(), # Remove grid lines</span></span>
<span id="cb32-1344"><a href="#cb32-1344" aria-hidden="true" tabindex="-1"></a><span class="in">        plot.title = element_text(hjust = 0.5, size = 16), # Center and style title</span></span>
<span id="cb32-1345"><a href="#cb32-1345" aria-hidden="true" tabindex="-1"></a><span class="in">        plot.subtitle = element_text(hjust = 0.5, size = 12))</span></span>
<span id="cb32-1346"><a href="#cb32-1346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1347"><a href="#cb32-1347" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>